<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éª°å­æˆ°çˆ­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a;
            color: white;
            font-family: sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        .dice-card {
            transition: transform 0.1s;
            position: relative;
            cursor: pointer;
        }

        .dice-card:active {
            transform: scale(0.95);
        }

        .tab-active {
            border-bottom: 4px solid #3b82f6;
            color: #3b82f6;
        }

        .scroll-hide::-webkit-scrollbar {
            display: none;
        }

        /* è®“åº•éƒ¨é¸å–®æ›´åƒæ‰‹æ©Ÿ App */
        .fixed.bottom-0 {
            padding-bottom: env(safe-area-inset-bottom, 12px);
            /* é©é… iPhone åº•ç·š */
            backdrop-filter: blur(10px);
            /* æ¯›ç»ç’ƒæ•ˆæœ */
            background: rgba(15, 23, 42, 0.95);
        }

        /* éš±è—æ»¾å‹•æ¢ä½†ä¿æŒæ»¾å‹• */
        .scroll-hide::-webkit-scrollbar {
            display: none;
        }

        .q-mythic {
            background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff);
            background-size: 200% 200%;
            animation: rainbow 3s linear infinite;
        }

        @keyframes rainbow {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* é¸å–ç‹€æ…‹ç‰¹æ•ˆ */
        .selected-dice {
            outline: 4px solid #3b82f6;
            box-shadow: 0 0 15px #3b82f6;
            transform: scale(1.05);
            z-index: 10;
        }

        .deck-slot-highlight {
            animation: pulse 1.5s infinite;
            border-color: #3b82f6 !important;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes popup {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-popup {
            animation: popup 0.3s ease-out forwards;
        }
    </style>
</head>

<body class="p-4 flex flex-col h-screen">
    <div class="flex justify-between items-center mb-4 bg-slate-800 p-3 rounded-xl shadow-lg border border-slate-700">
        <div class="flex items-center gap-2">
            <span class="text-yellow-400 font-bold text-lg">ğŸ’</span>
            <span id="goldText" class="font-mono text-xl text-yellow-500 font-bold">0</span>
        </div>
        <p class="text-[10px] text-slate-500">ç‰ˆæœ¬V0.2.4</p>
        <a href="index.html" class="no-underline">
            <button
                class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded-lg text-xs font-bold border border-slate-500 transition-colors">
                ğŸ  å¤§å»³
            </button>
        </a>
    </div>

    <div class="flex-1 overflow-y-auto pb-24" id="main-content">

        <div id="page-shop" class="hidden space-y-6">
            <h2 class="text-xl font-bold px-1 text-white">è‹±é›„å¬å–š</h2>

            <div
                class="bg-gradient-to-br from-indigo-900 to-slate-900 p-5 rounded-3xl border-2 border-indigo-500/50 shadow-xl relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-7xl opacity-10 rotate-12">â­</div>

                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-black text-indigo-300">åŠŸèƒ½å‹ç‰¹é¸æ± </h3>
                        <p class="text-[10px] text-indigo-400 opacity-80 uppercase tracking-tighter">Special Support
                            Summon</p>
                    </div>
                    <div
                        class="bg-indigo-950/80 px-3 py-1 rounded-full border border-indigo-500 flex items-center gap-1">
                        <span class="text-xs">ğŸŸï¸</span>
                        <span id="shopTicketText" class="font-mono text-sm font-bold text-white">0</span>
                    </div>
                </div>

                <div class="text-center py-4">
                    <div class="text-5xl mb-2">ğŸ«</div>
                    <p class="text-slate-300 text-xs mb-4">æœ¬æ± ç²å–ã€ŒåŠŸèƒ½å‹ã€è‹±é›„æ©Ÿç‡æå‡ 20%</p>
                </div>

                <button onclick="buySpecialBox(1)"
                    class="w-full bg-indigo-600 hover:bg-indigo-500 py-4 rounded-2xl font-bold active:scale-95 transition-all shadow-[0_4px_0_0_#4338ca]">
                    ğŸŸï¸ æ¶ˆè€— 1 å¼µç¥¨åˆ¸å¬å–š
                </button>
            </div>

            <div
                class="bg-gradient-to-br from-slate-800 to-slate-900 p-5 rounded-3xl border-2 border-slate-700 shadow-xl relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-black text-yellow-500">ä¸€èˆ¬å¬å–š</h3>
                        <p class="text-[10px] text-slate-500 uppercase">Standard Summon</p>
                    </div>
                    <div class="bg-slate-950/80 px-3 py-1 rounded-full border border-slate-700 flex items-center gap-1">
                        <span class="text-xs">ğŸ’</span>
                        <span id="shopGoldText" class="font-mono text-sm font-bold text-yellow-500">0</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="buyBox(10)"
                        class="bg-slate-700 py-4 rounded-2xl font-bold active:scale-95 transition-all flex flex-col items-center">
                        <span class="text-sm">10 é€£æŠ½</span>
                        <span class="text-[10px] text-yellow-500">10è¬ ğŸ’</span>
                    </button>
                    <button onclick="buyBox(100)"
                        class="bg-slate-700 py-4 rounded-2xl font-bold active:scale-95 transition-all flex flex-col items-center border border-yellow-500/30">
                        <span class="text-sm">100 é€£æŠ½</span>
                        <span class="text-[10px] text-yellow-500">100è¬ ğŸ’</span>
                    </button>
                </div>
            </div>

        </div>

        <div id="page-battle" class="space-y-6">
            <div class="bg-slate-900/80 p-4 rounded-2xl border border-slate-700 shadow-inner">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-[10px] text-blue-400 font-bold uppercase tracking-wider">Battle Deck</p>
                    <button onclick="showPage('inventory')"
                        class="text-[10px] text-slate-400 bg-slate-800 px-2 py-1 rounded-md">ä¿®æ”¹</button>
                </div>
                <div id="deckContainer" class="flex justify-between gap-2"></div>
            </div>

            <h2 class="text-xl font-bold px-1 text-white">é¸æ“‡æˆ°é¬¥æ¨¡å¼</h2>

            <div class="grid grid-cols-1 gap-4">
                <button onclick="startBattle()"
                    class="relative overflow-hidden group bg-gradient-to-r from-blue-600 to-blue-800 p-5 rounded-2xl text-left shadow-lg active:scale-95 transition-all">
                    <div class="relative z-10">
                        <h3 class="text-xl font-black mb-1">å†’éšªé—–é—œ</h3>
                        <p class="text-blue-100 text-xs opacity-80">æŒ‘æˆ°é—œå¡</p>
                    </div>
                    <span
                        class="absolute right-4 bottom-2 text-6xl opacity-20 group-hover:scale-110 transition-transform">ğŸ—ºï¸</span>
                </button>

                <button onclick="alert('PVPæ¨¡å¼å³å°‡é–‹æ”¾ï¼')"
                    class="relative overflow-hidden group bg-gradient-to-r from-red-600 to-red-800 p-5 rounded-2xl text-left shadow-lg active:scale-95 transition-all opacity-80">
                    <div class="relative z-10">
                        <h3 class="text-xl font-black mb-1">å°æˆ°</h3>
                        <p class="text-red-100 text-xs opacity-80">å³æ™‚ç«¶æŠ€</p>
                    </div>
                    <span class="absolute right-4 bottom-2 text-6xl opacity-20">âš”ï¸</span>
                    <div
                        class="absolute top-2 right-2 bg-black/50 px-2 py-0.5 rounded text-[10px] font-bold text-white">
                        SOON</div>
                </button>

                <button onclick="alert('åˆä½œæ¨¡å¼å³å°‡é–‹æ”¾ï¼')"
                    class="relative overflow-hidden group bg-gradient-to-r from-emerald-600 to-emerald-800 p-5 rounded-2xl text-left shadow-lg active:scale-95 transition-all opacity-80">
                    <div class="relative z-10">
                        <h3 class="text-xl font-black mb-1">å…±åŒåˆä½œ</h3>
                        <p class="text-emerald-100 text-xs opacity-80">è¯æ‰‹é˜²å®ˆï¼ŒæŠµç¦¦æ•µè»</p>
                    </div>
                    <span class="absolute right-4 bottom-2 text-6xl opacity-20">ğŸ¤</span>
                    <div
                        class="absolute top-2 right-2 bg-black/50 px-2 py-0.5 rounded text-[10px] font-bold text-white">
                        SOON</div>
                </button>
            </div>
        </div>

        <div id="page-inventory" class="hidden space-y-6">
            <div
                class="bg-slate-900 p-4 rounded-3xl border-2 border-blue-500/50 shadow-[0_0_15px_rgba(59,130,246,0.2)]">
                <div class="flex justify-between items-center mb-3 px-1">
                    <h3 class="text-sm font-bold text-blue-400 uppercase tracking-widest">å‡ºæˆ°é™£å®¹</h3>
                    <span class="text-[10px] text-slate-500">é»æ“Šä¸‹æ–¹éª°å­å¯æ›´æ›</span>
                </div>
                <div id="inventoryDeckContainer" class="flex justify-between gap-2">
                </div>
            </div>

            <div>
                <h2 class="text-lg font-bold mb-3 flex items-center gap-2 px-1">
                    <span>æˆ‘çš„éª°å­åº«</span>
                    <span id="diceCount" class="text-xs font-normal text-slate-500">(0/0)</span>
                </h2>
                <div id="inventorySection" class="grid grid-cols-3 gap-3 pb-10">
                </div>
            </div>
        </div>
    </div>

    <div
        class="fixed bottom-0 left-0 w-full bg-slate-900 border-t border-slate-700 px-6 py-3 flex justify-between items-center z-40">
        <button onclick="showPage('shop')" id="nav-shop"
            class="flex flex-col items-center gap-1 text-slate-400 transition-colors">
            <span class="text-2xl">ğŸ›’</span>
            <span class="text-[10px] font-bold">å•†åº—</span>
        </button>

        <button onclick="showPage('battle')" id="nav-battle"
            class="flex flex-col items-center gap-1 text-blue-400 transition-colors">
            <span class="text-3xl">âš”ï¸</span>
            <span class="text-[10px] font-bold">æˆ°é¬¥</span>
        </button>

        <button onclick="showPage('inventory')" id="nav-inventory"
            class="flex flex-col items-center gap-1 text-slate-400 transition-colors">
            <span class="text-2xl">ğŸ²</span>
            <span class="text-[10px] font-bold">å‚™æˆ°</span>
        </button>
    </div>

    <div id="rewardOverlay" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-6">
        <div class="bg-slate-800 w-full max-w-sm rounded-3xl p-6 border border-slate-600 animate-popup">
            <h3 class="text-center text-xl font-bold text-indigo-400 mb-6">å¬å–šçµæœ</h3>
            <div id="rewardList" class="flex flex-wrap justify-center gap-4 mb-8"></div>
            <button onclick="closeReward()" class="w-full bg-slate-700 py-3 rounded-xl font-bold">æ”¶ä¸‹å¡ç‰‡</button>
        </div>
    </div>

    <div id="upgradeOverlay" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-6">
        <div id="upgradeCard"
            class="bg-slate-800 w-full max-w-sm rounded-3xl p-6 border border-slate-600 animate-popup text-center">
            <div id="u-icon"
                class="w-20 h-20 mx-auto rounded-2xl flex items-center justify-center text-2xl font-black mb-4 border-4 shadow-2xl">
            </div>
            <h3 id="u-name" class="text-2xl font-bold mb-1"></h3>
            <p id="u-quality" class="text-xs mb-4 uppercase tracking-widest"></p>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-slate-900 p-3 rounded-2xl border border-slate-700">
                    <div class="text-slate-400 text-[10px]">ç•¶å‰ç­‰ç´š</div>
                    <div id="u-lv-now" class="text-xl font-bold text-white"></div>
                </div>
                <div class="bg-slate-900 p-3 rounded-2xl border border-slate-700">
                    <div class="text-slate-400 text-[10px]">æ”»æ“ŠåŠ›</div>
                    <div id="u-atk" class="text-xl font-bold text-green-400"></div>
                </div>
            </div>
            <div class="bg-slate-900/50 p-4 rounded-2xl border border-slate-700 mb-6">
                <div class="flex justify-around items-center">
                    <div class="text-center">
                        <div class="text-[10px] text-slate-500 mb-1 uppercase">æ‰€éœ€ç¢ç‰‡</div>
                        <div id="u-req-fragments" class="font-bold text-sm"></div>
                    </div>
                    <div class="h-8 w-[1px] bg-slate-700"></div>
                    <div class="text-center">
                        <div class="text-[10px] text-slate-500 mb-1 uppercase">æ‰€éœ€é‘½çŸ³</div>
                        <div id="u-req-gold" class="font-bold text-sm text-yellow-500"></div>
                    </div>
                </div>
            </div>

            <div class="flex gap-2 mb-4">
                <button id="btn-equip" onclick="confirmEquip()"
                    class="flex-1 bg-blue-600 py-3 rounded-xl font-bold">è£å‚™å‡ºæˆ°</button>
                <button id="btn-upgrade" onclick="confirmUpgrade()"
                    class="flex-1 bg-green-600 py-3 rounded-xl font-bold disabled:opacity-50 disabled:grayscale">å‡ç´š</button>
            </div>
            <button onclick="closeUpgradeUI()" class="text-slate-500 text-sm">è¿”å›</button>
        </div>
    </div>

    <script>
        // --- 1. åŸºç¤è³‡æ–™å®šç¾© ---
        const QUALITIES = {
            common: { name: 'æ™®é€š', color: '#ffffff', chance: 0.50 },
            rare: { name: 'ç¨€æœ‰', color: '#3b82f6', chance: 0.30 },
            epic: { name: 'å²è©©', color: '#a855f7', chance: 0.18 },
            legend: { name: 'å‚³èªª', color: '#eab308', chance: 0.015 },
            mythic: { name: 'ç¥è©±', color: '#ff00ff', chance: 0.005 }
        };

        const ALL_DICES = [
            // --- Common (æ™®é€š) ---
            {
                id: 'fire', name: 'ç«', quality: 'common', baseColor: '#ef4444', pattern: 'fire',
                stats: { atk: 15, speed: 50 }, grow: { atk: 5, speed: -1 },
                special: { label: 'æ¿ºå°„ç¯„åœ', value: 1.0, unit: 'æ ¼', grow: 0.1 }
            },
            {
                id: 'wind', name: 'é¢¨', quality: 'common', baseColor: '#10b981', pattern: 'wind',
                stats: { atk: 10, speed: 20 }, grow: { atk: 3, speed: -2 },
                special: { label: 'é€£æ“Šæ©Ÿç‡', value: 10, unit: '%', grow: 3 }
            },
            {
                id: 'ice', name: 'å†°', quality: 'common', baseColor: '#3b82f6', pattern: 'ice',
                stats: { atk: 8, speed: 60 }, grow: { atk: 2, speed: -1 },
                special: { label: 'ç·©é€Ÿæ•ˆæœ', value: 15, unit: '%', grow: 5 }
            },
            {
                id: 'electric', name: 'é›»', quality: 'common', baseColor: '#f59e0b', pattern: 'electric',
                stats: { atk: 7, speed: 40 }, grow: { atk: 2, speed: -1 },
                special: { label: 'é€£é–ç›®æ¨™', value: 3, unit: 'é«”', grow: 1 }
            },
            {
                id: 'poison', name: 'æ¯’', quality: 'common', baseColor: '#008000', pattern: 'poison',
                stats: { atk: 6, speed: 45 }, grow: { atk: 2, speed: -1 },
                special: { label: 'ä¸­æ¯’å‚·å®³', value: 5, unit: 'pt', grow: 3 }
            },

            // --- Rare (ç¨€æœ‰) ---
            {
                id: 'lock', name: 'é–å®š', quality: 'rare', baseColor: '#64748b', pattern: 'lock',
                stats: { atk: 10, speed: 55 }, grow: { atk: 4, speed: -1 },
                special: { label: 'ç¦éŒ®æ™‚é•·', value: 0.5, unit: 'ç§’', grow: 0.2 }
            },

            // --- Epic (å²è©©) ---
            {
                id: 'teleport', name: 'å‚³é€', quality: 'epic', baseColor: '#8b5cf6', pattern: 'teleport',
                stats: { atk: 5, speed: 65 }, grow: { atk: 2, speed: -1 },
                special: { label: 'å‚³é€å›çµ‚é»', value: 5, unit: '%', grow: 2 }
            },
            {
                id: 'gear', name: 'é½’è¼ª', quality: 'epic', baseColor: '#475569', pattern: 'gear',
                stats: { atk: 12, speed: 50 }, grow: { atk: 6, speed: -1 },
                special: { label: 'é€£çµåŠ æˆ', value: 10, unit: '%', grow: 5 }
            },

            // --- Legend (å‚³èªª) ---
            {
                id: 'joker', name: 'å°ä¸‘', quality: 'legend', baseColor: '#f87171', pattern: 'joker',
                stats: { atk: 5, speed: 50 }, grow: { atk: 1, speed: 0 },
                special: { label: 'ç¹¼æ‰¿æ¯”ä¾‹', value: 80, unit: '%', grow: 2 }
            },
            {
                id: 'growth', name: 'æˆé•·', quality: 'legend', baseColor: '#f472b6', pattern: 'growth',
                stats: { atk: 10, speed: 50 }, grow: { atk: 5, speed: -1 },
                special: { label: 'æˆé•·æ™‚é–“', value: 60, unit: 'ç§’', grow: -2 }
            },
            {
                id: 'sun', name: 'å¤ªé™½', quality: 'legend', baseColor: '#fbbf24', pattern: 'sun',
                stats: { atk: 25, speed: 55 }, grow: { atk: 12, speed: -0.5 },
                special: { label: 'æ¿ºå°„å‚·å®³', value: 100, unit: '%', grow: 20 }
            },

            // --- Mythic (ç¥è©±) ---
            {
                id: 'galaxy', name: 'éŠ€æ²³', quality: 'mythic', baseColor: '#6366f1', pattern: 'galaxy',
                stats: { atk: 40, speed: 45 }, grow: { atk: 20, speed: -1 },
                special: { label: 'é»‘æ´åå™¬', value: 1, unit: '%', grow: 0.5 }
            }
        ];

        // --- 2. è³‡æ–™è¼‰å…¥ ---
        let currentBalance = parseFloat(localStorage.getItem('sicbo_balance')) || 0;
        let userData = null;

        function initGameData() {
            let raw = localStorage.getItem('dice_game_data');
            let data = null;

            try {
                if (raw) {
                    data = JSON.parse(raw);
                    if (!data || !Array.isArray(data.deck)) throw new Error("Format error");
                }
            } catch (e) {
                console.warn("å­˜æª”æ ¼å¼ä¸ç¬¦ï¼Œæ­£åœ¨ä¿®å¾©...");
                data = null;
            }

            if (!data) {
                data = {
                    deck: ['fire', 'wind', 'ice', 'electric', 'poison'],
                    inventory: { 'fire': 1, 'wind': 1, 'ice': 1, 'electric': 1, 'poison': 1 },
                    diceLevels: { 'fire': 1, 'wind': 1, 'ice': 1, 'electric': 1, 'poison': 1 }
                };
                localStorage.setItem('dice_game_data', JSON.stringify(data));
            }

            ALL_DICES.forEach(d => {
                if (!data.inventory) data.inventory = {};
                if (!data.diceLevels) data.diceLevels = {};
                if (data.inventory[d.id] === undefined) data.inventory[d.id] = 0;
                if (data.diceLevels[d.id] === undefined) data.diceLevels[d.id] = 1;
            });

            return data;
        }

        userData = initGameData();

        let selectedInventoryId = null;
        let tempUpgradeId = null;

        const UPGRADE_CONFIG = {
            1: [5, 50000], 2: [10, 100000], 3: [20, 200000], 4: [50, 500000],
            5: [100, 1000000], 6: [200, 5000000], 7: [500, 10000000], 8: [800, 50000000],
            9: [1000, 100000000], 10: [1200, 500000000]
        };
        function drawDiceStars(ctx, x, y, size, stars, diceColor) {
            // 7æ˜Ÿé¡¯ç¤ºé‡‘è‰²å¤§æ˜Ÿæ˜Ÿ (é€™å€‹ç¶­æŒé‡‘è‰²ï¼Œå› ç‚ºå®ƒæ˜¯æœ€å¼·å½¢æ…‹)
            if (stars >= 7) {
                ctx.save();
                ctx.fillStyle = "#fbbf24";
                ctx.font = `bold ${size * 0.7}px Arial`;
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("â˜…", x + size / 2, y + size / 2 + size * 0.05);
                ctx.restore();
                return;
            }

            // 1-6æ˜Ÿä½¿ç”¨éª°å­é¡è‰²
            ctx.fillStyle = diceColor || "#333";

            const dotSize = size * 0.07;
            const p = size * 0.22;
            const m = size / 2;
            const l = p, r = size - p;
            const t = p, b = size - p;

            let dots = [];
            if (stars === 1) dots = [[m, m]];
            else if (stars === 2) dots = [[l, t], [r, b]];
            else if (stars === 3) dots = [[l, t], [m, m], [r, b]];
            else if (stars === 4) dots = [[l, t], [r, t], [l, b], [r, b]];
            else if (stars === 5) dots = [[l, t], [r, t], [m, m], [l, b], [r, b]];
            else if (stars === 6) dots = [[l, t], [r, t], [l, m], [r, m], [l, b], [r, b]];

            dots.forEach(dot => {
                ctx.beginPath();
                ctx.arc(x + dot[0], y + dot[1], dotSize, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        function drawDiceFeature(ctx, x, y, size, pattern, diceColor) {
            if (!pattern) return;

            const m = size / 2;
            ctx.save();
            ctx.translate(x, y);

            const r = parseInt(diceColor.slice(1, 3), 16);
            const g = parseInt(diceColor.slice(3, 5), 16);
            const b = parseInt(diceColor.slice(5, 7), 16);
            ctx.strokeStyle = `rgba(${r}, ${g}, ${b}, 0.3)`; // ç¨å¾®åŠ æ·±ä¸€é»é»ï¼Œæ›´æ˜é¡¯
            ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.12)`;
            ctx.lineWidth = 4;
            ctx.lineCap = "round";
            ctx.lineJoin = "round";

            switch (pattern) {
                // --- Common ---
                case 'fire':
                    ctx.beginPath();
                    ctx.moveTo(m, size * 0.2); ctx.lineTo(size * 0.8, size * 0.8); ctx.lineTo(size * 0.2, size * 0.8);
                    ctx.closePath(); ctx.stroke(); ctx.fill();
                    break;
                case 'ice':
                    ctx.beginPath(); ctx.arc(m, m, size * 0.35, 0, Math.PI * 2);
                    ctx.moveTo(m, size * 0.1); ctx.lineTo(m, size * 0.9);
                    ctx.moveTo(size * 0.1, m); ctx.lineTo(size * 0.9, m);
                    ctx.stroke();
                    break;
                case 'wind':
                    ctx.beginPath();
                    for (let i = -1; i <= 1; i++) {
                        ctx.moveTo(size * 0.2, m + (i * 12)); ctx.lineTo(size * 0.8, m + (i * 12));
                    }
                    ctx.stroke();
                    break;
                case 'electric':
                    ctx.beginPath();
                    ctx.moveTo(m + 5, size * 0.15); ctx.lineTo(m - 10, m + 5);
                    ctx.lineTo(m + 10, m - 5); ctx.lineTo(m - 5, size * 0.85);
                    ctx.stroke();
                    break;
                case 'poison':
                    ctx.beginPath();
                    ctx.moveTo(m, size * 0.2); ctx.lineTo(size * 0.75, m);
                    ctx.lineTo(m, size * 0.8); ctx.lineTo(size * 0.25, m);
                    ctx.closePath(); ctx.stroke(); ctx.fill();
                    break;

                // --- Rare & Epic ---
                case 'lock': // é–å®šï¼šæ–¹æ¡†ä¸­å¸¶ä¸€å€‹åœ“é»
                    ctx.strokeRect(size * 0.25, size * 0.25, size * 0.5, size * 0.5);
                    ctx.beginPath(); ctx.arc(m, m, 4, 0, Math.PI * 2); ctx.fill();
                    break;
                case 'teleport': // å‚³é€ï¼šå…©å€‹æ¼©æ¸¦æ‹¬è™Ÿ
                    ctx.beginPath();
                    ctx.arc(size * 0.3, m, size * 0.3, -Math.PI / 2, Math.PI / 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(size * 0.7, m, size * 0.3, Math.PI / 2, -Math.PI / 2);
                    ctx.stroke();
                    break;
                case 'gear': // é½’è¼ªï¼šå¤–åœˆå…«å€‹é½’ï¼ˆç”¨è™›ç·šæ¨¡æ“¬ï¼‰
                    ctx.beginPath();
                    ctx.setLineDash([5, 5]);
                    ctx.arc(m, m, size * 0.35, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.setLineDash([]); // æ¢å¾©å¯¦ç·š
                    ctx.beginPath(); ctx.arc(m, m, size * 0.15, 0, Math.PI * 2); ctx.stroke();
                    break;

                // --- Legend ---
                case 'joker': // å°ä¸‘ï¼šå€’ä¸‰è§’å½¢åŠ ä¸Šä¸Šæ–¹å…©é»
                    ctx.beginPath();
                    ctx.moveTo(size * 0.2, size * 0.3); ctx.lineTo(size * 0.8, size * 0.3);
                    ctx.lineTo(m, size * 0.8); ctx.closePath(); ctx.stroke();
                    ctx.beginPath(); ctx.arc(size * 0.35, size * 0.2, 3, 0, Math.PI * 2); ctx.fill();
                    ctx.beginPath(); ctx.arc(size * 0.65, size * 0.2, 3, 0, Math.PI * 2); ctx.fill();
                    break;
                case 'growth': // æˆé•·ï¼šå‘ä¸Šçš„ç®­é ­
                    ctx.beginPath();
                    ctx.moveTo(m, size * 0.15); ctx.lineTo(m, size * 0.85);
                    ctx.moveTo(m, size * 0.15); ctx.lineTo(size * 0.3, size * 0.4);
                    ctx.moveTo(m, size * 0.15); ctx.lineTo(size * 0.7, size * 0.4);
                    ctx.stroke();
                    break;
                case 'sun': // å¤ªé™½ï¼šåœ“å½¢æ”¾å°„ç‹€
                    ctx.beginPath(); ctx.arc(m, m, size * 0.2, 0, Math.PI * 2); ctx.stroke(); ctx.fill();
                    for (let i = 0; i < 8; i++) {
                        ctx.save();
                        ctx.translate(m, m); ctx.rotate(i * Math.PI / 4);
                        ctx.moveTo(0, -size * 0.25); ctx.lineTo(0, -size * 0.45);
                        ctx.stroke(); ctx.restore();
                    }
                    break;

                // --- Mythic ---
                case 'galaxy': // éŠ€æ²³ï¼šæ—‹æ¸¦ç‹€ S å‹
                    ctx.beginPath();
                    ctx.moveTo(m, size * 0.1);
                    ctx.bezierCurveTo(size * 0.9, size * 0.1, size * 0.1, size * 0.9, m, size * 0.9);
                    ctx.stroke();
                    ctx.beginPath(); ctx.arc(m, m, size * 0.1, 0, Math.PI * 2); ctx.fill();
                    break;
            }
            ctx.restore();
        }
        // --- 3. æ¸²æŸ“èˆ‡åŠŸèƒ½ ---
        function render() {
            if (!userData) return;

            // 1. æ›´æ–°é‡‘å¹£èˆ‡ç¥¨åˆ¸
            const goldDisplay = document.getElementById('goldText');
            if (goldDisplay) goldDisplay.innerText = Math.floor(currentBalance).toLocaleString();
            const shopGoldText = document.getElementById('shopGoldText');
            if (shopGoldText) shopGoldText.innerText = Math.floor(currentBalance).toLocaleString();

            const tickets = userData.tickets || 0;
            const shopTicketDisplay = document.getElementById('shopTicketText');
            if (shopTicketDisplay) shopTicketDisplay.innerText = tickets.toLocaleString();

            // 2. ç”¢ç”Ÿæˆå“¡æ¸…å–® (Deck) çš„ HTML - å€åˆ†ä¸»é èˆ‡å‚™æˆ°é é¢çš„ ID
            const generateDeckHtml = (prefix) => {
                return userData.deck.map((id, index) => {
                    const dice = ALL_DICES.find(d => d.id === id);
                    if (!dice) return `<div class="w-14 h-14 bg-slate-800 rounded-lg border-2 border-dashed border-slate-600"></div>`;

                    const q = QUALITIES[dice.quality] || QUALITIES.common;
                    const lv = userData.diceLevels[id] || 1;
                    const isReplacing = selectedInventoryId !== null;

                    return `
            <div onclick="selectDeckSlot(${index})" 
                class="w-14 h-14 rounded-lg flex flex-col items-center justify-center relative shadow-lg border-2 transition-all 
                ${dice.quality === 'mythic' ? 'q-mythic' : ''} ${isReplacing ? 'deck-slot-highlight' : ''}" 
                style="background-color: #ffffff; border-color: ${q.color}">
                <canvas id="${prefix}-deck-canvas-${index}" width="56" height="56" class="absolute inset-0 pointer-events-none"></canvas>
                <div class="absolute bottom-0 text-[8px] bg-black/50 text-white px-1 rounded z-10">Lv.${lv}</div>
            </div>`;
                }).join('');
            };

            const deckContainer = document.getElementById('deckContainer');
            if (deckContainer) deckContainer.innerHTML = generateDeckHtml('main');

            const inventoryDeckContainer = document.getElementById('inventoryDeckContainer');
            if (inventoryDeckContainer) inventoryDeckContainer.innerHTML = generateDeckHtml('inv');

            // 3. æ›´æ–°éª°å­å€‰åº« (Inventory) - åŠ ä¸Šåç¨±é¡¯ç¤º
            const inventorySection = document.getElementById('inventorySection');
            if (inventorySection) {
                inventorySection.innerHTML = ALL_DICES.map(dice => {
                    const count = userData.inventory[dice.id] || 0;
                    const lv = userData.diceLevels[dice.id] || 1;
                    const q = QUALITIES[dice.quality] || QUALITIES.common;
                    const isOwned = count > 0 || userData.deck.includes(dice.id);
                    const isSelected = selectedInventoryId === dice.id;

                    return `
            <div onclick="${isOwned ? `openUpgradeUI('${dice.id}')` : ''}" 
                class="bg-slate-800 p-2 rounded-xl text-center border-2 transition-all dice-card 
                ${isSelected ? 'selected-dice' : (isOwned ? 'border-slate-700' : 'opacity-20 grayscale pointer-events-none')}">
                <div class="w-12 h-12 mx-auto mb-1 relative rounded-lg bg-white overflow-hidden" 
                     style="border: 2px solid ${q.color}">
                    <canvas id="inv-canvas-${dice.id}" width="48" height="48" class="absolute inset-0 pointer-events-none"></canvas>
                </div>
                <div class="text-[10px] font-bold text-white truncate mb-0.5">${dice.name}</div>
                <div class="text-[9px] text-slate-300">Lv.${lv}</div>
                <div class="text-[8px] text-slate-400">${count} ç¢ç‰‡</div>
            </div>`;
                }).join('');
            }

            // --- 4. é—œéµæ­¥é©Ÿï¼šç¢ºä¿ HTML æ¸²æŸ“å¾Œå†ç¹ªåœ–ï¼Œä¸¦ä¿®æ­£åº§æ¨™ ---
            setTimeout(() => {
                // ç¹ªè£½ç·¨éšŠå€ (ä¸»é èˆ‡å‚™æˆ°é )
                ['main', 'inv'].forEach(prefix => {
                    userData.deck.forEach((id, index) => {
                        const dice = ALL_DICES.find(d => d.id === id);
                        const canvas = document.getElementById(`${prefix}-deck-canvas-${index}`);
                        if (canvas && dice) {
                            const ctx = canvas.getContext('2d');
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            // ä¿®æ­£åº§æ¨™ç‚º 0, 0ï¼Œé¿å…æ­ªæ‰
                            drawDiceFeature(ctx, 0, 0, canvas.width, dice.pattern || dice.id, dice.baseColor);
                            drawDiceStars(ctx, 0, 0, canvas.width, 1, dice.baseColor);
                        }
                    });
                });

                // ç¹ªè£½å€‰åº«å€
                ALL_DICES.forEach(dice => {
                    const canvas = document.getElementById(`inv-canvas-${dice.id}`);
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        // ä¿®æ­£åº§æ¨™ç‚º 0, 0
                        drawDiceFeature(ctx, 0, 0, canvas.width, dice.pattern || dice.id, dice.baseColor);
                        drawDiceStars(ctx, 0, 0, canvas.width, 1, dice.baseColor);
                    }
                });
            }, 0);
        }

        function saveData() {
            localStorage.setItem('dice_game_data', JSON.stringify(userData));
            localStorage.setItem('sicbo_balance', currentBalance);
        }

        function openUpgradeUI(id) {
            tempUpgradeId = id;
            const dice = ALL_DICES.find(d => d.id === id);
            const q = QUALITIES[dice.quality];
            const lv = userData.diceLevels[id] || 1;
            const count = userData.inventory[id] || 0;
            const req = UPGRADE_CONFIG[lv] || [999, 999999999];

            // 1. è¨ˆç®—å±¬æ€§ (ä¿ç•™ä½ åŸæœ¬çš„é‚è¼¯)
            const curAtk = dice.stats.atk + (lv - 1) * dice.grow.atk;
            const nextAtk = dice.stats.atk + lv * dice.grow.atk;
            const curSpd = dice.stats.speed + (lv - 1) * dice.grow.speed;
            const nextSpd = dice.stats.speed + lv * dice.grow.speed;

            let specialHTML = '';
            if (dice.special) {
                const curValue = (dice.special.value + (lv - 1) * dice.special.grow).toFixed(1).replace(/\.0$/, '');
                const nextValue = (dice.special.value + lv * dice.special.grow).toFixed(1).replace(/\.0$/, '');
                specialHTML = `
            <div class="text-xs text-slate-400 mt-2">${dice.special.label}</div>
            <div class="text-lg font-bold text-yellow-400">${curValue}${dice.special.unit} â†’ ${nextValue}${dice.special.unit}</div>
        `;
            }

            // 2. æ›´æ–°åŸºç¤è³‡è¨Š
            document.getElementById('u-name').innerText = dice.name + " éª°å­";
            document.getElementById('u-quality').innerText = `${q.name} å“è³ª`;
            document.getElementById('u-lv-now').innerText = `Lv. ${lv}`;
            document.getElementById('u-atk').innerHTML = `
        <div class="text-xs text-slate-400">åŸºç¤æ”»æ“Š</div>
        <div class="text-lg font-bold text-green-400">${curAtk} â†’ ${nextAtk}</div>
        <div class="text-xs text-slate-400 mt-2">æ”»æ“Šé–“éš” (ms)</div>
        <div class="text-lg font-bold text-blue-400">${curSpd} â†’ ${nextSpd}</div>
        ${specialHTML} 
    `;

            // --- 3. æ–°å¢ï¼šé¡¯ç¤ºå‡ç´šæ‰€éœ€çš„è³‡æºå°æ¯” ---
            const fragText = document.getElementById('u-req-fragments');
            const goldReqText = document.getElementById('u-req-gold');

            // ç¢ç‰‡é¡¯ç¤ºï¼š ç›®å‰æ•¸é‡ / éœ€æ±‚æ•¸é‡
            const hasEnoughFrags = count >= req[0];
            fragText.innerHTML = `<span class="${hasEnoughFrags ? 'text-green-400' : 'text-red-500'}">${count}</span> / ${req[0]}`;

            // é‘½çŸ³é¡¯ç¤ºï¼š ç›´æ¥é¡¯ç¤ºéœ€æ±‚é‡‘é¡ï¼Œä¸å¤ å°±è®Šç´…
            const hasEnoughGold = currentBalance >= req[1];
            goldReqText.innerHTML = `<span class="${hasEnoughGold ? 'text-yellow-400' : 'text-red-500'}">${req[1].toLocaleString()}</span>`;

            // 4. æŒ‰éˆ•ç‹€æ…‹ (ä¿®æ­£åˆ¤æ–·)
            const upgradeBtn = document.getElementById('btn-upgrade');
            const canAfford = hasEnoughFrags && hasEnoughGold;

            upgradeBtn.disabled = !canAfford || lv >= 10;

            if (lv >= 10) {
                upgradeBtn.innerText = 'å·²é”æœ€å¤§ç­‰ç´š';
                upgradeBtn.className = "flex-1 bg-slate-600 py-3 rounded-xl font-bold opacity-50";
            } else {
                upgradeBtn.innerText = canAfford ? 'ç¢ºèªå‡ç´š' : 'è³‡æºä¸è¶³';
                // æ ¹æ“šæ˜¯å¦å¯æ”¯ä»˜åˆ‡æ›æŒ‰éˆ•é¡è‰²
                upgradeBtn.className = `flex-1 py-3 rounded-xl font-bold transition-colors ${canAfford ? 'bg-green-600 hover:bg-green-500' : 'bg-slate-700 text-slate-400'}`;
            }

            document.getElementById('upgradeOverlay').classList.remove('hidden');
        }

        function confirmUpgrade() {
            if (!tempUpgradeId) return;
            const lv = userData.diceLevels[tempUpgradeId] || 1;
            const req = UPGRADE_CONFIG[lv];
            if (!req) return;

            if (userData.inventory[tempUpgradeId] >= req[0] && currentBalance >= req[1]) {
                currentBalance -= req[1];
                userData.inventory[tempUpgradeId] -= req[0];
                userData.diceLevels[tempUpgradeId] = lv + 1;
                saveData();
                render();
                openUpgradeUI(tempUpgradeId);
            }
        }

        function confirmEquip() {
            if (!tempUpgradeId) return;

            // ä¸å†é˜»æ“‹ï¼Œç›´æ¥è®“ç©å®¶é¸æ“‡ä½ç½®ä¾†é€²è¡Œã€Œäº’æ›ã€æˆ–ã€Œè£å‚™ã€
            selectedInventoryId = tempUpgradeId;
            closeUpgradeUI();
            render();

            const status = document.getElementById('deckStatus');
            if (status) {
                status.innerText = "è«‹é¸æ“‡ä¸Šæ–¹ä½ç½®æ›¿æ›æˆ–èª¿æ›ä½ç½®";
                status.classList.add('text-yellow-400');
            }
        }

        function selectDeckSlot(index) {
            // å¦‚æœç›®å‰æ²’æœ‰é¸ä¸­ä¸‹æ–¹çš„éª°å­ï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•å‹•ä½œ
            if (!selectedInventoryId) return;

            // 1. æª¢æŸ¥é€™å€‹éª°å­æ˜¯å¦å·²ç¶“åœ¨éšŠä¼çš„å…¶ä»–ä½ç½®
            const existingIndex = userData.deck.indexOf(selectedInventoryId);

            if (existingIndex !== -1) {
                // --- æ ¸å¿ƒé‚è¼¯ï¼šä½ç½®äº’æ› ---
                // å–å¾—ç›®æ¨™ä½ç½®åŸæœ¬çš„éª°å­
                const diceAtTarget = userData.deck[index];
                // æŠŠç›®æ¨™ä½ç½®åŸæœ¬çš„éª°å­ç§»åˆ°è©²éª°å­åŸæœ¬çš„ä½ç½®
                userData.deck[existingIndex] = diceAtTarget;
                // æŠŠé¸ä¸­çš„éª°å­æ”¾å…¥æ–°ä½ç½®
                userData.deck[index] = selectedInventoryId;
            } else {
                // --- æ ¸å¿ƒé‚è¼¯ï¼šç›´æ¥æ›¿æ› ---
                // éª°å­ä¸åœ¨éšŠä¼ä¸­ï¼Œç›´æ¥è¦†è“‹è©²ä½ç½®
                userData.deck[index] = selectedInventoryId;
            }

            // 2. çµæŸé¸æ“‡æ¨¡å¼
            selectedInventoryId = null;

            // 3. UI ç‹€æ…‹æ¢å¾©
            const status = document.getElementById('deckStatus');
            if (status) {
                status.innerText = "Battle Deck";
                status.classList.remove('text-yellow-400');
            }

            // 4. å„²å­˜ä¸¦åˆ·æ–°ç•«é¢
            saveData();
            render();
        }
        function buySpecialBox(amount) {
            const cost = amount;
            alert("æ•¬è«‹æœŸå¾…");
            return;
            if ((userData.tickets || 0) < cost) {
                alert("æŠ½çåˆ¸ä¸è¶³ï¼");
                return;
            }

            userData.tickets -= cost;

            // é€™è£¡å¯ä»¥å®šç¾©ç‰¹æ®Šæ± çš„è‹±é›„æ¸…å–®
            // å‡è¨­ä½ åªæƒ³åœ¨ç‰¹æ®Šæ± æŠ½ã€Œå¤ªé™½ã€è·Ÿã€Œå†°éœœã€
            const specialPool = ALL_DICES.filter(d => d.type === 'functional' || d.quality === 'mythic');

            // åŸ·è¡ŒæŠ½å¡ (é€™éƒ¨åˆ†å¯ä»¥åƒè€ƒä½ åŸæœ¬çš„ buyBoxï¼Œä½†æ”¹ç”¨ specialPool)
            // doSummon(amount, specialPool);

            saveData();
            render();
        }
        function buyBox(count = 10) {
            const singlePrice = 10000;
            const totalPrice = singlePrice * count;

            if (currentBalance < totalPrice) {
                alert("é‘½çŸ³ä¸è¶³ï¼");
                return;
            }

            currentBalance -= totalPrice;
            let rewardsSummary = {};

            for (let i = 0; i < count; i++) {
                const rand = Math.random();
                let selectedQ = 'common';
                let cum = 0;

                for (const [key, q] of Object.entries(QUALITIES)) {
                    cum += q.chance;
                    if (rand < cum) { selectedQ = key; break; }
                }

                const possibleDices = ALL_DICES.filter(d => d.quality === selectedQ);
                const dice = possibleDices[Math.floor(Math.random() * possibleDices.length)] || ALL_DICES[0];

                userData.inventory[dice.id] = (userData.inventory[dice.id] || 0) + 1;

                if (!rewardsSummary[dice.id]) {
                    rewardsSummary[dice.id] = { info: dice, count: 1 };
                } else {
                    rewardsSummary[dice.id].count++;
                }
            }

            saveData();
            showRewardUI(Object.values(rewardsSummary));
            render();
        }

        function showRewardUI(summarizedRewards) {
            // ä¿®æ­£é»ï¼šå°‡ rewardContainer æ”¹ç‚º rewardList (å°æ‡‰ HTML ä¸­çš„ ID)
            const container = document.getElementById('rewardList');
            if (!container) return; // å¢åŠ å®‰å…¨æ€§æª¢æŸ¥

            container.innerHTML = '';

            summarizedRewards.forEach(item => {
                const dice = item.info;
                const count = item.count;
                const div = document.createElement('div');
                div.className = "relative flex flex-col items-center p-2 bg-slate-800 rounded-xl border border-slate-700";

                const countBadge = count > 1 ?
                    `<div class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full z-10">x${count}</div>` : '';

                div.innerHTML = `
            ${countBadge}
            <div class="w-12 h-12 rounded-lg mb-1 flex items-center justify-center shadow-lg" 
                 style="background: ${dice.baseColor}; border: 2px solid ${QUALITIES[dice.quality].color}">
                 <span class="text-white font-bold text-sm">${dice.name}</span>
            </div>
            <div class="text-[10px]" style="color: ${QUALITIES[dice.quality].color}">${QUALITIES[dice.quality].name}</div>
        `;
                container.appendChild(div);
            });

            document.getElementById('rewardOverlay').classList.remove('hidden');
        }

        function closeReward() { document.getElementById('rewardOverlay').classList.add('hidden'); }
        function closeUpgradeUI() { document.getElementById('upgradeOverlay').classList.add('hidden'); tempUpgradeId = null; }

        function showPage(pageId) {
            // 1. éš±è—æ‰€æœ‰é é¢
            document.getElementById('page-shop').classList.add('hidden');
            document.getElementById('page-battle').classList.add('hidden');
            document.getElementById('page-inventory').classList.add('hidden');

            // 2. é¡¯ç¤ºæŒ‡å®šé é¢
            document.getElementById('page-' + pageId).classList.remove('hidden');

            // 3. æ›´æ–°æŒ‰éˆ•é¡è‰² (é‡ç½®æ‰€æœ‰æŒ‰éˆ•ç‚ºç°è‰²)
            document.getElementById('nav-shop').className = 'flex flex-col items-center gap-1 text-slate-400';
            document.getElementById('nav-battle').className = 'flex flex-col items-center gap-1 text-slate-400';
            document.getElementById('nav-inventory').className = 'flex flex-col items-center gap-1 text-slate-400';

            // 4. é«˜äº®ç•¶å‰æŒ‰éˆ•
            const activeColor = pageId === 'battle' ? 'text-blue-400' :
                (pageId === 'shop' ? 'text-yellow-400' : 'text-green-400');
            document.getElementById('nav-' + pageId).classList.replace('text-slate-400', activeColor);

            // å¦‚æœåˆ‡æ›åˆ°å‚™æˆ°æˆ–æˆ°é¬¥ï¼Œé‡æ–°æ¸²æŸ“é™£å®¹æˆ–æ¸…å–® (ç¢ºä¿æ•¸æ“šæœ€æ–°)
            render();
        }

        function startBattle() {
            saveData();
            window.location.href = 'dice_battle.html';
        }

        window.onload = function () {
            render();
        };
    </script>
</body>

</html>