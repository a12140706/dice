<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éª°å­æˆ°çˆ­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a;
            color: white;
            font-family: sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        .dice-card {
            transition: transform 0.1s;
            position: relative;
            cursor: pointer;
        }

        .dice-card:active {
            transform: scale(0.95);
        }

        .tab-active {
            border-bottom: 4px solid #3b82f6;
            color: #3b82f6;
        }

        .scroll-hide::-webkit-scrollbar {
            display: none;
        }

        .q-mythic {
            background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff);
            background-size: 200% 200%;
            animation: rainbow 3s linear infinite;
        }

        @keyframes rainbow {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* é¸å–ç‹€æ…‹ç‰¹æ•ˆ */
        .selected-dice {
            outline: 4px solid #3b82f6;
            box-shadow: 0 0 15px #3b82f6;
            transform: scale(1.05);
            z-index: 10;
        }

        .deck-slot-highlight {
            animation: pulse 1.5s infinite;
            border-color: #3b82f6 !important;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes popup {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-popup {
            animation: popup 0.3s ease-out forwards;
        }
    </style>
</head>

<body class="p-4 flex flex-col">

    <div class="flex justify-between items-center mb-6 bg-slate-800 p-3 rounded-xl shadow-lg border border-slate-700">
        <div class="flex items-center gap-2">
            <span class="text-yellow-400 font-bold text-lg">ğŸ’</span>
            <span id="goldText" class="font-mono text-xl text-yellow-500 font-bold">0</span>
        </div>
        <div>
            <p>ç‰ˆæœ¬V0.1.3</p>
        </div>
        <a href="index.html" style="text-decoration:none;">
            <button
                style="background:none; border:1px solid #777; color:#ccc; border-radius:5px; padding:5px 12px; font-size:14px; font-weight:bold;">ğŸ 
                å›å¤§å»³</button>
        </a>
    </div>

    <div class="mb-6">
        <h2 class="text-lg font-bold mb-3 flex justify-between items-center px-1">
            <span>é™£å®¹</span>
            <span id="deckStatus"
                class="text-[10px] text-blue-300 bg-blue-900/50 px-2 py-1 rounded-full uppercase">Battle Deck</span>
        </h2>
        <div id="deckContainer"
            class="flex justify-between gap-2 bg-slate-900 p-4 rounded-2xl border-2 border-slate-700">
        </div>
    </div>

    <div class="flex mb-4 border-b border-slate-700">
        <button onclick="switchTab('inventory')" id="tab-inventory"
            class="flex-1 py-2 font-bold tab-active">æˆ‘çš„éª°å­</button>
        <button onclick="switchTab('shop')" id="tab-shop" class="flex-1 py-2 font-bold text-slate-400">å•†åº—æŠ½å¡</button>
    </div>


    <div class="flex-1 overflow-y-auto scroll-hide pb-24">
        <div id="inventorySection" class="grid grid-cols-3 gap-3">
        </div>

        <div id="shopSection" class="hidden">
            <div
                class="bg-gradient-to-b from-slate-800 to-slate-900 p-6 rounded-3xl text-center border-2 border-yellow-600/30">
                <div class="text-6xl mb-2">ğŸ”®</div>
                <h3 class="text-2xl font-bold mb-1">éª°å­å¬å–š</h3>
                <p class="text-slate-400 text-sm mb-6">éš¨æ©Ÿç²å¾—è‹±é›„éª°å­</p>

                <button onclick="buyBox(10)"
                    class="w-full bg-indigo-600 py-4 rounded-2xl font-bold mb-3 active:scale-95 transition-transform">
                    10 é€£æŠ½ (10è¬ ğŸ’)
                </button>

                <button onclick="buyBox(100)"
                    class="w-full bg-gradient-to-r from-purple-600 to-indigo-700 py-4 rounded-2xl font-bold active:scale-95 transition-transform">
                    ğŸ’¯ ç™¾é€£æŠ½ (100è¬ ğŸ’)
                </button>
            </div>
        </div>
    </div>

    <div class="fixed bottom-6 left-0 w-full px-6">
        <button onclick="startBattle()"
            class="w-full bg-blue-600 py-4 rounded-2xl font-bold text-xl shadow-xl active:scale-95 transition-all">é€²å…¥æˆ°é¬¥</button>
    </div>

    <div id="rewardOverlay" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-6">
        <div class="bg-slate-800 w-full max-w-sm rounded-3xl p-6 border border-slate-600 animate-popup">
            <h3 class="text-center text-xl font-bold text-indigo-400 mb-6">å¬å–šçµæœ</h3>
            <div id="rewardList" class="flex flex-wrap justify-center gap-4 mb-8"></div>
            <button onclick="closeReward()" class="w-full bg-slate-700 py-3 rounded-xl font-bold">æ”¶ä¸‹å¡ç‰‡</button>
        </div>
    </div>

    <div id="upgradeOverlay" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-6">
        <div id="upgradeCard"
            class="bg-slate-800 w-full max-w-sm rounded-3xl p-6 border border-slate-600 animate-popup text-center">
            <div id="u-icon"
                class="w-20 h-20 mx-auto rounded-2xl flex items-center justify-center text-2xl font-black mb-4 border-4 shadow-2xl">
            </div>
            <h3 id="u-name" class="text-2xl font-bold mb-1"></h3>
            <p id="u-quality" class="text-xs mb-4 uppercase tracking-widest"></p>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-slate-900 p-3 rounded-2xl border border-slate-700">
                    <div class="text-slate-400 text-[10px]">ç•¶å‰ç­‰ç´š</div>
                    <div id="u-lv-now" class="text-xl font-bold text-white"></div>
                </div>
                <div class="bg-slate-900 p-3 rounded-2xl border border-slate-700">
                    <div class="text-slate-400 text-[10px]">æ”»æ“ŠåŠ›</div>
                    <div id="u-atk" class="text-xl font-bold text-green-400"></div>
                </div>
            </div>

            <div class="flex gap-2 mb-4">
                <button id="btn-equip" onclick="confirmEquip()"
                    class="flex-1 bg-blue-600 py-3 rounded-xl font-bold">è£å‚™å‡ºæˆ°</button>
                <button id="btn-upgrade" onclick="confirmUpgrade()"
                    class="flex-1 bg-green-600 py-3 rounded-xl font-bold disabled:opacity-50 disabled:grayscale">å‡ç´š</button>
            </div>
            <button onclick="closeUpgradeUI()" class="text-slate-500 text-sm">è¿”å›</button>
        </div>
    </div>

    <script>
        // --- 1. åŸºç¤è³‡æ–™å®šç¾© ---
        const QUALITIES = {
            common: { name: 'æ™®é€š', color: '#ffffff', chance: 0.50 },
            rare: { name: 'ç¨€æœ‰', color: '#3b82f6', chance: 0.30 },
            epic: { name: 'å²è©©', color: '#a855f7', chance: 0.18 },
            legend: { name: 'å‚³èªª', color: '#eab308', chance: 0.015 },
            mythic: { name: 'ç¥è©±', color: '#ff00ff', chance: 0.005 }
        };

        const ALL_DICES = [
            // --- Common (æ™®é€š) ---
            {
                id: 'fire', name: 'ç«', quality: 'common', baseColor: '#ef4444',
                stats: { atk: 15, speed: 50 }, grow: { atk: 5, speed: -1 },
                special: { label: 'æ¿ºå°„ç¯„åœ', value: 1.0, unit: 'æ ¼', grow: 0.1 }
            },
            {
                id: 'wind', name: 'é¢¨', quality: 'common', baseColor: '#10b981',
                stats: { atk: 10, speed: 20 }, grow: { atk: 3, speed: -2 },
                special: { label: 'é€£æ“Šæ©Ÿç‡', value: 10, unit: '%', grow: 3 }
            },
            {
                id: 'ice', name: 'å†°', quality: 'common', baseColor: '#3b82f6',
                stats: { atk: 8, speed: 60 }, grow: { atk: 2, speed: -1 },
                special: { label: 'ç·©é€Ÿæ•ˆæœ', value: 15, unit: '%', grow: 5 }
            },
            {
                id: 'electric', name: 'é›»', quality: 'common', baseColor: '#f59e0b',
                stats: { atk: 7, speed: 40 }, grow: { atk: 2, speed: -1 },
                special: { label: 'é€£é–ç›®æ¨™', value: 3, unit: 'é«”', grow: 1 }
            },
            {
                id: 'poison', name: 'æ¯’', quality: 'common', baseColor: '#008000',
                stats: { atk: 6, speed: 45 }, grow: { atk: 2, speed: -1 },
                special: { label: 'ä¸­æ¯’å‚·å®³', value: 5, unit: 'pt', grow: 3 }
            },

            // --- Rare (ç¨€æœ‰) ---
            {
                id: 'lock', name: 'é–å®š', quality: 'rare', baseColor: '#64748b',
                stats: { atk: 10, speed: 55 }, grow: { atk: 4, speed: -1 },
                special: { label: 'ç¦éŒ®æ™‚é•·', value: 0.5, unit: 'ç§’', grow: 0.2 }
            },

            // --- Epic (å²è©©) ---
            {
                id: 'teleport', name: 'å‚³é€', quality: 'epic', baseColor: '#8b5cf6',
                stats: { atk: 5, speed: 65 }, grow: { atk: 2, speed: -1 },
                special: { label: 'å‚³é€å›çµ‚é»', value: 5, unit: '%', grow: 2 }
            },
            {
                id: 'gear', name: 'é½’è¼ª', quality: 'epic', baseColor: '#475569',
                stats: { atk: 12, speed: 50 }, grow: { atk: 6, speed: -1 },
                special: { label: 'é€£çµåŠ æˆ', value: 10, unit: '%', grow: 5 }
            },

            // --- Legend (å‚³èªª) ---
            {
                id: 'joker', name: 'å°ä¸‘', quality: 'legend', baseColor: '#f87171',
                stats: { atk: 5, speed: 50 }, grow: { atk: 1, speed: 0 },
                special: { label: 'ç¹¼æ‰¿æ¯”ä¾‹', value: 80, unit: '%', grow: 2 }
            },
            {
                id: 'growth', name: 'æˆé•·', quality: 'legend', baseColor: '#f472b6',
                stats: { atk: 10, speed: 50 }, grow: { atk: 5, speed: -1 },
                special: { label: 'æˆé•·æ™‚é–“', value: 60, unit: 'ç§’', grow: -2 }
            },
            {
                id: 'sun', name: 'å¤ªé™½', quality: 'legend', baseColor: '#fbbf24',
                stats: { atk: 25, speed: 55 }, grow: { atk: 12, speed: -0.5 },
                special: { label: 'æ¿ºå°„å‚·å®³', value: 100, unit: '%', grow: 20 }
            },

            // --- Mythic (ç¥è©±) ---
            {
                id: 'galaxy', name: 'éŠ€æ²³', quality: 'mythic', baseColor: '#6366f1',
                stats: { atk: 40, speed: 45 }, grow: { atk: 20, speed: -1 },
                special: { label: 'é»‘æ´åå™¬', value: 1, unit: '%', grow: 0.5 }
            }
        ];

        // --- 2. è³‡æ–™è¼‰å…¥ ---
        let currentBalance = parseFloat(localStorage.getItem('sicbo_balance')) || 0;
        let userData = null;

        function initGameData() {
            let raw = localStorage.getItem('dice_game_data');
            let data = null;

            try {
                if (raw) {
                    data = JSON.parse(raw);
                    if (!data || !Array.isArray(data.deck)) throw new Error("Format error");
                }
            } catch (e) {
                console.warn("å­˜æª”æ ¼å¼ä¸ç¬¦ï¼Œæ­£åœ¨ä¿®å¾©...");
                data = null;
            }

            if (!data) {
                data = {
                    deck: ['fire', 'wind', 'ice', 'electric', 'poison'],
                    inventory: { 'fire': 1, 'wind': 1, 'ice': 1, 'electric': 1, 'poison': 1 },
                    diceLevels: { 'fire': 1, 'wind': 1, 'ice': 1, 'electric': 1, 'poison': 1 }
                };
                localStorage.setItem('dice_game_data', JSON.stringify(data));
            }

            ALL_DICES.forEach(d => {
                if (!data.inventory) data.inventory = {};
                if (!data.diceLevels) data.diceLevels = {};
                if (data.inventory[d.id] === undefined) data.inventory[d.id] = 0;
                if (data.diceLevels[d.id] === undefined) data.diceLevels[d.id] = 1;
            });

            return data;
        }

        userData = initGameData();

        let selectedInventoryId = null;
        let tempUpgradeId = null;

        const UPGRADE_CONFIG = {
            1: [5, 50000], 2: [10, 100000], 3: [20, 200000], 4: [50, 500000],
            5: [100, 1000000], 6: [200, 5000000], 7: [500, 10000000], 8: [800, 50000000],
            9: [1000, 100000000], 10: [1200, 500000000]
        };

        // --- 3. æ¸²æŸ“èˆ‡åŠŸèƒ½ ---
        function render() {
            if (!userData) return;

            const goldDisplay = document.getElementById('goldText');
            if (goldDisplay) goldDisplay.innerText = Math.floor(currentBalance).toLocaleString();

            const deckContainer = document.getElementById('deckContainer');
            if (deckContainer) {
                deckContainer.innerHTML = userData.deck.map((id, index) => {
                    const dice = ALL_DICES.find(d => d.id === id);
                    if (!dice) return `<div class="w-14 h-14 bg-slate-800 rounded-lg border-2 border-dashed border-slate-600"></div>`;

                    const q = QUALITIES[dice.quality] || QUALITIES.common;
                    const lv = userData.diceLevels[id] || 1;
                    const isReplacing = selectedInventoryId !== null;

                    return `
                    <div onclick="selectDeckSlot(${index})" 
                        class="w-14 h-14 rounded-lg flex flex-col items-center justify-center font-black shadow-lg border-2 transition-all 
                        ${dice.quality === 'mythic' ? 'q-mythic' : ''} ${isReplacing ? 'deck-slot-highlight' : ''}" 
                        style="background-color: ${dice.baseColor}; color: #fff; border-color: ${q.color}">
                        <div class="text-[10px] leading-none">${dice.name}</div>
                        <div class="text-[8px] mt-1 bg-black/30 px-1 rounded">Lv.${lv}</div>
                    </div>`;
                }).join('');
            }

            const inventorySection = document.getElementById('inventorySection');
            if (inventorySection) {
                inventorySection.innerHTML = ALL_DICES.map(dice => {
                    const count = userData.inventory[dice.id] || 0;
                    const lv = userData.diceLevels[dice.id] || 1;
                    const q = QUALITIES[dice.quality] || QUALITIES.common;
                    const isOwned = count > 0 || userData.deck.includes(dice.id);
                    const isSelected = selectedInventoryId === dice.id;

                    return `
                    <div onclick="${isOwned ? `openUpgradeUI('${dice.id}')` : ''}" 
                        class="bg-slate-800 p-2 rounded-xl text-center border-2 transition-all dice-card 
                        ${isSelected ? 'selected-dice' : (isOwned ? 'border-slate-700' : 'opacity-20 grayscale pointer-events-none')}">
                        <div class="w-12 h-12 mx-auto mb-1 rounded-lg flex items-center justify-center font-bold ${dice.quality === 'mythic' ? 'q-mythic' : ''}" 
                            style="background-color: ${dice.baseColor}; color: #fff; border: 2px solid ${q.color}">${dice.name}</div>
                        <div class="text-[10px]">Lv.${lv}</div>
                        <div class="text-[8px] text-slate-400">${count} ç¢ç‰‡</div>
                    </div>`;
                }).join('');
            }
        }

        function saveData() {
            localStorage.setItem('dice_game_data', JSON.stringify(userData));
            localStorage.setItem('sicbo_balance', currentBalance);
        }

        function openUpgradeUI(id) {
            tempUpgradeId = id;
            const dice = ALL_DICES.find(d => d.id === id);
            const q = QUALITIES[dice.quality];
            const lv = userData.diceLevels[id] || 1;
            const count = userData.inventory[id] || 0;
            const req = UPGRADE_CONFIG[lv] || [999, 999999999];

            const curAtk = dice.stats.atk + (lv - 1) * dice.grow.atk;
            const nextAtk = dice.stats.atk + lv * dice.grow.atk;
            const curSpd = dice.stats.speed + (lv - 1) * dice.grow.speed;
            const nextSpd = dice.stats.speed + lv * dice.grow.speed;

            let specialHTML = '';
            if (dice.special) {
                const curValue = (dice.special.value + (lv - 1) * dice.special.grow).toFixed(1).replace(/\.0$/, '');
                const nextValue = (dice.special.value + lv * dice.special.grow).toFixed(1).replace(/\.0$/, '');

                specialHTML = `
                    <div class="text-xs text-slate-400 mt-2">${dice.special.label}</div>
                    <div class="text-lg font-bold text-yellow-400">${curValue}${dice.special.unit} â†’ ${nextValue}${dice.special.unit}</div>
                `;
            }

            document.getElementById('u-name').innerText = dice.name + " éª°å­";
            document.getElementById('u-quality').innerText = `${q.name} å“è³ª`;
            document.getElementById('u-lv-now').innerText = `Lv. ${lv}`;

            document.getElementById('u-atk').innerHTML = `
                <div class="text-xs text-slate-400">åŸºç¤æ”»æ“Š</div>
                <div class="text-lg font-bold text-green-400">${curAtk} â†’ ${nextAtk}</div>
                <div class="text-xs text-slate-400 mt-2">æ”»æ“Šé–“éš” (ms)</div>
                <div class="text-lg font-bold text-blue-400">${curSpd} â†’ ${nextSpd}</div>
                ${specialHTML} 
            `;

            const upgradeBtn = document.getElementById('btn-upgrade');
            const canAfford = count >= req[0] && currentBalance >= req[1];
            upgradeBtn.disabled = !canAfford || lv >= 10;
            upgradeBtn.innerText = lv >= 10 ? 'å·²æ»¿ç´š' : `å‡ç´š (${req[1].toLocaleString()} ğŸ’°)`;

            document.getElementById('upgradeOverlay').classList.remove('hidden');
        }

        function confirmUpgrade() {
            if (!tempUpgradeId) return;
            const lv = userData.diceLevels[tempUpgradeId] || 1;
            const req = UPGRADE_CONFIG[lv];
            if (!req) return;

            if (userData.inventory[tempUpgradeId] >= req[0] && currentBalance >= req[1]) {
                currentBalance -= req[1];
                userData.inventory[tempUpgradeId] -= req[0];
                userData.diceLevels[tempUpgradeId] = lv + 1;
                saveData();
                render();
                openUpgradeUI(tempUpgradeId);
            }
        }

        function confirmEquip() {
            if (!tempUpgradeId) return;
            selectedInventoryId = tempUpgradeId;
            closeUpgradeUI();
            render();
            const status = document.getElementById('deckStatus');
            status.innerText = "è«‹é¸æ“‡ä¸Šæ–¹ä½ç½®æ›¿æ›";
            status.classList.add('text-yellow-400');
        }

        function selectDeckSlot(index) {
            if (!selectedInventoryId) return;
            userData.deck[index] = selectedInventoryId;
            selectedInventoryId = null;
            const status = document.getElementById('deckStatus');
            status.innerText = "Battle Deck";
            status.classList.remove('text-yellow-400');
            saveData();
            render();
        }

        function buyBox(count = 10) {
            const singlePrice = 10000;
            const totalPrice = singlePrice * count;

            if (currentBalance < totalPrice) {
                alert("é‡‘å¹£ä¸è¶³ï¼");
                return;
            }

            currentBalance -= totalPrice;
            let rewardsSummary = {};

            for (let i = 0; i < count; i++) {
                const rand = Math.random();
                let selectedQ = 'common';
                let cum = 0;

                for (const [key, q] of Object.entries(QUALITIES)) {
                    cum += q.chance;
                    if (rand < cum) { selectedQ = key; break; }
                }

                const possibleDices = ALL_DICES.filter(d => d.quality === selectedQ);
                const dice = possibleDices[Math.floor(Math.random() * possibleDices.length)] || ALL_DICES[0];

                userData.inventory[dice.id] = (userData.inventory[dice.id] || 0) + 1;

                if (!rewardsSummary[dice.id]) {
                    rewardsSummary[dice.id] = { info: dice, count: 1 };
                } else {
                    rewardsSummary[dice.id].count++;
                }
            }

            saveData();
            showRewardUI(Object.values(rewardsSummary));
            render();
        }

        function showRewardUI(summarizedRewards) {
            // ä¿®æ­£é»ï¼šå°‡ rewardContainer æ”¹ç‚º rewardList (å°æ‡‰ HTML ä¸­çš„ ID)
            const container = document.getElementById('rewardList');
            if (!container) return; // å¢åŠ å®‰å…¨æ€§æª¢æŸ¥

            container.innerHTML = '';

            summarizedRewards.forEach(item => {
                const dice = item.info;
                const count = item.count;
                const div = document.createElement('div');
                div.className = "relative flex flex-col items-center p-2 bg-slate-800 rounded-xl border border-slate-700";

                const countBadge = count > 1 ?
                    `<div class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full z-10">x${count}</div>` : '';

                div.innerHTML = `
            ${countBadge}
            <div class="w-12 h-12 rounded-lg mb-1 flex items-center justify-center shadow-lg" 
                 style="background: ${dice.baseColor}; border: 2px solid ${QUALITIES[dice.quality].color}">
                 <span class="text-white font-bold text-sm">${dice.name}</span>
            </div>
            <div class="text-[10px]" style="color: ${QUALITIES[dice.quality].color}">${QUALITIES[dice.quality].name}</div>
        `;
                container.appendChild(div);
            });

            document.getElementById('rewardOverlay').classList.remove('hidden');
        }

        function closeReward() { document.getElementById('rewardOverlay').classList.add('hidden'); }
        function closeUpgradeUI() { document.getElementById('upgradeOverlay').classList.add('hidden'); tempUpgradeId = null; }

        function switchTab(tab) {
            document.getElementById('inventorySection').classList.toggle('hidden', tab !== 'inventory');
            document.getElementById('shopSection').classList.toggle('hidden', tab !== 'shop');
            document.getElementById('tab-inventory').classList.toggle('tab-active', tab === 'inventory');
            document.getElementById('tab-shop').classList.toggle('tab-active', tab === 'shop');
        }

        function startBattle() {
            saveData();
            window.location.href = 'dice_battle.html';
        }

        window.onload = function () {
            render();
        };
    </script>
</body>

</html>