<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éª°å­æˆ°çˆ­</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a;
            color: white;
            font-family: sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        .pb-safe {
            /* env(safe-area-inset-bottom) æ˜¯ iOS å°ˆç”¨è®Šæ•¸ */
            /* æˆ‘å€‘ä¿ç•™åŸæœ¬çš„ py-3 (12px)ï¼Œä¸¦é¡å¤–åŠ ä¸Šå®‰å…¨å€åŸŸçš„é«˜åº¦ */
            padding-bottom: calc(0.75rem + env(safe-area-inset-bottom)) !important;
        }

        /* ç¢ºä¿æ•´å€‹å°èˆªåˆ—é«˜åº¦è‡ªå‹•æ’é–‹ */
        nav {
            min-height: calc(60px + env(safe-area-inset-bottom));
        }

        .dice-card {
            transition: transform 0.1s;
            position: relative;
            cursor: pointer;
        }

        .dice-card:active {
            transform: scale(0.95);
        }

        .tab-active {
            border-bottom: 4px solid #3b82f6;
            color: #3b82f6;
        }

        .scroll-hide::-webkit-scrollbar {
            display: none;
        }

        /* è®“åº•éƒ¨é¸å–®æ›´åƒæ‰‹æ©Ÿ App */
        .fixed.bottom-0 {
            padding-bottom: env(safe-area-inset-bottom, 12px);
            /* é©é… iPhone åº•ç·š */
            backdrop-filter: blur(10px);
            /* æ¯›ç»ç’ƒæ•ˆæœ */
            background: rgba(15, 23, 42, 0.95);
        }

        /* éš±è—æ»¾å‹•æ¢ä½†ä¿æŒæ»¾å‹• */
        .scroll-hide::-webkit-scrollbar {
            display: none;
        }

 

        @keyframes rainbow {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* é¸å–ç‹€æ…‹ç‰¹æ•ˆ */
        .selected-dice {
            outline: 4px solid #3b82f6;
            box-shadow: 0 0 15px #3b82f6;
            transform: scale(1.05);
            z-index: 10;
        }

        .deck-slot-highlight {
            animation: pulse 1.5s infinite;
            border-color: #3b82f6 !important;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes popup {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-popup {
            animation: popup 0.3s ease-out forwards;
        }
    </style>
</head>

<body class="p-4 flex flex-col h-screen">
    <div class="flex justify-between items-center mb-4 bg-slate-800 p-3 rounded-xl shadow-lg border border-slate-700">
        <div class="flex items-center gap-2">
            <span class="text-yellow-400 font-bold text-lg">ğŸ’</span>
            <span id="goldText" class="font-mono text-xl text-yellow-500 font-bold">0</span>
        </div>
        <div class="flex-1 flex justify-end px-3">
            <button onclick="toggleRank()" 
                class="flex items-center gap-1 bg-slate-900 hover:bg-slate-700 text-yellow-400 px-3 py-1.5 rounded-lg text-xs font-bold border border-slate-600 transition-all active:scale-95 shadow-sm">
                <span class="text-sm">ğŸ†</span>
                <span>æ¦œå–®</span>
            </button>
        </div>
        <p class="text-[10px] text-slate-500">V0.4</p>
        <a href="index.html" class="no-underline">
            <button
                class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded-lg text-xs font-bold border border-slate-500 transition-colors">
                ğŸ  å¤§å»³
            </button>
        </a>
    </div>

    <div class="flex-1 overflow-y-auto pb-24" id="main-content">

        <div id="page-shop" class="hidden space-y-6">
            <h2 class="text-xl font-bold px-1 text-white">éª°å­å¬å–š</h2>

            <div
                class="bg-gradient-to-br from-indigo-900 to-slate-900 p-5 rounded-3xl border-2 border-indigo-500/50 shadow-xl relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-7xl opacity-10 rotate-12">â­</div>

                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-black text-indigo-300">ç‰¹é¸æ± </h3>
                        <p class="text-[10px] text-indigo-400 opacity-80 uppercase tracking-tighter">Special Support
                            Summon</p>
                    </div>
                    <div
                        class="bg-indigo-950/80 px-3 py-1 rounded-full border border-indigo-500 flex items-center gap-1">
                        <span class="text-xs">ğŸŸï¸</span>
                        <span id="shopTicketText" class="font-mono text-sm font-bold text-white">0</span>
                    </div>
                </div>

                <div class="text-center py-4">
                    <div class="text-5xl mb-2">ğŸ«</div>
                    <p class="text-slate-300 text-xs mb-4">ç‰¹æ®Šéª°æ± </p>
                </div>

                <button onclick="buySpecialBox(1)"
                    class="w-full bg-indigo-600 hover:bg-indigo-500 py-4 rounded-2xl font-bold active:scale-95 transition-all shadow-[0_4px_0_0_#4338ca]">
                    ğŸŸï¸ æ¶ˆè€— 1 å¼µç¥¨åˆ¸å¬å–š
                </button>
            </div>

            <div
                class="bg-gradient-to-br from-slate-800 to-slate-900 p-5 rounded-3xl border-2 border-slate-700 shadow-xl relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-black text-yellow-500">ä¸€èˆ¬å¬å–š</h3>
                        <p class="text-[10px] text-slate-500 uppercase">Standard Summon</p>
                    </div>
                    <div class="bg-slate-950/80 px-3 py-1 rounded-full border border-slate-700 flex items-center gap-1">
                        <span class="text-xs">ğŸ’</span>
                        <span id="shopGoldText" class="font-mono text-sm font-bold text-yellow-500">0</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="buyBox(10)"
                        class="bg-slate-700 py-4 rounded-2xl font-bold active:scale-95 transition-all flex flex-col items-center">
                        <span class="text-sm">10 é€£æŠ½</span>
                        <span class="text-[10px] text-yellow-500">10è¬ ğŸ’</span>
                    </button>
                    <button onclick="buyBox(100)"
                        class="bg-slate-700 py-4 rounded-2xl font-bold active:scale-95 transition-all flex flex-col items-center border border-yellow-500/30">
                        <span class="text-sm">100 é€£æŠ½</span>
                        <span class="text-[10px] text-yellow-500">100è¬ ğŸ’</span>
                    </button>
                </div>
            </div>

        </div>

        <div id="page-battle" class="space-y-6">
            <div class="bg-slate-900/80 p-4 rounded-2xl border border-slate-700 shadow-inner">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-[10px] text-blue-400 font-bold uppercase tracking-wider">Battle Deck</p>
                    <button onclick="showPage('inventory')"
                        class="text-[10px] text-slate-400 bg-slate-800 px-2 py-1 rounded-md">ä¿®æ”¹</button>
                </div>
                <div id="deckContainer" class="flex justify-between gap-2"></div>
            </div>

            <h2 class="text-xl font-bold px-1 text-white">é¸æ“‡æˆ°é¬¥æ¨¡å¼</h2>

            <div class="grid grid-cols-1 gap-4">
                <button onclick="startBattle()"
                    class="relative overflow-hidden group bg-gradient-to-r from-blue-600 to-blue-800 p-5 rounded-2xl text-left shadow-lg active:scale-95 transition-all">
                    <div class="relative z-10">
                        <h3 class="text-xl font-black mb-1">å†’éšªé—–é—œ</h3>
                        <p class="text-blue-100 text-xs opacity-80">æŒ‘æˆ°é—œå¡</p>
                    </div>
                    <span
                        class="absolute right-4 bottom-2 text-6xl opacity-20 group-hover:scale-110 transition-transform">ğŸ—ºï¸</span>
                </button>

                <button onclick="alert('PVPæ¨¡å¼å³å°‡é–‹æ”¾ï¼')"
                    class="relative overflow-hidden group bg-gradient-to-r from-red-600 to-red-800 p-5 rounded-2xl text-left shadow-lg active:scale-95 transition-all opacity-80">
                    <div class="relative z-10">
                        <h3 class="text-xl font-black mb-1">å°æˆ°</h3>
                        <p class="text-red-100 text-xs opacity-80">å³æ™‚ç«¶æŠ€</p>
                    </div>
                    <span class="absolute right-4 bottom-2 text-6xl opacity-20">âš”ï¸</span>
                    <div
                        class="absolute top-2 right-2 bg-black/50 px-2 py-0.5 rounded text-[10px] font-bold text-white">
                        æœªå®Œæˆ</div>
                </button>

                <button onclick="openCoopModal()"
                    class="relative overflow-hidden group bg-gradient-to-r from-emerald-600 to-emerald-800 p-5 rounded-2xl text-left shadow-lg active:scale-95 transition-all opacity-80">
                    <div class="relative z-10">
                        <h3 class="text-xl font-black mb-1">å…±åŒåˆä½œ</h3>
                        <p class="text-emerald-100 text-xs opacity-80">è¯æ‰‹é˜²å®ˆï¼ŒæŠµç¦¦æ•µè»</p>
                    </div>
                    <span class="absolute right-4 bottom-2 text-6xl opacity-20">ğŸ¤</span>
                    <div
                        class="absolute top-2 right-2 bg-black/50 px-2 py-0.5 rounded text-[10px] font-bold text-white">
                        é–‹å§‹éŠç©!</div>
                </button>
            </div>
        </div>
        <div id="coop-modal"
            class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
            <div class="bg-slate-800 w-full max-w-sm rounded-3xl p-6 border border-emerald-500/30 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-white">åˆä½œæ¨¡å¼</h2>
                    <button onclick="closeCoopModal()" class="text-slate-400 text-2xl">&times;</button>
                </div>

                <div id="coop-initial-actions" class="space-y-4">
                    <button onclick="createCoopRoom()"
                        class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95">
                        å»ºç«‹æ–°æˆ¿é–“
                    </button>

                    <div class="relative py-2">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-slate-600"></div>
                        </div>
                        <div class="relative flex justify-center text-xs uppercase"><span
                                class="bg-slate-800 px-2 text-slate-400">æˆ–è€…åŠ å…¥ä»–äºº</span></div>
                    </div>

                    <div class="flex gap-2">
                        <input type="text" id="room-code-input" maxlength="4" placeholder="è«‹è¼¸å…¥4ä½æˆ¿è™Ÿ"
                            class="flex-1 bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-white text-center font-mono text-xl focus:border-emerald-500 outline-none">
                        <button onclick="joinCoopRoom()"
                            class="bg-slate-100 hover:bg-white text-slate-900 font-bold px-6 rounded-xl transition-all active:scale-95">
                            åŠ å…¥
                        </button>
                    </div>
                </div>

                <div id="coop-waiting-section" class="hidden flex flex-col items-center py-4">
                    <p class="text-slate-400 text-sm mb-1">æˆ¿é–“è™Ÿç¢¼</p>
                    <h1 id="display-room-id" class="text-5xl font-black text-white tracking-widest mb-4">----</h1>

                    <div class="w-full space-y-3 mb-6">
                        <div id="player-p1-row"
                            class="flex items-center justify-between bg-slate-700/50 p-3 rounded-xl border border-slate-600">
                            <div class="flex items-center gap-3">
                                <span
                                    class="bg-emerald-500 text-[10px] font-bold px-2 py-0.5 rounded uppercase">æˆ¿ä¸»</span>
                                <span id="p1-name" class="text-white font-medium">ç­‰å¾…ä¸­...</span>
                            </div>
                            <div id="p1-status" class="text-emerald-400 text-xs">â— å·²å°±ç·’</div>
                        </div>

                        <div id="player-p2-row"
                            class="flex items-center justify-between bg-slate-700/50 p-3 rounded-xl border border-slate-600">
                            <div class="flex items-center gap-3">
                                <span class="bg-blue-500 text-[10px] font-bold px-2 py-0.5 rounded uppercase">éšŠå‹</span>
                                <span id="p2-name" class="text-slate-400 font-medium">ç­‰å¾…åŠ å…¥...</span>
                            </div>
                            <div id="p2-status" class="text-slate-500 text-xs">â—‹ æº–å‚™ä¸­</div>
                        </div>
                    </div>

                    <p id="lobby-status-text" class="text-emerald-400 font-medium animate-pulse mb-6">ç­‰å¾…éšŠå‹åŠ å…¥...</p>

                    <button id="host-start-btn" onclick="hostStartGame()"
                        class="hidden w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95">
                        é–‹å§‹éŠæˆ²
                    </button>
                </div>
            </div>
        </div>

        <div id="page-inventory" class="hidden space-y-6">
            <div
                class="bg-slate-900 p-4 rounded-3xl border-2 border-blue-500/50 shadow-[0_0_15px_rgba(59,130,246,0.2)]">
                <div class="flex justify-between items-center mb-3 px-1">
                    <h3 class="text-sm font-bold text-blue-400 uppercase tracking-widest">å‡ºæˆ°é™£å®¹</h3>
                    <span class="text-[10px] text-slate-500">é»æ“Šä¸‹æ–¹éª°å­å¯æ›´æ›</span>
                </div>
                <div id="inventoryDeckContainer" class="flex justify-between gap-2">
                </div>
            </div>

            <div>
                <h2 class="text-lg font-bold mb-3 flex items-center gap-2 px-1">
                    <span>æˆ‘çš„éª°å­åº«</span>
                    <span id="diceCount" class="text-xs font-normal text-slate-500">(0/0)</span>
                </h2>
                <div id="inventorySection" class="grid grid-cols-3 gap-3 pb-10">
                </div>
            </div>
        </div>
    </div>

    <div
        class="fixed bottom-0 left-0 w-full bg-slate-900 border-t border-slate-700 px-6 py-3 flex justify-between items-center z-40 pb-safe">
        <button onclick="showPage('shop')" id="nav-shop"
            class="flex flex-col items-center gap-1 text-slate-400 transition-colors">
            <span class="text-2xl">ğŸ›’</span>
            <span class="text-[10px] font-bold">å•†åº—</span>
        </button>

        <button onclick="showPage('battle')" id="nav-battle"
            class="flex flex-col items-center gap-1 text-blue-400 transition-colors">
            <span class="text-3xl">âš”ï¸</span>
            <span class="text-[10px] font-bold">æˆ°é¬¥</span>
        </button>

        <button onclick="showPage('inventory')" id="nav-inventory"
            class="flex flex-col items-center gap-1 text-slate-400 transition-colors">
            <span class="text-2xl">ğŸ²</span>
            <span class="text-[10px] font-bold">å‚™æˆ°</span>
        </button>
    </div>
<div id="rankSidebar" class="fixed right-0 top-0 h-full w-80 bg-slate-900 border-l border-slate-700 transform translate-x-full transition-transform duration-300 z-50 flex flex-col shadow-2xl">
        <div class="p-4 border-b border-slate-700 bg-slate-800 flex justify-between items-center">
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                <span class="text-yellow-400">ğŸ†</span> æ¦®è­½æ®¿å ‚
            </h2>
            <button onclick="toggleRank()" class="text-slate-400 hover:text-white p-2">âœ•</button>
        </div>

        <div class="flex border-b border-slate-700 bg-slate-800/50">
            <button onclick="switchRankTab('adventure')" id="tab-adventure" 
                class="flex-1 py-3 text-sm font-bold text-yellow-400 border-b-2 border-yellow-400 bg-slate-800 transition-colors">
                âš”ï¸ é—œå¡æ¦œ
            </button>
            <button onclick="switchRankTab('coop')" id="tab-coop" 
                class="flex-1 py-3 text-sm font-bold text-slate-400 border-b-2 border-transparent hover:text-white transition-colors">
                ğŸ¤ åˆä½œæ¦œ
            </button>
            <button onclick="switchRankTab('pvp')" id="tab-pvp" 
                class="flex-1 py-3 text-sm font-bold text-slate-400 border-b-2 border-transparent hover:text-white transition-colors">
                âš”ï¸ PVPæ¦œ
            </button>
        </div>

        <div id="rankList" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
            <p class="text-center text-slate-500 mt-10">è¼‰å…¥ä¸­...</p>
        </div>
    </div>
    <div id="rewardOverlay" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-6">
        <div class="bg-slate-800 w-full max-w-sm rounded-3xl p-6 border border-slate-600 animate-popup">
            <h3 class="text-center text-xl font-bold text-indigo-400 mb-6">å¬å–šçµæœ</h3>
            <div id="rewardList" class="flex flex-wrap justify-center gap-4 mb-8"></div>
            <button onclick="closeReward()" class="w-full bg-slate-700 py-3 rounded-xl font-bold">æ”¶ä¸‹å¡ç‰‡</button>
        </div>
    </div>

    <div id="upgradeOverlay" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-6">
        <div id="upgradeCard"
            class="bg-slate-800 w-full max-w-sm rounded-3xl p-6 border border-slate-600 animate-popup text-center">
            <div id="u-icon"
                class="w-20 h-20 mx-auto rounded-2xl flex items-center justify-center text-2xl font-black mb-4 border-4 shadow-2xl">
                <canvas id="u-canvas" width="80" height="80"></canvas>
            </div>
            <h3 id="u-name" class="text-2xl font-bold mb-1"></h3>
            <p id="u-quality" class="text-xs mb-4 uppercase tracking-widest"></p>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-slate-900 p-3 rounded-2xl border border-slate-700">
                    <div class="text-slate-400 text-[10px]">ç•¶å‰ç­‰ç´š</div>
                    <div id="u-lv-now" class="text-xl font-bold text-white"></div>
                </div>
                <div class="bg-slate-900 p-3 rounded-2xl border border-slate-700">
                    <div class="text-slate-400 text-[10px]">æ”»æ“ŠåŠ›</div>
                    <div id="u-atk" class="text-xl font-bold text-green-400"></div>
                </div>
            </div>
            <div class="bg-slate-900/50 p-4 rounded-2xl border border-slate-700 mb-6">
                <div class="flex justify-around items-center">
                    <div class="text-center">
                        <div class="text-[10px] text-slate-500 mb-1 uppercase">æ‰€éœ€ç¢ç‰‡</div>
                        <div id="u-req-fragments" class="font-bold text-sm"></div>
                    </div>
                    <div class="h-8 w-[1px] bg-slate-700"></div>
                    <div class="text-center">
                        <div class="text-[10px] text-slate-500 mb-1 uppercase">æ‰€éœ€é‘½çŸ³</div>
                        <div id="u-req-gold" class="font-bold text-sm text-yellow-500"></div>
                    </div>
                </div>
            </div>

            <div class="flex gap-2 mb-4">
                <button id="btn-equip" onclick="confirmEquip()"
                    class="flex-1 bg-blue-600 py-3 rounded-xl font-bold">è£å‚™å‡ºæˆ°</button>
                <button id="btn-upgrade" onclick="confirmUpgrade()"
                    class="flex-1 bg-green-600 py-3 rounded-xl font-bold disabled:opacity-50 disabled:grayscale">å‡ç´š</button>
            </div>
            <button onclick="closeUpgradeUI()" class="text-slate-500 text-sm">è¿”å›</button>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>
    <script>
        const _k = ["AIzaSyDSRfVA", "uWCWCUd1NJop", "J6wHvsqsAM4UzJA"];

        const firebaseConfig = {
            apiKey: _k.join(''),
            authDomain: "game-80d68.firebaseapp.com",
            projectId: "game-80d68",
            databaseURL: "https://game-80d68-default-rtdb.asia-southeast1.firebasedatabase.app/",
            messagingSenderId: "636332967920",
            appId: "1:636332967920:web:29e5600daf4db0ab613f35",
            measurementId: "G-MJZ4PGEHSQ"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database(); // ä½¿ç”¨ Realtime Database
        const fs = firebase.firestore(); // ä¾ç„¶å¯ä»¥ç”¨ä¾†å­˜ç©å®¶çš„ç­‰ç´šã€éª°å­ç­‰é•·æœŸè³‡æ–™
 const SHOP_DATA = {
      title: [
        { id: 't_new', name: 'ğŸŒ±åˆå‡ºèŒ…å»¬', price: 50000 },
        { id: 't_hunter', name: 'ğŸ¹è³­å ´çµäºº', price: 200000 },
        { id: 't_rich', name: 'ğŸ’°åœŸè±ª', price: 1000000 },
        { id: 't_lady', name: 'ğŸ‘—åƒé‡‘å¤§å°å§', price: 5000000 },
        { id: 't_lucky', name: 'ğŸŒŸå¹¸é‹æ˜Ÿ', price: 100000000 },
        { id: 't_sir', name: 'ğŸ©è±ªé–€å¤§å°‘çˆº', price: 5000000 },
        { id: 't_king', name: 'ğŸ‘‘æ¢Ÿé›„', price: 10000000 },
        { id: 't_shit', name: 'ğŸ’©ç‹—å±é‹', price: 30000000 },
        { id: 't_legend', name: 'ğŸ‰è³­åŸå‚³å¥‡', price: 50000000 },
        { id: 't_red', name: 'ğŸ§§é´»é‹ç•¶é ­', price: 50000000 },
        { id: 't_sleep', name: 'ğŸ’¤ èººå¹³å¤§å¸«', price: 100000000 },
        { id: 't_god', name: 'âš–ï¸å¯Œå¯æ•µåœ‹', price: 100000000 },
        { id: 't_beauty', name: 'ğŸ§šå¯æ„›ç¾éº—å°ä»™å¥³', price: 200000000 },
        { id: 't_sky', name: 'ğŸ€å¤©é¸ä¹‹äºº', price: 500000000 },
        { id: 't_world', name: 'ğŸªè³­ç¥', price: 500000000 },
        { id: 't_ultimate', name: 'ğ’‚è‡³å°Š', price: 500000000,},
        { id: 't_koi', name: 'ğŸŒŒå¹¸é‹éŒ¦é¯‰', price: 0, lottoOnly: true }
      ],
      effect: [
        { id: 'e_thunder', name: 'âš¡ é›»é–ƒé›·é³´', price: 20000000, class: 'fx-thunder' },
        { id: 'e_void', name: 'ğŸŒ€ æ¹®æ»…é»‘æ´', price: 50000000, class: 'fx-void' },
        { id: 'e_gold', name: 'âœ¨ é»ƒé‡‘å‘¼å¸', price: 80000000, class: 'fx-gold' },
        { id: 'e_lightning', name: 'âš¡ æš—å½±é›·é›»', price: 100000000, class: 'fx-lightning' },
        { id: 'e_fire', name: 'ğŸ”¥ åœ°ç„ç«', price: 200000000, class: 'fx-fire' },
        { id: 'e_ice', name: 'â„ï¸ çµ•å°é›¶åº¦', price: 200000000, class: 'fx-ice' },
        { id: 'e_neon', name: 'ğŸŒˆ å½©è™¹æ¥µå…‰', price: 500000000, class: 'fx-neon' },
        { id: 'e_hacker', name: 'ğŸ’» é§­å®¢ä»»å‹™', price: 500000000, class: 'fx-hacker' },
        { id: 'e_nebula', name: 'ğŸŒŒ å»£é—Šæ˜Ÿé›²', price: 500000000, class: 'fx-nebula' },
        { id: 'e_timelord', name: 'â³ æ™‚å…‰é ˜åŸŸ', price: 500000000, class: 'fx-timelord' },
        { id: 'e_god_king', name: 'ğŸ”± çœ¾ç¥ä¹‹å·”', price: 1000000000, class: 'fx-god-king' },
        { id: 'e_ultimate', name: 'ğ’‚ å‚³å¥‡è‡³å°Š', price: 1000000000, class: 'fx-ultimate-legend' },
        { id: 'e_koi', name: 'ğŸŒŠ éŒ¦é¯‰èºé·', price: 0, class: 'fx-cosmic-koi', lottoOnly: true }
      ]
    };
        // --- 1. åŸºç¤è³‡æ–™å®šç¾© ---
        const QUALITIES = {
            common: { name: 'æ™®é€š', color: '#9ca3af', chance: 0.50 },
            rare: { name: 'ç¨€æœ‰', color: '#3b82f6', chance: 0.30 },
            epic: { name: 'å²è©©', color: '#a855f7', chance: 0.18 },
            legend: { name: 'å‚³èªª', color: '#eab308', chance: 0.019 },
            mythic: { name: 'ç¥è©±', color: '#ff00ff', chance: 0.001 }
        };

        const ALL_DICES = [
            // --- Common (æ™®é€š) ---
            {
                id: 'fire', name: 'ç«', quality: 'common', baseColor: '#ef4444', pattern: 'fire',
                stats: { atk: 18, speed: 55 }, grow: { atk: 6, speed: -1 },
                special: { label: 'æ¿ºå°„ç¯„åœ', value: 1.0, unit: 'æ ¼', grow: 0.1 }
            },
            {
                id: 'wind', name: 'é¢¨', quality: 'common', baseColor: '#10b981', pattern: 'wind',
                stats: { atk: 8, speed: 35 }, grow: { atk: 2, speed: -1.5 }, // å‰Šå¼±åŸºç¤ï¼Œè®“å‡ºå‰æœŸéœ¸ä¸»ä½ç½®
                special: { label: 'é€£æ“Šæ©Ÿç‡', value: 10, unit: '%', grow: 3 }
            },
            {
                id: 'ice', name: 'å†°', quality: 'common', baseColor: '#3b82f6', pattern: 'ice',
                stats: { atk: 5, speed: 60 }, grow: { atk: 1, speed: -1 },
                special: { label: 'ç·©é€Ÿæ•ˆæœ', value: 20, unit: '%', grow: 2 }
            },
            {
                id: 'electric', name: 'é›»', quality: 'common', baseColor: '#f59e0b', pattern: 'electric',
                stats: { atk: 6, speed: 45 }, grow: { atk: 2, speed: -1 },
                special: { label: 'é€£é–ç›®æ¨™', value: 3, unit: 'é«”', grow: 1 }
            },
            {
                id: 'poison', name: 'æ¯’', quality: 'common', baseColor: '#008000', pattern: 'poison',
                stats: { atk: 4, speed: 50 }, grow: { atk: 2, speed: -1 },
                special: { label: 'ä¸­æ¯’å‚·å®³', value: 8, unit: 'pt', grow: 4 }
            },

            // --- Rare (ç¨€æœ‰) ---
            {
                id: 'lock', name: 'é–å®š', quality: 'rare', baseColor: '#64748b', pattern: 'lock',
                stats: { atk: 12, speed: 55 }, grow: { atk: 4, speed: -1 },
                special: { label: 'ç¦éŒ®æ™‚é•·', value: 0.8, unit: 'ç§’', grow: 0.2 }
            },
            // --- æ˜“å‚·éª°å­ (æ›¿ä»£åŸæœ¬çš„ç ´ç”²) ---
            {
                id: 'crack', name: 'æ˜“å‚·', quality: 'rare', baseColor: '#f87171', pattern: 'crack',
                stats: { atk: 12, speed: 50 }, grow: { atk: 3, speed: -1 },
                special: { label: 'é¡å¤–å—å‚·', value: 5, unit: '%', grow: 1 }
            },
            // --- ç¤¦å±±éª°å­ (ç¶“æ¿Ÿå‹) ---
            {
                id: 'mine', name: 'ç¤¦å±±', quality: 'rare', baseColor: '#fbbf24', pattern: 'mine',
                stats: { atk: 0, speed: 40 }, grow: { atk: 0, speed: -5 }, // ä¸æ”»æ“Šï¼Œé€Ÿåº¦ä»£è¡¨ç”¢éŒ¢é–“éš”
                special: { label: 'ç”¢å‡ºSP', value: 10, unit: 'pt', grow: 5 }
            },

            // --- Epic (å²è©©) ---
            {
                id: 'laser', name: 'é›·å°„', quality: 'epic', baseColor: '#ec4899', pattern: 'laser_beam',
                stats: { atk: 5, speed: 40 }, grow: { atk: 2, speed: 0 },
                special: { label: 'å¢å¹…ä¸Šé™', value: 5, unit: 'å€', grow: 1 }
                // åŠŸèƒ½ï¼šæŒçºŒæ”»æ“ŠåŒä¸€å€‹ç›®æ¨™æ™‚ï¼Œå‚·å®³æœƒéš¨æ”»æ“Šæ¬¡æ•¸ä¸æ–·çˆ¬å‡
            },
            {
                id: 'teleport', name: 'å‚³é€', quality: 'epic', baseColor: '#8b5cf6', pattern: 'teleport',
                stats: { atk: 10, speed: 65 }, grow: { atk: 3, speed: -1 },
                special: { label: 'å‚³é€å›èµ·é»', value: 5, unit: '%', grow: 2 }
            },
            {
                id: 'gear', name: 'é½’è¼ª', quality: 'epic', baseColor: '#475569', pattern: 'gear',
                stats: { atk: 15, speed: 50 }, grow: { atk: 8, speed: -1 },
                special: { label: 'é€£çµåŠ æˆ', value: 12, unit: '%', grow: 6 }
            },

            // --- Legend (å‚³èªª) ---
            {
                id: 'mighty_wind', name: 'å¼·é¢¨', quality: 'legend', baseColor: '#a5f3fc', pattern: 'mighty_wind',
                stats: { atk: 15, speed: 40 }, grow: { atk: 6, speed: -1 },
                special: { label: 'ç‹‚æš´æ™‚é•·', value: 2, unit: 'ç§’', grow: 0.5 }
            },
            {
                id: 'joker', name: 'å°ä¸‘', quality: 'legend', baseColor: '#f87171', pattern: 'joker',
                stats: { atk: 5, speed: 50 }, grow: { atk: 1, speed: 0 },
                special: { label: 'ç¹¼æ‰¿æ¯”ä¾‹', value: 80, unit: '%', grow: 2 } // ä¾ç…§ä½ çš„æ¸¬è©¦ä¿ç•™ 80%
            },
            {
                id: 'growth', name: 'æˆé•·', quality: 'legend', baseColor: '#f472b6', pattern: 'growth',
                stats: { atk: 5, speed: 50 }, grow: { atk: 1, speed: -1 },
                special: { label: 'æˆé•·æ™‚é–“', value: 40, unit: 'ç§’', grow: -2 } // å› æ‡‰ç¯€å¥èª¿å¿«ï¼Œç¸®çŸ­è‡³ 40 ç§’
            },
            {
                id: 'sun', name: 'å¤ªé™½', quality: 'legend', baseColor: '#fbbf24', pattern: 'sun',
                stats: { atk: 35, speed: 55 }, grow: { atk: 15, speed: -0.5 },
                special: { label: 'æ¿ºå°„å‚·å®³', value: 100, unit: '%', grow: 25 }
            },
            {
                id: 'sanctuary', name: 'è–åŸŸ', quality: 'legend', baseColor: '#fbbf24', pattern: 'sanctuary',
                stats: { atk: 15, speed: 60 }, grow: { atk: 6, speed: -1 },
                special: { label: 'åŠ é€Ÿç¯„åœ', value: 30, unit: '%', grow: 5 }
            },
            {
                id: 'comet', name: 'å½—æ˜Ÿ', quality: 'legend', baseColor: '#3b82f6', pattern: 'comet',
                stats: { atk: 18, speed: 45 }, grow: { atk: 7, speed: -1 },
                special: { label: 'å……èƒ½å€ç‡', value: 500, unit: '%', grow: 100 }
            },

            // --- Epic (å²è©©) æ–°å¢ ---
            {
                id: 'chain', name: 'é€£é–', quality: 'epic', baseColor: '#8b5cf6', pattern: 'chain',
                stats: { atk: 15, speed: 50 }, grow: { atk: 5, speed: -1 },
                special: { label: 'å½ˆå°„å¢å‚·', value: 50, unit: '%', grow: 10 }
            },

            // --- Mythic (ç¥è©±) ---
            {
                id: 'doom', name: 'æ¯€æ»…', quality: 'mythic', baseColor: '#7c3aed', pattern: 'doom',
                stats: { atk: 45, speed: 50 }, grow: { atk: 20, speed: -1 },
                special: { label: 'æ–¬æ®ºæ¯”ä¾‹', value: 35, unit: '%', grow: 5 }
            },
            {
                id: 'galaxy', name: 'éŠ€æ²³', quality: 'mythic', baseColor: '#6366f1', pattern: 'galaxy',
                stats: { atk: 60, speed: 50 }, grow: { atk: 30, speed: -1 },
                special: { label: 'é»‘æ´åå™¬', value: 2, unit: '%', grow: 1 }
            }
        ];

        // --- 2. è³‡æ–™è¼‰å…¥ ---
        const userId = localStorage.getItem('player_id') || 'guest';
        let currentBalance = parseFloat(localStorage.getItem('sicbo_balance')) || 0;
        let userData = null;
        // å½ˆçª—æ§åˆ¶
        function openCoopModal() {
            document.getElementById('coop-modal').classList.remove('hidden');
        }

        function closeCoopModal() {
            document.getElementById('coop-modal').classList.add('hidden');
        }

        // --- Firebase åˆä½œé‚è¼¯ ---

        // --- æˆ¿é–“ç®¡ç†è®Šæ•¸ ---
        let currentRoomId = null;
        let isHost = false;

        // 1. å»ºç«‹æˆ¿é–“
        async function createCoopRoom() {
            // å–å¾—æœ€æ–°åç¨± (å°æ¥ index.html çš„ player_name)
            const playerName = localStorage.getItem('player_name') || 'æˆ¿ä¸»';

            // é€²å…¥åˆä½œæ¨¡å¼å‰ï¼Œå…ˆç¢ºä¿ç•¶å‰éª°å­ç­‰ç´šèˆ‡è³‡æ–™éƒ½ä¸Šå‚³äº†
            await saveData();

            const roomId = Math.floor(1000 + Math.random() * 9000).toString();
            currentRoomId = roomId;
            isHost = true;

            const roomData = {
                roomId: roomId,
                status: 'waiting',
                gameStarted: false,
                host: userId, // ç›´æ¥ä½¿ç”¨æˆ‘å€‘åœ¨é ‚å±¤å®šç¾©çš„ userId (u1766...)
                hostName: playerName,
                createdAt: Date.now(),
                wave: 1,
                hp: 3,
                players: {
                    p1: {
                        uid: userId,
                        name: playerName,
                        sp: 100,
                        isReady: true
                    }
                }
            };

            try {
                await firebase.database().ref('coop_rooms/' + roomId).set(roomData);
                showLobbyUI(roomId, "ç­‰å¾…éšŠå‹åŠ å…¥...");
                listenForRoomUpdates(roomId);
            } catch (error) {
                console.error("å»ºç«‹å¤±æ•—", error);
                alert("å»ºç«‹æˆ¿é–“å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
            }
        }

        // 2. åŠ å…¥æˆ¿é–“
        async function joinCoopRoom() {
            const roomId = document.getElementById('room-code-input').value;
            if (roomId.length !== 4) return;

            // å–å¾—æœ€æ–°åç¨±
            const playerName = localStorage.getItem('player_name') || 'æŒ‘æˆ°è€…';

            // é—œéµï¼šåŠ å…¥å‰å…ˆåŒæ­¥è‡ªå·±çš„ dice_dataï¼Œé€™æ¨£éšŠå‹æ‰çœ‹å¾—åˆ°ä½ çš„çœŸå¯¦ç­‰ç´š
            await saveData();

            const roomRef = firebase.database().ref('coop_rooms/' + roomId);
            const snapshot = await roomRef.once('value');
            const room = snapshot.val();

            if (!room || room.status !== 'waiting') {
                alert("æˆ¿é–“ä¸å­˜åœ¨æˆ–å·²æ»¿ï¼");
                document.getElementById('room-code-input').classList.add('border-red-500');
                return;
            }

            currentRoomId = roomId;
            isHost = false;

            // å¯«å…¥ P2 è³‡è¨Š
            await roomRef.child('players/p2').set({
                uid: userId, // ä½¿ç”¨å°æ¥å¾Œçš„ userId
                name: playerName,
                sp: 100,
                isReady: true
            });

            await roomRef.update({ status: 'ready' });

            showLobbyUI(roomId, "ç­‰å¾…æˆ¿ä¸»é–‹å§‹...");
            listenForRoomUpdates(roomId);
        }

        // 3. UI åˆ‡æ›è¼”åŠ©
        function showLobbyUI(roomId, statusMsg) {
            // 1. åˆ‡æ›é¡¯ç¤ºå€åŸŸ
            document.getElementById('coop-initial-actions').classList.add('hidden');
            document.getElementById('coop-waiting-section').classList.remove('hidden');

            // 2. é¡¯ç¤ºæˆ¿è™Ÿèˆ‡ç•¶å‰ç‹€æ…‹
            document.getElementById('display-room-id').innerText = roomId;
            document.getElementById('lobby-status-text').innerText = statusMsg;

            // 3. åˆå§‹åç¨±é‡ç½® (é¿å…æ®˜ç•™ä¸Šæ¬¡çš„è³‡æ–™)
            const myName = localStorage.getItem('player_name') || (isHost ? "æˆ¿ä¸»" : "éšŠå‹");

            if (isHost) {
                document.getElementById('p1-name').innerText = myName;
                document.getElementById('p2-name').innerText = "ç­‰å¾…åŠ å…¥...";
            } else {
                // å¦‚æœæ˜¯åŠ å…¥è€…ï¼Œè‡ªå·±çš„åå­—æœƒåœ¨ P2 (é€™éƒ¨åˆ†æœƒç”± listenForRoomUpdates éš¨å¾Œå¾ Firebase åŒæ­¥)
                document.getElementById('p2-name').innerText = myName;
            }
        }

        // 4. ç›£è½æˆ¿é–“ç‹€æ…‹
        function listenForRoomUpdates(roomId) {
            const roomRef = firebase.database().ref('coop_rooms/' + roomId);

            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                // --- æ›´æ–°ç©å®¶ 1 (æˆ¿ä¸») è³‡è¨Š ---
                if (room.players && room.players.p1) {
                    document.getElementById('p1-name').innerText = room.players.p1.name || "æˆ¿ä¸»";
                    document.getElementById('p1-name').classList.replace('text-slate-400', 'text-white');
                    document.getElementById('p1-status').innerText = "â— å·²å°±ç·’";
                    document.getElementById('p1-status').className = "text-emerald-400 text-xs";
                }

                // --- æ›´æ–°ç©å®¶ 2 (åŠ å…¥è€…) è³‡è¨Š ---
                if (room.players && room.players.p2) {
                    // P2 åœ¨ä½
                    document.getElementById('p2-name').innerText = room.players.p2.name || "éšŠå‹";
                    document.getElementById('p2-name').classList.replace('text-slate-400', 'text-white');
                    document.getElementById('p2-status').innerText = "â— å·²å°±ç·’";
                    document.getElementById('p2-status').className = "text-emerald-400 text-xs";

                    // å¦‚æœæˆ‘æ˜¯æˆ¿ä¸»ï¼Œé¡¯ç¤ºé–‹å§‹æŒ‰éˆ•
                    if (isHost) {
                        document.getElementById('lobby-status-text').innerText = "éšŠå‹å·²å°±ç·’ï¼";
                        document.getElementById('host-start-btn').classList.remove('hidden');
                    } else {
                        document.getElementById('lobby-status-text').innerText = "ç­‰å¾…æˆ¿ä¸»é–‹å§‹...";
                    }
                } else {
                    // P2 å°šæœªåŠ å…¥
                    document.getElementById('p2-name').innerText = "ç­‰å¾…åŠ å…¥...";
                    document.getElementById('p2-name').classList.replace('text-white', 'text-slate-400');
                    document.getElementById('p2-status').innerText = "â—‹ æº–å‚™ä¸­";
                    document.getElementById('p2-status').className = "text-slate-500 text-xs";

                    if (isHost) {
                        document.getElementById('host-start-btn').classList.add('hidden');
                    }
                }

                // --- æ ¸å¿ƒï¼šéŠæˆ²å•Ÿå‹•é‚è¼¯ ---
                if (room.gameStarted === true) {
                    roomRef.off(); // åœæ­¢ç›£è½ï¼Œé¿å…é‡è¤‡åŸ·è¡Œ
                    enterCoopBattle(roomId);
                }
            });
        }

        // 5. æˆ¿ä¸»æŒ‰ä¸‹é–‹å§‹
        function hostStartGame() {
            if (!currentRoomId) return;
            firebase.database().ref('coop_rooms/' + currentRoomId).update({
                gameStarted: true,
                status: 'playing'
            });
        }

        // é€²å…¥æˆ°é¬¥ç•«é¢
        // é€²å…¥æˆ°é¬¥é é¢ (è·³è½‰åˆ° dice_cooper.html)
        function enterCoopBattle(roomId) {
            // åœæ­¢ç›£è½ï¼Œé¿å…è·³è½‰æ™‚é‡è¤‡è§¸ç™¼
            firebase.database().ref('coop_rooms/' + roomId).off();

            // å¸¶ä¸Šåƒæ•¸ï¼šroomId (æˆ¿è™Ÿ) å’Œ role (è§’è‰²ï¼šhost æˆ– guest)
            const role = isHost ? 'host' : 'guest';
            const targetUrl = `dice_cooper.html?roomId=${roomId}&role=${role}`;

            console.log("æ­£åœ¨è·³è½‰è‡³åˆä½œæ¨¡å¼...", targetUrl);

            // åŸ·è¡Œè·³è½‰
            window.location.href = targetUrl;
        }
        function initGameData() {
            let raw = localStorage.getItem('dice_game_data');
            let data = null;

            try {
                if (raw) {
                    data = JSON.parse(raw);
                    if (!data || !Array.isArray(data.deck)) throw new Error("Format error");
                }
            } catch (e) {
                console.warn("å­˜æª”æ ¼å¼ä¸ç¬¦ï¼Œæ­£åœ¨ä¿®å¾©...");
                data = null;
            }

            if (!data) {
                data = {
                    deck: ['fire', 'wind', 'ice', 'electric', 'poison'],
                    inventory: { 'fire': 1, 'wind': 1, 'ice': 1, 'electric': 1, 'poison': 1 },
                    diceLevels: { 'fire': 1, 'wind': 1, 'ice': 1, 'electric': 1, 'poison': 1 },
                    tickets: 0,
                    unlockLevel: 1,
                    maxWave: 0
                };
                localStorage.setItem('dice_game_data', JSON.stringify(data));
            }

            // --- é—œéµè£œå¼·å€ï¼šç¢ºä¿èˆŠå­˜æª”ä¹Ÿèƒ½ç²å¾—æ–°å±¬æ€§ ---
            if (data.unlockLevel === undefined || isNaN(data.unlockLevel)) data.unlockLevel = 1;
            if (data.maxWave === undefined || isNaN(data.maxWave)) data.maxWave = 0;
            if (data.tickets === undefined) data.tickets = 0;
            if (!data.inventory) data.inventory = {};

            ALL_DICES.forEach(d => {
                if (!data.diceLevels) data.diceLevels = {};
                if (data.inventory[d.id] === undefined) data.inventory[d.id] = 0;
                if (data.diceLevels[d.id] === undefined) data.diceLevels[d.id] = 1;
            });

            return data;
        }

        userData = initGameData();

        let selectedInventoryId = null;
        let tempUpgradeId = null;

        async function syncFromCloud() {
            if (userId === 'guest') return;

            try {
                const doc = await fs.collection('users').doc(userId).get();
                if (doc.exists) {
                    const data = doc.data();

                    // åŒæ­¥é¤˜é¡ (é ‚å±¤æ¬„ä½)
                    if (data.balance !== undefined) {
                        currentBalance = Number(data.balance);
                    }

                    // åŒæ­¥éª°å­æ•¸æ“š (dice_data æ¬„ä½)
                    if (data.dice_data) {
                        const cloud = data.dice_data;
                        userData.deck = cloud.deck || userData.deck;
                        userData.inventory = cloud.inventory || {};
                        userData.diceLevels = cloud.diceLevels || {};
                        userData.tickets = cloud.tickets || 0;
                        userData.unlockLevel = cloud.unlockLevel || 1;
                        userData.maxWave = cloud.maxWave || 0;

                        // å­˜å›æœ¬åœ°ä¸¦åˆ·æ–°
                        localStorage.setItem('dice_game_data', JSON.stringify(userData));
                        localStorage.setItem('sicbo_balance', currentBalance);
                        render();
                        console.log("â˜ï¸ é›²ç«¯æ•¸æ“šå·²è¼‰å…¥");
                    }
                }
            } catch (error) {
                console.error("âŒ å¾é›²ç«¯æŠ“å–å¤±æ•—:", error);
            }
        }
        const UPGRADE_CONFIG = {
            1: [5, 50000], 2: [10, 100000], 3: [20, 200000], 4: [50, 500000],
            5: [100, 1000000], 6: [200, 5000000], 7: [500, 10000000], 8: [800, 50000000],
            9: [1000, 100000000], 10: [1200, 500000000]
        };
        function drawDiceStars(ctx, x, y, size, stars, diceColor) {
            ctx.save();
            // é—œéµï¼šå…ˆé‡ç½®çŸ©é™£ï¼Œç¢ºä¿åº§æ¨™ç³»çµ±æ˜¯ä¹¾æ·¨çš„ 1:1
            ctx.setTransform(1, 0, 0, 1, 0, 0);

            // ç§»å‹•åˆ°æŒ‡å®šä½ç½® (x, y)
            ctx.translate(x, y);

            if (stars >= 7) {
                ctx.fillStyle = "#fbbf24";
                ctx.font = `bold ${size * 0.7}px Arial`;
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("â˜…", size / 2, size / 2 + size * 0.05);
                ctx.restore();
                return;
            }

            // ç¢ºä¿æ˜Ÿæ˜Ÿé¡è‰²åœ¨ç™½è‰²èƒŒæ™¯ä¸Šæ¸…æ™°å¯è¦‹
            // å¦‚æœæ²’æœ‰å‚³å…¥é¡è‰²ï¼Œæˆ–é¡è‰²å¤ªæ·ºï¼Œä½¿ç”¨æ·±ç°è‰²
            let starColor = diceColor || "#333";

            // æª¢æŸ¥é¡è‰²æ˜¯å¦å¤ªæ·ºï¼ˆæ¥è¿‘ç™½è‰²ï¼‰
            if (starColor.toLowerCase() === '#ffffff' || starColor.toLowerCase() === '#fff' || starColor.toLowerCase() === 'white') {
                starColor = "#333"; // ä½¿ç”¨æ·±ç°è‰²
            }

            ctx.fillStyle = starColor;
            const dotSize = size * 0.07;
            const p = size * 0.22;
            const m = size / 2;
            const l = p, r = size - p;
            const t = p, b = size - p;

            let dots = [];
            if (stars === 1) dots = [[m, m]];
            else if (stars === 2) dots = [[l, t], [r, b]];
            else if (stars === 3) dots = [[l, t], [m, m], [r, b]];
            else if (stars === 4) dots = [[l, t], [r, t], [l, b], [r, b]];
            else if (stars === 5) dots = [[l, t], [r, t], [m, m], [l, b], [r, b]];
            else if (stars === 6) dots = [[l, t], [r, t], [l, m], [r, m], [l, b], [r, b]];

            dots.forEach(dot => {
                ctx.beginPath();
                // å› ç‚º translate(x, y) äº†ï¼Œæ‰€ä»¥é€™è£¡ç¶­æŒç”¨ç›¸å°åº§æ¨™å³å¯
                ctx.arc(dot[0], dot[1], dotSize, 0, Math.PI * 2);
                ctx.fill();
            });

            ctx.restore();
        }
        function drawDiceFeature(ctx, x, y, size, pattern, diceColor) {
            if (!pattern || !diceColor) return;

            const m = size / 2;
            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.translate(x, y);

            // é¡è‰²èˆ‡ç·šæ¢è™•ç†
            let r = 0, g = 0, b = 0;
            if (diceColor.startsWith('#')) {
                r = parseInt(diceColor.slice(1, 3), 16);
                g = parseInt(diceColor.slice(3, 5), 16);
                b = parseInt(diceColor.slice(5, 7), 16);
            }

            ctx.strokeStyle = `rgba(${r}, ${g}, ${b}, 0.4)`;
            ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.15)`;
            // é—œéµï¼šç·šæ¢ç²—ç´°éš¨ size æ”¹è®Šï¼Œé¦–é æ‰ä¸æœƒæ­ª
            ctx.lineWidth = Math.max(1, size * 0.06);
            ctx.lineCap = "round";
            ctx.lineJoin = "round";

            switch (pattern) {
                case 'laser_beam': // é›·å°„ï¼šç§‘æŠ€æ„Ÿåå­—æº–æ˜Ÿ + è„ˆè¡å…‰ç’°
                    // 1. å¤–åœˆæ—‹è½‰å…‰ç’°
                    ctx.save();
                    ctx.translate(m, m);
                    ctx.rotate(Date.now() / 500);
                    ctx.strokeStyle = `rgba(${r}, ${g}, ${b}, 0.4)`;
                    ctx.lineWidth = Math.max(1, size * 0.03);
                    ctx.beginPath();
                    ctx.arc(0, 0, size * 0.35, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.restore();

                    // 2. ä¸­å¿ƒåå­—ç·š (æº–æ˜Ÿ)
                    ctx.strokeStyle = `rgba(${r}, ${g}, ${b}, 0.8)`;
                    ctx.lineWidth = Math.max(1, size * 0.045);
                    ctx.beginPath();
                    ctx.moveTo(m - size * 0.2, m); ctx.lineTo(m + size * 0.2, m);
                    ctx.moveTo(m, m - size * 0.2); ctx.lineTo(m, m + size * 0.2);
                    ctx.stroke();

                    // 3. å››å€‹è§’è½å®šä½é»
                    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.6)`;
                    const corners = [
                        [size * 0.15, size * 0.15],
                        [size * 0.85, size * 0.15],
                        [size * 0.15, size * 0.85],
                        [size * 0.85, size * 0.85]
                    ];
                    corners.forEach(([cx, cy]) => {
                        ctx.beginPath();
                        ctx.arc(cx, cy, size * 0.03, 0, Math.PI * 2);
                        ctx.fill();
                    });

                    // 4. ä¸­å¿ƒç™¼å…‰é»
                    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.9)`;
                    ctx.beginPath();
                    ctx.arc(m, m, size * 0.08, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 'fire':
                    ctx.beginPath();
                    ctx.moveTo(m, size * 0.25);
                    ctx.lineTo(size * 0.75, size * 0.75);
                    ctx.lineTo(size * 0.25, size * 0.75);
                    ctx.closePath();
                    ctx.stroke(); ctx.fill();
                    break;
                case 'ice':
                    ctx.beginPath();
                    ctx.arc(m, m, size * 0.3, 0, Math.PI * 2);
                    ctx.moveTo(m, size * 0.15); ctx.lineTo(m, size * 0.85);
                    ctx.moveTo(size * 0.15, m); ctx.lineTo(size * 0.85, m);
                    ctx.stroke();
                    break;
                case 'wind':
                    ctx.beginPath();
                    const gap = size * 0.15;
                    for (let i = -1; i <= 1; i++) {
                        ctx.moveTo(size * 0.25, m + (i * gap));
                        ctx.lineTo(size * 0.75, m + (i * gap));
                    }
                    ctx.stroke();
                    break;
                case 'electric':
                    ctx.beginPath();
                    ctx.moveTo(m + size * 0.1, size * 0.2);
                    ctx.lineTo(m - size * 0.15, m + size * 0.05);
                    ctx.lineTo(m + size * 0.15, m - size * 0.05);
                    ctx.lineTo(m - size * 0.1, size * 0.8);
                    ctx.stroke();
                    break;
                case 'poison':
                    ctx.beginPath();
                    ctx.moveTo(m, size * 0.2); ctx.lineTo(size * 0.75, m);
                    ctx.lineTo(m, size * 0.8); ctx.lineTo(size * 0.25, m);
                    ctx.closePath(); ctx.stroke(); ctx.fill();
                    break;
                case 'lock':
                    ctx.strokeRect(size * 0.3, size * 0.3, size * 0.4, size * 0.4);
                    ctx.beginPath(); ctx.arc(m, m, size * 0.05, 0, Math.PI * 2); ctx.fill();
                    break;
                case 'teleport':
                    ctx.beginPath();
                    ctx.arc(size * 0.35, m, size * 0.25, -Math.PI / 2, Math.PI / 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(size * 0.65, m, size * 0.25, Math.PI / 2, -Math.PI / 2);
                    ctx.stroke();
                    break;
                case 'gear':
                    ctx.beginPath();
                    ctx.setLineDash([size * 0.05, size * 0.05]);
                    ctx.arc(m, m, size * 0.3, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    ctx.beginPath(); ctx.arc(m, m, size * 0.12, 0, Math.PI * 2); ctx.stroke();
                    break;
                case 'joker':
                    ctx.beginPath();
                    ctx.moveTo(size * 0.25, size * 0.35); ctx.lineTo(size * 0.75, size * 0.35);
                    ctx.lineTo(m, size * 0.75); ctx.closePath(); ctx.stroke();
                    ctx.beginPath(); ctx.arc(size * 0.38, size * 0.25, size * 0.05, 0, Math.PI * 2); ctx.fill();
                    ctx.beginPath(); ctx.arc(size * 0.62, size * 0.25, size * 0.05, 0, Math.PI * 2); ctx.fill();
                    break;
                case 'growth':
                    ctx.beginPath();
                    ctx.moveTo(m, size * 0.2); ctx.lineTo(m, size * 0.8);
                    ctx.moveTo(m, size * 0.2); ctx.lineTo(size * 0.35, size * 0.4);
                    ctx.moveTo(m, size * 0.2); ctx.lineTo(size * 0.65, size * 0.4);
                    ctx.stroke();
                    break;
                case 'sun':
                    ctx.beginPath(); ctx.arc(m, m, size * 0.18, 0, Math.PI * 2); ctx.stroke(); ctx.fill();
                    for (let i = 0; i < 8; i++) {
                        ctx.save();
                        ctx.translate(m, m); ctx.rotate(i * Math.PI / 4);
                        ctx.moveTo(0, -size * 0.25); ctx.lineTo(0, -size * 0.4);
                        ctx.stroke(); ctx.restore();
                    }
                    break;
                case 'galaxy':
                    ctx.beginPath();
                    ctx.moveTo(m, size * 0.15);
                    ctx.bezierCurveTo(size * 0.85, size * 0.15, size * 0.15, size * 0.85, m, size * 0.85);
                    ctx.stroke();
                    ctx.beginPath(); ctx.arc(m, m, size * 0.08, 0, Math.PI * 2); ctx.fill();
                    break;
                // --- æ˜“å‚· (Crack) å¤–è§€ï¼šç¢è£‚æ°´æ™¶æ•ˆæœ ---
                case 'crack':
                    // 1. ä¸­å¿ƒçˆ†è£‚é»
                    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.5)`;
                    ctx.beginPath();
                    ctx.arc(m, m, size * 0.12, 0, Math.PI * 2);
                    ctx.fill();

                    // 2. å¤šæ–¹å‘è£‚ç´‹æ“´æ•£
                    ctx.strokeStyle = `rgba(${r}, ${g}, ${b}, 0.7)`;
                    ctx.lineWidth = Math.max(1, size * 0.04);
                    const crackAngles = [0, 45, 90, 135, 180, 225, 270, 315];
                    crackAngles.forEach(angle => {
                        const rad = angle * Math.PI / 180;
                        const x1 = m + Math.cos(rad) * size * 0.12;
                        const y1 = m + Math.sin(rad) * size * 0.12;
                        const x2 = m + Math.cos(rad) * size * 0.42;
                        const y2 = m + Math.sin(rad) * size * 0.42;

                        ctx.beginPath();
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                        ctx.stroke();
                    });

                    // 3. å¤–åœç¢ç‰‡é»ç¶´
                    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.4)`;
                    [0.1, 0.25, 0.75, 0.9].forEach(ratio => {
                        ctx.beginPath();
                        ctx.arc(size * ratio, size * 0.15, size * 0.025, 0, Math.PI * 2);
                        ctx.arc(size * ratio, size * 0.85, size * 0.025, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    break;

                // --- ç¤¦å±± (Mine) å¤–è§€ï¼šä¸€å€‹ T å­—å‹çš„é¬é ­ ---
                case 'mine':
                    ctx.beginPath();
                    // é¬é ­çš„å¼§å½¢é‡‘å±¬éƒ¨åˆ†
                    ctx.moveTo(size * 0.25, size * 0.35);
                    ctx.quadraticCurveTo(m, size * 0.15, size * 0.75, size * 0.35);
                    ctx.stroke();
                    // é¬é ­çš„æœ¨æŸ„
                    ctx.beginPath();
                    ctx.moveTo(m, size * 0.25);
                    ctx.lineTo(m, size * 0.75);
                    ctx.stroke();
                    // è£é£¾ä¸€å€‹å°éŒ¢å¹£åœ“é»
                    ctx.beginPath();
                    ctx.arc(m + size * 0.15, size * 0.7, size * 0.08, 0, Math.PI * 2);
                    ctx.fill(); ctx.stroke();
                    break;
                case 'mighty_wind': // å¼·é¢¨ï¼šå¤šé‡æ°£æµç·šæ¢
                    ctx.beginPath();
                    for (let i = -1; i <= 1; i++) {
                        ctx.moveTo(size * 0.2, m + i * size * 0.15);
                        ctx.bezierCurveTo(m, m + i * size * 0.4, m, m - i * size * 0.4, size * 0.8, m + i * size * 0.15);
                    }
                    ctx.stroke();
                    break;

                // --- è–åŸŸ (Sanctuary) å…‰ç’°åœ“åœˆ ---
                case 'sanctuary':
                    ctx.beginPath();
                    ctx.arc(m, m, size * 0.35, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(m, m, size * 0.25, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(m - size * 0.1, m); ctx.lineTo(m + size * 0.1, m);
                    ctx.moveTo(m, m - size * 0.1); ctx.lineTo(m, m + size * 0.1);
                    ctx.stroke();
                    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.6)`;
                    [0, 90, 180, 270].forEach(angle => {
                        const rad = angle * Math.PI / 180;
                        const px = m + Math.cos(rad) * size * 0.3;
                        const py = m + Math.sin(rad) * size * 0.3;
                        ctx.beginPath();
                        ctx.arc(px, py, size * 0.04, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    break;

                // --- å½—æ˜Ÿ (Comet) å½—æ˜Ÿæ‹–å°¾ ---
                case 'comet':
                    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.8)`;
                    ctx.beginPath();
                    ctx.arc(size * 0.65, size * 0.35, size * 0.12, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    ctx.strokeStyle = `rgba(${r}, ${g}, ${b}, 0.5)`;
                    for (let i = -1; i <= 1; i++) {
                        ctx.beginPath();
                        ctx.moveTo(size * 0.65, size * 0.35);
                        ctx.quadraticCurveTo(
                            size * 0.4, size * 0.5 + i * size * 0.1,
                            size * 0.15, size * 0.7 + i * size * 0.15
                        );
                        ctx.stroke();
                    }
                    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.4)`;
                    [[0.3, 0.55], [0.2, 0.65], [0.15, 0.75]].forEach(([px, py]) => {
                        ctx.beginPath();
                        ctx.arc(size * px, size * py, size * 0.03, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    break;

                // --- é€£é– (Chain) é–ƒé›»éˆ ---
                case 'chain':
                    const chainPoints = [
                        [size * 0.2, size * 0.25],
                        [size * 0.5, size * 0.65],
                        [size * 0.8, size * 0.35]
                    ];
                    ctx.lineWidth = Math.max(1, size * 0.04);
                    for (let i = 0; i < chainPoints.length - 1; i++) {
                        const [x1, y1] = chainPoints[i];
                        const [x2, y2] = chainPoints[i + 1];
                        ctx.beginPath();
                        ctx.moveTo(x1, y1);
                        const segments = 3;
                        for (let s = 1; s <= segments; s++) {
                            const t = s / segments;
                            const mx = x1 + (x2 - x1) * t;
                            const my = y1 + (y2 - y1) * t;
                            const offset = (s % 2 === 0 ? 1 : -1) * size * 0.08;
                            ctx.lineTo(mx + offset, my);
                        }
                        ctx.lineTo(x2, y2);
                        ctx.stroke();
                    }
                    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.7)`;
                    chainPoints.forEach(([px, py]) => {
                        ctx.beginPath();
                        ctx.arc(px, py, size * 0.06, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    break;

                // --- æ¯€æ»… (Doom) æœ«æ—¥æ™‚é˜ ---
                case 'doom':
                    ctx.beginPath();
                    ctx.arc(m, m, size * 0.35, 0, Math.PI * 2);
                    ctx.stroke();
                    [0, 90, 180, 270].forEach(angle => {
                        const rad = angle * Math.PI / 180 - Math.PI / 2;
                        const x1 = m + Math.cos(rad) * size * 0.3;
                        const y1 = m + Math.sin(rad) * size * 0.3;
                        const x2 = m + Math.cos(rad) * size * 0.35;
                        const y2 = m + Math.sin(rad) * size * 0.35;
                        ctx.beginPath();
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                        ctx.stroke();
                    });
                    ctx.lineWidth = Math.max(1, size * 0.03);
                    ctx.strokeStyle = `rgba(${r}, ${g}, ${b}, 0.9)`;
                    ctx.beginPath();
                    ctx.moveTo(m, m);
                    ctx.lineTo(m, m - size * 0.25);
                    ctx.stroke();
                    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.8)`;
                    ctx.beginPath();
                    ctx.arc(m, m, size * 0.06, 0, Math.PI * 2);
                    ctx.fill();
                    break;
            }
            ctx.restore();
        }

        // --- æœ€çµ‚ä¿®å¾©ç‰ˆï¼šå“è³ªé‚Šæ¡†ç‰¹æ•ˆ (å«é˜²å‘†æ©Ÿåˆ¶) ---
        // --- ç´”ç²¹è£é£¾ç‰ˆï¼šé«˜å“è³ªéœæ…‹é‚Šæ¡† (å¼·èª¿è¨­è¨ˆæ„Ÿèˆ‡éšç´šå·®ç•°) ---
        function drawQualityBorder(ctx, x, y, size, diceId) {
            if (!diceId || size < 1) return;
            
            // ç‚ºäº†æ•ˆèƒ½ï¼Œæˆ‘å€‘é€™è£¡ç°¡å–®è®€å–
            // å¯¦éš›å°ˆæ¡ˆä¸­å»ºè­°æŠŠ quality å±¬æ€§ç›´æ¥å‚³é€²ä¾†ï¼Œä¸ç”¨æ¯æ¬¡ find
            const db = ALL_DICES.find(d => d.id === diceId); 
            if (!db) return;
            const quality = db.quality;
            if (quality !== 'legend' && quality !== 'mythic') return;

            // åŸºç¤åƒæ•¸
            const lw = Math.max(1.5, size * 0.05); // ç·šå¯¬

            // å…§å»ºç¹ªåœ–å·¥å…·ï¼šç•«åœ“è§’è·¯å¾‘ (ä¸strokeä¹Ÿä¸fillï¼Œåªå»ºç«‹è·¯å¾‘)
            function pathRound(cx, cy, w, h, r) {
                if (w < 2 * r) r = w / 2; if (h < 2 * r) r = h / 2;
                ctx.beginPath();
                ctx.moveTo(cx + r, cy);
                ctx.arcTo(cx + w, cy, cx + w, cy + h, r);
                ctx.arcTo(cx + w, cy + h, cx, cy + h, r);
                ctx.arcTo(cx, cy + h, cx, cy, r);
                ctx.arcTo(cx, cy, cx + w, cy, r);
                ctx.closePath();
            }

            ctx.save();
            ctx.translate(x, y);

            if (quality === 'legend') {
                // ==========================================
                // å‚³èªª (Legend)ï¼šçš‡å®¶é»ƒé‡‘æµ®é›• (åšé‡ã€å‚³çµ±ã€è²¡å¯Œ)
                // ==========================================
                
                // 1. å¤–æ¡† (æ·±è‰²æ‰“åº•ï¼Œè£½é€ é™°å½±æ„Ÿ)
                ctx.strokeStyle = '#B8860B'; // æš—é‡‘è‰²
                ctx.lineWidth = lw * 2.5;
                pathRound(1, 1, size - 2, size - 2, size * 0.18);
                ctx.stroke();

                // 2. ä¸»æ¡†é«” (é‡‘å±¬æ¼¸å±¤ï¼Œè£½é€ ç«‹é«”æ„Ÿ)
                const grad = ctx.createLinearGradient(0, 0, size, size);
                grad.addColorStop(0, '#FDB931'); // äº®é‡‘
                grad.addColorStop(0.3, '#D19C1D'); // ä¸­é‡‘
                grad.addColorStop(0.6, '#FFD700'); // ç´”é‡‘é«˜å…‰
                grad.addColorStop(1, '#8A6E2F'); // æš—è§’
                
                ctx.strokeStyle = grad;
                ctx.lineWidth = lw * 1.5;
                pathRound(2, 2, size - 4, size - 4, size * 0.17);
                ctx.stroke();

                // 3. å››è§’è£é£¾ (ä¸‰è§’å½¢è­·è§’)
                ctx.fillStyle = grad;
                const cSize = size * 0.12;
                // å·¦ä¸Š
                ctx.beginPath(); ctx.moveTo(0, cSize); ctx.lineTo(cSize, 0); ctx.lineTo(0, 0); ctx.fill();
                // å³ä¸Š
                ctx.beginPath(); ctx.moveTo(size-cSize, 0); ctx.lineTo(size, 0); ctx.lineTo(size, cSize); ctx.fill();
                // å³ä¸‹
                ctx.beginPath(); ctx.moveTo(size, size-cSize); ctx.lineTo(size, size); ctx.lineTo(size-cSize, size); ctx.fill();
                // å·¦ä¸‹
                ctx.beginPath(); ctx.moveTo(0, size-cSize); ctx.lineTo(0, size); ctx.lineTo(cSize, size); ctx.fill();

                // 4. å…§æé‚Š (ç²¾ç·»æ„Ÿ)
                ctx.strokeStyle = '#FFF8DC'; // ç±³ç™½é‡‘
                ctx.lineWidth = 1;
                pathRound(size * 0.12, size * 0.12, size * 0.76, size * 0.76, size * 0.1);
                ctx.stroke();

            } else if (quality === 'mythic') {
                // ==========================================
                // ç¥è©± (Mythic)ï¼šè™›ç©ºçŸ©é™£ (æ‡¸æµ®ã€ç§‘æŠ€ã€ç¥ç§˜)
                // çµæ§‹ä¸Šå®Œå…¨åŒ…è¦†å‚³èªªï¼Œä¸”æ›´åŠ è¤‡é›œ
                // ==========================================

                // å®šç¾©ç¥ç§˜æ¼¸å±¤ (ç´« -> é’ -> ç™½)
                const grad = ctx.createLinearGradient(0, 0, size, size);
                grad.addColorStop(0, '#7c3aed');   // ç´«è‰²
                grad.addColorStop(0.5, '#22d3ee'); // é’è‰²
                grad.addColorStop(1, '#e879f9');   // ç²‰ç´«

                // 1. æ–·è£‚å¼å¤–æ¡† (ä¸Šä¸‹å·¦å³å››æ¢é‚Šï¼Œä¸é€£åœ¨ä¸€èµ·)
                ctx.strokeStyle = grad;
                ctx.lineWidth = lw * 1.2;
                ctx.lineCap = "round";
                const gap = size * 0.25; // ç¼ºå£å¤§å°
                
                ctx.beginPath();
                // ä¸Šé‚Š
                ctx.moveTo(gap, 2); ctx.lineTo(size - gap, 2);
                // ä¸‹é‚Š
                ctx.moveTo(gap, size-2); ctx.lineTo(size - gap, size-2);
                // å·¦é‚Š
                ctx.moveTo(2, gap); ctx.lineTo(2, size - gap);
                // å³é‚Š
                ctx.moveTo(size-2, gap); ctx.lineTo(size-2, size - gap);
                ctx.stroke();

                // 2. è§’è½æ‡¸æµ®çŸ©é™£ (å–ä»£å‚³çµ±è­·è§’)
                // ç•«å››å€‹ L å‹çš„é›™ç·šçµæ§‹
                const cLen = size * 0.18;
                const offset = 3;
                
                // é›™å±¤ç·šæ¢ï¼šåº•å±¤æ·±è‰²
                ctx.strokeStyle = '#4c1d95'; // æ·±ç´«è¥¯åº•
                ctx.lineWidth = lw * 2;
                ctx.beginPath();
                // å·¦ä¸Š
                ctx.moveTo(offset, offset + cLen); ctx.lineTo(offset, offset); ctx.lineTo(offset + cLen, offset);
                // å³ä¸Š
                ctx.moveTo(size - offset, offset + cLen); ctx.lineTo(size - offset, offset); ctx.lineTo(size - offset - cLen, offset);
                // å³ä¸‹
                ctx.moveTo(size - offset, size - offset - cLen); ctx.lineTo(size - offset, size - offset); ctx.lineTo(size - offset - cLen, size - offset);
                // å·¦ä¸‹
                ctx.moveTo(offset, size - offset - cLen); ctx.lineTo(offset, size - offset); ctx.lineTo(offset + cLen, size - offset);
                ctx.stroke();

                // ä¸Šå±¤äº®è‰²
                ctx.strokeStyle = '#fff'; // ç´”ç™½é«˜äº®
                ctx.lineWidth = lw * 0.8;
                ctx.stroke(); // é‡ç•«ä¸€æ¬¡è·¯å¾‘

                // 3. èƒ½é‡ç¯€é» (å››è§’çš„åœ“é»)
                ctx.fillStyle = grad;
                const dotSize = size * 0.04;
                const dotOff = size * 0.08;
                
                ctx.beginPath();
                ctx.arc(dotOff, dotOff, dotSize, 0, Math.PI*2);
                ctx.arc(size - dotOff, dotOff, dotSize, 0, Math.PI*2);
                ctx.arc(size - dotOff, size - dotOff, dotSize, 0, Math.PI*2);
                ctx.arc(dotOff, size - dotOff, dotSize, 0, Math.PI*2);
                ctx.fill();

                // 4. å…§éƒ¨å¹¾ä½•è£é£¾ (ç´°ç·šæ¡†)
                ctx.strokeStyle = `rgba(255, 255, 255, 0.3)`;
                ctx.lineWidth = 1;
                pathRound(size * 0.15, size * 0.15, size * 0.7, size * 0.7, size * 0.05);
                ctx.stroke();
            }

            ctx.restore();
        }
// --- è£œä¸Šç¼ºå¤±çš„å·¥å…·å‡½å¼ ---
        function drawRoundedRect(ctx, x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
        }
        // --- 3. æ¸²æŸ“èˆ‡åŠŸèƒ½ ---
        function render() {
            if (!userData) return;

            // 1. æ›´æ–°é‡‘å¹£èˆ‡ç¥¨åˆ¸
            const goldDisplay = document.getElementById('goldText');
            if (goldDisplay) goldDisplay.innerText = Math.floor(currentBalance).toLocaleString();
            const shopGoldText = document.getElementById('shopGoldText');
            if (shopGoldText) shopGoldText.innerText = Math.floor(currentBalance).toLocaleString();

            const tickets = userData.tickets || 0;
            const shopTicketDisplay = document.getElementById('shopTicketText');
            if (shopTicketDisplay) shopTicketDisplay.innerText = tickets.toLocaleString();

            // 2. ç”¢ç”Ÿæˆå“¡æ¸…å–® (Deck) çš„ HTML
            const generateDeckHtml = (prefix) => {
                return userData.deck.map((id, index) => {
                    const dice = ALL_DICES.find(d => d.id === id);
                    if (!dice) return `<div class="w-14 h-14 bg-slate-800 rounded-lg border-2 border-dashed border-slate-600"></div>`;

                    const q = QUALITIES[dice.quality] || QUALITIES.common;
                    const lv = userData.diceLevels[id] || 1;
                    const isReplacing = selectedInventoryId !== null;

                    return `
        <div onclick="selectDeckSlot(${index})" 
            class="w-14 h-14 rounded-lg flex items-center justify-center relative shadow-lg border-2 transition-all overflow-hidden
            ${dice.quality === 'mythic' ? 'q-mythic' : ''} ${isReplacing ? 'deck-slot-highlight' : ''}" 
            style="background-color: #ffffff; border-color: ${q.color}">
            <canvas id="${prefix}-deck-canvas-${index}" width="56" height="56" style="width:56px; height:56px;"></canvas>
            <div class="absolute bottom-0 right-0 text-[8px] bg-black/50 text-white px-1 rounded z-10">Lv.${lv}</div>
        </div>`;
                }).join('');
            };

            const deckContainer = document.getElementById('deckContainer');
            if (deckContainer) deckContainer.innerHTML = generateDeckHtml('main');

            const inventoryDeckContainer = document.getElementById('inventoryDeckContainer');
            if (inventoryDeckContainer) inventoryDeckContainer.innerHTML = generateDeckHtml('inv');

            // 3. æ›´æ–°éª°å­å€‰åº« (Inventory)
            const inventorySection = document.getElementById('inventorySection');
            if (inventorySection) {
                inventorySection.innerHTML = ALL_DICES.map(dice => {
                    const count = userData.inventory[dice.id] || 0;
                    const lv = userData.diceLevels[dice.id] || 1;
                    const q = QUALITIES[dice.quality] || QUALITIES.common;
                    const isOwned = count > 0 || userData.deck.includes(dice.id);
                    const isSelected = selectedInventoryId === dice.id;

                    return `
        <div onclick="${isOwned ? `openUpgradeUI('${dice.id}')` : ''}" 
            class="bg-slate-800 p-2 rounded-xl text-center border-2 transition-all dice-card 
            ${isSelected ? 'selected-dice' : (isOwned ? 'border-slate-700' : 'opacity-20 grayscale pointer-events-none')}">
            <div class="w-12 h-12 mx-auto mb-1 flex items-center justify-center relative rounded-lg bg-white overflow-hidden" 
                 style="border: 2px solid ${q.color}">
                <canvas id="inv-canvas-${dice.id}" width="48" height="48" style="width:48px; height:48px;"></canvas>
            </div>
            <div class="text-[10px] font-bold text-white truncate mb-0.5">${dice.name}</div>
            <div class="text-[9px] text-slate-300">Lv.${lv}</div>
            <div class="text-[8px] text-slate-400">${count} ç¢ç‰‡</div>
        </div>`;
                }).join('');
            }

            // --- 4. é—œéµæ­¥é©Ÿï¼šç¢ºä¿ HTML æ¸²æŸ“å¾Œå†ç¹ªåœ–ï¼Œä¸¦ä¿®æ­£åº§æ¨™ ---
            setTimeout(() => {
                // ç¹ªè£½ç·¨éšŠå€ (ä¸»é èˆ‡å‚™æˆ°é )
                ['main', 'inv'].forEach(prefix => { // ç•«å‡ºæ‰€æœ‰æˆå“¡
                    userData.deck.forEach((diceId, index) => {
                        const canvas = document.getElementById(`${prefix}-deck-canvas-${index}`);
                        if (canvas) {
                            const dice = ALL_DICES.find(d => d.id === diceId);
                            if (dice) {
                                const ctx = canvas.getContext('2d');
                                ctx.clearRect(0, 0, canvas.width, canvas.height);
                                // å…ˆç•«é‚Šæ¡†ç‰¹æ•ˆ
                                drawQualityBorder(ctx, 0, 0, canvas.width, dice.id);
                                // ä¿®æ­£åº§æ¨™ç‚º 0, 0ï¼Œé¿å…æ­ªæ‰
                                drawDiceFeature(ctx, 0, 0, canvas.width, dice.pattern || dice.id, dice.baseColor);
                                drawDiceStars(ctx, 0, 0, canvas.width, 1, dice.baseColor);
                            }
                        }
                    });
                });

                // ç¹ªè£½å€‰åº«å€
                ALL_DICES.forEach(dice => {
                    const canvas = document.getElementById(`inv-canvas-${dice.id}`);
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        // å…ˆç•«é‚Šæ¡†ç‰¹æ•ˆ
                        drawQualityBorder(ctx, 0, 0, canvas.width, dice.id);
                        // ä¿®æ­£åº§æ¨™ç‚º 0, 0
                        drawDiceFeature(ctx, 0, 0, canvas.width, dice.pattern || dice.id, dice.baseColor);
                        drawDiceStars(ctx, 0, 0, canvas.width, 1, dice.baseColor);
                    }
                });
            }, 0);

            // å•Ÿå‹•é‚Šæ¡†å‹•ç•«ï¼ˆå¦‚æœæœ‰å‚³èªª/ç¥è©±éª°å­ä¸”å‹•ç•«æœªé‹è¡Œï¼‰
            setTimeout(() => {
                if (shouldAnimate() && !animationFrameId) {
                    animateDiceBorders();
                }
            }, 50);
        }

        // --- å‹•ç•«å¾ªç’°ï¼šæŒçºŒæ›´æ–°å‚³èªª/ç¥è©±å“è³ªéª°å­çš„é‚Šæ¡†ç‰¹æ•ˆ ---
        let animationFrameId = null;

        function shouldAnimate() {
            // æª¢æŸ¥æ˜¯å¦æœ‰å‚³èªªæˆ–ç¥è©±å“è³ªçš„éª°å­éœ€è¦å‹•ç•«
            if (!userData || !userData.deck) return false;
            return userData.deck.some(id => {
                const dice = ALL_DICES.find(d => d.id === id);
                return dice && (dice.quality === 'legend' || dice.quality === 'mythic');
            });
        }

        function animateDiceBorders() {
            if (!shouldAnimate()) {
                animationFrameId = null;
                return; // æ²’æœ‰éœ€è¦å‹•ç•«çš„éª°å­ï¼Œåœæ­¢å¾ªç’°
            }

            try {
                // æ›´æ–°æ‰€æœ‰ canvas ä¸­çš„éª°å­
                ['main', 'inv'].forEach(prefix => {
                    if (!userData || !userData.deck) return;

                    userData.deck.forEach((diceId, index) => {
                        const canvas = document.getElementById(`${prefix}-deck-canvas-${index}`);
                        if (!canvas) return;

                        const dice = ALL_DICES.find(d => d.id === diceId);
                        if (dice && (dice.quality === 'legend' || dice.quality === 'mythic')) {
                            const ctx = canvas.getContext('2d');
                            ctx.clearRect(0, 0, canvas.width, canvas.height);

                            drawDiceFeature(ctx, 0, 0, canvas.width, dice.pattern || dice.id, dice.baseColor);
                            drawDiceStars(ctx, 0, 0, canvas.width, 1, dice.baseColor);
                            drawQualityBorder(ctx, 0, 0, canvas.width, dice.id);
                        }
                    });
                });

                // æ›´æ–°å€‰åº«å€çš„å‚³èªª/ç¥è©±éª°å­
                ALL_DICES.forEach(dice => {
                    if (dice.quality === 'legend' || dice.quality === 'mythic') {
                        const canvas = document.getElementById(`inv-canvas-${dice.id}`);
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            drawQualityBorder(ctx, 0, 0, canvas.width, dice.id);
                            drawDiceFeature(ctx, 0, 0, canvas.width, dice.pattern || dice.id, dice.baseColor);
                            drawDiceStars(ctx, 0, 0, canvas.width, 1, dice.baseColor);
                        }
                    }
                });
                if (tempUpgradeId) {
                    const canvas = document.getElementById('u-canvas');
                    const dice = ALL_DICES.find(d => d.id === tempUpgradeId);
                    if (canvas && dice && (dice.quality === 'legend' || dice.quality === 'mythic')) {
                        const ctx = canvas.getContext('2d');
                        const size = canvas.width;

                        // å› ç‚ºå‡ç´šä»‹é¢èƒŒæ™¯æ˜¯ç™½çš„ï¼Œé‡ç¹ªæ™‚è¦è£œä¸Šç™½åº•
                        ctx.fillStyle = "#ffffff";
                        ctx.fillRect(0, 0, size, size);

                        drawDiceFeature(ctx, 0, 0, size, dice.pattern || dice.id, dice.baseColor);
                        drawDiceStars(ctx, 0, 0, size, 1, "#333333");
                        drawQualityBorder(ctx, 0, 0, size, dice.id);
                    }
                }
            } catch (error) {
                console.error('å‹•ç•«å¾ªç’°éŒ¯èª¤:', error);
            }

            animationFrameId = requestAnimationFrame(animateDiceBorders);
        }

        // å•Ÿå‹•å‹•ç•«å¾ªç’°ï¼ˆåœ¨é é¢è¼‰å…¥å¾Œï¼‰
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (shouldAnimate() && !animationFrameId) {
                    animateDiceBorders();
                }
            }, 100);
        });

        async function saveData() {
            // 1. æœ¬åœ°å„²å­˜
            localStorage.setItem('dice_game_data', JSON.stringify(userData));
            localStorage.setItem('sicbo_balance', currentBalance);

            // 2. é›²ç«¯åŒæ­¥ (å°æ¥ index.html çš„ playerId)
            if (userId !== 'guest') {
                try {
                    await fs.collection('users').doc(userId).set({
                        balance: Number(currentBalance), // åŒæ­¥é¤˜é¡
                        dice_data: { // ä¾ç…§ä½ çš„è¦æ±‚æ”¹ç‚º dice_data
                            deck: userData.deck,
                            inventory: userData.inventory,
                            diceLevels: userData.diceLevels,
                            tickets: userData.tickets,
                            unlockLevel: userData.unlockLevel,
                            maxWave: userData.maxWave,
                            lastSync: Date.now()
                        }
                    }, { merge: true });
                    console.log("âœ… é›²ç«¯åŒæ­¥æˆåŠŸ (UID: " + userId + ")");
                } catch (error) {
                    console.error("âŒ é›²ç«¯åŒæ­¥å¤±æ•—:", error);
                }
            }
        }

        function openUpgradeUI(id) {
            tempUpgradeId = id;
            const dice = ALL_DICES.find(d => d.id === id);
            if (!dice) return;

            const q = QUALITIES[dice.quality];
            const lv = userData.diceLevels[id] || 1;
            const count = userData.inventory[id] || 0;
            const req = UPGRADE_CONFIG[lv] || [999, 999999999];

            // 1. è¨ˆç®—å±¬æ€§
            const curAtk = dice.stats.atk + (lv - 1) * dice.grow.atk;
            const nextAtk = dice.stats.atk + lv * dice.grow.atk;
            const curSpd = dice.stats.speed + (lv - 1) * dice.grow.speed;
            const nextSpd = dice.stats.speed + lv * dice.grow.speed;

            let specialHTML = '';
            if (dice.special) {
                const curValue = (dice.special.value + (lv - 1) * dice.special.grow).toFixed(1).replace(/\.0$/, '');
                const nextValue = (dice.special.value + lv * dice.special.grow).toFixed(1).replace(/\.0$/, '');
                specialHTML = `
            <div class="text-xs text-slate-400 mt-2">${dice.special.label}</div>
            <div class="text-lg font-bold text-yellow-400">${curValue}${dice.special.unit} â†’ ${nextValue}${dice.special.unit}</div>
        `;
            }

            // 2. æ›´æ–°åŸºç¤è³‡è¨Š
            document.getElementById('u-name').innerText = dice.name + " éª°å­";
            document.getElementById('u-quality').innerText = `${q.name} å“è³ª`;
            document.getElementById('u-quality').style.color = q.color; // è®“å“è³ªæ–‡å­—ä¹Ÿè®Šè‰²
            document.getElementById('u-lv-now').innerText = `Lv. ${lv}`;
            document.getElementById('u-atk').innerHTML = `
        <div class="text-xs text-slate-400">åŸºç¤æ”»æ“Š</div>
        <div class="text-lg font-bold text-green-400">${curAtk} â†’ ${nextAtk}</div>
        <div class="text-xs text-slate-400 mt-2">æ”»æ“Šé–“éš” (ms)</div>
        <div class="text-lg font-bold text-blue-400">${curSpd} â†’ ${nextSpd}</div>
        ${specialHTML} 
    `;

            // 3. è³‡æºå°æ¯”
            const fragText = document.getElementById('u-req-fragments');
            const goldReqText = document.getElementById('u-req-gold');
            const hasEnoughFrags = count >= req[0];
            fragText.innerHTML = `<span class="${hasEnoughFrags ? 'text-green-400' : 'text-red-500'}">${count}</span> / ${req[0]}`;
            const hasEnoughGold = currentBalance >= req[1];
            goldReqText.innerHTML = `<span class="${hasEnoughGold ? 'text-yellow-400' : 'text-red-500'}">${req[1].toLocaleString()}</span>`;

            // 4. æŒ‰éˆ•ç‹€æ…‹
            const upgradeBtn = document.getElementById('btn-upgrade');
            const canAfford = hasEnoughFrags && hasEnoughGold;
            upgradeBtn.disabled = !canAfford || lv >= 10;

            if (lv >= 10) {
                upgradeBtn.innerText = 'å·²é”æœ€å¤§ç­‰ç´š';
                upgradeBtn.className = "flex-1 bg-slate-600 py-3 rounded-xl font-bold opacity-50";
            } else {
                upgradeBtn.innerText = canAfford ? 'ç¢ºèªå‡ç´š' : 'è³‡æºä¸è¶³';
                upgradeBtn.className = `flex-1 py-3 rounded-xl font-bold transition-colors ${canAfford ? 'bg-green-600 hover:bg-green-500' : 'bg-slate-700 text-slate-400'}`;
            }

            // --- 5. å¼·åˆ¶ç¹ªè£½éª°å­ ---
            const iconContainer = document.getElementById('u-icon');
            const canvas = document.getElementById('u-canvas');
            if (canvas && iconContainer) {
                const ctx = canvas.getContext('2d');
                const size = canvas.width;

                // è¨­å®šé‚Šæ¡†é¡è‰²èˆ‡èƒŒæ™¯
                iconContainer.style.borderColor = q.color;
                iconContainer.style.backgroundColor = "#ffffff";

                // æ¸…é™¤ç•«å¸ƒä¸¦å¡«ç™½åº•
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(0, 0, size, size);

                // å…ˆç•«å“è³ªé‚Šæ¡†ç‰¹æ•ˆ

                // å‘¼å«ä½ çš„ç¹ªåœ–å‡½å¼
                drawDiceFeature(ctx, 0, 0, size, dice.pattern || dice.id, dice.baseColor);
                drawDiceStars(ctx, 0, 0, size, 1, "#333333");
                drawQualityBorder(ctx, 0, 0, size, dice.id);
            }

            document.getElementById('upgradeOverlay').classList.remove('hidden');
        }
        function confirmUpgrade() {
            if (!tempUpgradeId) return;
            const lv = userData.diceLevels[tempUpgradeId] || 1;
            const req = UPGRADE_CONFIG[lv];
            if (!req) return;

            if (userData.inventory[tempUpgradeId] >= req[0] && currentBalance >= req[1]) {
                currentBalance -= req[1];
                userData.inventory[tempUpgradeId] -= req[0];
                userData.diceLevels[tempUpgradeId] = lv + 1;
                saveData();
                render();
                openUpgradeUI(tempUpgradeId);
            }
        }

        function confirmEquip() {
            if (!tempUpgradeId) return;

            // ä¸å†é˜»æ“‹ï¼Œç›´æ¥è®“ç©å®¶é¸æ“‡ä½ç½®ä¾†é€²è¡Œã€Œäº’æ›ã€æˆ–ã€Œè£å‚™ã€
            selectedInventoryId = tempUpgradeId;
            closeUpgradeUI();
            render();

            const status = document.getElementById('deckStatus');
            if (status) {
                status.innerText = "è«‹é¸æ“‡ä¸Šæ–¹ä½ç½®æ›¿æ›æˆ–èª¿æ›ä½ç½®";
                status.classList.add('text-yellow-400');
            }
        }

        function selectDeckSlot(index) {
            // å¦‚æœç›®å‰æ²’æœ‰é¸ä¸­ä¸‹æ–¹çš„éª°å­ï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•å‹•ä½œ
            if (!selectedInventoryId) return;

            // 1. æª¢æŸ¥é€™å€‹éª°å­æ˜¯å¦å·²ç¶“åœ¨éšŠä¼çš„å…¶ä»–ä½ç½®
            const existingIndex = userData.deck.indexOf(selectedInventoryId);

            if (existingIndex !== -1) {
                // --- æ ¸å¿ƒé‚è¼¯ï¼šä½ç½®äº’æ› ---
                // å–å¾—ç›®æ¨™ä½ç½®åŸæœ¬çš„éª°å­
                const diceAtTarget = userData.deck[index];
                // æŠŠç›®æ¨™ä½ç½®åŸæœ¬çš„éª°å­ç§»åˆ°è©²éª°å­åŸæœ¬çš„ä½ç½®
                userData.deck[existingIndex] = diceAtTarget;
                // æŠŠé¸ä¸­çš„éª°å­æ”¾å…¥æ–°ä½ç½®
                userData.deck[index] = selectedInventoryId;
            } else {
                // --- æ ¸å¿ƒé‚è¼¯ï¼šç›´æ¥æ›¿æ› ---
                // éª°å­ä¸åœ¨éšŠä¼ä¸­ï¼Œç›´æ¥è¦†è“‹è©²ä½ç½®
                userData.deck[index] = selectedInventoryId;
            }

            // 2. çµæŸé¸æ“‡æ¨¡å¼
            selectedInventoryId = null;

            // 3. UI ç‹€æ…‹æ¢å¾©
            const status = document.getElementById('deckStatus');
            if (status) {
                status.innerText = "Battle Deck";
                status.classList.remove('text-yellow-400');
            }

            // 4. å„²å­˜ä¸¦åˆ·æ–°ç•«é¢
            saveData();
            render();
        }
        function buySpecialBox(amount) {
            const cost = amount;
            alert("æ•¬è«‹æœŸå¾…");
            return;
            if ((userData.tickets || 0) < cost) {
                alert("æŠ½çåˆ¸ä¸è¶³ï¼");
                return;
            }

            userData.tickets -= cost;

            // é€™è£¡å¯ä»¥å®šç¾©ç‰¹æ®Šæ± çš„è‹±é›„æ¸…å–®
            // å‡è¨­ä½ åªæƒ³åœ¨ç‰¹æ®Šæ± æŠ½ã€Œå¤ªé™½ã€è·Ÿã€Œå†°éœœã€
            const specialPool = ALL_DICES.filter(d => d.type === 'functional' || d.quality === 'mythic');

            // åŸ·è¡ŒæŠ½å¡ (é€™éƒ¨åˆ†å¯ä»¥åƒè€ƒä½ åŸæœ¬çš„ buyBoxï¼Œä½†æ”¹ç”¨ specialPool)
            // doSummon(amount, specialPool);

            saveData();
            render();
        }
        async function buyBox(count = 10) {
            const singlePrice = 10000;
            const totalPrice = singlePrice * count;

            if (currentBalance < totalPrice) {
                alert("é‘½çŸ³ä¸è¶³ï¼");
                return;
            }

            currentBalance -= totalPrice;
            let rewardsSummary = {};

            for (let i = 0; i < count; i++) {
                const rand = Math.random();
                let selectedQ = 'common';
                let cum = 0;

                for (const [key, q] of Object.entries(QUALITIES)) {
                    cum += q.chance;
                    if (rand < cum) { selectedQ = key; break; }
                }

                const possibleDices = ALL_DICES.filter(d => d.quality === selectedQ);
                const dice = possibleDices[Math.floor(Math.random() * possibleDices.length)] || ALL_DICES[0];

                userData.inventory[dice.id] = (userData.inventory[dice.id] || 0) + 1;

                if (!rewardsSummary[dice.id]) {
                    rewardsSummary[dice.id] = { info: dice, count: 1 };
                } else {
                    rewardsSummary[dice.id].count++;
                }
            }

            await saveData();
            showRewardUI(Object.values(rewardsSummary));
            render();
        }

        function showRewardUI(summarizedRewards) {
            // ä¿®æ­£é»ï¼šå°‡ rewardContainer æ”¹ç‚º rewardList (å°æ‡‰ HTML ä¸­çš„ ID)
            const container = document.getElementById('rewardList');
            if (!container) return; // å¢åŠ å®‰å…¨æ€§æª¢æŸ¥

            container.innerHTML = '';

            summarizedRewards.forEach(item => {
                const dice = item.info;
                const count = item.count;
                const div = document.createElement('div');
                div.className = "relative flex flex-col items-center p-2 bg-slate-800 rounded-xl border border-slate-700";

                const countBadge = count > 1 ?
                    `<div class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full z-10">x${count}</div>` : '';

                div.innerHTML = `
            ${countBadge}
            <div class="w-12 h-12 rounded-lg mb-1 flex items-center justify-center shadow-lg" 
                 style="background: ${dice.baseColor}; border: 2px solid ${QUALITIES[dice.quality].color}">
                 <span class="text-white font-bold text-sm">${dice.name}</span>
            </div>
            <div class="text-[10px]" style="color: ${QUALITIES[dice.quality].color}">${QUALITIES[dice.quality].name}</div>
        `;
                container.appendChild(div);
            });

            document.getElementById('rewardOverlay').classList.remove('hidden');
        }

        function closeReward() { document.getElementById('rewardOverlay').classList.add('hidden'); }
        function closeUpgradeUI() { document.getElementById('upgradeOverlay').classList.add('hidden'); tempUpgradeId = null; }

        function showPage(pageId) {
            // 1. éš±è—æ‰€æœ‰é é¢
            document.getElementById('page-shop').classList.add('hidden');
            document.getElementById('page-battle').classList.add('hidden');
            document.getElementById('page-inventory').classList.add('hidden');

            // 2. é¡¯ç¤ºæŒ‡å®šé é¢
            document.getElementById('page-' + pageId).classList.remove('hidden');

            // 3. æ›´æ–°æŒ‰éˆ•é¡è‰² (é‡ç½®æ‰€æœ‰æŒ‰éˆ•ç‚ºç°è‰²)
            document.getElementById('nav-shop').className = 'flex flex-col items-center gap-1 text-slate-400';
            document.getElementById('nav-battle').className = 'flex flex-col items-center gap-1 text-slate-400';
            document.getElementById('nav-inventory').className = 'flex flex-col items-center gap-1 text-slate-400';

            // 4. é«˜äº®ç•¶å‰æŒ‰éˆ•
            const activeColor = pageId === 'battle' ? 'text-blue-400' :
                (pageId === 'shop' ? 'text-yellow-400' : 'text-green-400');
            document.getElementById('nav-' + pageId).classList.replace('text-slate-400', activeColor);

            // å¦‚æœåˆ‡æ›åˆ°å‚™æˆ°æˆ–æˆ°é¬¥ï¼Œé‡æ–°æ¸²æŸ“é™£å®¹æˆ–æ¸…å–® (ç¢ºä¿æ•¸æ“šæœ€æ–°)
            render();
        }
// ç•¶å‰æ’è¡Œæ¦œæ¨¡å¼
    let currentRankMode = 'adventure'; 

    // é–‹é—œæ’è¡Œæ¦œå´é‚Šæ¬„
    function toggleRank() {
        const sidebar = document.getElementById('rankSidebar');
        const overlay = document.getElementById('rankOverlay'); // ç¢ºä¿ HTML æœ‰é€™å€‹é®ç½© div

        if (sidebar.classList.contains('translate-x-full')) {
            // é–‹å•Ÿ
            sidebar.classList.remove('translate-x-full');
            if(overlay) overlay.classList.remove('hidden');
            // è¼‰å…¥ç•¶å‰åˆ†é è³‡æ–™
            switchRankTab(currentRankMode); 
        } else {
            // é—œé–‰
            sidebar.classList.add('translate-x-full');
            if(overlay) overlay.classList.add('hidden');
        }
    }

    // åˆ‡æ›åˆ†é é‚è¼¯
    function switchRankTab(mode) {
        currentRankMode = mode;
        const tabs = ['adventure', 'coop', 'pvp'];
        const rankList = document.getElementById('rankList');

        // 1. æ›´æ–°æŒ‰éˆ•æ¨£å¼
        tabs.forEach(t => {
            const btn = document.getElementById(`tab-${t}`);
            if (t === mode) {
                // æ¿€æ´»æ¨£å¼
                btn.className = "flex-1 py-3 text-sm font-bold text-yellow-400 border-b-2 border-yellow-400 bg-slate-800 transition-colors";
            } else {
                // éæ¿€æ´»æ¨£å¼
                btn.className = "flex-1 py-3 text-sm font-bold text-slate-400 border-b-2 border-transparent hover:text-white transition-colors";
            }
        });

        // 2. æ ¹æ“šæ¨¡å¼è¼‰å…¥å…§å®¹
        if (mode === 'adventure') {
            loadAdventureRanking();
        } else if (mode === 'coop') {
            rankList.innerHTML = `
                <div class="flex flex-col items-center justify-center h-64 text-slate-500">
                    <div class="text-4xl mb-4">ğŸ¤</div>
                    <p>åˆä½œæ¨¡å¼æ’è¡Œæ¦œ</p>
                    <p class="text-xs mt-2 text-slate-600">å³å°‡æ¨å‡º</p>
                </div>`;
        } else if (mode === 'pvp') {
            rankList.innerHTML = `
                <div class="flex flex-col items-center justify-center h-64 text-slate-500">
                    <div class="text-4xl mb-4">âš”ï¸</div>
                    <p>PVP å°æˆ°æ’è¡Œæ¦œ</p>
                    <p class="text-xs mt-2 text-slate-600">å³å°‡æ¨å‡º</p>
                </div>`;
        }
    }

    // --- è®€å–ã€é—œå¡æ¦œã€‘é‚è¼¯ ---
    async function loadAdventureRanking() {
        const rankList = document.getElementById('rankList');
        rankList.innerHTML = '<div class="text-center text-slate-500 mt-10"><div class="animate-spin text-2xl mb-2">ğŸ²</div>è¼‰å…¥æ•¸æ“šä¸­...</div>';
        
        try {
           const snapshot = await fs.collection("users")
                .where("dice_data.unlockLevel", ">", 1) // æ¢ä»¶ï¼šåªæŠ“å–è§£é–ç­‰ç´š > 1 çš„äºº (å³é€šéç¬¬1é—œ)
                .orderBy("dice_data.unlockLevel", "desc") 
                .limit(10) 
                .get();

            let html = '';
            let i = 1;
            const now = Date.now();

            snapshot.forEach(doc => {
                const data = doc.data();
                const userAssets = data.assets || {};
                
                // é˜²å‘†ï¼šå¦‚æœè©²ç©å®¶é‚„æ²’ç©éï¼Œå¯èƒ½æ²’æœ‰ dice_data
                const diceData = data.dice_data || {};
                // é è¨­é—œå¡ç‚º 1
                const maxStage = diceData.unlockLevel || 1; 

                // --- ç¨±è™ŸéæœŸåˆ¤æ–· ---
                let titleText = data.equipped_title || "";
                if (titleText) {
                    const titleObj = SHOP_DATA.title.find(t => t.name === titleText);
                    // å¦‚æœæ‰¾ä¸åˆ°å•†å“ID æˆ– ç•¶å‰æ™‚é–“ > åˆ°æœŸæ™‚é–“ï¼Œå‰‡ç§»é™¤ç¨±è™Ÿ
                    if (titleObj && userAssets[titleObj.id] && now > userAssets[titleObj.id]) {
                        titleText = "";
                    }
                }

                // --- ç‰¹æ•ˆéæœŸåˆ¤æ–· ---
                let fxClass = data.equipped_fx || "";
                if (fxClass) {
                    const effectObj = SHOP_DATA.effect.find(e => e.class === fxClass);
                    if (effectObj && userAssets[effectObj.id] && now > userAssets[effectObj.id]) {
                        fxClass = "";
                    }
                }

                // --- ç¨±è™Ÿé¡è‰²è™•ç† ---
                let titleColorClass = "t-blue";
                if (titleText.includes("å¹¸é‹éŒ¦é¯‰")) titleColorClass = "t-koi-color";
                else if (titleText.includes("è³­ç¥") || titleText.includes("å¯Œå¯æ•µåœ‹") || titleText.includes("è‡³å°Š")) titleColorClass = "t-red";
                else if (titleText.includes("å‚³å¥‡") || titleText.includes("å¤©é¸")) titleColorClass = "t-orange";
                else if (titleText.includes("åœŸè±ª") || titleText.includes("åƒé‡‘")) titleColorClass = "t-purple";
                else if (titleText.includes("å¹¸é‹")) titleColorClass = "t-yellow";

                const titleHTML = titleText ? `<span class="player-title ${titleColorClass}">ã€${titleText}ã€‘</span>` : "";

                // --- ç”¢ç”Ÿ HTML (å–®äººæ¦œæ¨£å¼) ---
                // å‰ä¸‰åæœ‰ä¸åŒé¡è‰²çš„çç›ƒæˆ–æ•¸å­—
                let rankDisplay = `<span class="text-slate-500 font-bold">${i}</span>`;
                if (i === 1) rankDisplay = `<span class="text-2xl">ğŸ¥‡</span>`;
                if (i === 2) rankDisplay = `<span class="text-2xl">ğŸ¥ˆ</span>`;
                if (i === 3) rankDisplay = `<span class="text-2xl">ğŸ¥‰</span>`;

                html += `
                    <div class="rank-item ${fxClass} flex items-center bg-slate-800 p-3 rounded-lg border border-slate-700 relative overflow-hidden transition-transform hover:scale-[1.02]">
                        <div class="w-10 text-center flex-shrink-0">
                            ${rankDisplay}
                        </div>
                        
                        <div class="flex-1 px-2 min-w-0">
                            <div class="text-[10px] mb-0.5 whitespace-nowrap overflow-hidden text-ellipsis">${titleHTML}</div>
                            <div class="text-white font-bold text-sm truncate">${data.name || 'ç„¡åæ°'}</div>
                        </div>

                        <div class="text-right flex-shrink-0">
                            <div class="text-blue-400 font-black text-xl leading-none">${maxStage}</div>
                            <div class="text-[9px] text-slate-500 mt-1">é—œå¡</div>
                        </div>
                    </div>
                `;
                i++;
            });

            if (html === '') {
                rankList.innerHTML = '<p class="text-center text-slate-500 mt-10">å°šç„¡ç©å®¶è³‡æ–™</p>';
            } else {
                rankList.innerHTML = html;
            }

        } catch (e) {
            console.error("è¼‰å…¥å¤±æ•—:", e);
            // æç¤ºç´¢å¼•éŒ¯èª¤
            rankList.innerHTML = '<p class="text-center text-red-400 mt-10 text-sm">è¼‰å…¥å¤±æ•—<br>è«‹æª¢æŸ¥ Firebase ç´¢å¼•è¨­å®š</p>';
        }
    }
        function startBattle() {
            saveData();
            window.location.href = 'dice_battle.html';
        }

        window.onload = async function () {
            userData = initGameData();

            // 2. æ ¸å¿ƒä¿®æ­£ï¼šå°‡ localStorage çš„ player_id ç¶å®šçµ¦ userData
            userData.uid = userId;

            // 3. å…ˆç•«å‡ºä»‹é¢
            render();

            // 4. å¾é›²ç«¯åŒæ­¥æœ€æ–°é€²åº¦ (åŒ…å« dice_data èˆ‡ balance)
            await syncFromCloud();
        };
    </script>
</body>

</html>