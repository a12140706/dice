<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
<title>ÂØ∂Áü≥Á§¶Âùë</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ÈòøË®òÂ®õÊ®ÇÂüé">
<meta name="mobile-web-app-capable" content="yes">

<style>
  :root {
    --bg-dark: #1a0f0f; --btn-gold: #ffbe0b; --text-light: #fefefe;
    --game-width: 80vw; --game-height: 70vh; --grid-size: 5;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; touch-action: manipulation; font-family: "Microsoft JhengHei", Arial, sans-serif; }
  body { 
    height: 100dvh; width: 100vw; overflow: hidden; background: var(--bg-dark); color: var(--text-light);
    display: flex; flex-direction: column; justify-content: space-between; align-items: center;
    padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right);
    transition: background 0.5s ease;
  }
  
  @media (orientation: portrait) {
    .portrait-tip {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh;
      background: #1a0505; z-index: 9999; display: flex; flex-direction: column;
      justify-content: center; align-items: center; text-align: center; color: #fff; font-size: 24px;
    }
  }
  @media (orientation: landscape) { .portrait-tip { display: none; } }

  .top-bar {
    width: 100%; height: 50px; background: linear-gradient(#4a0404, #2a0202);
    display: flex; justify-content: space-between; align-items: center; padding: 0 15px; flex-shrink: 0; border-bottom: 2px solid #5c0a0a;
  }
  .sound-controls { display: flex; gap: 8px; }
  .sound-btn {
    background: rgba(255,255,255,0.1); border: 1px solid var(--btn-gold);
    color: #fff; padding: 4px 8px; border-radius: 8px; font-size: 12px; cursor: pointer;
  }
  .balance-display { background: rgba(0,0,0,0.4); border: 1px solid var(--btn-gold); border-radius: 10px; padding: 5px 12px; font-weight: bold; color: var(--btn-gold); font-size: 16px; }

  .game-area { display: flex; flex-direction: column; justify-content: center; align-items: center; flex: 1; width: var(--game-width); max-width: 900px; position: relative; padding: 10px; }
  .gem-grid {
    display: grid; grid-template-columns: repeat(var(--grid-size), 1fr); grid-template-rows: repeat(var(--grid-size), 1fr);
    gap: 2px; background: rgba(0,0,0,0.5); border: 5px solid #3d2b0e; border-radius: 10px;
    width: min(calc(var(--game-height) * 0.9), var(--game-width) * 0.7); aspect-ratio: 1 / 1; max-width: 500px; overflow: hidden;
  }
  .grid-cell { background: #2b1f0d; display: flex; justify-content: center; align-items: center; font-size: clamp(20px, 5vw, 40px); border-radius: 3px; position: relative; }
  .gem { position: absolute; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; font-size: inherit; transition: transform 0.3s ease-out, opacity 0.3s ease-out; will-change: transform, opacity; }
  .gem.dropping { transform: translateY(-100%); transition: transform 0s; }
  .gem.dropped { transform: translateY(0); transition: transform 0.3s ease-out; }
  .gem.vanishing { animation: vanish 0.4s ease-out forwards; pointer-events: none; }
  @keyframes vanish { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.8; } 100% { transform: scale(0); opacity: 0; } }

  .message-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); border: 2px solid var(--btn-gold); border-radius: 10px; padding: 15px 25px; font-size: 20px; font-weight: bold; z-index: 100; display: none; text-align: center; white-space: pre-wrap; }

  .bottom-bar { width: 100%; height: 80px; background: linear-gradient(#333, #111); display: flex; justify-content: center; align-items: center; gap: 20px; flex-shrink: 0; border-top: 2px solid #555; padding-bottom: env(safe-area-inset-bottom); }
  .bet-control { display: flex; align-items: center; background: rgba(0,0,0,0.4); border-radius: 50px; border: 1px solid #555; padding: 2px 10px; gap: 5px; }
  .bet-btn { background: none; border: none; color: var(--btn-gold); font-size: 28px; padding: 0 10px; cursor: pointer; }
  .auto-btn { background: #333; color: #fff; border: 2px solid #777; padding: 10px 15px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
  .auto-active { background: #2ecc71; border-color: #fff; box-shadow: 0 0 15px #2ecc71; color: #000; }
  .spin-btn { background: var(--btn-gold); color: #000; font-size: 24px; font-weight: bold; padding: 10px 30px; border-radius: 15px; border: none; cursor: pointer; box-shadow: 0 5px 0 #b38b00; transition: all 0.1s ease; }
  .spin-btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #b38b00; }
  .spin-btn:disabled { background: #555; box-shadow: 0 2px 0 #333; color: #888; cursor: not-allowed; }
  .win-display { font-size: 22px; color: #2ecc71; font-weight: bold; min-width: 100px; text-align: center; }
</style>
</head>
<body>
<div class="portrait-tip"><div style="font-size: 50px;">üîÑ</div><p style="margin-top: 20px;">Ê©´ËëóÁé©</p></div>

<div class="top-bar">
  <div class="sound-controls">
    <button class="sound-btn" onclick="toggleMute()" id="muteBtn">üîä</button>
    <button class="sound-btn" onclick="cycleBGM()" id="bgmBtn">üéµ Èü≥Ê®Ç 1</button>
  </div>
  <div class="balance-display">üí∞ <span id="balanceText">10000</span></div>
  <a href="index.html" style="text-decoration:none;"><button class="sound-btn">üè† ÂõûÂ§ßÂª≥</button></a>
</div>

<div class="game-area">
  <div class="gem-grid" id="gemGrid"></div>
  <div class="message-box" id="messageBox"></div>
</div>

<div class="bottom-bar">
  <div class="bet-control">
    <button class="bet-btn" onclick="changeBet(-1)">‚óÄ</button>
    <div class="bet-info"><div id="betDisplay" style="font-size: 20px; color: var(--btn-gold); font-weight: bold;">$50</div></div>
    <button class="bet-btn" onclick="changeBet(1)">‚ñ∂</button>
  </div>
  <button id="autoBtn" class="auto-btn" onclick="toggleAuto()">Ëá™ÂãïÁé©</button>
  <button class="spin-btn" id="spinBtn" onclick="startSpin()">ÊãâÂêß</button>
  <div class="win-display">WIN: <span id="winAmount">0</span></div>
</div>

<audio id="sndSpin" src="https://assets.mixkit.co/active_storage/sfx/2045/2045-preview.mp3" preload="auto"></audio>
<audio id="sndWin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
<audio id="sndExplode" src="https://assets.mixkit.co/active_storage/sfx/1461/1461-preview.mp3" preload="auto"></audio>
<audio id="sndSuperWin" src="https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3" preload="auto"></audio>
<audio id="bgm1" src="background-music-434612.mp3" loop preload="auto"></audio>
<audio id="bgm2" src="soft-background-music-427252.mp3" loop preload="auto"></audio>
<audio id="bgm3" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" loop preload="auto"></audio>
<audio id="bgmCrazy" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" loop preload="auto"></audio>

<script>
let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 10000;
let currentBet = 50;
let lastWin = 0;
let isSpinning = false;
let isMuted = false;
let isCrazyMode = false;
let isAuto = false;
let currentBgmIdx = 1;
const bgmList = [null, 'bgm1', 'bgm2', 'bgm3'];
const GRID_SIZE = 5;
const betOptions = [10, 50, 100, 300, 500, 1000];
let currentBetIdx = 1;

// ÈÅäÊà≤ÈÇèËºØËÆäÊï∏
let hasBombThisTurn = false;
let grid = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill(null));

const GEMS = ['üíé','üí∞','üí∞','üîÆ','üîÆ','üçè','üçè','üèÆ','üèÆ','üåü','üåü','üåü','‚ú®','‚ú®','‚ú®','‚õèÔ∏è','‚õèÔ∏è','‚õèÔ∏è','‚õèÔ∏è','ü™®','ü™®','ü™®','ü™®','ü™µ','ü™µ','ü™µ','ü™µ','üí£'];
const CRAZY_POOL = ['üíé','üí∞','üí∞','üåü','üåü','üåü','‚ú®','‚ú®','‚ú®','ü™®','ü™®','ü™®','ü™®','ü™®','ü™µ','ü™µ','ü™µ','ü™µ','ü™µ','üîÆ','üîÆ','üçè','üçè','üèÆ','üèÆ','‚õèÔ∏è','‚õèÔ∏è','‚õèÔ∏è','‚õèÔ∏è','üí£','üí£','üí£'];
const GEM_VALUES = { 'üíé': 5, 'üí∞': 3, 'üîÆ': 3, 'üçè': 3, 'üèÆ': 3, 'üåü': 2, '‚ú®': 2, '‚õèÔ∏è': 1, 'ü™®': 0.5, 'ü™µ': 0.5, 'üí£': 0 };

function wait(ms) { return new Promise(res => setTimeout(res, ms)); }

function updateUI() {
    currentBet = betOptions[currentBetIdx];
    document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString();
    document.getElementById('winAmount').textContent = Math.floor(lastWin).toLocaleString();
    document.getElementById('betDisplay').textContent = "$" + currentBet;
}

// ================= Èü≥Ê®ÇÊéßÂà∂Á≥ªÁµ± =================

function stopAllBGM() {
    bgmList.forEach(id => { if(id) { const a = document.getElementById(id); a.pause(); a.muted = true; } });
    const crazy = document.getElementById('bgmCrazy');
    crazy.pause(); crazy.muted = true;
}

function cycleBGM(shouldNext = true) {
    stopAllBGM();
    if (shouldNext) currentBgmIdx = (currentBgmIdx + 1) % 4;
    const btn = document.getElementById('bgmBtn');
    
    if (currentBgmIdx === 0) {
        btn.textContent = 'üö´ Èü≥Ê®ÇÈóú';
    } else {
        btn.textContent = 'üéµ Èü≥Ê®Ç ' + currentBgmIdx;
        if (!isMuted && !isCrazyMode) {
            const bgm = document.getElementById(bgmList[currentBgmIdx]);
            if (bgm) { bgm.muted = false; bgm.volume = 0.3; bgm.play().catch(()=>{}); }
        }
    }
}

function toggleMute() {
    isMuted = !isMuted;
    document.getElementById('muteBtn').textContent = isMuted ? 'üîá' : 'üîä';
    if (isMuted) stopAllBGM();
    else {
        if (isCrazyMode) {
            const crazy = document.getElementById('bgmCrazy');
            crazy.muted = false; crazy.play().catch(()=>{});
        } else {
            cycleBGM(false);
        }
    }
}

// Ê†∏ÂøÉËß£ÈéñÔºöÁßªÊ§çÈ™∞ÂØ∂ÊñπÊ°à
function unlockAudio() {
    const audios = document.querySelectorAll('audio');
    audios.forEach(a => {
        const oldMuted = a.muted;
        a.muted = true;
        a.play().then(() => {
            a.pause();
            a.currentTime = 0;
            a.muted = oldMuted;
        }).catch(() => {});
    });

    setTimeout(() => {
        if (!isMuted && currentBgmIdx !== 0 && !isCrazyMode) {
            const bgm = document.getElementById(bgmList[currentBgmIdx]);
            if (bgm) { bgm.muted = false; bgm.volume = 0.3; bgm.play().catch(()=>{}); }
        }
    }, 150);
    document.removeEventListener('click', unlockAudio);
    document.removeEventListener('touchstart', unlockAudio);
}
document.addEventListener('click', unlockAudio);
document.addEventListener('touchstart', unlockAudio);

// ================= ÈÅäÊà≤Ê†∏ÂøÉÈÇèËºØ =================

function processBombCheck() {
    let count = 0;
    grid.forEach(row => row.forEach(cell => { 
        if (cell === 'üí£') { count++; hasBombThisTurn = true; } 
    }));
    
    if (count >= 3 && !isCrazyMode) {
        isCrazyMode = true;
        document.body.style.background = "#4a0404";
        showMessage("üö® ÈÄ≤ÂÖ•ÁòãÁãÇÊ®°ÂºèÔºÅ üö®");
        stopAllBGM();
        if (!isMuted) {
            const crazyBgm = document.getElementById('bgmCrazy');
            crazyBgm.muted = false; crazyBgm.volume = 0.4; crazyBgm.play().catch(()=>{});
        }
    }
}

async function startSpin() {
    if (isSpinning) return;
    if (!isCrazyMode && balance < currentBet) { showMessage("ÁâüÂêâÈòø"); if (isAuto) toggleAuto(); return; }
    
    if (!isCrazyMode) balance -= currentBet;
    isSpinning = true;
    document.getElementById('spinBtn').disabled = true;
    
    let totalWinInThisTurn = 0;
    hasBombThisTurn = false;
    updateUI();

    try {
        if(!isMuted) document.getElementById('sndSpin').play().catch(()=>{});
        await fillGrid(true);
        processBombCheck(); 

        let combo = true;
        while (combo) {
            let matches = findMatches();
            if (matches.length > 0) {
                let win = calculateWin(matches);
                totalWinInThisTurn += win;
                lastWin = totalWinInThisTurn;
                balance += win; updateUI();
                if(!isMuted) document.getElementById('sndWin').cloneNode().play().catch(()=>{});
                await eliminate(matches);
                await drop();
                await fillGrid(false);
                processBombCheck();
                continue;
            }
            
            let bombResult = await explodeBombs();
            if (bombResult.exploded) {
                hasBombThisTurn = true;
                totalWinInThisTurn += bombResult.win;
                lastWin = totalWinInThisTurn;
                balance += bombResult.win; updateUI();
                await drop();
                await fillGrid(false);
                processBombCheck();
                continue;
            }
            combo = false;
        }

        // ÁµêÊùüÂæåÂÜ∑ÂçªÂà§ÂÆö
        if (isCrazyMode && !hasBombThisTurn) {
            isCrazyMode = false;
            document.body.style.background = "#1a0f0f";
            showMessage("Á§¶ÂùëÂ∑≤Á∂ìÂÜ∑Âçª");
            stopAllBGM();
            if (!isMuted && currentBgmIdx !== 0) {
                const originalBgm = document.getElementById(bgmList[currentBgmIdx]);
                if (originalBgm) { originalBgm.muted = false; originalBgm.play().catch(()=>{}); }
            }
        }

        if (totalWinInThisTurn >= currentBet * 50) {
            if(!isMuted) document.getElementById('sndSuperWin').play().catch(()=>{});
            showMessage("üéä MEGA WIN üéä\nüí∞ " + Math.floor(totalWinInThisTurn).toLocaleString());
        }
        
    } finally {
        isSpinning = false;
        document.getElementById('spinBtn').disabled = false;
        localStorage.setItem('sicbo_balance', balance);
        updateUI();
        if (isAuto || isCrazyMode) {
            setTimeout(() => { if (!isSpinning) startSpin(); }, 1200);
        }
    }
}

async function fillGrid(isInitial) {
    const pool = isCrazyMode ? CRAZY_POOL : GEMS;
    if(isInitial) {
        for(let r=0; r<GRID_SIZE; r++) for(let c=0; c<GRID_SIZE; c++) {
            grid[r][c] = null; document.getElementById(`cell-${r}-${c}`).innerHTML = '';
        }
    }
    for (let c = 0; c < GRID_SIZE; c++) {
        for (let r = 0; r < GRID_SIZE; r++) {
            if (grid[r][c] === null) {
                let type = pool[Math.floor(Math.random() * pool.length)];
                grid[r][c] = type;
                const cell = document.getElementById(`cell-${r}-${c}`);
                cell.innerHTML = `<div class="gem dropping">${type}</div>`;
                const gem = cell.firstChild;
                setTimeout(() => { gem.classList.remove('dropping'); gem.classList.add('dropped'); }, 10);
            }
        }
    }
    await wait(400);
}

async function eliminate(matches) {
    matches.forEach(m => {
        const cell = document.getElementById(`cell-${m.r}-${m.c}`);
        if(cell.firstChild) cell.firstChild.classList.add('vanishing');
        grid[m.r][m.c] = null;
    });
    await wait(400);
    matches.forEach(m => { document.getElementById(`cell-${m.r}-${m.c}`).innerHTML = ''; });
}

async function explodeBombs() {
    let bombs = [];
    grid.forEach((row, r) => row.forEach((type, c) => { if(type === 'üí£') bombs.push({r, c}); }));
    if (bombs.length === 0) return { exploded: false };

    if(!isMuted) document.getElementById('sndExplode').cloneNode().play().catch(()=>{});
    if (window.navigator.vibrate) window.navigator.vibrate([100, 50, 100]);
    
    let win = 0; let targets = new Set();
    bombs.forEach(b => {
        for(let i=b.r-1; i<=b.r+1; i++) for(let j=b.c-1; j<=b.c+1; j++) {
            if(i>=0 && i<GRID_SIZE && j>=0 && j<GRID_SIZE) {
                targets.add(`${i},${j}`);
                if(isCrazyMode && grid[i][j] && grid[i][j]!=='üí£') win += currentBet * GEM_VALUES[grid[i][j]] * 0.1;
            }
        }
    });
    targets.forEach(t => {
        let [r, c] = t.split(',').map(Number);
        const cell = document.getElementById(`cell-${r}-${c}`);
        if(cell.firstChild) cell.firstChild.classList.add('vanishing');
        grid[r][c] = null;
    });
    await wait(400);
    targets.forEach(t => {
        let [r, c] = t.split(',').map(Number);
        document.getElementById(`cell-${r}-${c}`).innerHTML = '';
    });
    return { exploded: true, win };
}

async function drop() {
    for (let c = 0; c < GRID_SIZE; c++) {
        let empty = 0;
        for (let r = GRID_SIZE - 1; r >= 0; r--) {
            if (grid[r][c] === null) empty++;
            else if (empty > 0) {
                grid[r + empty][c] = grid[r][c]; grid[r][c] = null;
                const oldCell = document.getElementById(`cell-${r}-${c}`);
                const newCell = document.getElementById(`cell-${r+empty}-${c}`);
                newCell.innerHTML = oldCell.innerHTML; oldCell.innerHTML = '';
            }
        }
    }
    await wait(300);
}

function findMatches() {
    let matched = [];
    for(let r=0; r<GRID_SIZE; r++) for(let c=0; c<GRID_SIZE-2; c++) {
        if(grid[r][c] && grid[r][c]==grid[r][c+1] && grid[r][c]==grid[r][c+2]) matched.push({r,c}, {r,c:c+1}, {r,c:c+2});
    }
    for(let c=0; c<GRID_SIZE; c++) for(let r=0; r<GRID_SIZE-2; r++) {
        if(grid[r][c] && grid[r][c]==grid[r+1][c] && grid[r][c]==grid[r+2][c]) matched.push({r,c}, {r:r+1,c}, {r:r+2,c});
    }
    const unique = []; const seen = new Set();
    matched.forEach(m => { const k = `${m.r}-${m.c}`; if(!seen.has(k)){ unique.push(m); seen.add(k); }});
    return unique;
}

function calculateWin(matches) {
    let win = 0; let counts = {};
    matches.forEach(m => { let t = grid[m.r][m.c]; if(t) counts[t] = (counts[t]||0)+1; });
    for(let t in counts) {
        const c = counts[t]; const base = GEM_VALUES[t] || 1;
        let mult = c >= 5 ? 12 : (c === 4 ? 5 : 1.5);
        win += currentBet * base * mult;
    }
    return win;
}

function showMessage(msg) { const b = document.getElementById('messageBox'); b.innerText = msg; b.style.display = 'block'; setTimeout(()=> b.style.display = 'none', 2000); }
function toggleAuto() { isAuto = !isAuto; const btn = document.getElementById('autoBtn'); btn.classList.toggle('auto-active', isAuto); if(isAuto && !isSpinning) startSpin(); }
function changeBet(dir) { if (isSpinning) return; currentBetIdx = Math.max(0, Math.min(betOptions.length - 1, currentBetIdx + dir)); updateUI(); }

// È†ÅÈù¢ÂàùÂßãÂåñ
window.onload = async () => {
    const gridEl = document.getElementById('gemGrid');
    gridEl.innerHTML = '';
    for(let r=0; r<GRID_SIZE; r++) {
        for(let c=0; c<GRID_SIZE; c++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.id = `cell-${r}-${c}`;
            gridEl.appendChild(cell);
        }
    }
    updateUI();
    setTimeout(async () => {
        await fillGrid(true);
    }, 300);
};
</script>
</body>
</html>