<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
<title>ç¤¦å‘å¯¶çŸ³</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="é˜¿è¨˜å¨›æ¨‚åŸ">
<meta name="mobile-web-app-capable" content="yes">

<style>
  .sound-controls {
    display: flex;
    gap: 8px;
  }
  .sound-btn {
    background: rgba(255,255,255,0.1);
    border: 1px solid var(--btn-gold);
    color: #fff;
    padding: 4px 8px;
    border-radius: 8px;
    font-size: 12px;
    cursor: pointer;
  }
  :root {
    --bg-dark: #1a0f0f;
    --btn-gold: #ffbe0b;
    --text-light: #fefefe;
    --game-width: 80vw;
    --game-height: 70vh;
    --grid-size: 5; /* 5x5 çš„ç¶²æ ¼ */
  }

  * { 
    box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent; 
    margin: 0; padding: 0; 
    touch-action: manipulation;
    font-family: "Microsoft JhengHei", Arial, sans-serif;
  }
  body { 
    height: 100dvh; width: 100vw; overflow: hidden;
    background: var(--bg-dark); color: var(--text-light);
    display: flex; flex-direction: column; justify-content: space-between; align-items: center;
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
  }

  /* å¼·åˆ¶æ©«å‘æç¤º */
  @media (orientation: portrait) {
    .portrait-tip {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh;
      background: #1a0505; z-index: 9999; display: flex; flex-direction: column;
      justify-content: center; align-items: center; text-align: center; color: #fff;
      font-size: 24px;
    }
  }
  @media (orientation: landscape) { .portrait-tip { display: none; } }

  .top-bar {
    width: 100%; height: 50px; background: linear-gradient(#4a0404, #2a0202);
    display: flex; justify-content: space-between; align-items: center;
    padding: 0 15px; flex-shrink: 0; border-bottom: 2px solid #5c0a0a;
  }
  .balance-display {
    background: rgba(0,0,0,0.4); border: 1px solid var(--btn-gold); border-radius: 10px;
    padding: 5px 12px; font-weight: bold; color: var(--btn-gold); font-size: 16px;
  }
  .home-btn {
    background: none; border: 1px solid #777; color: #ccc; border-radius: 5px;
    padding: 5px 12px; font-size: 14px; cursor: pointer;
  }
  .bet-control {
  display: flex;
  align-items: center;
  background: rgba(0,0,0,0.4);
  border-radius: 50px;
  border: 1px solid #555;
  padding: 2px 10px;
  gap: 5px;
}

/* è®“ç±Œç¢¼é¡¯ç¤ºå€å¡Šå›ºå®šå¯¬åº¦ï¼Œæ•¸å­—æ‰ä¸æœƒè·³å‹• */
.bet-info {
  text-align: center;
  min-width: 60px;
}
  /* éŠæˆ²ä¸»å€åŸŸ */
  .game-area {
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    flex: 1; width: var(--game-width); max-width: 900px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
    position: relative;
    padding: 10px;
  }

  /* å¯¶çŸ³ç¶²æ ¼ */
  .gem-grid {
    display: grid;
    grid-template-columns: repeat(var(--grid-size), 1fr);
    grid-template-rows: repeat(var(--grid-size), 1fr);
    gap: 2px;
    background: rgba(0,0,0,0.5);
    border: 5px solid #3d2b0e;
    border-radius: 10px;
    width: min(calc(var(--game-height) * 0.9), var(--game-width) * 0.7); /* è®“ç¶²æ ¼ç›¡é‡æ–¹å½¢ä¸¦é©æ‡‰å¯¬åº¦ */
    aspect-ratio: 1 / 1; /* å¼·åˆ¶æ­£æ–¹å½¢ */
    max-width: 500px;
    overflow: hidden; /* éš±è—æ‰è½å‰çš„å¯¶çŸ³ */
  }

  .grid-cell {
    background: #2b1f0d;
    display: flex; justify-content: center; align-items: center;
    font-size: clamp(20px, 5vw, 40px); /* è®“å¯¶çŸ³å¤§å°è‡ªé©æ‡‰ */
    border-radius: 3px;
    position: relative;
  }

  .gem {
    position: absolute;
    width: 100%; height: 100%;
    display: flex; justify-content: center; align-items: center;
    font-size: inherit;
    transition: transform 0.3s ease-out, opacity 0.3s ease-out; /* æ‰è½èˆ‡æ¶ˆé™¤å‹•ç•« */
    will-change: transform, opacity;
  }

  .gem.dropping {
    transform: translateY(-100%); /* æ¨¡æ“¬å¾ä¸Šæ–¹æ‰è½ */
    transition: transform 0s; /* æ‰è½å‰ç¬é–“æ­¸ä½ */
  }
  .gem.dropped {
    transform: translateY(0);
    transition: transform 0.3s ease-out;
  }
  .gem.vanishing {
    animation: vanish 0.4s ease-out forwards; /* æ¶ˆé™¤å‹•ç•« */
    pointer-events: none;
  }

  @keyframes vanish {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.8; }
    100% { transform: scale(0); opacity: 0; }
  }
  .auto-btn {
  background: #333;
  color: #fff;
  border: 2px solid #777;
  padding: 10px 15px;
  border-radius: 12px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}

/* è‡ªå‹•ç©é–‹å•Ÿæ™‚çš„ç‹€æ…‹ */
.auto-active {
  background: #2ecc71; /* è®Šæˆç¶ è‰² */
  border-color: #fff;
  box-shadow: 0 0 15px #2ecc71;
  color: #000;
}
.bet-selector-new {
  display: flex;
  align-items: center;
  background: rgba(0,0,0,0.4);
  border-radius: 50px;
  border: 2px solid #555;
  padding: 5px 15px;
  gap: 10px;
}
.bet-btn {
  background: none;
  border: none;
  color: var(--btn-gold);
  font-size: 28px;
  padding: 0 10px;
  cursor: pointer;
  transition: transform 0.1s;
}
.bet-btn:active { transform: scale(1.2); }
.bet-info { text-align: center; min-width: 70px; }

  /* éŠæˆ²è¨Šæ¯èˆ‡çµæœ */
  .message-box {
    position: absolute;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.8); border: 2px solid var(--btn-gold); border-radius: 10px;
    padding: 15px 25px; font-size: 20px; font-weight: bold; z-index: 100;
    display: none; /* é è¨­éš±è— */
  }

  /* åº•éƒ¨æ“ä½œå€ */
  .bottom-bar {
    width: 100%; height: 80px; background: linear-gradient(#333, #111);
    display: flex; justify-content: center; align-items: center;
    gap: 20px; flex-shrink: 0; border-top: 2px solid #555;
    padding-bottom: env(safe-area-inset-bottom); /* é¿é–‹åº•éƒ¨å®‰å…¨å€ */
  }
  .spin-btn {
    background: var(--btn-gold); color: #000; font-size: 24px; font-weight: bold;
    padding: 10px 30px; border-radius: 15px; border: none; cursor: pointer;
    box-shadow: 0 5px 0 #b38b00; transition: all 0.1s ease;
  }
  .spin-btn:active {
    transform: translateY(3px);
    box-shadow: 0 2px 0 #b38b00;
  }
  .win-display {
    font-size: 22px; color: #2ecc71; font-weight: bold;
    min-width: 100px; text-align: center;
  }
</style>
</head>
<div class="portrait-tip">
  <div style="font-size: 50px;">ğŸ”„</div>
  <p style="margin-top: 20px;">æ©«è‘—ç©</p>
</div>

<div class="top-bar">
  <div class="sound-controls">
    <button class="sound-btn" onclick="toggleMute()" id="muteBtn">ğŸ”Š</button>
    <button class="sound-btn" onclick="cycleBGM()" id="bgmBtn">ğŸµ éŸ³æ¨‚ 1</button>
  </div>
  <div class="balance-display">ğŸ’° <span id="balanceText">10000</span></div>
  <a href="index.html" style="text-decoration:none;">
    <button class="sound-btn">ğŸ  å›å¤§å»³</button>
  </a>
</div>

<div class="game-area">
  <div class="gem-grid" id="gemGrid"></div>
  <div class="message-box" id="messageBox"></div>
</div>

<div class="bottom-bar">
  <div class="bet-control">
        <button class="bet-btn" onclick="changeBet(-1)">â—€</button>
    <div class="bet-info">
      <div id="betDisplay" style="font-size: 20px; color: var(--btn-gold); font-weight: bold;">$50</div>
    </div>
    <button class="bet-btn" onclick="changeBet(1)">â–¶</button>
  </div>
  <button id="autoBtn" class="auto-btn" onclick="toggleAuto()">è‡ªå‹•ç©</button>
  <button class="spin-btn" id="spinBtn">æ‹‰å§</button>
  <div class="win-display">WIN: <span id="winAmount">0</span></div>
</div>

<audio id="sndSpin" src="https://assets.mixkit.co/active_storage/sfx/2045/2045-preview.mp3" preload="auto"></audio>
<audio id="sndWin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
<audio id="sndSuperWin" src="https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3" preload="auto"></audio>
<audio id="bgm1" src="background-music-434612.mp3" loop preload="auto"></audio>
<audio id="bgm2" src="soft-background-music-427252.mp3" loop preload="auto"></audio>
<audio id="bgm3" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" loop preload="auto"></audio>

<script>
// --- æ ¸å¿ƒè®Šæ•¸ (å»¶çºŒé˜¿è¨˜çš„è¨­å®š) ---
let balance = parseFloat(localStorage.getItem('gem_slot_balance')) || 10000;
let currentBet = 50;
let lastWin = 0;
let isSpinning = false;
let isMuted = false;
let currentBgmIdx = 1;
const bgmList = [null, 'bgm1', 'bgm2', 'bgm3'];
const GRID_SIZE = 5;
const GEMS = ['ğŸ’', 'ğŸ’°', 'â›ï¸', 'ğŸ’£', 'ğŸŒŸ', 'âœ¨'];
const GEM_VALUES = { 'ğŸ’': 5, 'ğŸ’°': 4, 'ğŸŒŸ': 3, 'âœ¨': 2, 'â›ï¸': 1, 'ğŸ’£': 0.5 };
let grid = [];

// --- éŸ³æ•ˆæ§åˆ¶åŠŸèƒ½ ---
function toggleMute() {
    isMuted = !isMuted;
    document.getElementById('muteBtn').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
}

function cycleBGM() {
    bgmList.forEach(id => { if(id) { const a = document.getElementById(id); a.pause(); a.currentTime = 0; } });
    currentBgmIdx = (currentBgmIdx + 1) % 4;
    const btn = document.getElementById('bgmBtn');
    if (currentBgmIdx === 0) {
        btn.textContent = 'ğŸš« éŸ³æ¨‚é—œ';
    } else {
        const bgm = document.getElementById(bgmList[currentBgmIdx]);
        bgm.volume = 0.3;
        bgm.play().catch(()=>{});
        btn.textContent = 'ğŸµ éŸ³æ¨‚ ' + currentBgmIdx;
    }
}

// è§£é–è¡Œå‹•è£ç½®éŸ³æ•ˆé™åˆ¶
document.addEventListener('click', () => {
    const audios = document.querySelectorAll('audio');
    audios.forEach(a => { a.play().then(()=>{a.pause(); a.currentTime=0;}).catch(()=>{}); });
}, { once: true });

// --- éŠæˆ²é‚è¼¯ ---
window.onload = () => {
  updateUI();
  initGrid();
  document.getElementById('spinBtn').addEventListener('click', startSpin);
  document.getElementById('betAmount').addEventListener('change', (e) => currentBet = parseInt(e.target.value));
};

function updateUI() {
  document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString();
  document.getElementById('winAmount').textContent = lastWin.toLocaleString();
}

function initGrid() {
  const gemGridEl = document.getElementById('gemGrid');
  gemGridEl.innerHTML = '';
  for (let r = 0; r < GRID_SIZE; r++) {
    grid[r] = [];
    for (let c = 0; c < GRID_SIZE; c++) {
      const gemType = GEMS[Math.floor(Math.random() * GEMS.length)];
      grid[r][c] = gemType;
      const cell = document.createElement('div');
      cell.classList.add('grid-cell');
      cell.id = `cell-${r}-${c}`;
      const gemEl = document.createElement('div');
      gemEl.className = 'gem';
      gemEl.textContent = gemType;
      cell.appendChild(gemEl);
      gemGridEl.appendChild(cell);
    }
  }
}

async function startSpin() {
  if (isSpinning) return;
  if (balance < currentBet) { 
    showMessage("é˜¿è¨˜ï¼šæ²’éŒ¢é–‹æŒ–å•¦ï¼"); 
    if (isAuto) toggleAuto(); // æ²’éŒ¢è‡ªå‹•é—œé–‰è‡ªå‹•ç©
    return; 
  }

  isSpinning = true;
  balance -= currentBet;
  lastWin = 0;
  updateUI();
  document.getElementById('spinBtn').disabled = true;
  if(!isMuted) document.getElementById('sndSpin').play().catch(()=>{});

  await fillGridWithNewGems();
  
  let totalChainWin = 0;
  while (true) {
    await new Promise(r => setTimeout(r, 400));
    const matches = findMatches();
    if (matches.length === 0) break;

    const chainWin = calculateWin(matches);
    totalChainWin += chainWin;
    lastWin = totalChainWin;
    balance += chainWin;
    updateUI();

    if(!isMuted) {
      if (chainWin >= currentBet * 10) document.getElementById('sndSuperWin').cloneNode().play().catch(()=>{});
      else document.getElementById('sndWin').cloneNode().play().catch(()=>{});
    }

    await animateElimination(matches);
    await dropGems();
    await fillEmptyCells();
  }

  if (totalChainWin > 0) {
    const msg = totalChainWin >= currentBet * 20 ? "ğŸ”¥ ç¤¦å‘çˆ†ç™¼ ğŸ”¥" : "ä¸­å¤§çï¼";
    showMessage(`${msg}\n+${totalChainWin.toLocaleString()}`);
  }
  
  // --- é‡é»æ”¹å‹•åœ¨é€™è£¡ ---
  isSpinning = false;
  document.getElementById('spinBtn').disabled = false;
  localStorage.setItem('gem_slot_balance', balance);

  // å¦‚æœè‡ªå‹•ç©é–‹å•Ÿä¸­ï¼Œç­‰ 1.2 ç§’å¾Œå†ä¸‹ä¸€è¼ª
  if (isAuto) {
    setTimeout(() => {
      if (isAuto) startSpin(); 
    }, 1200); 
  }
}

// ... (findMatches, calculateWin, animateElimination, dropGems, fillEmptyCells èˆ‡ä¹‹å‰é‚è¼¯ä¸€è‡´) ...
// ç‚ºäº†ç°¡æ½”ï¼Œé€™è£¡ä¿ç•™æ ¸å¿ƒé‚è¼¯ä¸¦ç¢ºä¿ DOM æ“ä½œèˆ‡éŸ³æ•ˆåŒæ­¥

function findMatches() {
  const matches = [];
  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c <= GRID_SIZE - 3; c++) {
      if (grid[r][c] && grid[r][c] === grid[r][c+1] && grid[r][c] === grid[r][c+2]) {
        let len = 3; while(c+len < GRID_SIZE && grid[r][c] === grid[r][c+len]) len++;
        for(let i=0; i<len; i++) matches.push({r, c: c+i, type: grid[r][c]});
        c += len - 1;
      }
    }
  }
  for (let c = 0; c < GRID_SIZE; c++) {
    for (let r = 0; r <= GRID_SIZE - 3; r++) {
      if (grid[r][c] && grid[r][c] === grid[r+1][c] && grid[r][c] === grid[r+2][c]) {
        let len = 3; while(r+len < GRID_SIZE && grid[r][c] === grid[r+len][c]) len++;
        for(let i=0; i<len; i++) matches.push({r: r+i, c, type: grid[r][c]});
        r += len - 1;
      }
    }
  }
  const unique = []; const seen = new Set();
  matches.forEach(m => { const k = `${m.r}-${m.c}`; if(!seen.has(k)){ unique.push(m); seen.add(k); }});
  return unique;
}

function calculateWin(matches) {
  let win = 0; const counts = {};
  matches.forEach(m => { counts[m.type] = (counts[m.type] || 0) + 1; });
  for(const t in counts) {
    const c = counts[t]; const base = GEM_VALUES[t] || 1;
    let mult = c >= 5 ? 15 : (c === 4 ? 6 : 2);
    win += currentBet * base * mult;
  }
  return win;
}

async function animateElimination(matches) {
  const anims = [];
  matches.forEach(m => {
    const el = document.getElementById(`cell-${m.r}-${m.c}`).querySelector('.gem');
    if(el) { el.classList.add('vanishing'); anims.push(new Promise(res => el.onanimationend = res)); }
    grid[m.r][m.c] = null;
  });
  await Promise.all(anims);
  matches.forEach(m => { document.getElementById(`cell-${m.r}-${m.c}`).innerHTML = ''; });
}

async function dropGems() {
  const anims = [];
  for(let c=0; c<GRID_SIZE; c++) {
    let empty = 0;
    for(let r=GRID_SIZE-1; r>=0; r--) {
      if(grid[r][c] === null) empty++;
      else if(empty > 0) {
        const type = grid[r][c]; grid[r+empty][c] = type; grid[r][c] = null;
        const gem = document.getElementById(`cell-${r}-${c}`).querySelector('.gem');
        if(gem) {
          gem.style.transition = 'none';
          document.getElementById(`cell-${r+empty}-${c}`).appendChild(gem);
          gem.style.transform = `translateY(-${empty*100}%)`;
          setTimeout(() => { gem.style.transition = 'transform 0.3s ease-out'; gem.style.transform = 'translateY(0)'; }, 10);
          anims.push(new Promise(res => gem.ontransitionend = res));
        }
      }
    }
  }
  await Promise.all(anims);
}

async function fillEmptyCells() {
  const anims = [];
  for(let c=0; c<GRID_SIZE; c++) {
    for(let r=0; r<GRID_SIZE; r++) {
      if(grid[r][c] === null) {
        const type = GEMS[Math.floor(Math.random()*GEMS.length)]; grid[r][c] = type;
        const cell = document.getElementById(`cell-${r}-${c}`);
        const gem = document.createElement('div'); gem.className = 'gem dropping'; gem.textContent = type;
        cell.appendChild(gem);
        setTimeout(() => { gem.classList.remove('dropping'); gem.classList.add('dropped'); }, 50 + r*50);
        anims.push(new Promise(res => gem.ontransitionend = res));
      }
    }
  }
  await Promise.all(anims);
}

async function fillGridWithNewGems() {
    for (let r=0; r<GRID_SIZE; r++) for(let c=0; c<GRID_SIZE; c++) document.getElementById(`cell-${r}-${c}`).innerHTML = '';
    await new Promise(r => setTimeout(r, 100));
    const anims = [];
    for (let c=0; c<GRID_SIZE; c++) {
        for (let r=0; r<GRID_SIZE; r++) {
            const type = GEMS[Math.floor(Math.random()*GEMS.length)]; grid[r][c] = type;
            const cell = document.getElementById(`cell-${r}-${c}`);
            const gem = document.createElement('div'); gem.className = 'gem dropping'; gem.textContent = type;
            cell.appendChild(gem);
            setTimeout(() => { gem.classList.remove('dropping'); gem.classList.add('dropped'); }, 50 + r*50);
            anims.push(new Promise(res => gem.ontransitionend = res));
        }
    }
    await Promise.all(anims);
}

function showMessage(msg) {
  const box = document.getElementById('messageBox');
  box.innerText = msg; box.style.display = 'block';
  setTimeout(() => box.style.display = 'none', 2000);
}
const betOptions = [10, 50, 100, 300, 500, 1000];
let currentBetIdx = 1; // é è¨­æŒ‡å‘ 50

// 2. æ›´æ–° UI çš„å‡½å¼
function updateUI() {
  currentBet = betOptions[currentBetIdx]; // åŒæ­¥æ›´æ–°å…¨åŸŸè®Šæ•¸ currentBet
  document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString();
  document.getElementById('winAmount').textContent = lastWin.toLocaleString();
  document.getElementById('betDisplay').textContent = "$" + currentBet;
}
let isAuto = false; // è‡ªå‹•ç©ç‹€æ…‹

function toggleAuto() {
  isAuto = !isAuto;
  const btn = document.getElementById('autoBtn');
  if (isAuto) {
    btn.classList.add('auto-active');
    btn.textContent = "åœæ­¢";
    if (!isSpinning) startSpin(); // å¦‚æœç•¶ä¸‹æ²’åœ¨è½‰ï¼Œç«‹å³é–‹å§‹
  } else {
    btn.classList.remove('auto-active');
    btn.textContent = "è‡ªå‹•";
  }
}
// 3. å·¦å³åˆ‡æ›æŒ‰éˆ•çš„å‡½å¼
function changeBet(dir) {
  if (isSpinning) return; // è½‰å‹•ä¸­ä¸èƒ½æ”¹æ³¨
  
  // ç´¢å¼•å¾ªç’°æˆ–é™åˆ¶ç¯„åœ
  currentBetIdx = currentBetIdx + dir;
  if (currentBetIdx < 0) currentBetIdx = 0;
  if (currentBetIdx >= betOptions.length) currentBetIdx = betOptions.length - 1;
  
  // æ’­æ”¾å€‹å°éŸ³æ•ˆï¼ˆé¸é…ï¼‰
  // if(!isMuted) document.getElementById('sndWin').cloneNode().play(); 
  
  updateUI();
}

// 4. è¨˜å¾—åœ¨ window.onload è£¡é¢æŠŠåŸæœ¬çš„ select ç›£è½åˆªæ‰ï¼Œæ”¹å‘¼å«ä¸€æ¬¡ updateUI()
window.onload = () => {
  updateUI();
  initGrid();
  document.getElementById('spinBtn').addEventListener('click', startSpin);
};
</script>
</body>
</html>