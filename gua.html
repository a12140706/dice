<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
<title>2026 è³€æ­²å½©åˆ¸è¡Œ</title>
<style>
  :root {
    --gold: #ffd86b; --red: #ff4757; --bg-red: #b33939; --win-green: #2ecc71;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; touch-action: none; font-family: "Microsoft JhengHei", Arial, sans-serif; }
  
  body { height: 100dvh; width: 100vw; background: #1a0505; color: #fff; display: flex; flex-direction: column; overflow: hidden; }

  /* é ‚éƒ¨æ¬„ */
  .topbar { 
    width: 100%; padding-top: env(safe-area-inset-top); 
    height: calc(60px + env(safe-area-inset-top)); 
    background: linear-gradient(#4a0404, #2a0202); 
    display: flex; align-items: center; padding: 0 15px; gap: 10px; 
    border-bottom: 2px solid #5c0a0a; flex-shrink: 0; z-index: 1000;
  }
  .sound-toggle { background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 8px; border: 1px solid var(--gold); cursor: pointer; font-size: 13px; color: #fff; }
  .balance-box { background: rgba(0,0,0,0.5); border: 1px solid var(--gold); border-radius: 15px; padding: 4px 12px; color: var(--gold); font-weight: bold; font-size: 16px; }

  /* æ«ƒå°ä»‹é¢ */
  #lobby { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; gap: 12px; padding: 20px; overflow-y: auto; }
  .card-option {
    width: 100%; max-width: 320px; background: #fff; color: #333; border-radius: 15px;
    padding: 15px; display: flex; align-items: center; box-shadow: 0 8px 15px rgba(0,0,0,0.4);
    border-left: 10px solid var(--gold); position: relative; cursor: pointer; flex-shrink: 0;
  }
  .price-tag { position: absolute; top: -10px; right: 10px; background: #e67e22; color: #fff; padding: 2px 12px; border-radius: 20px; font-weight: bold; font-size: 14px; }

  /* éŠæˆ²å€åŸŸ */
  #gameRoom { display: none; flex: 1; flex-direction: column; align-items: center; justify-content: center; gap: 15px; }
  #gameRuleDesc { font-size: 14px; color: var(--gold); background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px; }
  
  .scratch-card-container { position: relative; width: 320px; height: 420px; }
  .scratch-card {
    width: 100%; height: 100%; background: #fff; border: 8px solid var(--gold); border-radius: 15px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.6); overflow: hidden; position: relative;
  }

  .card-content { width: 100%; height: 100%; display: grid; padding: 10px; gap: 5px; background: #fff; }
  .layout-numbers { grid-template-rows: 1fr 2.5fr; }
  .layout-symbols { grid-template-columns: 1fr 1fr; grid-template-rows: repeat(3, 1fr); }

  /* é¦¬å¹´ç‰¹æ•ˆæ¨£å¼ */
  .goal-item { background: rgba(0,0,0,0.4); border: 1px solid #777; border-radius: 8px; padding: 4px; text-align: center; transition: all 0.4s ease; }
  .goal-active { 
    background: linear-gradient(145deg, #ff4757, #b33939) !important; 
    border-color: #f1c40f !important; 
    box-shadow: 0 0 15px #ff4757; 
    transform: scale(1.05);
    animation: flash 1s infinite alternate;
  }
  /* é»äº®ç›®æ¨™çš„ç´…ç«ç‰¹æ•ˆ */
.goal-active { 
  background: linear-gradient(145deg, #ff4757, #b33939) !important; 
  border: 2px solid #ffd86b !important; 
  box-shadow: 0 0 20px #ff4757; 
  transform: scale(1.05);
  animation: houseFlash 0.8s infinite alternate;
  z-index: 5;
}
@keyframes houseFlash {
  from { filter: brightness(1); }
  to { filter: brightness(1.5); }
}

/* ä¸­çæ ¼å­çš„é–ƒçˆ */
.item-win { 
  background: #fff3cd !important; 
  border: 2px solid #2ecc71 !important; 
  animation: pulse 0.6s infinite; 
}
  @keyframes flash { from { opacity: 0.8; } to { opacity: 1; box-shadow: 0 0 20px #ffd86b; } }

  .lucky-zone { border-bottom: 2px dashed #e67e22; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fff9f0; }
  .number-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: repeat(3, 1fr); gap: 8px; padding-top: 10px; }

  .prize-item { display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fefefe; border: 1px solid #eee; border-radius: 8px; color: #333; }
  .prize-amount { font-size: 14px; font-weight: bold; color: #d63031; }
  .prize-symbol { font-size: 32px; }
  .item-win { background: #dff9fb !important; border: 2px solid var(--win-green) !important; animation: pulse 0.8s infinite; animation: winPulse 0.8s infinite alternate;}
.goal-active {
  background: rgba(255, 215, 0, 0.4) !important; /* èƒŒæ™¯è®Šé‡‘è‰² */
  border: 2px solid #fff !important;
  box-shadow: 0 0 15px #ffd700; /* é‡‘å…‰å¤–æ¡† */
  transform: scale(1.1); /* ç¨å¾®æ”¾å¤§ */
  animation: houseJump 0.6s infinite alternate ease-in-out;
  z-index: 5;
}
@keyframes winPulse {
  from { transform: scale(1); filter: brightness(1); }
  to { transform: scale(1.1); filter: brightness(1.3); }
}

@keyframes houseJump {
  0% { transform: scale(1.1) translateY(0); }
  100% { transform: scale(1.15) translateY(-5px); } /* å¾€ä¸Šè·³ä¸¦æ”¾å¤§ */
}
  canvas { position: absolute; top: 0; left: 0; z-index: 10; cursor: crosshair; transition: opacity 0.5s; touch-action: none; }
#scratchCanvas {
  position: absolute;
  top: 0;
  left: 0;
  z-index: 10; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
  transition: none !important; /* ç¦ç”¨ä»»ä½•éæ¸¡æ•ˆæœï¼Œé˜²æ­¢é–ƒçˆ */
}

.card-content {
  position: relative;
  z-index: 1;
}
  .button-group { display: flex; gap: 15px; width: 100%; justify-content: center; }
  .btn { background: var(--gold); color: #000; border: none; padding: 12px 25px; border-radius: 12px; font-weight: bold; box-shadow: 0 5px 0 #b38b00; cursor: pointer; }
  .btn:disabled { background: #ccc; box-shadow: 0 5px 0 #999; cursor: not-allowed; }
  .btn-secondary { background: #7f8c8d; color: #fff; box-shadow: 0 5px 0 #2c3e50; }

  @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
</style>
</head>
  <body>

  <div class="topbar">
    <div class="sound-toggle" onclick="toggleMute()" id="soundIcon">ğŸ”Š</div>
    <div class="sound-toggle" onclick="cycleBGM()" id="bgmBtn">ğŸµ éŸ³æ¨‚ 1</div>
    <div class="balance-box">ğŸ’ <span id="balanceText">0</span></div>
    <marquee style="flex:1; color:var(--gold); font-size: 12px;">æœ‰å•é¡Œå†èªª</marquee>
    <a href="index.html" style="text-decoration:none;"><button style="background:none; border:1px solid #777; color:#ccc; padding:5px; border-radius:5px;">ğŸ å›å¤§å»³</button></a>
  </div>

  <div id="lobby">
    <h2 style="color:var(--gold); margin-bottom: 10px;">ğŸ§§ æŒ‘é¸åˆ®åˆ®æ¨‚</h2>
    <div class="card-option" onclick="selectCard('small')">
      <div class="price-tag">$10,000</div>
      <div><h3>ğŸ’°è²¡ç¥åˆ°</h3><p style="font-size:12px;color:#666">å°ä¸­å¹¸é‹è™Ÿç¢¼å³ä¸­ç</p></div>
    </div>
    <div class="card-option" onclick="selectCard('mid')">
      <div class="price-tag">$50,000</div>
      <div><h3>ğŸ²é‡‘é¾è³€æ­²</h3><p style="font-size:12px;color:#666">æœé›† ğŸ² æˆ– ğŸ§§ ä¸­å¤§ç</p></div>
    </div>
    <div class="card-option" onclick="selectCard('big')">
      <div class="price-tag">$500,000</div>
      <div><h3>ğŸ§§å¤§ç´…åŒ…</h3><p style="font-size:12px;color:#666">ä¸‰åŒé‡‘é¡æˆ–åˆ®å‡ºğŸ‘‘å³ä¸­</p></div>
    </div>
    <div class="card-option" onclick="selectCard('xmas')" style="background: #eb4d4b; color: white;">
      <div class="price-tag" style="background: #27ae60;">$1,000,000</div>
      <div><h3>ğŸ„è–èª•ç¦®ç‰©</h3><p style="font-size:12px;color:#eee">é›†é½Šè–èª•è€äººéšŠä¼</p></div>
    </div>
    <div class="card-option" onclick="selectCard('newyear')" style="background: #d63031; color: white;">
      <div class="price-tag" style="background: #f1c40f; color: #000;">$2,026,000</div>
      <div><h3>ğŸé¦¬å¹´å¿«æ¨‚</h3><p style="font-size:12px;color:#fff">è¶…è¶Šé‡Œç¨‹æ‹¿çé‡‘</p></div>
    </div>
  </div>

  <div id="gameRoom">
    <div id="gameRuleDesc">ç©æ³•èªªæ˜</div>
    <div class="scratch-card-container">
      <div class="scratch-card">
        <div id="cardContent" class="card-content"></div>
        <canvas id="scratchCanvas" width="320" height="420"></canvas>
      </div>
    </div>
    <div class="button-group">
      <button class="btn btn-secondary" onclick="backToLobby()">å›æ«ƒå°</button>
      <button class="btn" id="quickBuyBtn" onclick="reBuy()" disabled>å†åˆ®ä¸€å¼µ</button>
    </div>
  </div>

  <audio id="sndWin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
  <audio id="bgm1" src="background-music-434612.mp3" loop preload="auto"></audio>
  <audio id="bgm2" src="soft-background-music-427252.mp3" loop preload="auto"></audio>
  <audio id="bgm3" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" loop preload="auto"></audio>

  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>
  <script>
    const _k = ["AIzaSyDSRfVA", "uWCWCUd1NJop", "J6wHvsqsAM4UzJA"];
  const firebaseConfig = {
    apiKey: _k.join(''),
    authDomain: "game-80d68.firebaseapp.com",
    projectId: "game-80d68",
    storageBucket: "game-80d68.firebasestorage.app",
    messagingSenderId: "636332967920",
    appId: "1:636332967920:web:29e5600daf4db0ab613f35",
    measurementId: "G-MJZ4PGEHSQ"
  };
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.firestore();
  let balance = parseFloat(localStorage.getItem('sicbo_balance'));
  let lastSyncedBalance = balance;
  let currentConfig = null, isDrawing = false, isScratched = false, winAmount = 0, currentType = '';
  let isMuted = false, currentBgmIdx = 1;
  let currentNewYearTotalKM = 0; 
  let scratchPointCount = 0;
  let totalDist = 0; // ç´€éŒ„æ‰‹æŒ‡åˆ®éçš„ç¸½è·é›¢
  const bgmList = [null, 'bgm1', 'bgm2', 'bgm3'];
  const canvas = document.getElementById('scratchCanvas'), ctx = canvas.getContext('2d');

  function saveToLocal() {
    localStorage.setItem('sicbo_balance', balance);
  }

  async function syncToFirebase() {
    const playerId = localStorage.getItem('player_id');
    if (!playerId || !db || balance === lastSyncedBalance) return;

    try {
      await db.collection("users").doc(playerId).update({
        balance: balance,
        lastUpdate: firebase.firestore.Timestamp.now()
      });
      lastSyncedBalance = balance;
      console.log("âœ… é¤˜é¡å·²åŒæ­¥è‡³é›²ç«¯");
    } catch (e) {
      console.error("âŒ é›²ç«¯åŒæ­¥å¤±æ•—", e);
    }
  }

  // ç•«é¢åŠ è¼‰æ™‚å¾é›²ç«¯æŠ“å–é¤˜é¡ (ä¿æŒè·Ÿä½ çš„éº»å°‡ä¾‹å­ä¸€è‡´)
  window.onload = async () => {
    const localBal = localStorage.getItem('sicbo_balance');
    if (localBal !== null) balance = parseFloat(localBal);

    const playerId = localStorage.getItem('player_id');
    if (playerId && db) {
      try {
        const doc = await db.collection("users").doc(playerId).get();
        if (doc.exists) {
          const cloudBal = doc.data().balance;
          // å¦‚æœé›²ç«¯éŒ¢æ¯”è¼ƒå¤šï¼Œä»¥é›²ç«¯ç‚ºä¸»
          if (cloudBal !== undefined && cloudBal > balance) {
            balance = cloudBal;
            saveToLocal();
          }
        }
      } catch (e) { console.log("é›¢ç·šæ¨¡å¼"); }
    }
    updateUI();
  };
  const CONFIGS = {
    small: { price: 10000, prizes: [10000, 200000, 500000, 1000000], winRate: 0.35, desc: "å°ä¸­å¹¸é‹è™Ÿç¢¼å³ä¸­ç" },
    mid: { price: 50000, prizes: [50000, 100000, 200000, 500000, 5000000], winRate: 0.33, desc: "æœé›† ğŸ² æˆ– ğŸ§§" },
    big: { price: 500000, prizes: [500000, 1000000,5000000, 10000000, 50000000], winRate: 0.3, desc: "ä¸‰åŒé‡‘é¡æˆ–åˆ®å‡ºğŸ‘‘å³ä¸­" },
    xmas: { price: 1000000, prizes: [5000000,10000000, 100000000], winRate: 0.32, desc: "é›†é½Šè–èª•è€äººéšŠä¼" },
    newyear: { price: 2026000, prizes: [202600, 2026000, 20260000, 202600000], winRate: 0.3, desc: "é‡Œç¨‹é”æ¨™å³é»äº®çé‡‘" }
  };

  function updateUI() { 
    document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString(); 
    saveToLocal(); // å­˜æœ¬åœ°
  }

  function stopAllBGM() { bgmList.forEach(id => { if(id) { const a = document.getElementById(id); a.pause(); a.currentTime = 0; } }); }
  function cycleBGM() {
      stopAllBGM(); currentBgmIdx = (currentBgmIdx + 1) % 4;
      const btn = document.getElementById('bgmBtn');
      if (currentBgmIdx === 0) btn.textContent = 'ğŸš« éŸ³æ¨‚é—œ';
      else { btn.textContent = 'ğŸµ éŸ³æ¨‚ ' + currentBgmIdx; if (!isMuted) { const bgm = document.getElementById(bgmList[currentBgmIdx]); if(bgm) { bgm.volume = 0.3; bgm.play().catch(()=>{}); } } }
  }
  function toggleMute() {
      isMuted = !isMuted; document.getElementById('soundIcon').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      if (isMuted) stopAllBGM();
      else if (currentBgmIdx !== 0) { const bgm = document.getElementById(bgmList[currentBgmIdx]); if(bgm) bgm.play().catch(()=>{}); }
  }

  function selectCard(type) {
    currentType = type; currentConfig = CONFIGS[type];
    if(balance < currentConfig.price) { alert("é¤˜é¡ä¸è¶³ï¼"); return; }
    document.getElementById('lobby').style.display = 'none';
    document.getElementById('gameRoom').style.display = 'flex';
    document.getElementById('gameRuleDesc').textContent = currentConfig.desc;
    startNewGame();
  }
function startNewGame() {
  if(balance < currentConfig.price) { alert("é¤˜é¡ä¸è¶³ï¼"); backToLobby(); return; }
  
  // 1. ç«‹å³æ¸…ç©ºåº•å±¤å…§å®¹ (è®Šæˆç™½æ¿)
  const container = document.getElementById('cardContent');
  container.innerHTML = '<div style="display:flex; height:100%; align-items:center; justify-content:center; color:#ccc;">æº–å‚™ä¸­...</div>'; 
  
  // 2. æ‰£éŒ¢ã€é‡ç½®è®Šæ•¸
  balance -= currentConfig.price; 
  updateUI();
  isScratched = false; winAmount = 0; currentNewYearTotalKM = 0; totalDist = 0;

  // 3. è®“ç•«å¸ƒå‡ºç¾ä¸¦å¡—é‡‘
  canvas.style.opacity = '1';
  document.getElementById('quickBuyBtn').disabled = true;
  
  initScratchLayer(); // ç•«é‡‘è‰²

}
 async function generateCardLayout() {
    const container = document.getElementById('cardContent');
    // --- ä¿®æ­£é»ï¼šä¸è¦ removeAttributeï¼Œæ”¹ç”¨ className ç¢ºä¿ CSS èƒ½æŠ“åˆ° ---
    container.className = 'card-content';
    container.style.background = '#fff';
    container.style.opacity = '0';
    
    const isWin = Math.random() < currentConfig.winRate;
    let html = '';

    if (currentType === 'small') {
      container.classList.add('layout-numbers');
      // å¼·åˆ¶è®“å®¹å™¨è®Šæˆ column ä½ˆå±€ï¼Œä¸¦æ’æ»¿é«˜åº¦
      container.style.display = 'flex';
      container.style.flexDirection = 'column';
      container.style.justifyContent = 'space-between';
      container.style.height = '100%'; 
      container.style.padding = '10px';

      const luckyNum = Math.floor(Math.random() * 90) + 10;
      const multi = Math.random() > 0.8 ? 2 : 1;
      
      // ä¸Šæ–¹å¹¸é‹å€ç¨å¾®æ”¾å¤§ä¸€é»
      html = `<div class="lucky-zone" style="margin-bottom:15px; transform: scale(1.1);">
                <span>å¹¸é‹è™Ÿç¢¼</span>
                <span style="font-size:48px;color:#d63031;margin:0 10px;">${luckyNum}</span>
                ${multi>1?'<b style="color:#e67e22;font-size:24px;">x2</b>':''}
              </div>
              <div class="number-grid" style="display:grid; grid-template-columns:1fr 1fr; grid-template-rows:repeat(3,1fr); gap:10px; flex:1;">`;
      
      let winPos = isWin ? Math.floor(Math.random() * 6) : -1;
      if(isWin) winAmount = currentConfig.prizes[Math.floor(Math.random() * currentConfig.prizes.length)] * multi;
      else winAmount = 0;

      for(let i=0; i<6; i++) {
        let n = Math.floor(Math.random() * 90) + 10;
        let p = currentConfig.prizes[Math.floor(Math.random() * 3)];
        if (i === winPos) { n = luckyNum; p = winAmount / multi; }
        else { if (n === luckyNum) n = (n === 99) ? n - 1 : n + 1; }

        // æ”¾å¤§æ ¼å­å…§çš„æ•¸å­—èˆ‡é‡‘é¡
        html += `
          <div class="prize-item ${i === winPos ? 'win-mark' : ''}" style="display:flex; flex-direction:column; justify-content:center; align-items:center; background:#fff; border:2px solid #eee; border-radius:12px;">
            <span style="font-size:32px; font-weight:bold; color:#2d3436;">${n}</span>
            <span class="prize-amount" style="font-size:18px; font-weight:900; color:#d63031; margin-top:5px;">$${p.toLocaleString()}</span>
          </div>`;
      }
      html += `</div>`;
    }
    else if (currentType === 'mid') {
      container.classList.add('layout-symbols');
      // --- è§£æ±ºå‚ç›´æ’åˆ—ï¼šå¼·åˆ¶æŒ‡å®š grid åˆ†æ¬„ ---
      container.style.display = 'grid';
      container.style.gridTemplateColumns = '1fr 1fr';
      container.style.gap = '5px';

      const syms = ['ğŸ‹', 'ğŸ®', 'ğŸŠ', 'ğŸ§¨'];
      let count = isWin ? Math.floor(Math.random() * 2) + 1 : 0;
      if(isWin) winAmount = currentConfig.prizes[Math.floor(Math.random() * currentConfig.prizes.length)];
      
      let items = [];
      for(let i=0; i<6; i++) {
        let randomPrize = currentConfig.prizes[Math.floor(Math.random() * currentConfig.prizes.length)];
        if(i < count) items.push({s:'ğŸ²', p: winAmount/count, w:true});
        else items.push({s:syms[Math.floor(Math.random()*syms.length)], p: randomPrize, w:false});
      }
      items.sort(()=>Math.random()-0.5);
      html = items.map(it => `<div class="prize-item ${it.w?'win-mark':''}"><h3>${it.s}</h3><span class="prize-amount">$${it.p.toLocaleString()}</span></div>`).join('');
    }
    else if (currentType === 'big') {
      container.classList.add('layout-symbols');
      // --- è§£æ±ºå‚ç›´æ’åˆ—ï¼šå¼·åˆ¶æŒ‡å®š grid åˆ†æ¬„ ---
      container.style.display = 'grid';
      container.style.gridTemplateColumns = '1fr 1fr';
      container.style.gap = '5px';

      const isCrown = isWin && Math.random() > 0.7;
      if(isWin) {
        let r = Math.random() * 100;
        let pz = currentConfig.prizes; 
        if (r < 5) winAmount = pz[4];
        else if (r < 13) winAmount = pz[3];
        else if (r < 31) winAmount = pz[2];
        else if (r < 60) winAmount = pz[1];
        else winAmount = pz[0];
      } else { winAmount = 0; }
      
      let items = [];
      if(isCrown) {
        items.push({s:'ğŸ‘‘', p:winAmount, w:true});
        while(items.length < 6) {
          let p = currentConfig.prizes[Math.floor(Math.random() * currentConfig.prizes.length)];
          items.push({s:'ğŸ§§', p:p, w:false});
        }
      } else if(isWin) {
        for(let i=0; i<3; i++) items.push({s:'ğŸ§§', p:winAmount, w:true});
        while(items.length < 6) {
          let p = currentConfig.prizes[Math.floor(Math.random() * currentConfig.prizes.length)];
          if(p !== winAmount) items.push({s:'ğŸ§§', p:p, w:false});
        }
      } else {
        let prizeCounts = {};
        while(items.length < 6) {
          let p = currentConfig.prizes[Math.floor(Math.random() * currentConfig.prizes.length)];
          if(!prizeCounts[p]) prizeCounts[p] = 0;
          if(prizeCounts[p] < 2) {
            items.push({s:'ğŸ§§', p:p, w:false});
            prizeCounts[p]++;
          }
        }
      }
      items.sort(()=>Math.random()-0.5);
      html = items.map(it => `
        <div class="prize-item ${it.w?'win-mark':''}" data-val="${it.p}">
          <h3>${it.s}</h3>
          <span class="prize-amount">$${it.p.toLocaleString()}</span>
        </div>`).join('');
    }
    else if (currentType === 'xmas') {
      container.classList.add('layout-symbols');
      container.style.background = '#16a085';
      container.style.display = 'flex';
      container.style.flexDirection = 'column';
      container.style.padding = '8px';

      const goalPrizes = [currentConfig.prizes[0], currentConfig.prizes[1], currentConfig.prizes[2]];
      let winLevel = 0;
      if (isWin) {
        let r = Math.random();
        if (r > 0.9) winLevel = 3; else if (r > 0.6) winLevel = 2; else winLevel = 1; 
      }
      let items = [];
      if (winLevel === 3) { items = [{s:'ğŸ¦Œ'}, {s:'ğŸ¦Œ'}, {s:'ğŸ›·'}, {s:'ğŸ…'}, {s:'ğŸ­'}, {s:'ğŸ­'}]; winAmount = goalPrizes[2]; }
      else if (winLevel === 2) { items = [{s:'ğŸ¦Œ'}, {s:'ğŸ¦Œ'}, {s:'ğŸ›·'}, {s:'â˜ï¸'}, {s:'ğŸ§Š'}, {s:'ğŸ­'}]; winAmount = goalPrizes[1]; }
      else if (winLevel === 1) { items = [{s:'ğŸ¦Œ'}, {s:'ğŸ¦Œ'}, {s:'â˜ï¸'}, {s:'ğŸ§Š'}, {s:'ğŸ§Š'}, {s:'ğŸ­'}]; winAmount = goalPrizes[0]; }
      else { items = [{s:'ğŸ¦Œ'}, {s:'ğŸ›·'}, {s:'â˜ï¸'}, {s:'ğŸ§Š'}, {s:'ğŸ§Š'}, {s:'ğŸ­'}]; winAmount = 0; }
      items.sort(() => Math.random() - 0.5);

      let htmlTop = `<div style="display:grid; grid-template-columns:repeat(3,1fr); gap:6px; width:100%; margin-bottom:10px;">`;
      const houseIcons = ["ğŸ ", "ğŸ¡", "ğŸ°"];
      const houseReqs = ["ğŸ¦Œx2", "ğŸ¦Œx2+ğŸ›·", "ğŸ¦Œx2+ğŸ›·+ğŸ…"];
      [0, 1, 2].forEach((i) => {
        htmlTop += `<div class="goal-item" id="xmas-house-${i+1}" style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.4); border-radius:8px; padding:6px; text-align:center;">
            <div style="font-size:22px;">${houseIcons[i]}</div>
            <div style="font-size:10px; color:#fff;">${houseReqs[i]}</div>
            <div style="font-size:12px; color:#ffd86b; font-weight:bold;">$${(goalPrizes[i]/10000).toLocaleString()}è¬</div>
          </div>`;
      });
      htmlTop += `</div>`;

      let htmlGrid = `<div style="display:grid; grid-template-columns:1fr 1fr; grid-template-rows:repeat(3,1fr); gap:8px; flex:1; width:100%;">`;
      const symbolNames = {'ğŸ¦Œ': 'è–èª•éº‹é¹¿', 'ğŸ›·': 'é›ªæ©‡è»Š', 'ğŸ…': 'è–èª•è€å…¬å…¬', 'ğŸ­': 'ç¤™äº‹æ‹æ–ç³–', 'ğŸ§Š': 'æ“‹è·¯å†°å¡Š', 'â˜ï¸': 'é®çœ¼çƒé›²'};
      items.forEach(it => {
        const isMember = ['ğŸ¦Œ', 'ğŸ›·', 'ğŸ…'].includes(it.s);
        htmlGrid += `<div class="prize-item ${isMember ? 'xmas-member' : ''}" data-symbol="${it.s}" style="background:#fffafa; border:2px solid #27ae60; border-radius:10px; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:5px;">
            <span style="font-size:36px; line-height:1.1;">${it.s}</span>
            <span style="font-size:14px; color:#27ae60; font-weight:900; margin-top:2px; white-space:nowrap;">${symbolNames[it.s] || 'ç¥ç§˜ç‰©'}</span>
          </div>`;
      });
      htmlGrid += `</div>`;
      html = htmlTop + htmlGrid;
      container.dataset.winLevel = winLevel; 
    }
    else if (currentType === 'newyear') {
      container.classList.add('layout-symbols');
      container.style.background = '#d63031';
      container.style.display = 'flex';
      container.style.flexDirection = 'column';
      const goals = [100, 250, 500, 1000];
      const goalPrizes = currentConfig.prizes;
      let targetKM = 0;
      if (isWin) {
        let r = Math.random();
        if (r > 0.9) targetKM = 1000 + Math.floor(Math.random() * 50);
        else if (r > 0.6) targetKM = 500 + Math.floor(Math.random() * 100);
        else if (r > 0.3) targetKM = 250 + Math.floor(Math.random() * 50);
        else targetKM = 100 + Math.floor(Math.random() * 30);
      } else { targetKM = 50 + Math.floor(Math.random() * 40); }
      currentNewYearTotalKM = targetKM; 
      winAmount = 0;
      if(targetKM >= 1000) winAmount = goalPrizes[3] || goalPrizes[goalPrizes.length-1];
      else if(targetKM >= 500) winAmount = goalPrizes[2];
      else if(targetKM >= 250) winAmount = goalPrizes[1];
      else if(targetKM >= 100) winAmount = goalPrizes[0];

      let steps = []; let tempSum = 0;
      for(let i=0; i<5; i++){ let s = Math.floor(Math.random() * (targetKM/3.5)); steps.push(s); tempSum += s; }
      steps.push(Math.max(5, targetKM - tempSum));
      steps.sort(() => Math.random() - 0.5);

      let htmlTop = `<div style="display:grid; grid-template-columns:repeat(4,1fr); gap:4px; width:100%; margin-bottom:10px;">`;
      goals.forEach((g, i) => {
        let pText = goalPrizes[i] ? (goalPrizes[i]/10000).toLocaleString() + 'è¬' : '---';
        htmlTop += `<div class="goal-item" id="goal-${g}"><div style="font-size:9px; color:#ccc;">${g}km</div><div style="font-size:10px; color:gold; font-weight:bold;">$${pText}</div></div>`;
      });
      htmlTop += `</div>`;

      let htmlGrid = `<div style="display:grid; grid-template-columns:1fr 1fr; grid-template-rows:repeat(3,1fr); gap:5px; flex:1; width:100%;">`;
      steps.forEach((s) => {
        const isHorse = s >= 100;
        let isWinningSlot = false;
        if (isWin) {
          if (isHorse) isWinningSlot = true;
          else if (s === Math.max(...steps) && !steps.some(val => val >= 100)) isWinningSlot = true;
        }
        htmlGrid += `<div class="prize-item ${isWinningSlot ? 'win-mark' : ''}" style="background:#fff9f0; border:1px solid #f1c40f; border-radius:8px; display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <span style="font-size:24px;">${isHorse ? 'ğŸ' : 'ğŸ’¨'}</span>
            <span style="font-size:16px; font-weight:bold; color:#c0392b">+${s}km</span>
          </div>`;
      });
      htmlGrid += `</div>`;
      html = htmlTop + htmlGrid;
    }
    
    container.innerHTML = html;
    requestAnimationFrame(() => { container.style.opacity = '1'; });
}

 function initScratchLayer() {
  ctx.globalCompositeOperation = 'source-over';
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // ç¹ªè£½é‡‘è‰²æ¼¸å±¤
  const g = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
  g.addColorStop(0, '#d4af37'); 
  g.addColorStop(0.5, '#f1c40f'); 
  g.addColorStop(1, '#b38b00');
  ctx.fillStyle = g; 
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // ç¹ªè£½æ–‡å­—
  ctx.fillStyle = "rgba(0,0,0,0.3)"; 
  ctx.font = "bold 40px Arial"; 
  ctx.textAlign = "center";
  ctx.fillText("åˆ®é–‹å€", canvas.width/2, canvas.height/2 + 15);

  // --- é—œéµä¿®æ”¹ï¼šé‡‘è‰²ç•«å¥½äº†ï¼Œç¾åœ¨æ‰å‡†ç”Ÿæˆå…§å®¹ ---
  // ä½¿ç”¨ requestAnimationFrame ç¢ºä¿ç€è¦½å™¨å·²ç¶“æŠŠä¸Šé¢é‚£å¡Šé‡‘è‰²é¡¯ç¤ºå‡ºä¾†äº†
  requestAnimationFrame(() => {
    generateCardLayout();
  });
}

 function handleScratch(e) {
    if (!isDrawing || isScratched) return;
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

    // 1. ç¹ªè£½ç·šæ¢ (ä¿æŒçµ²æ»‘)
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.lineWidth = 70;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();

    // 2. è¨ˆç®—é€™ä¸€æ­¥æ»‘å‹•çš„è·é›¢ (å‹¾è‚¡å®šç†)
    const dx = x - lastX;
    const dy = y - lastY;
    const distance = Math.sqrt(dx * dx + dy * dy);
    
    // 3. åªæœ‰ç•¶æ‰‹æŒ‡çœŸçš„æœ‰åœ¨å‹•æ™‚æ‰ç´¯åŠ ï¼Œé¿å…åŸåœ°è¸æ­¥
    if (distance > 2) {
      totalDist += distance;
    }

    [lastX, lastY] = [x, y];

    // 4. åˆ¤å®šé–€æª»ï¼šæ ¹æ“šç•«å¸ƒå¯¬åº¦å‹•æ…‹èª¿æ•´
    // å‡è¨­ç©å®¶éœ€è¦åŠƒéç´„ 2.5 å€ç•«å¸ƒå¯¬åº¦çš„ç¸½é•·åº¦å°±å…¨é–‹
    const threshold = canvas.width * 6; 
    
    if (totalDist > threshold) {
      revealCard();
    }
  }


  async function revealCard() {
  if(isScratched) return;
  isScratched = true; 
  canvas.style.opacity = '0';
  
  const btn = document.getElementById('quickBuyBtn');
  if(btn) btn.disabled = false;

  // 1. æª¢æŸ¥ç•«é¢ä¸Šæ˜¯å¦æœ‰æ¨™è¨˜ä¸­ççš„æ ¼å­
  const winMarks = document.querySelectorAll('.win-mark, .xmas-member');
  
  // --- é—œéµï¼šé‡‘é¡å¤§æ–¼0ä¸”æœ‰å°ä¸­æ¨™è¨˜æ‰æ’­éŸ³æ•ˆ ---
  if (winAmount > 0 && winMarks.length > 0) {
    balance += winAmount; 
    updateUI(); 
    if(!isMuted) {
      const snd = document.getElementById('sndWin');
      snd.currentTime = 0; // å¼·åˆ¶å›åˆ°é–‹é ­ï¼Œé˜²æ­¢é€£çºŒè§¸ç™¼å¤±æ•ˆ
      snd.play().catch(()=>{});
    }
    // è®“æ‰€æœ‰ä¸­çæ ¼å­è·³å‹•
    winMarks.forEach(el => el.classList.add('item-win'));
  }

  // 2. è™•ç†ç‰¹æ®Šé¡å‹çš„ç‡ˆè™Ÿäº®èµ·
  try {
    // ã€é¦¬å¹´ï¼šåªäº®æœ€é«˜é”æ¨™çš„é‚£ä¸€å€‹ã€‘
    if (currentType === 'newyear') {
      const goals = [1000, 500, 250, 100]; // ç”±å¤§åˆ°å°åˆ¤æ–·
      const finalGoal = goals.find(g => currentNewYearTotalKM >= g);
      if (finalGoal) {
        const el = document.getElementById(`goal-${finalGoal}`);
        if (el) el.classList.add('goal-active');
      }
    }
    
    // ã€è–èª•ï¼šåªäº®ç™¼éŒ¢çš„é‚£ä¸€æ£Ÿã€‘
    else if (currentType === 'xmas') {
      const container = document.getElementById('cardContent');
      const level = parseInt(container.dataset.winLevel || 0);
      
      // åªæœ‰ä¸­çç­‰ç´š > 0 æ™‚ï¼Œæ‰é»äº®å°æ‡‰çš„é‚£ä¸€æ£Ÿ
      if (level > 0) {
        const el = document.getElementById(`xmas-house-${level}`);
        if (el) {
          el.classList.add('goal-active');
        }
      }
    }
  } catch(e) { 
    console.warn(e); 
  }

  syncToFirebase();
}

  function reBuy() { startNewGame(); }
  function backToLobby() { document.getElementById('lobby').style.display = 'flex'; document.getElementById('gameRoom').style.display = 'none'; }

  canvas.addEventListener('mousedown', (e) => { 
    isDrawing = true; 
    const rect = canvas.getBoundingClientRect();
    // ç´€éŒ„èµ·å§‹é»ï¼Œé˜²æ­¢å™´ç·š
    lastX = (e.clientX - rect.left);
    lastY = (e.clientY - rect.top);
    handleScratch(e); 
  });
  window.addEventListener('mouseup', () => isDrawing = false);
  canvas.addEventListener('mousemove', handleScratch);
  canvas.addEventListener('touchstart', (e) => { 
    isDrawing = true; 
    const rect = canvas.getBoundingClientRect();
    // ç´€éŒ„èµ·å§‹é»ï¼Œé˜²æ­¢å™´ç·š
    lastX = (e.touches[0].clientX - rect.left);
    lastY = (e.touches[0].clientY - rect.top);
    handleScratch(e); 
  });
  canvas.addEventListener('touchmove', handleScratch);
  window.addEventListener('touchend', () => isDrawing = false);

  updateUI();
  </script>
  </body>
</html>