<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
<title>å½©åˆ¸è¡Œ</title>
<style>
  :root {
    --gold: #ffd86b; --red: #ff4757; --bg-red: #b33939; --win-green: #2ecc71;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; touch-action: none; font-family: "Microsoft JhengHei", Arial, sans-serif; }
  
  body { height: 100dvh; width: 100vw; background: #1a0505; color: #fff; display: flex; flex-direction: column; overflow: hidden; }

  /* é ‚éƒ¨æ¬„ */
  .topbar { 
    width: 100%; padding-top: env(safe-area-inset-top); 
    height: calc(60px + env(safe-area-inset-top)); 
    background: linear-gradient(#4a0404, #2a0202); 
    display: flex; align-items: center; padding: 0 15px; gap: 10px; 
    border-bottom: 2px solid #5c0a0a; flex-shrink: 0; z-index: 1000;
  }
  .sound-toggle { background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 8px; border: 1px solid var(--gold); cursor: pointer; font-size: 13px; color: #fff; }
  .balance-box { background: rgba(0,0,0,0.5); border: 1px solid var(--gold); border-radius: 15px; padding: 4px 12px; color: var(--gold); font-weight: bold; font-size: 16px; }

  /* æ«ƒå°ä»‹é¢ */
  #lobby { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; padding: 20px; overflow-y: auto; }
  .card-option {
    width: 100%; max-width: 320px; background: #fff; color: #333; border-radius: 15px;
    padding: 20px; display: flex; align-items: center; box-shadow: 0 8px 15px rgba(0,0,0,0.4);
    border-left: 10px solid var(--gold); position: relative; cursor: pointer;
  }
  .price-tag { position: absolute; top: -10px; right: 10px; background: #e67e22; color: #fff; padding: 2px 12px; border-radius: 20px; font-weight: bold; font-size: 14px; }

  /* éŠæˆ²å€åŸŸ */
  #gameRoom { display: none; flex: 1; flex-direction: column; align-items: center; justify-content: center; gap: 15px; }
  #gameRuleDesc { font-size: 14px; color: var(--gold); background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px; }
  
  .scratch-card-container { position: relative; width: 320px; height: 420px; }
  .scratch-card {
    width: 100%; height: 100%; background: #fff; border: 8px solid var(--gold); border-radius: 15px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.6); overflow: hidden; position: relative;
  }

  .card-content { width: 100%; height: 100%; display: grid; padding: 10px; gap: 5px; background: #fff; }
  
  /* è²¡ç¥åˆ° ä½ˆå±€ */
  .layout-numbers { grid-template-rows: 1fr 2.5fr; }
  .lucky-zone { border-bottom: 2px dashed #e67e22; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fff9f0; }
  .number-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: repeat(3, 1fr); gap: 8px; padding-top: 10px; }
  
  /* é‡‘é¾ & ç´…åŒ… ä½ˆå±€ */
  .layout-symbols { grid-template-columns: 1fr 1fr; grid-template-rows: repeat(3, 1fr); }

  .prize-item { display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fefefe; border: 1px solid #eee; border-radius: 8px; color: #333; }
  .prize-amount { font-size: 14px; font-weight: bold; color: #d63031; }
  .prize-symbol { font-size: 32px; }
  .item-win { background: #dff9fb !important; border: 2px solid var(--win-green) !important; animation: pulse 0.8s infinite; }

  canvas { position: absolute; top: 0; left: 0; z-index: 10; cursor: crosshair; transition: opacity 0.5s; touch-action: none; }

  .button-group { display: flex; gap: 15px; width: 100%; justify-content: center; }
  .btn { background: var(--gold); color: #000; border: none; padding: 12px 25px; border-radius: 12px; font-weight: bold; box-shadow: 0 5px 0 #b38b00; cursor: pointer; }
  .btn:disabled { background: #ccc; box-shadow: 0 5px 0 #999; cursor: not-allowed; }
  .btn-secondary { background: #7f8c8d; color: #fff; box-shadow: 0 5px 0 #2c3e50; }

  @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
</style>
</head>
<body>

<div class="topbar">
  <div class="sound-toggle" onclick="toggleMute()" id="soundIcon">ğŸ”Š</div>
  <div class="sound-toggle" onclick="cycleBGM()" id="bgmBtn">ğŸµ éŸ³æ¨‚ 1</div>
  <div class="balance-box">ğŸ’ <span id="balanceText">0</span></div>
  <a href="index.html" style="text-decoration:none;"><button style="background:none; border:1px solid #777; color:#ccc; padding:5px; border-radius:5px;">ğŸ </button></a>
</div>

<div id="lobby">
  <h2 style="color:var(--gold); margin-bottom: 10px;">ğŸ§§ æŒ‘é¸åˆ®åˆ®æ¨‚</h2>
  <div class="card-option" onclick="selectCard('small')">
    <div class="price-tag">$100</div>
    <div><h3>ğŸ’° è²¡ç¥åˆ°</h3><p style="font-size:12px;color:#666">å¹¸é‹è™Ÿç¢¼å°ä¸­å³å¾—çé‡‘</p></div>
  </div>
  <div class="card-option" onclick="selectCard('mid')">
    <div class="price-tag">$500</div>
    <div><h3>ğŸ² é‡‘é¾è³€æ­²</h3><p style="font-size:12px;color:#666">åˆ®å‡º ğŸ§§ æˆ– ğŸ² ä¸­ç</p></div>
  </div>
  <div class="card-option" onclick="selectCard('big')">
    <div class="price-tag">$5000</div>
    <div><h3>ğŸ§§ å„„å…ƒå¤§ç´…åŒ…</h3><p style="font-size:12px;color:#666">ä¸‰å€‹ç›¸åŒé‡‘é¡å³ä¸­ç</p></div>
  </div>
</div>

<div id="gameRoom">
  <div id="gameRuleDesc">ç©æ³•èªªæ˜</div>
  <div class="scratch-card-container">
    <div class="scratch-card">
      <div id="cardContent" class="card-content"></div>
      <canvas id="scratchCanvas" width="320" height="420"></canvas>
    </div>
  </div>
  <div class="button-group">
    <button class="btn btn-secondary" onclick="backToLobby()">å›æ«ƒå°</button>
    <button class="btn" id="quickBuyBtn" onclick="reBuy()" disabled>å†åˆ®ä¸€å¼µ</button>
  </div>
</div>

<audio id="sndWin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
<audio id="bgm1" src="background-music-434612.mp3" loop preload="auto"></audio>
<audio id="bgm2" src="soft-background-music-427252.mp3" loop preload="auto"></audio>
<audio id="bgm3" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" loop preload="auto"></audio>

<script>
let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
let currentConfig = null, isDrawing = false, isScratched = false, winAmount = 0, currentType = '';
let isMuted = false, currentBgmIdx = 1;
const bgmList = [null, 'bgm1', 'bgm2', 'bgm3'];
const canvas = document.getElementById('scratchCanvas'), ctx = canvas.getContext('2d');

const CONFIGS = {
  small: { price: 10000, prizes: [100, 200, 500, 1000, 2000], winRate: 0.35, desc: "å°ä¸­å¹¸é‹è™Ÿç¢¼å³ä¸­ç" },
  mid: { price: 50000, prizes: [500, 1000, 2000, 5000, 10000, 500000], winRate: 0.33, desc: "åˆ®å‡º ğŸ§§ æˆ– ğŸ² å³ä¸­ç" },
  big: { price: 500000, prizes: [50000, 500000, 1000000, 10000000, 100000000], winRate: 0.3, desc: "ä¸‰å€‹ç›¸åŒé‡‘é¡å³ä¸­ç" }
};

function updateUI() { 
  document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString(); 
  localStorage.setItem('sicbo_balance', balance); 
}

// --- éŸ³æ•ˆèˆ‡éŸ³æ¨‚é‚è¼¯ ---
function stopAllBGM() { bgmList.forEach(id => { if(id) { const a = document.getElementById(id); a.pause(); a.currentTime = 0; } }); }
function cycleBGM() {
    stopAllBGM(); currentBgmIdx = (currentBgmIdx + 1) % 4;
    const btn = document.getElementById('bgmBtn');
    if (currentBgmIdx === 0) btn.textContent = 'ğŸš« éŸ³æ¨‚é—œ';
    else { btn.textContent = 'ğŸµ éŸ³æ¨‚ ' + currentBgmIdx; if (!isMuted) { const bgm = document.getElementById(bgmList[currentBgmIdx]); if(bgm) { bgm.volume = 0.3; bgm.play().catch(()=>{}); } } }
}
function toggleMute() {
    isMuted = !isMuted; document.getElementById('soundIcon').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
    if (isMuted) stopAllBGM();
    else if (currentBgmIdx !== 0) { const bgm = document.getElementById(bgmList[currentBgmIdx]); if(bgm) bgm.play().catch(()=>{}); }
}

function selectCard(type) {
  currentType = type; currentConfig = CONFIGS[type];
  if(balance < currentConfig.price) { alert("é¤˜é¡ä¸è¶³ï¼"); return; }
  document.getElementById('lobby').style.display = 'none';
  document.getElementById('gameRoom').style.display = 'flex';
  document.getElementById('gameRuleDesc').textContent = currentConfig.desc;
  startNewGame();
}

function startNewGame() {
  if(balance < currentConfig.price) { alert("é¤˜é¡ä¸è¶³ï¼"); backToLobby(); return; }
  balance -= currentConfig.price; updateUI();
  isScratched = false; winAmount = 0; canvas.style.opacity = '1';
  document.getElementById('quickBuyBtn').disabled = true;
  generateCardLayout();
  initScratchLayer();
}

function generateCardLayout() {
  const container = document.getElementById('cardContent');
  container.className = 'card-content';
  const isWin = Math.random() < currentConfig.winRate;
  let html = '';

  if (currentType === 'small') {
    container.classList.add('layout-numbers');
    const luckyNum = Math.floor(Math.random() * 90) + 10;
    html = `<div class="lucky-zone"><span style="font-size:12px;color:#666">å¹¸é‹è™Ÿç¢¼</span><span style="font-size:40px;font-weight:bold;color:#d63031">${luckyNum}</span></div><div class="number-grid">`;
    
    let winPos = isWin ? Math.floor(Math.random() * 6) : -1;
    if(isWin) winAmount = currentConfig.prizes[Math.floor(Math.random() * currentConfig.prizes.length)];

    for(let i=0; i<6; i++) {
      let n = Math.floor(Math.random() * 90) + 10;
      let p = currentConfig.prizes[Math.floor(Math.random() * 3)]; // éš¨æ©Ÿé¡¯ç¤ºé‡‘é¡
      if (i === winPos) { n = luckyNum; p = winAmount; }
      else if (n === luckyNum) n++;
      
      html += `<div class="prize-item ${i === winPos ? 'win-mark' : ''}">
                <span style="font-size:22px;font-weight:bold">${n}</span>
                <span class="prize-amount">$${p.toLocaleString()}</span>
               </div>`;
    }
    html += `</div>`;
  } 
  else if (currentType === 'mid') {
    container.classList.add('layout-symbols');
    const symbols = ['ğŸ‹', 'ğŸ®', 'ğŸŠ', 'ğŸ§¨', 'ğŸ’°', 'ğŸ”¥', 'â˜ï¸', 'ğŸ””'];
    const winSymbols = ['ğŸ§§', 'ğŸ²'];
    let winPos = isWin ? Math.floor(Math.random() * 6) : -1;
    if(isWin) winAmount = currentConfig.prizes[Math.floor(Math.random() * currentConfig.prizes.length)];

    for(let i=0; i<6; i++) {
      let s = symbols[Math.floor(Math.random()*symbols.length)];
      let p = currentConfig.prizes[Math.floor(Math.random() * 3)];
      if (i === winPos) { s = winSymbols[Math.floor(Math.random()*2)]; p = winAmount; }
      html += `<div class="prize-item ${i === winPos ? 'win-mark' : ''}">
                <span class="prize-symbol">${s}</span>
                <span class="prize-amount">$${p.toLocaleString()}</span>
               </div>`;
    }
  } 
  else { // big (ç™¾è¬å¤§ç´…åŒ…: ä¸‰å€‹ç›¸åŒå³ä¸­ç)
    container.classList.add('layout-symbols');
    winAmount = isWin ? currentConfig.prizes[Math.floor(Math.random() * currentConfig.prizes.length)] : 0;
    let items = [];
    if(isWin) {
      for(let i=0; i<3; i++) items.push(winAmount);
      while(items.length < 6) {
        let p = currentConfig.prizes[Math.floor(Math.random()*currentConfig.prizes.length)];
        if(p !== winAmount) items.push(p);
      }
    } else {
      let pool = [];
      currentConfig.prizes.forEach(p => { pool.push(p, p); }); // æ¯å€‹é‡‘é¡æœ€å¤šå‡ºç¾å…©æ¬¡
      for(let i=0; i<6; i++) {
        let idx = Math.floor(Math.random() * pool.length);
        items.push(pool.splice(idx, 1)[0]);
      }
    }
    items.sort(()=>Math.random()-0.5);
    html = items.map(p => `<div class="prize-item" data-val="${p}"><span class="prize-symbol">ğŸ§§</span><span class="prize-amount">$${p.toLocaleString()}</span></div>`).join('');
  }
  container.innerHTML = html;
}

function initScratchLayer() {
  ctx.globalCompositeOperation = 'source-over';
  const g = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
  g.addColorStop(0, '#d4af37'); g.addColorStop(0.5, '#f1c40f'); g.addColorStop(1, '#b38b00');
  ctx.fillStyle = g; ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.font = "bold 40px Arial"; ctx.textAlign = "center";
  ctx.fillText("åˆ®é–‹å€", canvas.width/2, canvas.height/2 + 15);
}

function handleScratch(e) {
  if (!isDrawing || isScratched) return;
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
  ctx.globalCompositeOperation = 'destination-out';
  ctx.beginPath(); ctx.arc(x, y, 35, 0, Math.PI * 2); ctx.fill();
  checkProgress();
}

function checkProgress() {
  const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
  let count = 0; 
  for (let i = 3; i < data.length; i += 120) if (data[i] === 0) count++;
  if (count > (data.length / 550)) revealCard(); // åˆ®é–‹ç´„ 50% è‡ªå‹•å…¨é–‹
}

function revealCard() {
  if(isScratched) return;
  isScratched = true; canvas.style.opacity = '0';
  document.getElementById('quickBuyBtn').disabled = false;
  if (winAmount > 0) {
    balance += winAmount; updateUI();
    if(!isMuted) document.getElementById('sndWin').play().catch(()=>{});
    
    // é¡¯ç¤ºä¸­çè¦–è¦ºæ•ˆæœ
    if(currentType === 'big') {
      const items = document.querySelectorAll('.prize-item');
      items.forEach(el => {
        if(el.getAttribute('data-val') == winAmount) el.classList.add('item-win');
      });
    } else {
      document.querySelectorAll('.win-mark').forEach(el => el.classList.add('item-win'));
    }
  }
}

function reBuy() { startNewGame(); }
function backToLobby() { document.getElementById('lobby').style.display = 'flex'; document.getElementById('gameRoom').style.display = 'none'; }

// ç›£è½ç•«å¸ƒäº‹ä»¶
canvas.addEventListener('mousedown', (e) => { isDrawing = true; handleScratch(e); });
window.addEventListener('mouseup', () => isDrawing = false);
canvas.addEventListener('mousemove', handleScratch);
canvas.addEventListener('touchstart', (e) => { isDrawing = true; handleScratch(e); });
canvas.addEventListener('touchmove', handleScratch);
window.addEventListener('touchend', () => isDrawing = false);

updateUI();
</script>
</body>
</html>