<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
<title>2026 è³€æ­²å½©åˆ¸è¡Œ</title>
<style>
  :root {
    --gold: #ffd86b; --red: #ff4757; --bg-red: #b33939; --win-green: #2ecc71;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; touch-action: none; font-family: "Microsoft JhengHei", Arial, sans-serif; }
  
  body { height: 100dvh; width: 100vw; background: #1a0505; color: #fff; display: flex; flex-direction: column; overflow: hidden; }

  /* é ‚éƒ¨æ¬„ */
  .topbar { 
    width: 100%; padding-top: env(safe-area-inset-top); 
    height: calc(60px + env(safe-area-inset-top)); 
    background: linear-gradient(#4a0404, #2a0202); 
    display: flex; align-items: center; padding: 0 15px; gap: 10px; 
    border-bottom: 2px solid #5c0a0a; flex-shrink: 0; z-index: 1000;
  }
  .sound-toggle { background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 8px; border: 1px solid var(--gold); cursor: pointer; font-size: 13px; color: #fff; }
  .balance-box { background: rgba(0,0,0,0.5); border: 1px solid var(--gold); border-radius: 15px; padding: 4px 12px; color: var(--gold); font-weight: bold; font-size: 16px; }

  /* æ«ƒå°ä»‹é¢ */
  #lobby { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; gap: 12px; padding: 20px; overflow-y: auto; }
  .card-option {
    width: 100%; max-width: 320px; background: #fff; color: #333; border-radius: 15px;
    padding: 15px; display: flex; align-items: center; box-shadow: 0 8px 15px rgba(0,0,0,0.4);
    border-left: 10px solid var(--gold); position: relative; cursor: pointer; flex-shrink: 0;
  }
  .price-tag { position: absolute; top: -10px; right: 10px; background: #e67e22; color: #fff; padding: 2px 12px; border-radius: 20px; font-weight: bold; font-size: 14px; }

  /* éŠæˆ²å€åŸŸ */
  #gameRoom { display: none; flex: 1; flex-direction: column; align-items: center; justify-content: center; gap: 15px; }
  #gameRuleDesc { font-size: 14px; color: var(--gold); background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px; }
  
  .scratch-card-container { position: relative; width: 320px; height: 420px; }
  .scratch-card {
    width: 100%; height: 100%; background: #fff; border: 8px solid var(--gold); border-radius: 15px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.6); overflow: hidden; position: relative;
  }

  .card-content { width: 100%; height: 100%; display: grid; padding: 10px; gap: 5px; background: #fff; }
  .layout-numbers { grid-template-rows: 1fr 2.5fr; }
  .layout-symbols { grid-template-columns: 1fr 1fr; grid-template-rows: repeat(3, 1fr); }

  /* é¦¬å¹´ç‰¹æ•ˆæ¨£å¼ */
  .goal-item { background: rgba(0,0,0,0.4); border: 1px solid #777; border-radius: 8px; padding: 4px; text-align: center; transition: all 0.4s ease; }
  .goal-active { 
    background: linear-gradient(145deg, #ff4757, #b33939) !important; 
    border-color: #f1c40f !important; 
    box-shadow: 0 0 15px #ff4757; 
    transform: scale(1.05);
    animation: flash 1s infinite alternate;
  }
  /* é»äº®ç›®æ¨™çš„ç´…ç«ç‰¹æ•ˆ */
.goal-active { 
  background: linear-gradient(145deg, #ff4757, #b33939) !important; 
  border: 2px solid #ffd86b !important; 
  box-shadow: 0 0 20px #ff4757; 
  transform: scale(1.05);
  animation: houseFlash 0.8s infinite alternate;
  z-index: 5;
}
@keyframes houseFlash {
  from { filter: brightness(1); }
  to { filter: brightness(1.5); }
}

/* ä¸­çæ ¼å­çš„é–ƒçˆ */
.item-win { 
  background: #fff3cd !important; 
  border: 2px solid #2ecc71 !important; 
  animation: pulse 0.6s infinite; 
}
  @keyframes flash { from { opacity: 0.8; } to { opacity: 1; box-shadow: 0 0 20px #ffd86b; } }

  .lucky-zone { border-bottom: 2px dashed #e67e22; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fff9f0; }
  .number-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: repeat(3, 1fr); gap: 8px; padding-top: 10px; }

  .prize-item { display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fefefe; border: 1px solid #eee; border-radius: 8px; color: #333; }
  .prize-amount { font-size: 14px; font-weight: bold; color: #d63031; }
  .prize-symbol { font-size: 32px; }
  .item-win { background: #dff9fb !important; border: 2px solid var(--win-green) !important; animation: pulse 0.8s infinite; }

  canvas { position: absolute; top: 0; left: 0; z-index: 10; cursor: crosshair; transition: opacity 0.5s; touch-action: none; }

  .button-group { display: flex; gap: 15px; width: 100%; justify-content: center; }
  .btn { background: var(--gold); color: #000; border: none; padding: 12px 25px; border-radius: 12px; font-weight: bold; box-shadow: 0 5px 0 #b38b00; cursor: pointer; }
  .btn:disabled { background: #ccc; box-shadow: 0 5px 0 #999; cursor: not-allowed; }
  .btn-secondary { background: #7f8c8d; color: #fff; box-shadow: 0 5px 0 #2c3e50; }

  @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
</style>
</head>
  <body>

  <div class="topbar">
    <div class="sound-toggle" onclick="toggleMute()" id="soundIcon">ğŸ”Š</div>
    <div class="sound-toggle" onclick="cycleBGM()" id="bgmBtn">ğŸµ éŸ³æ¨‚ 1</div>
    <div class="balance-box">ğŸ’ <span id="balanceText">0</span></div>
    <a href="index.html" style="text-decoration:none;"><button style="background:none; border:1px solid #777; color:#ccc; padding:5px; border-radius:5px;">ğŸ </button></a>
  </div>

  <div id="lobby">
    <h2 style="color:var(--gold); margin-bottom: 10px;">ğŸ§§ æŒ‘é¸åˆ®åˆ®æ¨‚</h2>
    <div class="card-option" onclick="selectCard('small')">
      <div class="price-tag">$10,000</div>
      <div><h3>ğŸ’°è²¡ç¥åˆ°</h3><p style="font-size:12px;color:#666">å°ä¸­å¹¸é‹è™Ÿç¢¼å³ä¸­ç</p></div>
    </div>
    <div class="card-option" onclick="selectCard('mid')">
      <div class="price-tag">$50,000</div>
      <div><h3>ğŸ²é‡‘é¾è³€æ­²</h3><p style="font-size:12px;color:#666">æœé›† ğŸ² æˆ– ğŸ§§ ä¸­å¤§ç</p></div>
    </div>
    <div class="card-option" onclick="selectCard('big')">
      <div class="price-tag">$500,000</div>
      <div><h3>ğŸ§§å¤§ç´…åŒ…</h3><p style="font-size:12px;color:#666">ä¸‰åŒé‡‘é¡æˆ–åˆ®å‡ºğŸ‘‘å³ä¸­</p></div>
    </div>
    <div class="card-option" onclick="selectCard('xmas')" style="background: #eb4d4b; color: white;">
      <div class="price-tag" style="background: #27ae60;">$1,000,000</div>
      <div><h3>ğŸ„è–èª•ç¦®ç‰©</h3><p style="font-size:12px;color:#eee">é›†é½Šè–èª•è€äººéšŠä¼</p></div>
    </div>
    <div class="card-option" onclick="selectCard('newyear')" style="background: #d63031; color: white;">
      <div class="price-tag" style="background: #f1c40f; color: #000;">$2,026,000</div>
      <div><h3>ğŸæ–°å¹´å¿«æ¨‚ï¼Œåˆ¥ç©é€™å€‹</h3><p style="font-size:12px;color:#fff">å…ˆåˆ¥ç©é€™å€‹ï¼Œä¸çµ¦éŒ¢ï¼Œè¶…è¶Šé‡Œç¨‹æ‹¿çé‡‘</p></div>
    </div>
  </div>

  <div id="gameRoom">
    <div id="gameRuleDesc">ç©æ³•èªªæ˜</div>
    <div class="scratch-card-container">
      <div class="scratch-card">
        <div id="cardContent" class="card-content"></div>
        <canvas id="scratchCanvas" width="320" height="420"></canvas>
      </div>
    </div>
    <div class="button-group">
      <button class="btn btn-secondary" onclick="backToLobby()">å›æ«ƒå°</button>
      <button class="btn" id="quickBuyBtn" onclick="reBuy()" disabled>å†åˆ®ä¸€å¼µ</button>
    </div>
  </div>

  <audio id="sndWin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
  <audio id="bgm1" src="background-music-434612.mp3" loop preload="auto"></audio>
  <audio id="bgm2" src="soft-background-music-427252.mp3" loop preload="auto"></audio>
  <audio id="bgm3" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" loop preload="auto"></audio>

  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>
  <script>
    const _k = ["AIzaSyDSRfVA", "uWCWCUd1NJop", "J6wHvsqsAM4UzJA"];
  const firebaseConfig = {
    apiKey: _k.join(''),
    authDomain: "game-80d68.firebaseapp.com",
    projectId: "game-80d68",
    storageBucket: "game-80d68.firebasestorage.app",
    messagingSenderId: "636332967920",
    appId: "1:636332967920:web:29e5600daf4db0ab613f35",
    measurementId: "G-MJZ4PGEHSQ"
  };
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.firestore();
  let balance = parseFloat(localStorage.getItem('sicbo_balance'));
  let lastSyncedBalance = balance;
  let currentConfig = null, isDrawing = false, isScratched = false, winAmount = 0, currentType = '';
  let isMuted = false, currentBgmIdx = 1;
  let currentNewYearTotalKM = 0; 
  let scratchPointCount = 0;
  const bgmList = [null, 'bgm1', 'bgm2', 'bgm3'];
  const canvas = document.getElementById('scratchCanvas'), ctx = canvas.getContext('2d');

  function saveToLocal() {
    localStorage.setItem('sicbo_balance', balance);
  }

  async function syncToFirebase() {
    const playerId = localStorage.getItem('player_id');
    if (!playerId || !db || balance === lastSyncedBalance) return;

    try {
      await db.collection("users").doc(playerId).update({
        balance: balance,
        lastUpdate: firebase.firestore.Timestamp.now()
      });
      lastSyncedBalance = balance;
      console.log("âœ… é¤˜é¡å·²åŒæ­¥è‡³é›²ç«¯");
    } catch (e) {
      console.error("âŒ é›²ç«¯åŒæ­¥å¤±æ•—", e);
    }
  }

  // ç•«é¢åŠ è¼‰æ™‚å¾é›²ç«¯æŠ“å–é¤˜é¡ (ä¿æŒè·Ÿä½ çš„éº»å°‡ä¾‹å­ä¸€è‡´)
  window.onload = async () => {
    const localBal = localStorage.getItem('sicbo_balance');
    if (localBal !== null) balance = parseFloat(localBal);

    const playerId = localStorage.getItem('player_id');
    if (playerId && db) {
      try {
        const doc = await db.collection("users").doc(playerId).get();
        if (doc.exists) {
          const cloudBal = doc.data().balance;
          // å¦‚æœé›²ç«¯éŒ¢æ¯”è¼ƒå¤šï¼Œä»¥é›²ç«¯ç‚ºä¸»
          if (cloudBal !== undefined && cloudBal > balance) {
            balance = cloudBal;
            saveToLocal();
          }
        }
      } catch (e) { console.log("é›¢ç·šæ¨¡å¼"); }
    }
    updateUI();
  };
  const CONFIGS = {
    small: { price: 10000, prizes: [10000, 200000, 500000, 1000000], winRate: 0.35, desc: "å°ä¸­å¹¸é‹è™Ÿç¢¼å³ä¸­ç" },
    mid: { price: 50000, prizes: [50000, 100000, 200000, 500000, 5000000], winRate: 0.33, desc: "æœé›† ğŸ² æˆ– ğŸ§§" },
    big: { price: 500000, prizes: [500000, 1000000,5000000, 10000000], winRate: 0.3, desc: "ä¸‰åŒé‡‘é¡æˆ–åˆ®å‡ºğŸ‘‘å³ä¸­" },
    xmas: { price: 1000000, prizes: [5000000,10000000, 100000000], winRate: 0.32, desc: "é›†é½Šè–èª•è€äººéšŠä¼" },
    newyear: { price: 2026000, prizes: [202600, 2026000, 20260000, 202600000], winRate: 0.3, desc: "é‡Œç¨‹é”æ¨™å³é»äº®çé‡‘" }
  };

  function updateUI() { 
    document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString(); 
    saveToLocal(); // å­˜æœ¬åœ°
  }

  function stopAllBGM() { bgmList.forEach(id => { if(id) { const a = document.getElementById(id); a.pause(); a.currentTime = 0; } }); }
  function cycleBGM() {
      stopAllBGM(); currentBgmIdx = (currentBgmIdx + 1) % 4;
      const btn = document.getElementById('bgmBtn');
      if (currentBgmIdx === 0) btn.textContent = 'ğŸš« éŸ³æ¨‚é—œ';
      else { btn.textContent = 'ğŸµ éŸ³æ¨‚ ' + currentBgmIdx; if (!isMuted) { const bgm = document.getElementById(bgmList[currentBgmIdx]); if(bgm) { bgm.volume = 0.3; bgm.play().catch(()=>{}); } } }
  }
  function toggleMute() {
      isMuted = !isMuted; document.getElementById('soundIcon').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      if (isMuted) stopAllBGM();
      else if (currentBgmIdx !== 0) { const bgm = document.getElementById(bgmList[currentBgmIdx]); if(bgm) bgm.play().catch(()=>{}); }
  }

  function selectCard(type) {
    currentType = type; currentConfig = CONFIGS[type];
    if(balance < currentConfig.price) { alert("é¤˜é¡ä¸è¶³ï¼"); return; }
    document.getElementById('lobby').style.display = 'none';
    document.getElementById('gameRoom').style.display = 'flex';
    document.getElementById('gameRuleDesc').textContent = currentConfig.desc;
    startNewGame();
  }

  function startNewGame() {
    if(balance < currentConfig.price) { alert("é¤˜é¡ä¸è¶³ï¼"); backToLobby(); return; }
    balance -= currentConfig.price; updateUI();
    isScratched = false; winAmount = 0; currentNewYearTotalKM = 0; 
    canvas.style.opacity = '1';
    scratchPointCount = 0; // æ¯ä¸€å±€éƒ½è¦é‡ç½®è¨ˆæ•¸
  document.getElementById('quickBuyBtn').disabled = true; //
    generateCardLayout();
    initScratchLayer();
  }

  async function generateCardLayout() {
    const container = document.getElementById('cardContent');
    container.className = 'card-content';
    container.style.background = '#fff';
    const isWin = Math.random() < currentConfig.winRate;
    let html = '';

    if (currentType === 'small') {
      container.classList.add('layout-numbers');
      const luckyNum = Math.floor(Math.random() * 90) + 10;
      const multi = Math.random() > 0.8 ? 2 : 1;
      html = `<div class="lucky-zone"><span>å¹¸é‹è™Ÿç¢¼</span><span style="font-size:40px;color:#d63031">${luckyNum}</span>${multi>1?'<b style="color:#e67e22">x2</b>':''}</div><div class="number-grid">`;
      let winPos = isWin ? Math.floor(Math.random() * 6) : -1;
      if(isWin) winAmount = currentConfig.prizes[Math.floor(Math.random() * currentConfig.prizes.length)] * multi;
      for(let i=0; i<6; i++) {
        let n = Math.floor(Math.random() * 90) + 10;
        let p = currentConfig.prizes[Math.floor(Math.random() * 3)];
        if (i === winPos) { n = luckyNum; p = winAmount / multi; } else if (n === luckyNum) n++;
        html += `<div class="prize-item ${i === winPos ? 'win-mark' : ''}"><span>${n}</span><span class="prize-amount">$${p.toLocaleString()}</span></div>`;
      }
      html += `</div>`;
    } 
    else if (currentType === 'mid') {
      container.classList.add('layout-symbols');
      const syms = ['ğŸ‹', 'ğŸ®', 'ğŸŠ', 'ğŸ§¨'];
      let count = isWin ? Math.floor(Math.random() * 2) + 1 : 0;
      if(isWin) winAmount = currentConfig.prizes[Math.floor(Math.random() * currentConfig.prizes.length)];
      let items = [];
      for(let i=0; i<6; i++) {
        if(i < count) items.push({s:'ğŸ²', p:winAmount/count, w:true});
        else items.push({s:syms[Math.floor(Math.random()*syms.length)], p:0, w:false});
      }
      items.sort(()=>Math.random()-0.5);
      html = items.map(it => `<div class="prize-item ${it.w?'win-mark':''}"><h3>${it.s}</h3><span class="prize-amount">${it.p>0?'$'+it.p.toLocaleString():''}</span></div>`).join('');
    } 
    else if (currentType === 'big') {
      container.classList.add('layout-symbols');
      const isCrown = isWin && Math.random() > 0.7;
      if(isWin) winAmount = currentConfig.prizes[Math.floor(Math.random() * currentConfig.prizes.length)];
      let items = [];
      if(isCrown) {
        items.push({s:'ğŸ‘‘', p:winAmount, w:true});
        while(items.length < 6) items.push({s:'ğŸ§§', p:currentConfig.prizes[0], w:false});
      } else if(isWin) {
        for(let i=0; i<3; i++) items.push({s:'ğŸ§§', p:winAmount, w:true});
        while(items.length < 6) items.push({s:'ğŸ§§', p:currentConfig.prizes[0], w:false});
      } else {
        let p1 = currentConfig.prizes[0], p2 = currentConfig.prizes[1];
        for(let i=0; i<6; i++) items.push({s:'ğŸ§§', p:i%2?p1:p2, w:false});
      }
      items.sort(()=>Math.random()-0.5);
      html = items.map(it => `<div class="prize-item ${it.w?'win-mark':''}" data-val="${it.p}"><h3>${it.s}</h3><span class="prize-amount">$${it.p.toLocaleString()}</span></div>`).join('');
    }
    else if (currentType === 'xmas') {
      // ã€ğŸ„ è–èª•å¤–é€åœ˜éšŠ - é›†æˆå“¡é€²ç…™å›ªç‰ˆã€‘
      container.classList.add('layout-symbols');
      container.style.background = '#16a085'; // è–èª•å¢¨ç¶ 
      container.style.display = 'flex';
      container.style.flexDirection = 'column';

      const goalPrizes = [currentConfig.prizes[0], currentConfig.prizes[1], currentConfig.prizes[2]];
      const isWin = Math.random() < currentConfig.winRate;

      // 1. æ±ºå®šæœ€çµ‚ä¸­çç­‰ç´š (0:ä¸ä¸­, 1:ç´…, 2:ç¶ , 3:é‡‘)
      let winLevel = 0;
      if (isWin) {
        let r = Math.random();
        if (r > 0.9) winLevel = 3;      // 10% ä¸­é‡‘æˆ¿å­
        else if (r > 0.6) winLevel = 2; // 30% ä¸­ç¶ æˆ¿å­
        else winLevel = 1;              // 60% ä¸­ç´…æˆ¿å­
      }

      // 2. æ ¹æ“šä¸­çç­‰ç´šåˆ†é… 6 æ ¼å…§å®¹
      let items = [];
      if (winLevel === 3) {
        items = [{s:'ğŸ¦Œ'}, {s:'ğŸ¦Œ'}, {s:'ğŸ›·'}, {s:'ğŸ…'}, {s:'ğŸ­'}, {s:'ğŸ­'}];
        winAmount = goalPrizes[2];
      } else if (winLevel === 2) {
        items = [{s:'ğŸ¦Œ'}, {s:'ğŸ¦Œ'}, {s:'ğŸ›·'}, {s:'â˜ï¸'}, {s:'ğŸ§Š'}, {s:'ğŸ­'}];
        winAmount = goalPrizes[1];
      } else if (winLevel === 1) {
        items = [{s:'ğŸ¦Œ'}, {s:'ğŸ¦Œ'}, {s:'â˜ï¸'}, {s:'ğŸ§Š'}, {s:'ğŸ§Š'}, {s:'ğŸ­'}];
        winAmount = goalPrizes[0];
      } else {
        // æ²’ä¸­çï¼šæ•…æ„çµ¦ 1 éš»éº‹é¹¿æˆ– 1 å€‹é›ªæ©‡ï¼Œè®“ä½ å·®ä¸€é»é»
        items = [{s:'ğŸ¦Œ'}, {s:'ğŸ›·'}, {s:'â˜ï¸'}, {s:'ğŸ§Š'}, {s:'ğŸ§Š'}, {s:'ğŸ­'}];
        winAmount = 0;
      }
      items.sort(() => Math.random() - 0.5);

      // 3. ç”Ÿæˆ HTML
      // ä¸Šæ–¹ï¼šç…™å›ªå®¶å±‹ç›®æ¨™å€
      let htmlTop = `<div style="display:grid; grid-template-columns:repeat(3,1fr); gap:5px; width:100%; margin-bottom:10px;">`;
      const houseNames = ["ç´…æˆ¿å­", "ç¶ æˆ¿å­", "é‡‘å®¶å±‹"];
      const houseIcons = ["ğŸ ", "ğŸ¡", "ğŸ°"];
      const houseReqs = ["ğŸ¦Œx2", "ğŸ¦Œx2+ğŸ›·", "ğŸ¦Œx2+ğŸ›·+ğŸ…"];
      
      houseNames.forEach((name, i) => {
        htmlTop += `
          <div class="goal-item" id="xmas-house-${i+1}" style="background:rgba(255,255,255,0.1); border:1px solid #555; border-radius:8px; padding:4px; text-align:center;">
            <div style="font-size:12px;">${houseIcons[i]}</div>
            <div style="font-size:8px; color:#fff;">${houseReqs[i]}</div>
            <div style="font-size:10px; color:#ffd86b; font-weight:bold;">$${(goalPrizes[i]/10000).toLocaleString()}è¬</div>
          </div>`;
      });
      htmlTop += `</div>`;

      // ä¸‹æ–¹ï¼š6 æ ¼å¤–é€æˆå“¡å€
      let htmlGrid = `<div style="display:grid; grid-template-columns:1fr 1fr; grid-template-rows:repeat(3,1fr); gap:5px; flex:1; width:100%;">`;
      items.forEach(it => {
        // æ¨™è¨˜æœ‰æ•ˆæˆå“¡ä»¥ä¾¿å¾ŒçºŒäº®ç‡ˆåˆ¤å®š
        const isMember = ['ğŸ¦Œ', 'ğŸ›·', 'ğŸ…'].includes(it.s);
        htmlGrid += `
          <div class="prize-item ${isMember ? 'xmas-member' : ''}" data-symbol="${it.s}" style="background:#fffafa; border:1px solid #27ae60">
            <span style="font-size:28px;">${it.s}</span>
            <span style="font-size:9px; color:#27ae60">${isMember ? 'å¤–é€å“¡' : 'å¹²æ“¾'}</span>
          </div>`;
      });
      htmlGrid += `</div>`;

      html = htmlTop + htmlGrid;
      container.dataset.winLevel = winLevel; // ç´€éŒ„ä¸­çç­‰ç´šçµ¦ revealCard ç”¨
    }
    else if (currentType === 'newyear') {
      // ã€2026 ä¸™åˆç´…é¦¬ - é‡Œç¨‹å¥”é¨°ç‰ˆã€‘
      container.classList.add('layout-symbols');
      container.style.background = '#d63031';
      container.style.display = 'flex';
      container.style.flexDirection = 'column';

      const goals = [100, 250, 500, 1000];
      const goalPrizes = [currentConfig.prizes[0], currentConfig.prizes[1], currentConfig.prizes[2], currentConfig.prizes[3]];
      
      // é ç®—ç¸½é‡Œç¨‹
      let targetKM = isWin ? (Math.random() > 0.7 ? 1050 : 550) : 120;
      currentNewYearTotalKM = targetKM; // å­˜å…¥å…¨åŸŸè®Šæ•¸æ–¹ä¾¿ revealCard åˆ¤å®š

      // ç”Ÿæˆ 6 æ ¼é‡Œç¨‹
      let steps = [];
      let tempSum = 0;
      for(let i=0; i<5; i++){
        let s = Math.floor(Math.random() * (targetKM/3.5));
        steps.push(s); tempSum += s;
      }
      steps.push(Math.max(10, targetKM - tempSum)); 
      steps.sort(()=>Math.random()-0.5);

      // HTMLï¼šä¸Šæ–¹ç›®æ¨™çé‡‘
      let htmlTop = `<div style="display:grid; grid-template-columns:repeat(4,1fr); gap:4px; width:100%; margin-bottom:10px;">`;
      goals.forEach((g, i) => {
        htmlTop += `
          <div class="goal-item" id="goal-${g}">
            <div style="font-size:9px; color:#ccc;">${g}km</div>
            <div style="font-size:10px; color:var(--gold); font-weight:bold;">$${(goalPrizes[i]/10000).toLocaleString()}è¬</div>
          </div>`;
      });
      htmlTop += `</div>`;

      // HTMLï¼šä¸‹æ–¹é‡Œç¨‹æ ¼
      let htmlGrid = `<div style="display:grid; grid-template-columns:1fr 1fr; grid-template-rows:repeat(3,1fr); gap:5px; flex:1; width:100%;">`;
      steps.forEach((s, idx) => {
        htmlGrid += `
          <div class="prize-item" style="background:#fff9f0; border:1px solid #f1c40f">
            <span style="font-size:24px;">${s >= 150 ? 'ğŸ' : 'ğŸ’¨'}</span>
            <span style="font-size:16px; font-weight:bold; color:#c0392b">+${s}km</span>
          </div>`;
      });
      htmlGrid += `</div>`;

      html = htmlTop + htmlGrid;
      
      // åˆ¤å®šæœ€çµ‚çé‡‘
      if(isWin) {
        if(targetKM >= 1000) winAmount = goalPrizes[3];
        else if(targetKM >= 500) winAmount = goalPrizes[2];
        else if(targetKM >= 250) winAmount = goalPrizes[1];
        else winAmount = goalPrizes[0];
      } else {
        winAmount = 0;
      }
      
    }
    
    container.innerHTML = html;
  }

  function initScratchLayer() {
    ctx.globalCompositeOperation = 'source-over';
    const g = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
    g.addColorStop(0, '#d4af37'); g.addColorStop(0.5, '#f1c40f'); g.addColorStop(1, '#b38b00');
    ctx.fillStyle = g; ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.font = "bold 40px Arial"; ctx.textAlign = "center";
    ctx.fillText("åˆ®é–‹å€", canvas.width/2, canvas.height/2 + 15);
  }

  function handleScratch(e) {
    if (!isDrawing || isScratched) return;
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath(); ctx.arc(x, y, 35, 0, Math.PI * 2); ctx.fill();
    scratchPointCount++; 
  if (scratchPointCount > 450) { // æ‰‹æ©Ÿæ»‘å‹•ç´„ 3-5 ä¸‹æœƒé”åˆ°æ­¤å€¼
    revealCard();
  }
  }


  async function revealCard() {
  if(isScratched) return;
  isScratched = true; 
  canvas.style.opacity = '0';
  
  // --- 1. å„ªå…ˆè§£é–æŒ‰éˆ•ï¼Œç¢ºä¿ç©å®¶èƒ½é»ã€Œå†è²·ä¸€æ¬¡ã€ ---
  const btn = document.getElementById('quickBuyBtn');
  if(btn) btn.disabled = false;

  // --- 2. äº®ç‡ˆé‚è¼¯ (åŠ å…¥ try-catch é¿å… ID éŒ¯èª¤å°è‡´å¾Œé¢ä¸çµç®—) ---
  try {
    if (currentType === 'newyear') {
      [100, 250, 500, 1000].forEach(g => {
        const el = document.getElementById(`goal-${g}`);
        if (currentNewYearTotalKM >= g && el) el.classList.add('goal-active');
      });
    }
    if (currentType === 'xmas') {
      const level = parseInt(document.getElementById('cardContent').dataset.winLevel || 0);
      for(let i=1; i<=level; i++){
        const el = document.getElementById(`xmas-house-${i}`);
        if(el) el.classList.add('goal-active');
      }
    }
  } catch(e) { console.warn("è¦–è¦ºç‰¹æ•ˆéŒ¯èª¤", e); }

  // --- 3. çµç®—çé‡‘ ---
  if (winAmount > 0) {
    balance += winAmount; 
    updateUI(); 
    if(!isMuted) document.getElementById('sndWin').play().catch(()=>{});
    document.querySelectorAll('.win-mark, .xmas-member').forEach(el => el.classList.add('item-win'));
  }
  
  // --- 4. èƒŒæ™¯åŒæ­¥ (ä¸ä½¿ç”¨ await é¿å…å¡é “) ---
  syncToFirebase();
}

  function reBuy() { startNewGame(); }
  function backToLobby() { document.getElementById('lobby').style.display = 'flex'; document.getElementById('gameRoom').style.display = 'none'; }

  canvas.addEventListener('mousedown', (e) => { isDrawing = true; handleScratch(e); });
  window.addEventListener('mouseup', () => isDrawing = false);
  canvas.addEventListener('mousemove', handleScratch);
  canvas.addEventListener('touchstart', (e) => { isDrawing = true; handleScratch(e); });
  canvas.addEventListener('touchmove', handleScratch);
  window.addEventListener('touchend', () => isDrawing = false);

  updateUI();
  </script>
  </body>
</html>