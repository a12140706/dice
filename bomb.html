<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
    <title>尋寶冒險</title>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --gold: #ffd86b;
            --red: #ff4757;
            --green: #2ecc71;
            --dark: #1a0505;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            font-family: "Microsoft JhengHei", Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--dark);
            color: #fff;
            font-family: Arial;
            height: 100dvh;
            /* 確保使用動態視窗高度 */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: manipulation;
            /* 移除原本這裡的 padding-bottom，改到面板裡處理 */
        }

        .bg-stars {
            position: fixed;
            /* 改為 fixed 確保捲動時依然覆蓋 */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            /* 深色漸層 */
        }

        @keyframes bgMove {
            from {
                background-position: 0 0;
            }

            to {
                background-position: 1000px 1000px;
            }
        }

        .topbar {
            background: linear-gradient(#4a0404, #2a0202);
            /* 1. 增加總高度並預留手機安全區（避開瀏海） */
            height: calc(45px + env(safe-area-inset-top));
            padding-top: calc(15px + env(safe-area-inset-top));
            padding-bottom: 5px;

            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 5px;
            /* 2. 縮小間距防止跑版 */
            padding-left: 10px;
            padding-right: 10px;
            border-bottom: 2px solid #5c0a0a;
            z-index: 1000;
            box-sizing: border-box;
            width: 100%;
            white-space: nowrap;
            /* 3. 強制單行，不換行 */
        }

        /* 4. 排行榜與回大廳按鈕縮小，並加入 flex-shrink 確保不變形 */
        .topbar-rank-btn {
            background: none;
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 4px 6px;
            border-radius: 5px;
            font-size: 11px;
            flex-shrink: 0;
        }

        .topbar-exit-btn {
            background: none;
            border: 1px solid #777;
            color: #ccc;
            border-radius: 5px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* 5. 金額區塊微調 */
        .balance-box {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--gold);
            border-radius: 8px;
            padding: 4px 8px;
            color: var(--gold);
            font-weight: bold;
            font-size: 13px;
            flex-shrink: 1;
            /* 金額過長時允許自動縮放 */
        }

        .sound-btn {
            font-size: 10px;
            background: #4a148c;
            border: 1px solid #ce93d8;
            padding: 3px 6px;
            border-radius: 12px;
            color: #fff;
        }

        .balance-box {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--gold);
            border-radius: 8px;
            padding: 4px 8px;
            color: var(--gold);
            font-weight: bold;
            font-size: 13px;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* 新增：讓內容垂直置中，填補下方空洞 */
            padding: 10px;
            gap: 15px;
            /* 稍微加大間距，讓手機點擊更舒服 */
            overflow-y: auto;
            z-index: 10;
            width: 100%;
            box-sizing: border-box;
        }

        .top-winner-bar {
            width: 92%;
            padding: 8px 12px;
            /* 減少邊距，避免把遊戲區推得太遠 */
            margin: 10px auto 15px auto;

            background: rgba(0, 0, 0, 0.3);
            /* 深色背景更能顯出稱號特效 */
            border: 1px solid rgba(212, 175, 55, 0.5);
            /* 降低邊框亮度 */
            border-radius: 50px;
            /* 變成圓角的膠囊狀更精緻 */
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);

            position: relative;
            z-index: 5;

            /* 確保內容物在同一行且不換行 */
            white-space: nowrap;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 如果你想讓裡面的名字或紀錄大一點，也可以微調 */
        #topWinnerName {
            display: flex;
            flex-direction: column;
            /* 讓稱號、名字、金額垂直排開，更佔空間 */
            gap: 8px;
            align-items: center;
        }

        .multiplier-step {
            font-size: 14px;
            color: #aaa;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255, 216, 107, 0.3);
        }

        .multiplier-step.active {
            color: var(--gold);
            border-color: var(--gold);
            background: rgba(255, 216, 107, 0.2);
            font-weight: bold;
            box-shadow: 0 0 10px var(--gold);
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            width: 100%;
            max-width: 350px;
            aspect-ratio: 1/1;
            margin: 10px 0;
        }

        .tile {
            background: #3d0a0a;
            border-radius: 8px;
            border: 1px solid #5c0a0a;
            border-bottom: 5px solid #2a0505;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            /* 新增以下三行，確保格子絕對是正方形且不變形 */
            aspect-ratio: 1 / 1;
            width: 100%;
            box-sizing: border-box;
        }


        @keyframes gemAppear {
            0% {
                transform: scale(0) rotate(-45deg);
                opacity: 0;
            }

            80% {
                transform: scale(1.2) rotate(10deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .tile.active {
            background: linear-gradient(145deg, #4a0a0a, #2a0505);
            border: 1.5px solid var(--gold);
            /* 加入金邊 */
            box-shadow: inset 0 0 10px rgba(255, 216, 107, 0.2);
            /* 加入呼吸燈特效，一眼看出這區可以點 */
            animation: pulse-active 2s infinite alternate;
        }

        /* 移除或覆蓋原本會導致位移的 active 縮放 */
        .tile.active:active {
            transform: scale(0.95);
            /* 改用等比例微縮小模擬按壓，不會影響佈局 */
            border-bottom-width: 4px;
            /* 保持邊框高度一致防止抖動 */
        }

        .tile.revealed-coin {
            background: linear-gradient(135deg, #00d2ff, #3a7bd5) !important;
            border: 1.5px solid #fff !important;
            border-bottom: 4px solid #2d5a9e !important;
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            animation: flip 0.3s forwards;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: default;
            z-index: 2;
            /* 確保層級高於一般格子 */
        }

        /* 炸彈格：修正顏色並確保不被覆蓋 */
        .tile.revealed-bomb {
            background: linear-gradient(135deg, #ff4b2b, #ff416c) !important;
            border: 1.5px solid #fff !important;
            border-bottom: 4px solid #b22222 !important;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            animation: shake 0.4s ease-in-out;
            cursor: default;
            z-index: 2;
        }

        /* 修正 flip 動畫，確保 transform 不會殘留縮放以外的偏移 */
        @keyframes flip {
            from {
                transform: perspective(400px) rotateY(90deg);
                opacity: 0;
            }

            to {
                transform: perspective(400px) rotateY(0deg);
                opacity: 1;
            }
        }

        /* 修正 shake 動畫，確保最後回到原位且不影響寬度 */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-3px);
            }

            75% {
                transform: translateX(3px);
            }
        }

        /* 呼吸燈動畫定義 */
        @keyframes pulse-active {
            from {
                box-shadow: inset 0 0 5px rgba(255, 216, 107, 0.1), 0 0 5px rgba(255, 216, 107, 0.1);
            }

            to {
                box-shadow: inset 0 0 15px rgba(255, 216, 107, 0.3), 0 0 12px rgba(255, 216, 107, 0.4);
            }
        }

        .tile.disabled:not(.revealed-coin):not(.revealed-bomb) {
            cursor: default;
            opacity: 0.5;
            filter: grayscale(1);
            border-color: #333;
            border-bottom: 2px solid #111;
            animation: none;
        }

        .controls {
            width: 100%;
            max-width: 350px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid #4a0404;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-row {
            display: flex;
            justify-content: space-between;
            /* 讓文字與選擇器分開到兩端 */
            align-items: center;
            gap: 20px;
            width: 100%;
            /* 強制填滿容器寬度 */
            padding: 5px 0;
        }

        .input-row span {
            color: #ccc;
            font-weight: bold;
            flex: 1;
            /* 讓文字佔據剩餘空間，推動右側對齊 */
            text-align: left;
        }

        .bet-selector {
            /* 保持固定寬度 150px 確保上下兩行對齊 */
            width: 150px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #5c0a0a;
            border-radius: 10px;
            padding: 2px;
        }

        .action-btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-start {
            background: var(--gold);
            color: #000;
            box-shadow: 0 5px 0 #b38b00;
        }

        .btn-cashout {
    background: var(--green);
    color: #fff;
    box-shadow: 0 5px 0 #27ae60;
    display: none;
    
    /* 新增以下屬性來支援兩行顯示 */
    white-space: pre-line;   /* 關鍵：讓 \n 能夠換行 */
    line-height: 1.3;        /* 讓兩行字之間的距離適中 */
    padding: 12px 10px;      /* 增加上下內距，確保裝得下兩行字 */
    min-height: 65px;        /* 確保按鈕高度固定，點擊時不會跳動 */
    align-items: center;
    justify-content: center;
}
        #rankSidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background: rgba(20, 0, 0, 0.95);
            border-left: 2px solid var(--gold);
            z-index: 2000;
            transition: 0.3s;
            padding: 20px;
            overflow-y: auto;
        }

        #rankOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 1999;
        }

        .rank-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 216, 107, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-title {
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 3px;
            margin-right: 4px;
        }

        .t-red {
            border: 1px solid #ff4757;
            color: #ff4757;
        }

        .t-orange {
            border: 1px solid #ffa502;
            color: #ffa502;
        }

        .t-purple {
            border: 1px solid #a4b0be;
            color: #a4b0be;
        }

        @keyframes flip {
            from {
                transform: perspective(400px) rotateY(90deg);
                opacity: 0;
            }

            to {
                transform: perspective(400px) rotateY(0deg);
                opacity: 1;
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-2px);
            }

            /* 縮小抖動幅度減少對佈局的影響 */
            75% {
                transform: translateX(2px);
            }
        }

        .bet-btn {
            background: #3d0a0a;
            border: 1px solid var(--gold);
            color: var(--gold);
            width: 30px;
            height: 30px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        .bet-btn:disabled {
            opacity: 0.3;
        }

        .bet-display {
            flex: 1;
            text-align: center;
            font-weight: bold;
            color: var(--gold);
            font-size: 16px;
        }

        .win-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: var(--gold);
            padding: 20px 40px;
            border: 2px solid var(--gold);
            border-radius: 15px;
            font-size: 20px;
            font-weight: bold;
            z-index: 10000;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            animation: toastFade 2.5s forwards;
            pointer-events: none;
        }

        @keyframes toastFade {
            0% {
                opacity: 0;
                transform: translate(-50%, -40%);
            }

            20% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }

            80% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
        }

        /* 大獎結算畫面 */
        .big-win-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            animation: fadeIn 0.5s forwards;
        }

        .big-win-content {
            text-align: center;
            animation: scorePopup 0.6s cubic-bezier(0.17, 0.89, 0.32, 1.49);
        }

        .big-win-title {
            font-size: 40px;
            color: #ff0000;
            text-shadow: 0 0 20px #ff0000, 0 0 40px #ff8c00;
            font-weight: 900;
            margin-bottom: 10px;
            letter-spacing: 5px;
        }

        .big-win-amount {
            font-size: 48px;
            color: var(--gold);
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            font-weight: bold;
            margin: 20px 0;
        }

        .big-win-mult {
            font-size: 24px;
            color: #fff;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 20px;
            border-radius: 20px;
        }

        @keyframes scorePopup {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* 普通中獎提示 (小提示框) */
        .win-result-toast {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid #444;
            padding: 15px 30px;
            border-radius: 12px;
            text-align: center;
            z-index: 10002;
            pointer-events: none;
            animation: simpleFade 2s forwards;
        }

        .win-result-toast .amount {
            color: var(--gold);
            font-size: 24px;
            font-weight: bold;
        }

        .win-result-toast .mult {
            color: #888;
            font-size: 14px;
        }

        @keyframes simpleFade {
            0% {
                opacity: 0;
                transform: translate(-50%, -30%);
            }

            15% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }

            85% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
        }

        .player-title {
            font-weight: 900;
            margin-right: 5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* 稱號等級色彩 */
        .t-green {
            color: #2ecc71 !important;
        }

        .t-blue {
            color: #3498db !important;
        }

        .t-purple {
            color: #9b59b6 !important;
        }

        .t-orange {
            color: #e67e22 !important;
        }

        .t-red {
            color: #ff4757 !important;
            animation: title-glow 1s infinite alternate;
        }

        @keyframes title-glow {
            from {
                filter: drop-shadow(0 0 1px #ff4757);
            }

            to {
                filter: drop-shadow(0 0 5px #ff4757);
            }
        }

        /* --- 2. 排行榜項目特效核心 (確保在遊戲 Sidebar 內生效) --- */
        .rank-item {
            position: relative !important;
            overflow: hidden !important;
            contain: paint;
            /* 防止特效溢出造成手機橫向滾動 */
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* [特效：極限獄火] */
        .fx-fire {
            border: 2px solid transparent !important;
            background: linear-gradient(#2a0000, #2a0000) padding-box,
                linear-gradient(0deg, #ff4757, #ff9f43, #ff4757) border-box !important;
            background-size: 100% 100%, 100% 300% !important;
            color: #fff !important;
            box-shadow: inset 0 0 15px #741b1b, 0 0 15px rgba(255, 71, 87, 0.5) !important;
            text-shadow: 0 0 8px #ff4757 !important;
            animation: fire-flicker 0.2s ease-in-out infinite alternate, border-flow 1.5s linear infinite !important;
        }

        .fx-fire::before {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 200%;
            background: linear-gradient(0deg, transparent 0%, rgba(255, 69, 0, 0.4) 20%, transparent 80%);
            z-index: -1;
            animation: fire-rise 1s linear infinite;
        }

        /* [特效：雷霆霓虹] */
        .fx-neon {
            border: 2px solid #fff !important;
            /* 1. 關鍵修改：將 0% 和 100% 的黑色改為深藍色，hue-rotate 才能抓到顏色變色 */
            background: linear-gradient(135deg,
                    #001a33 0%,
                    /* 取代黑色 */
                    #004488 25%,
                    #0066aa 50%,
                    #440088 75%,
                    #001a33 100%
                    /* 取代黑色 */
                ) !important;
            background-size: 300% 300% !important;
            color: #fff !important;

            /* 2. 增加強烈的內部發光，直接把背景照亮 */
            box-shadow:
                inset 0 0 30px rgba(0, 210, 255, 0.7),
                0 0 10px #fff,
                0 0 20px #00d2ff !important;

            /* 3. 動畫組合 */
            animation:
                neon-flicker 2s infinite,
                neon-rainbow 2s linear infinite,
                bg-flow-extreme 1s ease-in-out infinite !important;

            /* 確保內容在發光背景上依然清晰 */
            text-shadow: 0 0 5px #000, 2px 2px 2px #000 !important;
        }

        /* 4. 強化的背景移動：讓漸層在盒子裡大幅度滑動 */
        @keyframes bg-flow-extreme {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .fx-ultimate-legend {
            position: relative;
            /* 1. 背景改為流光漸層，取代純黑 */
            background: linear-gradient(90deg,
                    #000 0%,
                    #FFD700 20%,
                    #FFFFFF 40%,
                    #FF4500 60%,
                    #9400D3 80%,
                    #000 100%) !important;
            background-size: 300% 100% !important;

            z-index: 1;
            border: 1px solid #FFD700;
            /* 這裡必須是 visible，否則流動陰影會被切掉 */
            overflow: visible !important;
            width: 100% !important;
            box-sizing: border-box !important;

            /* 震動效果 + 背景流動動畫 */
            animation: ult-bg-flow 4s linear infinite, ult-vibrate 0.15s infinite;
        }

        /* 改造後的陰影層：多色呼吸發光 */
        .fx-ultimate-legend::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 52px;
            z-index: -1;
            filter: blur(12px);
            /* 稍微加深模糊，更有能量場的感覺 */
            opacity: 0.7;
            /* 執行多色陰影變換動畫 */
            animation: ult-shadow-glow 3s ease-in-out infinite alternate;
        }

        /* 文字層維持你原本的流光質感 */
        .fx-ultimate-legend span {
            position: relative;
            z-index: 20 !important;
            background: linear-gradient(to right, #fff 20%, #ffd700 40%, #ff4500 60%, #fff 80%);
            background-size: 200% auto;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: ult-text-flow 2s linear infinite;
            font-weight: 900;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }

        /* --- 新增/修改動畫定義 --- */

        /* 背景流動：讓黑框裡的顏色動起來 */
        @keyframes ult-bg-flow {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 300% 50%;
            }
        }

        /* 多色陰影變換：補償原本 JS 粒子的顏色動態 */
        @keyframes ult-shadow-glow {
            0% {
                background: #0f12dd;
                box-shadow: 0 0 15px #0f12dd, 0 0 30px rgba(255, 215, 0, 0.4);
            }

            50% {
                background: #9400D3;
                box-shadow: 0 0 20px #9400D3, 0 0 40px rgba(148, 0, 211, 0.4);
            }

            100% {
                background: #FF4500;
                box-shadow: 0 0 15px #FF4500, 0 0 30px rgba(255, 69, 0, 0.4);
            }
        }

        /* 原本的動畫保留 */
        @keyframes ult-text-flow {
            0% {
                background-position: 0% center;
            }

            100% {
                background-position: 200% center;
            }
        }

        @keyframes ult-vibrate {
            0% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(0.5px, -0.5px);
            }

            100% {
                transform: translate(0, 0);
            }
        }

        /* --- 特效 12：暗影雷電特效 (fx-lightning) --- */
        .fx-lightning {
            background: #000 !important;
            color: #fff !important;
            box-shadow: 0 0 10px #00d2ff, 0 0 20px #3a7bd5 inset !important;
            animation: lightning-flash 2s infinite !important;
        }

        @keyframes lightning-flash {

            0%,
            90%,
            100% {
                opacity: 1;
            }

            92% {
                filter: brightness(3);
                transform: scale(1.02);
            }

            94% {
                filter: brightness(1);
            }

            96% {
                filter: brightness(2.5);
            }
        }

        /* --- 新特效動畫定義 --- */
        @keyframes ice-shimmer {
            from {
                filter: saturate(1) brightness(1);
                box-shadow: 0 0 5px #00f2fe;
            }

            to {
                filter: saturate(1.5) brightness(1.2);
                box-shadow: 0 0 20px #00f2fe;
            }
        }

        @keyframes lightning-strike {

            0%,
            95%,
            98% {
                opacity: 0;
            }

            96%,
            99% {
                opacity: 0.4;
            }

            /* 模擬雷雨閃電瞬間閃爍 */
        }

        @keyframes void-pulse {

            0%,
            100% {
                transform: scale(1);
                filter: blur(0px);
            }

            50% {
                transform: scale(0.98);
                filter: blur(0.5px);
            }
        }

        @keyframes rotate-slow {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .fx-hacker {
            position: relative !important;
            background: #000 !important;
            border: 2px solid #0f0 !important;
            color: #0f0 !important;
            font-family: 'Courier New', monospace;
            overflow: hidden !important;
            box-shadow: 0 0 15px #0f0, inset 0 0 30px rgba(0, 255, 0, 0.4) !important;
            z-index: 1;
        }

        /* 1. 背景條紋 */
        .fx-hacker::before {
            content: "";
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 0, 0.1) 2px,
                    rgba(0, 255, 0, 0.1) 4px);
            z-index: -1;
        }

        /* 2. 亂碼瀑布流 - 加長內容確保循環不斷 */
        .fx-hacker::after {
            content: "10110010101010010101101010101001010101010101010010110101001010110101010010101101010010101010101010010010110100101010100101010101010100101101010010101101010100101011010100101010101010101001\A 0101010101010101010101010010101010101010110101010010101010100101010101010010101010010110101001010101\A 1101010100101011010100101010101010100101101010010101010010101101010101001001010110101010101001\A 1011001010101001010110101010100101010101010101001011010100101011010101001010110101001010101010101001001011010010101010010101010101010010110101001010110101010010101101010010101010101010101001";
            position: absolute;
            top: -100%;
            left: 0;
            width: 100%;
            height: 300%;
            /* 增加高度 */
            font-size: 12px;
            line-height: 12px;
            word-break: break-all;
            white-space: pre-wrap;
            color: rgba(0, 255, 0, 0.3);
            animation: matrix-scroll 4s linear infinite;
            z-index: -1;
        }

        @keyframes matrix-scroll {
            0% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(50%);
            }

            /* 控制移動範圍 */
        }

        @keyframes matrix-bg-scroll {
            0% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(-20px);
            }
        }

        @keyframes scanline-pass {
            0% {
                top: -20%;
            }

            100% {
                top: 120%;
            }
        }

        /* --- 特效 8：星雲霸主 (銀河繁星版) --- */
        .fx-nebula {
            position: relative !important;
            background: transparent !important;
            border: 2px solid transparent !important;
            color: #fff !important;
            overflow: hidden !important;
            box-shadow: 0 0 20px #7b2cbf, 0 0 40px #e0aaff !important;
            text-shadow: 0 0 5px #fff, 0 0 10px #ff00de !important;
            z-index: 1;
        }

        /* 邊框層 */
        .fx-nebula::before {
            content: "";
            position: absolute;
            inset: -3px;
            background: conic-gradient(from 0deg, #ff00de, #7b2cbf, #4cc9f0, #ff00de);
            z-index: -2;
            animation: spin-super-fast 3s linear infinite;
            border-radius: 12px;
        }

        /* 背景層：極致密度的星空 */
        .fx-nebula::after {
            content: "";
            position: absolute;
            inset: 3px;
            background:
                /* Bright Stars (Big) */
                radial-gradient(2px 2px at 15% 15%, #fff, transparent),
                radial-gradient(2px 2px at 50% 20%, #fff, transparent),
                radial-gradient(2px 2px at 85% 15%, #fff, transparent),
                radial-gradient(2px 2px at 10% 80%, #fff, transparent),
                radial-gradient(2px 2px at 90% 85%, #fff, transparent),

                /* Medium Stars */
                radial-gradient(1.5px 1.5px at 30% 40%, rgba(255, 255, 255, 0.8), transparent),
                radial-gradient(1.5px 1.5px at 70% 60%, rgba(255, 255, 255, 0.8), transparent),
                radial-gradient(1.5px 1.5px at 20% 60%, rgba(255, 255, 255, 0.8), transparent),
                radial-gradient(1.5px 1.5px at 80% 30%, rgba(255, 255, 255, 0.8), transparent),

                /* Tiny Stars Cluster */
                radial-gradient(1px 1px at 5% 5%, rgba(255, 255, 255, 0.5), transparent),
                radial-gradient(1px 1px at 25% 25%, rgba(255, 255, 255, 0.5), transparent),
                radial-gradient(1px 1px at 45% 45%, rgba(255, 255, 255, 0.5), transparent),
                radial-gradient(1px 1px at 65% 65%, rgba(255, 255, 255, 0.5), transparent),
                radial-gradient(1px 1px at 85% 85%, rgba(255, 255, 255, 0.5), transparent),
                radial-gradient(1px 1px at 15% 75%, rgba(255, 255, 255, 0.5), transparent),
                radial-gradient(1px 1px at 35% 95%, rgba(255, 255, 255, 0.5), transparent),
                radial-gradient(1px 1px at 55% 15%, rgba(255, 255, 255, 0.5), transparent),
                radial-gradient(1px 1px at 75% 35%, rgba(255, 255, 255, 0.5), transparent),
                radial-gradient(1px 1px at 95% 55%, rgba(255, 255, 255, 0.5), transparent),
                radial-gradient(1px 1px at 2% 40%, rgba(255, 255, 255, 0.5), transparent),
                radial-gradient(1px 1px at 98% 60%, rgba(255, 255, 255, 0.5), transparent),

                /* Deep Background */
                linear-gradient(135deg, #12002f 0%, #30005a 100%);
            background-size: 200% 200%;
            z-index: -1;
            border-radius: 10px;
            animation: nebula-bg-shift 6s ease infinite alternate;
        }

        @keyframes nebula-bg-shift {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 100% 50%;
            }
        }

        /* --- 特效 9：時光領主 (齒輪回歸版) --- */
        .fx-timelord {
            position: relative !important;
            background-color: #111 !important;
            /* 將網格背景移到主元素，讓出 ::before 給齒輪 */
            background-image:
                linear-gradient(#444 1px, transparent 1px),
                linear-gradient(90deg, #444 1px, transparent 1px);
            background-size: 30px 30px;
            color: #ffd700 !important;
            border: 2px solid #ffd700 !important;
            overflow: hidden !important;
            box-shadow: inset 0 0 20px #000, 0 0 15px #ffd700 !important;
            z-index: 1;
            animation: bg-grid-scroll 4s linear infinite !important;
        }

        /* 1. 巨大金屬齒輪 (回歸) */
        .fx-timelord::before {
            content: "⚙️";
            position: absolute;
            right: -25px;
            bottom: -25px;
            font-size: 90px;
            opacity: 0.15;
            z-index: 0;
            animation: rotate-slow 10s linear infinite;
            filter: grayscale(1) brightness(1.5);
        }

        /* 2. 黃金指針掃過 (Overlay 模式) */
        .fx-timelord::after {
            content: "";
            position: absolute;
            top: -100%;
            left: -50%;
            width: 200%;
            height: 300%;
            /* 使用 hard-light 混合模式 */
            background: conic-gradient(from 0deg, transparent 0deg, rgba(255, 230, 0, 0.4) 15deg, rgba(255, 255, 255, 0.9) 20deg, transparent 25deg, transparent 40deg);
            animation: radar-sweep 3s linear infinite;
            z-index: 2;
            /* 放在最上層 */
            pointer-events: none;
            /* 讓點擊穿透 */
            mix-blend-mode: hard-light;
            /* 讓光效疊加在文字上 */
        }

        @keyframes bg-grid-scroll {
            0% {
                background-position: 0 0;
            }

            100% {
                background-position: 0 30px;
            }
        }

        @keyframes grid-move {
            0% {}

            100% {
                transform: translateY(30px);
            }
        }

        @keyframes radar-sweep {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }


        /* --- 特效 10：眾神之王 (MAXIMALISM VERSION) --- */
        .fx-god-king {
            position: relative !important;
            /* Radiant sunburst gradient */
            background: radial-gradient(circle at center, #ffecb3 0%, #ffd700 40%, #a07e00 100%) !important;
            border: 2px solid #fff !important;
            color: #5c0a0a !important;
            /* Dark text for contrast */
            font-weight: 900 !important;
            overflow: hidden !important;
            /* Blinding outer glow */
            box-shadow: 0 0 30px #ffd700, 0 0 60px #fff, 0 0 80px #ffea00 !important;
            text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
            /* White outline for text */
            animation: god-pulse 2s ease-in-out infinite !important;
            z-index: 1;
        }

        /* Rotating Rays - Stronger contrast */
        .fx-god-king::before {
            content: "";
            position: absolute;
            top: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background: repeating-conic-gradient(from 0deg,
                    rgba(255, 255, 255, 0.4) 0deg 5deg,
                    transparent 5deg 15deg);
            animation: spin-slow 10s linear infinite;
            z-index: 0;
        }

        /* Falling Gold Dust / Sparkles */
        .fx-god-king::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle, #fff 1px, transparent 1px),
                radial-gradient(circle, #fff 2px, transparent 2px);
            background-size: 15px 15px, 30px 30px;
            animation: god-particles 1s linear infinite;
            z-index: 0;
            opacity: 0.6;
        }

        @keyframes nebula-float {
            0% {
                transform: translateY(0px) scale(1);
            }

            100% {
                transform: translateY(-3px) scale(1.02);
            }
        }

        @keyframes spin-super-fast {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes time-warp {
            0% {
                transform: perspective(300px) rotateX(20deg) translateY(0);
            }

            100% {
                transform: perspective(300px) rotateX(20deg) translateY(-20px);
            }
        }

        @keyframes god-pulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 30px #ffd700;
            }

            50% {
                transform: scale(1.03);
                box-shadow: 0 0 50px #ffd700, 0 0 80px #fff;
            }
        }

        @keyframes god-particles {
            from {
                background-position: 0 0, 0 0;
            }

            to {
                background-position: 0 15px, 0 30px;
            }
        }

        /* [特效：至尊皇金] */
        .fx-gold {
            border: 1px solid #ffd700 !important;
            background-image: linear-gradient(110deg, #6b5500 0%, #ffd700 50%, #6b5500 100%) !important;
            background-size: 200% auto !important;
            animation: shine-gold 3s linear infinite !important;
        }

        /* [特效：絕對零度] */
        /* --- 特效 4：絕對零度 (冰藍呼吸 + 結晶閃爍) --- */
   .fx-ice {
    position: relative;
    overflow: hidden;
    border: 1px solid #00f2fe !important;
    background: linear-gradient(135deg, #005f73, #00d4ff) !important;
    color: #fff !important;
    text-shadow: 0 0 10px #7ed6ff !important;
    box-shadow: 0 0 15px rgba(0, 242, 254, 0.5) !important;
    animation: ice-shimmer 2s ease-in-out infinite alternate !important;
}
/* ❄️ 這裡是雪花專屬層 */
.fx-ice::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
    
    /* 使用三層隨機分佈的雪花點 */
    background-image: 
        radial-gradient(1.5px 1.5px at 20% 30%, #fff 100%, transparent),
        radial-gradient(2px 2px at 50% 70%, #fff 100%, transparent),
        radial-gradient(1.2px 1.2px at 80% 40%, #fff 100%, transparent);
    
    /* 讓雪花背景重複鋪滿，並設定不同的大小來打破規律 */
    background-size: 100px 100px, 150px 150px, 200px 200px;
    
    /* 執行下雪動畫 */
    animation: snow-fall-fixed 10s linear infinite;
}
    .fx-ice::before {
      content: "❄" !important;
      color: #6860fe !important; 
      text-shadow: 0 0 5px rgba(237, 159, 255, 0.8) !important;
      position: absolute;
      right: 5px;
      top: -5px;
      opacity: 1;
      font-size: 20px;
      animation: rotate-slow 5s linear infinite;
    }
    @keyframes snow-fall-fixed {
    0% {
        background-position: 0 0, 0 0, 0 0;
    }
    100% {
        /* 讓三層雪花以不同速度和方向飄落，視覺上很隨機 */
        background-position: 100px 100px, -150px 300px, 200px 600px;
    }
}

        /* [特效：黑洞湮滅] */
        .fx-void {
            border: 2px solid #2f3542 !important;
            background: black !important;
            color: #a55eea !important;
            box-shadow: 0 0 20px #6c5ce7 !important;
            animation: void-pulse 3s ease-in-out infinite !important;
        }

        /* --- 特效：深海雷鳴 (修正版) --- */
        .fx-thunder {
            border: 1px solid #4834d4 !important;
            background: #060b28 !important;
            color: #fff !important;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .fx-thunder::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            z-index: -1;
            animation: lightning-strike 2s steps(1) infinite;
        }

        @keyframes lightning-strike {

            0%,
            95%,
            98% {
                opacity: 0;
            }

            96%,
            99% {
                opacity: 0.4;
            }

            /* 模擬閃電瞬間亮起 */
        }

        /* --- 特效 7：駭客任務 (矩陣代碼雨) --- */
        .fx-hacker {
            border: 1px solid #0f0 !important;
            background: #000 !important;
            color: #0f0 !important;
            font-family: 'Courier New', monospace;
            box-shadow: 0 0 10px #0f0, inset 0 0 20px rgba(0, 255, 0, 0.2) !important;
            position: relative;
            overflow: hidden;
        }

        .fx-hacker::before {
            content: "0 1 0 1 0 1 1 0 1 0 0 1";
            position: absolute;
            top: -100%;
            left: 0;
            width: 100%;
            height: 100%;
            color: rgba(0, 255, 0, 0.2);
            font-size: 10px;
            line-height: 10px;
            word-break: break-all;
            animation: matrix-rain 2s linear infinite;
            z-index: 0;
        }

        @keyframes matrix-rain {
            0% {
                top: -100%;
            }

            100% {
                top: 100%;
            }
        }

        /* --- 特效 8：星雲霸主 (深空紫霧) --- */
        .fx-nebula {
            border: 1px solid #ff00de !important;
            background: linear-gradient(135deg, #240b36, #c31432) !important;
            background-size: 200% 200% !important;
            color: #fff !important;
            text-shadow: 0 0 5px #fff !important;
            box-shadow: 0 0 20px #ff00de !important;
            animation: nebula-flow 5s ease infinite !important;
        }

        @keyframes nebula-flow {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* --- 特效 9：時光領主 (齒輪轉動感 + 金銀交錯) --- */
        .fx-timelord {
            border: 2px double #c0c0c0;
            background: #1a1a1a;
            color: #ffd700;
            box-shadow: inset 0 0 20px #000;
            position: relative;
            overflow: hidden;
        }

        .fx-timelord::before,
        .fx-timelord::after {
            content: "⚙️";
            position: absolute;
            opacity: 0.1;
            font-size: 40px;
            animation: rotate-slow 10s linear infinite;
        }

        .fx-timelord::before {
            top: -10px;
            right: -10px;
        }

        .fx-timelord::after {
            bottom: -10px;
            left: -10px;
            animation-direction: reverse;
        }

        /* --- 特效 10：眾神之王 (神聖光輝) --- */
        .fx-god-king {
            border: 2px solid #fff !important;
            background: linear-gradient(45deg, #ffd700, #fff, #ffd700) !important;
            background-size: 200% auto !important;
            color: #000 !important;
            font-weight: 900 !important;
            box-shadow: 0 0 30px #ffd700, 0 0 60px #fff !important;
            animation: god-shine 2s linear infinite !important;
        }

        @keyframes god-shine {
            0% {
                background-position: 0% center;
            }

            100% {
                background-position: 200% center;
            }
        }

        /* --- 3. 所有關鍵動畫定義 (合併首頁所有 Keyframes) --- */
        @keyframes border-flow {
            0% {
                background-position: 0% 0%, 50% 100%;
            }

            100% {
                background-position: 0% 0%, 50% -100%;
            }
        }

        @keyframes fire-rise {
            0% {
                transform: translateY(0%);
                opacity: 0.8;
            }

            100% {
                transform: translateY(-50%);
                opacity: 0.4;
            }
        }

        @keyframes fire-flicker {
            0% {
                filter: brightness(1);
            }

            100% {
                filter: brightness(1.3);
            }
        }

        @keyframes neon-rainbow {
            0% {
                filter: hue-rotate(0deg);
            }

            100% {
                filter: hue-rotate(360deg);
            }
        }

        @keyframes neon-flicker {

            0%,
            18%,
            22%,
            25%,
            53%,
            57%,
            100% {
                opacity: 1;
            }

            20%,
            24%,
            55% {
                opacity: 0.7;
            }
        }

        @keyframes shine-gold {
            to {
                background-position: 200% center;
            }
        }

        @keyframes ice-shimmer {
            from {
                filter: brightness(1);
                box-shadow: 0 0 5px #00f2fe;
            }

            to {
                filter: brightness(1.2);
                box-shadow: 0 0 20px #00f2fe;
            }
        }

        @keyframes void-pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(0.98);
            }
        }
    </style>
</head>

<body onclick="handleFirstClick()">

    <div class="bg-stars"></div>

    <div id="rankOverlay" onclick="toggleRank()"></div>
    <div id="rankSidebar">
        <h3 style="color:var(--gold); margin-bottom:20px; text-align:center;">🏆尋寶排行榜</h3>
        <div id="mineRankList"></div>
    </div>

    <div class="topbar">
        <div class="sound-btn" onclick="toggleMute()" id="muteBtn">🔊</div>
        <div class="sound-btn" onclick="cycleBGM()" id="bgmBtn">🎵音樂 1</div>
        <div class="balance-box">💎 <span id="balanceText">0</span></div>

        <div style="flex:1"></div>

        <button onclick="toggleRank()" class="topbar-rank-btn">🏆排行榜</button>

        <a href="index.html" style="text-decoration:none;">
            <button class="topbar-exit-btn">🏠大廳</button>
        </a>
    </div>
    <div class="main-container">
        <div class="top-winner-bar" id="topWinnerName">載入中...</div>
        <div class="multiplier-step" id="multDisplay">下一格倍率: --</div>
        <div class="grid-container" id="grid"></div>

        <div class="controls">
            <div class="input-row">
                <span>💎 下注金額:</span>
                <div class="bet-selector">
                    <button class="bet-btn" onclick="changeBet(-1)" id="betMinus">-</button>
                    <div class="bet-display" id="betText">10,000,000</div>
                    <button class="bet-btn" onclick="changeBet(1)" id="betPlus">+</button>
                </div>
            </div>
            <div class="input-row">
                <span>💣 炸彈數量(影響探險倍率)</span>
                <div class="bet-selector">
                    <button class="bet-btn" onclick="changeBomb(-1)" id="bombMinus">-</button>
                    <div class="bet-display" id="bombText">10</div>
                    <button class="bet-btn" onclick="changeBomb(1)" id="bombPlus">+</button>
                </div>
            </div>

            <button class="action-btn btn-start" id="startBtn" onclick="startGame()">開始探險</button>
            <button class="action-btn btn-cashout" id="cashoutBtn" onclick="cashout()">贏得: $0</button>
        </div>
    </div>

    <audio id="sndCoin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
    <audio id="sndBomb" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" preload="auto"></audio>
    <audio id="bgm1" src="background-music-434612.mp3" loop preload="auto"></audio>
    <audio id="bgm2" src="another-bgm.mp3" loop preload="auto"></audio>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>
    <script>
        // --- Firebase 初始化 ---
        const _k = ["AIzaSyDSRfVA", "uWCWCUd1NJop", "J6wHvsqsAM4UzJA"];
        const firebaseConfig = {
            apiKey: _k.join(''),
            authDomain: "game-80d68.firebaseapp.com",
            projectId: "game-80d68",
            storageBucket: "game-80d68.firebasestorage.app",
            messagingSenderId: "636332967920",
            appId: "1:636332967920:web:29e5600daf4db0ab613f35"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 核心變數 ---
        let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
        let lastSyncedBalance = balance;
        let isGameActive = false;
        let mines = [];
        let revealedCount = 0;
        let currentBet = 0;
        let isMuted = false, currentBGM = 1, hasInteracted = false;
        const betOptions = [10000, 50000, 100000, 1000000, 5000000, 10000000];
        let currentBetIdx = 5;
        // 定義炸彈數量的選項（依照原本 select 的值）
        const bombOptions = [3, 5, 10, 15, 20];
        let currentBombIndex = 2; // 預設 3 顆
        const CASHOUT_RETENTION = 0.9; //提統跑路

        function changeBomb(delta) {
            // 遊戲進行中禁止修改
            if (typeof isGameActive !== 'undefined' && isGameActive) return;

            currentBombIndex += delta;

            // 限制範圍
            if (currentBombIndex < 0) currentBombIndex = 0;
            if (currentBombIndex >= bombOptions.length) currentBombIndex = bombOptions.length - 1;

            const count = bombOptions[currentBombIndex];
            document.getElementById('bombText').innerText = count;

            // 更新倍率顯示（如果有這功能）
            if (typeof updateNextWinInfo === 'function') {
                updateNextWinInfo();
            }
        }

        // 修正原本 startGame 抓取炸彈值的方式
        // 請在原本的 startGame 函數中，將抓取 bombCount 的地方改為：
        // const bombCount = parseInt(document.getElementById('bombText').innerText);
        function updateUI() {
            const balanceEl = document.getElementById('balanceText');
            if (balanceEl) {
                balanceEl.textContent = Math.floor(balance).toLocaleString();
            }
            // 確保 Key 值與您其他遊戲一致
            localStorage.setItem('sicbo_balance', balance);
        }

        // --- 音樂邏輯 (比照麻將) ---
        function handleFirstClick() { if (!hasInteracted) { hasInteracted = true; playBGM(); } }
        function playBGM() {
            const b1 = document.getElementById('bgm1'), b2 = document.getElementById('bgm2');
            [b1, b2].forEach(b => { if (b) b.pause(); });
            if (isMuted) return;
            const track = (currentBGM === 1 ? b1 : b2);
            if (track) track.play().catch(() => { });
        }
        function cycleBGM() {
            currentBGM = currentBGM === 1 ? 2 : 1;
            document.getElementById('bgmBtn').textContent = `🎵 音樂 ${currentBGM}`;
            if (hasInteracted) playBGM();
        }
        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('muteBtn').textContent = isMuted ? '🔇' : '🔊';
            playBGM();
        }

        async function syncToFirebase() {
            const playerId = localStorage.getItem('player_id');
            if (!playerId || balance === lastSyncedBalance) return;
            try {
                await db.collection("users").doc(playerId).update({
                    balance: balance,
                    lastUpdate: firebase.firestore.Timestamp.now()
                });
                lastSyncedBalance = balance;
            } catch (e) { console.error("同步失敗", e); }
        }

        function listenRank() {
            const rankList = document.getElementById('mineRankList');
            const topBar = document.getElementById('topWinnerName');

            if (!rankList || !topBar) return;

            db.collection("users")
                .orderBy("mineMaxWin", "desc")
                .limit(10)
                .onSnapshot(snap => {
                    let html = '';
                    let i = 1;

                    if (snap.empty) {
                        topBar.innerHTML = "🏆 暫無最高紀錄";
                        rankList.innerHTML = '<p style="text-align:center; color:#888;">尚無數據</p>';
                        return;
                    }

                    snap.forEach(doc => {
                        const data = doc.data();
                        const win = data.mineMaxWin || 0;
                        if (win <= 0) return;

                        const fxClass = data.equipped_fx || "";
                        const titleText = data.equipped_title || "";
                        let titleColorClass = "t-blue";
                        if (titleText.includes("幸運錦鯉")) titleColorClass = "t-koi-color"; // 新增錦鯉色
                        else if (titleText.includes("賭神") || titleText.includes("富可敵國") || titleText.includes("至尊") || titleText.includes("躺平")) titleColorClass = "t-red";
                        else if (titleText.includes("梟雄") || titleText.includes("傳奇") || titleText.includes("鴻運") || titleText.includes("天選")) titleColorClass = "t-orange";
                        else if (titleText.includes("土豪") || titleText.includes("千金") || titleText.includes("狗屎") || titleText.includes("少爺") || titleText.includes("仙女")) titleColorClass = "t-purple";
                        else if (titleText.includes("幸運")) titleColorClass = "t-yellow";
                        const titleHTML = titleText ? `<span class="player-title ${titleColorClass}">【${titleText}】</span>` : "";

                        html += `
<div class="rank-item ${fxClass}" style="overflow:visible;">
    <div class="rank-info" style="overflow:visible;">
        <span class="rank-num">${i === 1 ? '🏆' : i}</span>
        <span class="rank-name" style="display:flex; align-items:center; gap:4px; overflow:visible;">
            ${titleHTML}
            <span style="color:#fff;">${data.name || '無名氏'}</span>
        </span>
    </div>
    <span class="rank-bal" style="color:var(--gold)">💎${Math.floor(win).toLocaleString()}</span>
</div>`;

                        if (i === 1) {
                            topBar.innerHTML = `
        <div class="${fxClass}" style="display:inline-flex; align-items:center; font-size: 14px; padding: 4px 10px; overflow:visible; white-space:nowrap;">
            <span style="margin-right:5px;">🏆 最高紀錄：</span>
            <div style="display:inline-flex; align-items:center; overflow:visible;">
                ${titleHTML}
                <span style="color:#fff; margin-left:2px;">${data.name || '無名氏'}</span> 
            </div>
            <span style="color:var(--gold); margin-left:8px;">贏得 $${Math.floor(win).toLocaleString()}</span>
        </div>`;
                        }
                        i++;
                    });
                    rankList.innerHTML = html;
                }, err => {
                    console.error("排行榜監聽錯誤:", err);
                    topBar.innerHTML = "🏆 掃雷大挑戰"; // 報錯時給予預設文字，不顯示載入中
                });
        }

        function toggleRank() {
            const s = document.getElementById('rankSidebar'), o = document.getElementById('rankOverlay');
            if (s.style.right === '0px') { s.style.right = '-300px'; o.style.display = 'none'; }
            else { s.style.right = '0px'; o.style.display = 'block'; }
        }

        function getMultiplier(totalMines, revealed) {
    if (revealed === 0) return 1;
    const totalTiles = 25;
    let multiplier = 1;

    // 基礎數學邏輯
    for (let i = 0; i < revealed; i++) {
        multiplier *= (totalTiles - i) / (totalTiles - totalMines - i);
    }

    let finalMult = multiplier;

    // 門檻 1000 倍 (以1000萬下注計即為100億)
    if (finalMult > 1000 && finalMult <= 100000) {
        // 超過 1000 倍的部分砍 70%，留 30%
        finalMult = 1000 + (finalMult - 1000) * 0.3;
    } 
    else if (finalMult > 100000) {
        // 超過 10 萬倍的部分（針對極端炸彈）強制鎖死成長
        let baseBonus = 99000 * 0.3; // 前段增量
        finalMult = 1000 + baseBonus + (finalMult - 100000) * 0.0001;
    }

    return finalMult;
}

        function updateNextWinInfo() {
            // 將原本的 bombCount 改為 bombText，並用 innerText 取值
            const bombCountEl = document.getElementById('bombText');
            const bombCount = bombCountEl ? parseInt(bombCountEl.innerText) : 3;

            const nextMult = getMultiplier(bombCount, revealedCount + 1);
            const infoEl = document.getElementById('multDisplay');
            if (infoEl) {
                infoEl.textContent = `下一格倍率: x${nextMult.toFixed(2)}`;
                infoEl.classList.add('active');
                setTimeout(() => infoEl.classList.remove('active'), 200);
            }
        }
        function changeBet(dir) {
            if (isGameActive) return; // 遊戲中不能換籌碼
            currentBetIdx = Math.max(0, Math.min(betOptions.length - 1, currentBetIdx + dir));
            document.getElementById('betText').textContent = betOptions[currentBetIdx].toLocaleString();
        }
        function startGame() {
            const bet = betOptions[currentBetIdx];
            if (bet > balance) { alert("餘額不足！"); return; }

            // 扣款與初始化
            balance -= bet;
            currentBet = bet;
            updateUI();
            syncToFirebase();

            isGameActive = true;
            revealedCount = 0;
            mines = new Array(25).fill(false);

            // 讀取新的炸彈顯示文字
            let count = 0;
            const targetMines = parseInt(document.getElementById('bombText').innerText);

            // 佈雷邏輯
            while (count < targetMines) {
                let r = Math.floor(Math.random() * 25);
                if (!mines[r]) { mines[r] = true; count++; }
            }

            // 按鈕狀態切換
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('cashoutBtn').style.display = 'block';
            document.getElementById('cashoutBtn').disabled = true;
            document.getElementById('cashoutBtn').textContent = `本金: 💎${bet.toLocaleString()}`;

            // 禁用所有調整選項 (包含籌碼與炸彈)
            document.getElementById('betMinus').disabled = true;
            document.getElementById('betPlus').disabled = true;
            document.getElementById('bombMinus').disabled = true; // 新增：禁用炸彈減號
            document.getElementById('bombPlus').disabled = true;  // 新增：禁用炸彈加號

            updateNextWinInfo();
            renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('grid'); grid.innerHTML = '';
            for (let i = 0; i < 25; i++) {
                const t = document.createElement('div'); t.className = 'tile active';
                t.onclick = () => revealTile(i, t); grid.appendChild(t);
            }
        }

        function revealTile(idx, el) {
    if (!isGameActive || el.classList.contains('disabled')) return;

    const bombCountEl = document.getElementById('bombText');
    const currentBombs = bombCountEl ? parseInt(bombCountEl.innerText) : 3;

    if (mines[idx]) {
        gameOver(false);
    } else {
        revealedCount++;
        el.classList.add('revealed-coin', 'disabled');
        el.innerHTML = '💎';
        if (!isMuted) document.getElementById('sndCoin').play().catch(() => { });

        document.getElementById('cashoutBtn').disabled = false;

        const totalSafeTiles = 25 - currentBombs;
        const currentM = getMultiplier(currentBombs, revealedCount);
        
        // 1. 計算當前跑路金額 (90%)
        const currentCashout = Math.floor(currentBet * currentM * CASHOUT_RETENTION);

        // 2. 計算下一格預告
        let nextInfo = "";
        if (revealedCount < totalSafeTiles) {
            const nextM = getMultiplier(currentBombs, revealedCount + 1);
            if (revealedCount + 1 === totalSafeTiles) {
                // 最後一格，顯示 100% 全開大獎 (不乘 0.9)
                const nextAmount = Math.floor(currentBet * nextM);
                nextInfo = `\n[ 下一格全開: 💎${nextAmount.toLocaleString()} ]`;
            } else {
                // 非最後一格，顯示下一格跑路 (90%)
                const nextAmount = Math.floor(currentBet * nextM * CASHOUT_RETENTION);
                nextInfo = `\n(下一格: 💎${nextAmount.toLocaleString()})`;
            }
        } else {
            nextInfo = "\n(🎉 完美通關！)";
        }
        const btn = document.getElementById('cashoutBtn');
        btn.textContent = `提桶跑路: 💎${currentCashout.toLocaleString()}${nextInfo}`;

        // 4. 全開自動結算
        if (revealedCount === totalSafeTiles) {

            showWinToast(`🎉 完美的探險！全開獎金 x${currentM.toFixed(2)}`);
            setTimeout(() => { cashout(true); }, 1500);
        }
    }
}

        // 輔助函數：顯示提示
        function showWinToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'win-toast';
            toast.innerHTML = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        async function cashout(isAutoWin = false) {
            if (!isGameActive) return;

            const bombCountEl = document.getElementById('bombText');
            const bombCount = bombCountEl ? parseInt(bombCountEl.innerText) : 3;

            // 獲取基礎倍率
            let m = getMultiplier(bombCount, revealedCount);

            // --- 核心邏輯：中途跑路只領 70%，全開領 100% ---
            if (!isAutoWin) {
                m = m * CASHOUT_RETENTION;
            }

            const win = Math.floor(currentBet * m);

            // 根據最終倍率顯示 UI
            if (m >= 40) {
                showBigWinUI(win, m);
            } else {
                showSimpleWinUI(win, m);
            }

            balance += win;

            // Firebase 同步邏輯 (維持你原本的邏輯，不修改 Firebase 結構)
            const playerId = localStorage.getItem('player_id');
            if (playerId && db) {
                try {
                    const userRef = db.collection("users").doc(playerId);
                    const doc = await userRef.get();
                    let updateData = { balance: balance, lastUpdate: firebase.firestore.Timestamp.now() };
                    if (doc.exists) {
                        let currentMax = doc.data().mineMaxWin || 0;
                        if (win > currentMax) {
                            updateData.mineMaxWin = win;
                            updateData.mineMaxTime = firebase.firestore.FieldValue.serverTimestamp();
                        }
                    }
                    await userRef.update(updateData);
                    lastSyncedBalance = balance;
                } catch (e) { console.error("同步失敗", e); }
            }

            gameOver(true);
        }

        // 輔助函數：普通贏錢提示 (自動消失)
        function showSimpleWinUI(amount, mult) {
            const toast = document.createElement('div');
            toast.className = 'win-result-toast';
            toast.innerHTML = `
        <div style="color:#ccc; font-size:14px; margin-bottom:5px;">成功撤退</div>
        <div class="amount">💎 ${amount.toLocaleString()}</div>
        <div class="mult">獲利倍率 x${mult.toFixed(2)}</div>
    `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000); // 2秒後自動消失
        }

        // 輔助函數：顯示大獎 UI
        function showBigWinUI(amount, mult) {
            const overlay = document.createElement('div');
            overlay.className = 'big-win-overlay';
            overlay.innerHTML = `
        <div class="big-win-content">
            <div class="big-win-title">🔥 BIG WIN 🔥</div>
            <div class="big-win-amount">💎 ${amount.toLocaleString()}</div>
            <div class="big-win-mult">達成倍率 x${mult.toFixed(2)}</div>
            <p style="color: #aaa; margin-top: 30px;">點擊任何處繼續</p>
        </div>
    `;

            // 點擊後關閉大獎畫面
            overlay.onclick = () => {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 300);
            };

            document.body.appendChild(overlay);

            // 如果沒靜音，播放一個震撼的音效
            if (!isMuted) {
                // 這裡可以使用你現有的 sndCoin，或者另外找個大獎音效
                document.getElementById('sndCoin').play().catch(() => { });
            }
        }
        // 輔助函數：顯示輸球提示 (自動消失)
        function showLoseUI(betAmount, potentialWin) {
            const overlay = document.createElement('div');
            overlay.className = 'big-win-overlay';
            overlay.style.background = 'rgba(40, 0, 0, 0.85)';

            // 根據是否有潛在獎金來決定第二行字
            let extraMsg = '';
            if (potentialWin > 0) {
                extraMsg = `
            <div style="color: #ffd86b; font-size: 18px; font-weight: bold; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 10px;">
                差一點就能帶走 💎 ${potentialWin.toLocaleString()}
            </div>`;
            } else {
                // 第一下就踩雷的安慰話
                extraMsg = `<p style="color: #ff9f43; margin-top: 10px;">出師不利...</p>`;
            }

            overlay.innerHTML = `
        <div class="big-win-content" style="animation: shake 0.5s ease-in-out;">
            <div class="big-win-title" style="color: #ff4757; text-shadow: 0 0 20px #ff0000;">💥 踩到炸彈 💥</div>
            <div class="big-win-amount" style="color: #fff; font-size: 24px; margin-bottom: 5px;">損失本金 💎 ${betAmount.toLocaleString()}</div>
            ${extraMsg}
            <p style="color: #aaa; margin-top: 20px; font-size: 14px;">別灰心，下一把一定中！</p>
        </div>
    `;
            document.body.appendChild(overlay);

            setTimeout(() => {
                overlay.style.opacity = '0';
                overlay.style.transition = '0.5s';
                setTimeout(() => overlay.remove(), 500);
            }, 1500);
        }
        function gameOver(isWin) {
            isGameActive = false;

            // 1. 先抓取當前狀態
            const lastBet = currentBet;
            const currentBombs = parseInt(document.getElementById('bombText').innerText);

            // 2. 翻開所有格子
            document.querySelectorAll('.tile').forEach((t, i) => {
                t.classList.add('disabled');
                if (mines[i]) {
                    t.innerHTML = '💣';
                    t.classList.add('revealed-bomb');
                }
            });

            // 3. 處理輸贏分支
            if (!isWin) {
                if (!isMuted) document.getElementById('sndBomb').play().catch(() => { });

                // 計算當前倍率
                const currentMult = getMultiplier(currentBombs, revealedCount);
                const potentialWin = Math.floor(lastBet * currentMult);

                setTimeout(() => {
                    // 如果 revealedCount > 0，代表有累積到獎金，才傳入 potentialWin
                    // 如果第一下就死 (revealedCount === 0)，我們傳入 0 或者是 null
                    showLoseUI(lastBet, revealedCount > 0 ? potentialWin : 0);
                }, 500);
            }

            // 4. 重置 UI 與按鈕
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('cashoutBtn').style.display = 'none';
            document.getElementById('betMinus').disabled = false;
            document.getElementById('betPlus').disabled = false;
            document.getElementById('bombMinus').disabled = false;
            document.getElementById('bombPlus').disabled = false;

            // 5. 更新數據與同步 (最後再歸零)
            updateUI();
            syncToFirebase();
            updateNextWinInfo();
            revealedCount = 0; // 放在最後，確保之前的 UI 更新能抓到正確的數值
        }



        window.onload = async () => {
            // 1. 第一時間讀取本地，讓玩家進場立刻看到錢，不卡頓
            const savedBal = localStorage.getItem('sicbo_balance');
            if (savedBal !== null) {
                balance = parseFloat(savedBal);
            }

            // 先顯示本地資料，確保畫面不留白
            updateUI();
            renderGrid();
            updateNextWinInfo();

            // 2. 核心：聯網校正 (解決滑掉遊戲/換機儲值問題)
            const playerId = localStorage.getItem('player_id');
            if (playerId && typeof db !== 'undefined') {
                try {
                    const doc = await db.collection("users").doc(playerId).get();
                    if (doc.exists) {
                        const cloudBal = doc.data().balance;

                        // 如果雲端的錢比較多 (代表在別台手機玩過)，才更新本地
                        if (cloudBal !== undefined && cloudBal > balance) {
                            balance = cloudBal;
                            localStorage.setItem('sicbo_balance', balance);
                            updateUI(); // 再次更新 UI 顯示正確金額
                            console.log("已從雲端同步最新高額餘額");
                        }
                        // 如果本地錢比較多 (代表上次滑掉沒同步成功)，主動幫雲端補傳
                        else if (cloudBal !== undefined && balance > cloudBal) {
                            syncToFirebase();
                            console.log("本地進度領先，已自動補傳雲端");
                        }
                    }
                } catch (e) {
                    console.log("離線模式，使用本地餘額", e);
                }
            }

            // 3. 最後加載排行榜
            listenRank();
        };
    </script>
</body>

</html>