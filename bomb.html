<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
    <title>åœ°é›·å°‹å¯¶</title>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --gold: #ffd86b;
            --red: #ff4757;
            --green: #2ecc71;
            --dark: #1a0505;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            font-family: "Microsoft JhengHei", Arial, sans-serif;
        }

        body {
            height: 100dvh;
            width: 100vw;
            background: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: radial-gradient(circle at center, #2a0505 0%, #000 100%);
            position: relative;
        }

        .bg-stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://www.transparenttextures.com/patterns/stardust.png');
            opacity: 0.3;
            pointer-events: none;
            animation: bgMove 120s linear infinite;
            z-index: 1;
        }

        @keyframes bgMove {
            from {
                background-position: 0 0;
            }

            to {
                background-position: 1000px 1000px;
            }
        }

        .topbar {
            width: 100%;
            padding-top: env(safe-area-inset-top);
            height: calc(60px + env(safe-area-inset-top));
            background: rgba(42, 2, 2, 0.9);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 10px;
            border-bottom: 2px solid #5c0a0a;
            flex-shrink: 0;
            z-index: 1000;
        }

        .sound-btn {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 8px;
            border: 1px solid var(--gold);
            cursor: pointer;
            font-size: 13px;
            color: #fff;
            white-space: nowrap;
        }

        .balance-box {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--gold);
            border-radius: 15px;
            padding: 4px 12px;
            color: var(--gold);
            font-weight: bold;
            font-size: 16px;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            gap: 10px;
            overflow-y: auto;
            z-index: 10;
        }

        .top-winner-bar {
            width: 90%;
            background: rgba(0, 0, 0, 0.4);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            color: #aaa;
            text-align: center;
            border: 1px solid rgba(255, 216, 107, 0.2);
        }

        .multiplier-step {
            font-size: 14px;
            color: #aaa;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255, 216, 107, 0.3);
        }

        .multiplier-step.active {
            color: var(--gold);
            border-color: var(--gold);
            background: rgba(255, 216, 107, 0.2);
            font-weight: bold;
            box-shadow: 0 0 10px var(--gold);
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            width: 100%;
            max-width: 350px;
            aspect-ratio: 1/1;
            margin: 10px 0;
        }

        .tile {
            background: rgba(61, 10, 10, 0.8);
            border-radius: 8px;
            border-bottom: 4px solid #2a0505;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: 0.1s;
            position: relative;
        }

        .tile.active:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }


@keyframes gemAppear {
    0% { transform: scale(0) rotate(-45deg); opacity: 0; }
    80% { transform: scale(1.2) rotate(10deg); }
    100% { transform: scale(1) rotate(0deg); opacity: 1; }
}

       /* å®‰å…¨æ ¼ï¼šé‘½çŸ³é¢¨æ ¼ */
.tile.revealed-coin {
    background: linear-gradient(135deg, #00d2ff, #3a7bd5); /* äº®è—åˆ°æ·±è— */
    border-bottom: 4px solid #2d5a9e;
    color: white;
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
    animation: flip 0.3s forwards;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5rem; /* è®“é‘½çŸ³å¤§ä¸€é» */
}

/* ç‚¸å½ˆæ ¼ï¼šç†”å²©é¢¨æ ¼ */
.tile.revealed-bomb {
    background: linear-gradient(135deg, #ff4b2b, #ff416c); /* é®®ç´…åˆ°æ·±ç´… */
    border-bottom: 4px solid #b22222;
    animation: shake 0.4s; /* å¢åŠ ä¸€å€‹éœ‡å‹•æ„Ÿ */
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5rem;
}

/* ç‚¸å½ˆéœ‡å‹•ç‰¹æ•ˆ */
@keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
    100% { transform: translateX(0); }
}

        .tile.disabled {
            cursor: default;
            opacity: 0.6;
        }

        .controls {
            width: 100%;
            max-width: 350px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid #4a0404;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        input,
        select {
            background: #000;
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 8px;
            border-radius: 8px;
            font-size: 16px;
            width: 95px;
            text-align: center;
        }

        .action-btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-start {
            background: var(--gold);
            color: #000;
            box-shadow: 0 5px 0 #b38b00;
        }

        .btn-cashout {
            background: var(--green);
            color: #fff;
            box-shadow: 0 5px 0 #27ae60;
            display: none;
        }

        #rankSidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background: rgba(20, 0, 0, 0.95);
            border-left: 2px solid var(--gold);
            z-index: 2000;
            transition: 0.3s;
            padding: 20px;
            overflow-y: auto;
        }

        #rankOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 1999;
        }

        .rank-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 216, 107, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-title {
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 3px;
            margin-right: 4px;
        }

        .t-red {
            border: 1px solid #ff4757;
            color: #ff4757;
        }

        .t-orange {
            border: 1px solid #ffa502;
            color: #ffa502;
        }

        .t-purple {
            border: 1px solid #a4b0be;
            color: #a4b0be;
        }

        @keyframes flip {
            from {
                transform: rotateY(90deg);
            }

            to {
                transform: rotateY(0);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .bet-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #5c0a0a;
            border-radius: 10px;
            padding: 2px;
            width: 150px;
        }

        .bet-btn {
            background: #3d0a0a;
            border: 1px solid var(--gold);
            color: var(--gold);
            width: 30px;
            height: 30px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        .bet-btn:disabled {
            opacity: 0.3;
        }

        .bet-display {
            flex: 1;
            text-align: center;
            font-weight: bold;
            color: var(--gold);
            font-size: 16px;
        }
        .win-toast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    color: var(--gold);
    padding: 20px 40px;
    border: 2px solid var(--gold);
    border-radius: 15px;
    font-size: 20px;
    font-weight: bold;
    z-index: 10000;
    text-align: center;
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
    animation: toastFade 2.5s forwards;
    pointer-events: none;
}

@keyframes toastFade {
    0% { opacity: 0; transform: translate(-50%, -40%); }
    20% { opacity: 1; transform: translate(-50%, -50%); }
    80% { opacity: 1; transform: translate(-50%, -50%); }
    100% { opacity: 0; transform: translate(-50%, -60%); }
}
/* å¤§ççµç®—ç•«é¢ */
.big-win-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10001;
    animation: fadeIn 0.5s forwards;
}

.big-win-content {
    text-align: center;
    animation: scorePopup 0.6s cubic-bezier(0.17, 0.89, 0.32, 1.49);
}

.big-win-title {
    font-size: 40px;
    color: #ff0000;
    text-shadow: 0 0 20px #ff0000, 0 0 40px #ff8c00;
    font-weight: 900;
    margin-bottom: 10px;
    letter-spacing: 5px;
}

.big-win-amount {
    font-size: 48px;
    color: var(--gold);
    text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
    font-weight: bold;
    margin: 20px 0;
}

.big-win-mult {
    font-size: 24px;
    color: #fff;
    background: rgba(255, 255, 255, 0.2);
    padding: 5px 20px;
    border-radius: 20px;
}

@keyframes scorePopup {
    0% { transform: scale(0.5); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
/* æ™®é€šä¸­çæç¤º (å°æç¤ºæ¡†) */
.win-result-toast {
    position: fixed;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(20, 20, 20, 0.95);
    border: 1px solid #444;
    padding: 15px 30px;
    border-radius: 12px;
    text-align: center;
    z-index: 10002;
    pointer-events: none;
    animation: simpleFade 2s forwards;
}
.win-result-toast .amount { color: var(--gold); font-size: 24px; font-weight: bold; }
.win-result-toast .mult { color: #888; font-size: 14px; }

@keyframes simpleFade {
    0% { opacity: 0; transform: translate(-50%, -30%); }
    15% { opacity: 1; transform: translate(-50%, -50%); }
    85% { opacity: 1; transform: translate(-50%, -50%); }
    100% { opacity: 0; transform: translate(-50%, -60%); }
}
    </style>
</head>

<body onclick="handleFirstClick()">

    <div class="bg-stars"></div>

    <div id="rankOverlay" onclick="toggleRank()"></div>
    <div id="rankSidebar">
    <h3 style="color:var(--gold); margin-bottom:20px; text-align:center;">ğŸ†æƒé›·æ’è¡Œæ¦œ</h3>
    <div id="mineRankList"></div> 
</div>

    <div class="topbar">
        <div class="sound-btn" onclick="toggleMute()" id="muteBtn">ğŸ”Š</div>
        <div class="sound-btn" onclick="cycleBGM()" id="bgmBtn">ğŸµ éŸ³æ¨‚ 1</div>
        <div class="balance-box">ğŸ’ <span id="balanceText">0</span></div>
        <div style="flex:1"></div>
        <button onclick="toggleRank()"
            style="background:none; border:1px solid var(--gold); color:var(--gold); padding:5px 10px; border-radius:5px; font-size:12px;">ğŸ†
            æ’è¡Œæ¦œ</button>
        <a href="index.html" id="homeLink"><button
                style="background:none; border:1px solid #777; color:#ccc; padding:5px; border-radius:5px; margin-left:5px;">ğŸ </button></a>
    </div>

    <div class="main-container">
        <div class="top-winner-bar" id="topWinnerName">è¼‰å…¥ä¸­...</div>
        <div class="multiplier-step" id="multDisplay">ä¸‹ä¸€æ ¼å€ç‡: --</div>
        <div class="grid-container" id="grid"></div>

        <div class="controls">
            <div class="input-row">
                <span>ğŸ’ ä¸‹æ³¨é‡‘é¡:</span>
                <div class="bet-selector">
                    <button class="bet-btn" onclick="changeBet(-1)" id="betMinus">-</button>
                    <div class="bet-display" id="betText">10,000,000</div>
                    <button class="bet-btn" onclick="changeBet(1)" id="betPlus">+</button>
                </div>
            </div>
            <div class="input-row">
                <span>ğŸ’£ ç‚¸å½ˆæ•¸é‡:</span>
                <select id="bombCount" onchange="updateNextWinInfo()">
                    <option value="3" selected>3</option>
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                </select>
            </div>
            <button class="action-btn btn-start" id="startBtn" onclick="startGame()">é–‹å§‹æ¢éšª</button>
            <button class="action-btn btn-cashout" id="cashoutBtn" onclick="cashout()">æå‰çµæŸ: $0</button>
        </div>
    </div>

    <audio id="sndCoin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
    <audio id="sndBomb" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" preload="auto"></audio>
    <audio id="bgm1" src="background-music-434612.mp3" loop preload="auto"></audio>
    <audio id="bgm2" src="another-bgm.mp3" loop preload="auto"></audio>
<script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>
    <script>
        // --- Firebase åˆå§‹åŒ– ---
        const _k = ["AIzaSyDSRfVA", "uWCWCUd1NJop", "J6wHvsqsAM4UzJA"];
        const firebaseConfig = {
            apiKey: _k.join(''),
            authDomain: "game-80d68.firebaseapp.com",
            projectId: "game-80d68",
            storageBucket: "game-80d68.firebasestorage.app",
            messagingSenderId: "636332967920",
            appId: "1:636332967920:web:29e5600daf4db0ab613f35"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- æ ¸å¿ƒè®Šæ•¸ ---
        let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
        let lastSyncedBalance = balance;
        let isGameActive = false;
        let mines = [];
        let revealedCount = 0;
        let currentBet = 0;
        let isMuted = false, currentBGM = 1, hasInteracted = false;
        const betOptions = [10000, 50000, 100000, 1000000, 5000000, 10000000];
        let currentBetIdx = 5;

        function updateUI() {
            document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString();
            localStorage.setItem('sicbo_balance', balance);
        }

        // --- éŸ³æ¨‚é‚è¼¯ (æ¯”ç…§éº»å°‡) ---
        function handleFirstClick() { if (!hasInteracted) { hasInteracted = true; playBGM(); } }
        function playBGM() {
            const b1 = document.getElementById('bgm1'), b2 = document.getElementById('bgm2');
            [b1, b2].forEach(b => { if (b) b.pause(); });
            if (isMuted) return;
            const track = (currentBGM === 1 ? b1 : b2);
            if (track) track.play().catch(() => { });
        }
        function cycleBGM() {
            currentBGM = currentBGM === 1 ? 2 : 1;
            document.getElementById('bgmBtn').textContent = `ğŸµ éŸ³æ¨‚ ${currentBGM}`;
            if (hasInteracted) playBGM();
        }
        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('muteBtn').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            playBGM();
        }

        async function syncToFirebase() {
            const playerId = localStorage.getItem('player_id');
            if (!playerId || balance === lastSyncedBalance) return;
            try {
                await db.collection("users").doc(playerId).update({
                    balance: balance,
                    lastUpdate: firebase.firestore.Timestamp.now()
                });
                lastSyncedBalance = balance;
            } catch (e) { console.error("åŒæ­¥å¤±æ•—", e); }
        }

       function listenRank() {
  db.collection("users")
    .where("mineMaxWin", ">", 0)
    .orderBy("mineMaxWin", "desc")
    .limit(10)
    .onSnapshot(snap => {
      let html = '';
      let i = 1;

      snap.forEach(doc => {
        const data = doc.data();
        const win = data.mineMaxWin || 0;
        
        // --- æ ¸å¿ƒï¼šæå–ç‰¹æ•ˆèˆ‡ç¨±è™Ÿé‚è¼¯ ---
        const fxClass = data.equipped_fx || "";
        const titleText = data.equipped_title || "";
        
        let titleColorClass = "t-blue"; // é è¨­è—è‰²
        if (titleText.includes("å¹¸é‹éŒ¦é¯‰")) titleColorClass = "t-koi-color";
        else if (titleText.includes("è³­ç¥") || titleText.includes("å¯Œå¯æ•µåœ‹")) titleColorClass = "t-red";
        else if (titleText.includes("æ¢Ÿé›„") || titleText.includes("å‚³å¥‡")) titleColorClass = "t-orange";
        else if (titleText.includes("åœŸè±ª") || titleText.includes("åƒé‡‘") || titleText.includes("å°‘çˆº")) titleColorClass = "t-purple";

        const titleHTML = titleText ? `<span class="player-title ${titleColorClass}">ã€${titleText}ã€‘</span>` : "";

        // --- çµ„è£ HTML ---
        html += `
          <div class="rank-item ${fxClass}">
            <div class="rank-info">
              <span class="rank-num">${i === 1 ? 'ğŸ†' : i}</span>
              <span class="rank-name">${titleHTML}${data.name || 'ç„¡åæ°'}</span>
            </div>
            <span class="rank-bal" style="color:var(--gold)">ğŸ’°${Math.floor(win).toLocaleString()}</span>
          </div>
        `;
        
        // æ›´æ–°é ‚éƒ¨è·‘é¦¬ç‡ˆæˆ–ç¬¬ä¸€åæ¨™ç¤º
        if (i === 1) {
            document.getElementById('topWinnerName').innerHTML = `ğŸ† æœ€é«˜ç´€éŒ„ï¼š${titleHTML}${data.name} è´å¾— $${Math.floor(win).toLocaleString()}`;
        }
        
        i++;
      });
      
      const rankList = document.getElementById('mineRankList'); // ç¢ºä¿ ID æ­£ç¢º
      if(rankList) rankList.innerHTML = html || '<p style="text-align:center; color:#888;">å°šç„¡æ•¸æ“š</p>';
    });
}

        function toggleRank() {
            const s = document.getElementById('rankSidebar'), o = document.getElementById('rankOverlay');
            if (s.style.right === '0px') { s.style.right = '-300px'; o.style.display = 'none'; }
            else { s.style.right = '0px'; o.style.display = 'block'; }
        }

        function getMultiplier(totalMines, revealed) {
            if (revealed === 0) return 1;
            const totalTiles = 25;
            let multiplier = 1;

            // 1. åŸºç¤æ©Ÿç‡è¨ˆç®—
            for (let i = 0; i < revealed; i++) {
                multiplier *= (totalTiles - i) / (totalTiles - totalMines - i);
            }

            // 2. åŸºç¤æŠ½æ°´ç¶­æŒ 0.75
            let finalMult = multiplier * 0.75;

            // 3. å¼·åŒ–ç¸®æ¸›é‚è¼¯ï¼šæå‰è‡³è¶…é 40 å€å¾Œï¼Œå¢é•·é€Ÿåº¦å³è®Šç‚º 2%
            if (finalMult > 40) {
                let excess = finalMult - 40;
                finalMult = 40 + (excess * 0.02);
            }

            return finalMult;
        }

        function updateNextWinInfo() {
            const bombCount = parseInt(document.getElementById('bombCount').value);
            const nextMult = getMultiplier(bombCount, revealedCount + 1);
            const infoEl = document.getElementById('multDisplay');
            infoEl.textContent = `ä¸‹ä¸€æ ¼å€ç‡: x${nextMult.toFixed(2)}`;
            infoEl.classList.add('active'); setTimeout(() => infoEl.classList.remove('active'), 200);
        }
        function changeBet(dir) {
            if (isGameActive) return; // éŠæˆ²ä¸­ä¸èƒ½æ›ç±Œç¢¼
            currentBetIdx = Math.max(0, Math.min(betOptions.length - 1, currentBetIdx + dir));
            document.getElementById('betText').textContent = betOptions[currentBetIdx].toLocaleString();
        }
        function startGame() {
            const bet = betOptions[currentBetIdx];
            if (bet > balance) { alert("é¤˜é¡ä¸è¶³ï¼"); return; }
            balance -= bet; currentBet = bet; updateUI(); syncToFirebase();
            isGameActive = true; revealedCount = 0; mines = new Array(25).fill(false);
            let count = 0; const targetMines = parseInt(document.getElementById('bombCount').value);
            while (count < targetMines) { let r = Math.floor(Math.random() * 25); if (!mines[r]) { mines[r] = true; count++; } }
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('cashoutBtn').style.display = 'block';
            document.getElementById('cashoutBtn').disabled = true;
            document.getElementById('betMinus').disabled = true;
            document.getElementById('betPlus').disabled = true;
            document.getElementById('bombCount').disabled = true;
            updateNextWinInfo(); renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('grid'); grid.innerHTML = '';
            for (let i = 0; i < 25; i++) {
                const t = document.createElement('div'); t.className = 'tile active';
                t.onclick = () => revealTile(i, t); grid.appendChild(t);
            }
        }

        function revealTile(idx, el) {
    if (!isGameActive || el.classList.contains('disabled')) return;
    if (mines[idx]) { 
        gameOver(false); 
    }
    else {
        revealedCount++; 
        el.classList.add('revealed-coin', 'disabled'); 
        el.innerHTML = 'ğŸ’';
        
        if (!isMuted) document.getElementById('sndCoin').play().catch(() => { });
        
        document.getElementById('cashoutBtn').disabled = false;
        const m = getMultiplier(parseInt(document.getElementById('bombCount').value), revealedCount);
        document.getElementById('cashoutBtn').textContent = `è´å¾—: ğŸ’${Math.floor(currentBet * m).toLocaleString()}`;
        
        updateNextWinInfo();

        // --- æ”¹å‹•é€™è£¡ï¼šåˆ¤æ–·æ˜¯å¦å…¨é–‹ ---
        const totalSafeTiles = 25 - parseInt(document.getElementById('bombCount').value);
        if (revealedCount === totalSafeTiles) {
            showWinToast(`ğŸ‰ å®Œç¾çš„æ¢éšªï¼å…¨é–‹çé‡‘ x${m.toFixed(2)}`);
            setTimeout(() => {
                cashout();
            }, 1500); // ç¨å¾®ç•™é»æ™‚é–“è®“ç©å®¶çœ‹æ¸…æ¥šç•«é¢å†çµç®—
        }
    }
}

// è¼”åŠ©å‡½æ•¸ï¼šé¡¯ç¤ºæç¤º
function showWinToast(msg) {
    const toast = document.createElement('div');
    toast.className = 'win-toast';
    toast.innerHTML = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2500);
}

    async function cashout() {
    if (!isGameActive) return;
    
    const bombCount = parseInt(document.getElementById('bombCount').value);
    const m = getMultiplier(bombCount, revealedCount);
    const win = Math.floor(currentBet * m);

    // --- æ ¹æ“šå€ç‡æ±ºå®šé¡¯ç¤ºå“ªç¨®çµç®—ç•«é¢ ---
    if (m >= 40) {
        showBigWinUI(win, m); // å‘¼å«ä¹‹å‰å¯«çš„è±ªè¯ç‰ˆ (å…¨è¢å¹•/æ‰‹å‹•é—œé–‰)
    } else {
        showSimpleWinUI(win, m); // å‘¼å«æ™®é€šç‰ˆ (å°æ¡†/è‡ªå‹•æ¶ˆå¤±)
    }

    balance += win;
    // ... (é€™è£¡ä¿ç•™ä½ åŸæœ¬çš„ Firebase åŒæ­¥èˆ‡ localStorage æ›´æ–°é‚è¼¯ï¼Œä¸è¦æ”¹å‹•)
    
    // åŸ·è¡ŒåŒæ­¥
    const playerId = localStorage.getItem('player_id');
    if (playerId && db) {
        try {
            const userRef = db.collection("users").doc(playerId);
            const doc = await userRef.get();
            let updateData = { balance: balance, lastUpdate: firebase.firestore.Timestamp.now() };
            if (doc.exists) {
                let currentMax = doc.data().mineMaxWin || 0;
                if (win > currentMax) { 
                    updateData.mineMaxWin = win;
                    updateData.mineMaxTime = firebase.firestore.FieldValue.serverTimestamp();
                }
            }
            await userRef.update(updateData);
            lastSyncedBalance = balance;
        } catch (e) { }
    }
    
    gameOver(true);
}

// è¼”åŠ©å‡½æ•¸ï¼šæ™®é€šè´éŒ¢æç¤º (è‡ªå‹•æ¶ˆå¤±)
function showSimpleWinUI(amount, mult) {
    const toast = document.createElement('div');
    toast.className = 'win-result-toast';
    toast.innerHTML = `
        <div style="color:#ccc; font-size:14px; margin-bottom:5px;">æˆåŠŸæ’¤é€€</div>
        <div class="amount">ğŸ’ ${amount.toLocaleString()}</div>
        <div class="mult">ç²åˆ©å€ç‡ x${mult.toFixed(2)}</div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000); // 2ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
}

// è¼”åŠ©å‡½æ•¸ï¼šé¡¯ç¤ºå¤§ç UI
function showBigWinUI(amount, mult) {
    const overlay = document.createElement('div');
    overlay.className = 'big-win-overlay';
    overlay.innerHTML = `
        <div class="big-win-content">
            <div class="big-win-title">ğŸ”¥ BIG WIN ğŸ”¥</div>
            <div class="big-win-amount">ğŸ’ ${amount.toLocaleString()}</div>
            <div class="big-win-mult">é”æˆå€ç‡ x${mult.toFixed(2)}</div>
            <p style="color: #aaa; margin-top: 30px;">é»æ“Šä»»ä½•è™•ç¹¼çºŒ</p>
        </div>
    `;
    
    // é»æ“Šå¾Œé—œé–‰å¤§çç•«é¢
    overlay.onclick = () => {
        overlay.style.opacity = '0';
        setTimeout(() => overlay.remove(), 300);
    };
    
    document.body.appendChild(overlay);

    // å¦‚æœæ²’éœéŸ³ï¼Œæ’­æ”¾ä¸€å€‹éœ‡æ’¼çš„éŸ³æ•ˆ
    if (!isMuted) {
        // é€™è£¡å¯ä»¥ä½¿ç”¨ä½ ç¾æœ‰çš„ sndCoinï¼Œæˆ–è€…å¦å¤–æ‰¾å€‹å¤§çéŸ³æ•ˆ
        document.getElementById('sndCoin').play().catch(()=>{});
    }
}

        function gameOver(isWin) {
            isGameActive = false;
            revealedCount = 0;
            document.querySelectorAll('.tile').forEach((t, i) => {
                t.classList.add('disabled'); if (mines[i]) { t.innerHTML = 'ğŸ’£'; t.classList.add('revealed-bomb'); }
            });
            if (!isWin && !isMuted) document.getElementById('sndBomb').play().catch(() => { });
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('cashoutBtn').style.display = 'none';
            document.getElementById('betMinus').disabled = false;
            document.getElementById('betPlus').disabled = false;
            document.getElementById('bombCount').disabled = false;
            updateUI(); syncToFirebase();
            updateNextWinInfo();
        }

        document.getElementById('homeLink').addEventListener('click', async (e) => {
            e.preventDefault(); await syncToFirebase(); window.location.href = "index.html";
        });

        window.onload = () => { updateUI(); renderGrid(); listenRank(); };
    </script>
</body>

</html>