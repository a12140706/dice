<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
<title>éº»å°‡å¤§äº¨ - é€²åŒ–æŸ±ä¿®æ­£ç‰ˆ</title>
<style>
  :root { --gold: #ffd86b; --bg: #004d40; --m-red: #d32f2f; --m-green: #2e7d32; --m-blue: #1976d2; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
  body { margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: Arial; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0; }

  /* é ‚éƒ¨æ¬„ */
  .topbar { height: 45px; background: rgba(0,0,0,0.7); display: flex; align-items: center; padding: 0 10px; gap: 10px; border-bottom: 1px solid #00695c; }
  .balance-box { background: rgba(0,0,0,0.5); border: 1px solid var(--gold); border-radius: 8px; padding: 4px 8px; color: var(--gold); font-weight: bold; font-size: 14px; }
  .audio-ctrl { font-size: 11px; background: #004d40; border: 1px solid #b2dfdb; padding: 3px 6px; border-radius: 12px; }

  /* ä¸»éŠæˆ²å€ä½ˆå±€ */
  .main-container { flex: 1; display: flex; overflow: hidden; padding: 8px; gap: 10px; align-items: stretch; }
  .game-area { flex: 1; display: flex; align-items: center; justify-content: center; }
  .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; width: 100%; max-width: 320px; aspect-ratio: 4/4.8; background: #00796b; padding: 10px; border-radius: 10px; border: 2px solid #004d40; }

  /* å³å´é€²åŒ–æŸ±ï¼šä¿®æ­£ç‚ºç”±ä¸‹å¾€ä¸Š */
  .combo-pillar { 
    width: 60px; 
    background: linear-gradient(to top, #004d40, #4db6ac); /* æ¼¸å±¤æ–¹å‘ä¹Ÿæ”¹ä¸€ä¸‹ */
    border-radius: 10px; 
    border: 2px solid #b2dfdb; 
    display: flex; 
    flex-direction: column-reverse; /* é—œéµï¼šè®“å…§å®¹ç”±ä¸‹å¾€ä¸Šæ’ */
    align-items: center; 
    padding: 15px 0;
    gap: 10px;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
  }
  .evo-slot { 
    width: 42px; height: 42px; background: rgba(0,0,0,0.4); border-radius: 8px; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    font-size: 18px; border: 1.5px solid #004d40; transition: 0.4s; opacity: 0.4; color: #ccc; 
  }
  .evo-slot.active { opacity: 1; border-color: var(--gold); background: #fff; color: #000; box-shadow: 0 0 15px var(--gold); transform: scale(1.05); }
  .evo-slot span { font-size: 9px; margin-top: 2px; font-weight: bold; }
  
  .combo-display { 
    margin-bottom: 5px; /* åœ¨ column-reverse ä¸­ï¼Œé€™æ˜¯æœ€ä¸‹æ–¹ */
    text-align: center; border-top: 1px solid rgba(255,255,255,0.2); width: 80%; padding-top: 5px;
  }

  /* ç‰Œé¢èˆ‡åº•éƒ¨é¢æ¿ä¿æŒä¹‹å‰å„ªåŒ–éçš„ */
  .mj-tile { background: #fff; border-radius: 5px; color: #000; font-size: 10vw; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 4px 0 #999; position: relative; }
  @media (min-width: 400px) { .mj-tile { font-size: 40px; } }
  .tile-hu { background: linear-gradient(#ffd700, #ff8c00) !important; color: #fff !important; }
  .tile-wild-effect { animation: wildGlow 0.8s infinite alternate; }
  @keyframes wildGlow { from { box-shadow: 0 0 5px var(--gold); } to { box-shadow: 0 0 15px var(--gold); } }
  .mj-tile.eliminating { transform: scale(0); opacity: 0; transition: 0.3s; }
  .wild-tag { position: absolute; top: 0; right: 0; background: gold; color: #000; font-size: 8px; padding: 1px 3px; border-radius: 0 0 0 5px; }

  .bottom-panel { background: #000; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
  .win-display { background: #001a1a; color: var(--gold); text-align: center; padding: 6px; border-radius: 5px; font-weight: bold; border: 1px solid #004d40; font-size: 18px; }
  .control-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  .bet-control { flex: 1; background: #111; border-radius: 8px; display: flex; flex-direction: column; align-items: center; padding: 5px; border: 1px solid #444; }
  .spin-btn { width: 110px; height: 55px; background: linear-gradient(#4db6ac, #00796b); border: 2px solid #b2dfdb; border-radius: 8px; color: #fff; font-size: 22px; font-weight: bold; box-shadow: 0 4px 0 #004d40; }
  .auto-btn { flex: 1; height: 55px; background: #455a64; border: 1px solid #546e7a; border-radius: 8px; color: #fff; font-weight: bold; }
  .auto-btn.active { background: #c2185b; }
</style>
</head>
<body>

<div class="topbar">
  <div class="balance-box">ğŸ’° <span id="balanceText">0</span></div>
  <div class="audio-ctrl" onclick="toggleMute()" id="muteBtn">ğŸ”Š é–‹</div>
  <div class="audio-ctrl" onclick="cycleBGM()" id="bgmBtn">ğŸµ BGM 1</div>
</div>

<div class="main-container">
  <div class="game-area"><div class="grid" id="grid"></div></div>
  
  <div class="combo-pillar">
    <div class="combo-display">
      <div style="font-size: 9px; color: #b2dfdb;">COMBO</div>
      <div id="comboCount" style="font-size:20px; color:white; font-weight:bold;">0</div>
    </div>
    <div id="evo-white" class="evo-slot">â¬œ<span>2é€£</span></div>
    <div id="evo-zhong" class="evo-slot">ğŸ€„<span>5é€£</span></div>
    <div id="evo-fa" class="evo-slot">ğŸ€…<span>10é€£</span></div>
  </div>
</div>

<div class="bottom-panel">
  <div class="win-display">WIN: <span id="sessionWinText">0</span></div>
  <div class="control-row">
    <div class="bet-control">
      <div style="font-size: 9px; color: #888;">BET</div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span onclick="changeBet(-1)" style="color:var(--gold); font-size:24px;">-</span>
        <span id="betText" style="font-weight:bold; font-size: 18px;">300</span>
        <span onclick="changeBet(1)" style="color:var(--gold); font-size:24px;">+</span>
      </div>
    </div>
    <button class="spin-btn" id="spinBtn" onclick="handleFirstClick(); startSpin();">SPIN</button>
    <button class="auto-btn" id="autoBtn" onclick="handleFirstClick(); toggleAuto();">è‡ªå‹•ç©</button>
  </div>
</div>

<audio id="bgm1" src="background-music-434612.mp3" loop preload="auto"></audio>
<audio id="bgm2" src="soft-background-music-427252.mp3" loop preload="auto"></audio>
<audio id="sndSpin" src="https://assets.mixkit.co/active_storage/sfx/2014/2014-preview.mp3"></audio>
<audio id="sndMatch" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>

<script>
let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
let isSpinning = false, isAuto = false, combo = 0;
let currentBetIdx = 2, currentBGM = 1, isMuted = false, hasInteracted = false;
const betOptions = [50, 100, 300, 500, 1000];

const tileData = { 'ğŸ€':'mj-red','ğŸ€š':'mj-blue','ğŸ€':'mj-blue','ğŸ€‘':'mj-green','ğŸ€”':'mj-green','ğŸ€„':'mj-red','ğŸ€…':'mj-green','â¬œ':'mj-blue','èƒ¡':'tile-hu','å…ƒå¯¶':'tile-wild' };
let board = [];

// éŸ³æ¨‚æ§åˆ¶
function handleFirstClick() { if (!hasInteracted) { hasInteracted = true; playBGM(); } }
function playBGM() {
    const b1 = document.getElementById('bgm1'), b2 = document.getElementById('bgm2');
    b1.pause(); b2.pause(); if (isMuted) return;
    const active = currentBGM === 1 ? b1 : b2; active.currentTime = 0; active.play().catch(()=>{});
}
function cycleBGM() { currentBGM = currentBGM === 1 ? 2 : 1; document.getElementById('bgmBtn').textContent = `ğŸµ BGM ${currentBGM}`; if (hasInteracted) playBGM(); }
function toggleMute() { isMuted = !isMuted; document.getElementById('muteBtn').textContent = isMuted ? 'ğŸ”‡ é—œ' : 'ğŸ”Š é–‹'; playBGM(); }
function playSfx(id) { if (!isMuted) { const s = document.getElementById(id); if (s) { s.currentTime = 0; s.play().catch(()=>{}); } } }

// éŠæˆ²é‚è¼¯
function updateUI() {
    document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString();
    document.getElementById('comboCount').textContent = combo;
    document.getElementById('betText').textContent = betOptions[currentBetIdx];
    document.getElementById('sessionWinText').textContent = Math.floor(window.winThisSpin || 0).toLocaleString();
    // é€²åŒ–ç‹€æ…‹
    document.getElementById('evo-white').classList.toggle('active', combo >= 2);
    document.getElementById('evo-zhong').classList.toggle('active', combo >= 5);
    document.getElementById('evo-fa').classList.toggle('active', combo >= 10);
    localStorage.setItem('sicbo_balance', balance);
}

function isWild(icon) {
    if (icon === 'å…ƒå¯¶') return true;
    if (combo >= 2 && icon === 'â¬œ') return true;
    if (combo >= 5 && icon === 'ğŸ€„') return true;
    if (combo >= 10 && icon === 'ğŸ€…') return true;
    return false;
}

function initBoard() {
    const gridEl = document.getElementById('grid'); gridEl.innerHTML = '';
    board = Array.from({length:4}, () => Array(4).fill(null));
    for (let r=0; r<4; r++) {
        for (let c=0; c<4; c++) {
            board[r][c] = Object.keys(tileData)[Math.floor(Math.random()*10)];
            const tile = document.createElement('div');
            tile.id = `tile-${r}-${c}`;
            gridEl.appendChild(tile);
            updateTileVisual(r, c);
        }
    }
}

function updateTileVisual(r, c) {
    const el = document.getElementById(`tile-${r}-${c}`);
    const icon = board[r][c];
    el.className = `mj-tile ${tileData[icon]}`;
    el.innerHTML = (icon === 'å…ƒå¯¶') ? 'ğŸ’°' : icon;
    if (isWild(icon) && icon !== 'èƒ¡') {
        el.innerHTML += '<div class="wild-tag">WILD</div>';
        el.classList.add('tile-wild-effect');
    }
}

async function startSpin() {
    if (isSpinning || balance < betOptions[currentBetIdx]) return;
    isSpinning = true; balance -= betOptions[currentBetIdx];
    combo = 0; window.winThisSpin = 0; playSfx('sndSpin'); updateUI(); initBoard();
    await new Promise(r => setTimeout(r, 600));
    processMatches();
}

async function processMatches() {
    let matches = [];
    for(let r=0; r<4; r++){ if(board[r][0]===board[r][1] && board[r][1]===board[r][2]) matches.push({r,c:0},{r,c:1},{r,c:2}); }
    if (matches.length > 0) {
        combo++; playSfx('sndMatch');
        window.winThisSpin += matches.length * 10 * combo;
        balance += matches.length * 10 * combo;
        updateUI();
        matches.forEach(m => document.getElementById(`tile-${m.r}-${m.c}`).classList.add('eliminating'));
        await new Promise(r => setTimeout(r, 400));
        initBoard(); processMatches();
    } else {
        isSpinning = false; updateUI();
        if (isAuto) { await new Promise(r => setTimeout(r, 1000)); startSpin(); }
    }
}

function changeBet(dir) { if (!isSpinning) { currentBetIdx = (currentBetIdx + dir + betOptions.length) % betOptions.length; updateUI(); } }
function toggleAuto() { isAuto = !isAuto; document.getElementById('autoBtn').classList.toggle('active', isAuto); document.getElementById('autoBtn').textContent = isAuto ? "åœæ­¢" : "è‡ªå‹•ç©"; if (isAuto && !isSpinning) startSpin(); }

window.onload = () => { updateUI(); initBoard(); };
</script>
</body>
</html>