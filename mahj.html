<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
<title>éº»å°‡å¤§äº¨ - åéšé€²åŒ–</title>
<style>
  :root { --gold: #ffd86b; --bg: #004d40; --m-red: #d32f2f; --m-green: #2e7d32; --m-blue: #1976d2; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
  body { margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: Arial; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0; }

  /* é ‚éƒ¨æ¬„ */
  .topbar { height: 45px; background: rgba(0,0,0,0.7); display: flex; align-items: center; padding: 0 10px; gap: 10px; border-bottom: 1px solid #00695c; }
  .balance-box { background: rgba(0,0,0,0.5); border: 1px solid var(--gold); border-radius: 8px; padding: 4px 8px; color: var(--gold); font-weight: bold; font-size: 14px; }
  .audio-ctrl { font-size: 11px; background: #004d40; border: 1px solid #b2dfdb; padding: 3px 6px; border-radius: 12px; }

  /* ä¸»éŠæˆ²å€ä½ˆå±€ */
  .main-container { flex: 1; display: flex; overflow: hidden; padding: 8px; gap: 10px; align-items: stretch; }
  .game-area { flex: 1; display: flex; align-items: center; justify-content: center; }
  .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; width: 100%; max-width: 320px; aspect-ratio: 4/4.8; background: #00796b; padding: 10px; border-radius: 10px; border: 2px solid #004d40; }

  /* å³å´é€²åŒ–æŸ±ï¼š10å±¤éšæ¢¯è¨­è¨ˆ */
  .combo-pillar { 
    width: 65px; 
    background: linear-gradient(to top, #00332a, #00695c);
    border-radius: 10px; 
    border: 2px solid #b2dfdb; 
    display: flex; 
    flex-direction: column-reverse; /* ç”±ä¸‹å¾€ä¸Š */
    padding: 10px 0;
    justify-content: space-between;
    box-shadow: inset 0 0 15px rgba(0,0,0,0.6);
  }

  /* æ¯ä¸€æ ¼ç¯€é» */
  .step {
    flex: 1;
    width: 80%;
    margin: 2px auto;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: rgba(255,255,255,0.3);
    transition: all 0.3s;
  }
  
  /* å•Ÿç”¨çš„ç¯€é» */
  .step.active {
    background: rgba(77, 182, 172, 0.4);
    border-color: var(--gold);
    color: #fff;
    box-shadow: 0 0 8px var(--gold);
  }

  /* ç‰¹æ®Šç‰Œç¯€é»æ¨£å¼ */
  .step.special { font-size: 20px; font-weight: bold; opacity: 0.3; }
  .step.special.active { opacity: 1; background: #fff; color: #000; transform: scale(1.1); }

  .combo-info { text-align: center; background: #000; width: 100%; padding: 4px 0; border-top: 1px solid #4db6ac; }

  /* ç‰Œé¢èˆ‡åº•éƒ¨é¢æ¿ */
  .mj-tile { background: #fff; border-radius: 5px; color: #000; font-size: 10vw; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 4px 0 #999; position: relative; }
  @media (min-width: 400px) { .mj-tile { font-size: 40px; } }
  .tile-hu { background: linear-gradient(#ffd700, #ff8c00) !important; color: #fff !important; }
  .tile-wild-effect { animation: wildGlow 0.8s infinite alternate; }
  @keyframes wildGlow { from { box-shadow: 0 0 5px var(--gold); } to { box-shadow: 0 0 15px var(--gold); } }
  .mj-tile.eliminating { transform: scale(0); opacity: 0; transition: 0.3s; }
  .wild-tag { position: absolute; top: 0; right: 0; background: gold; color: #000; font-size: 8px; padding: 1px 3px; border-radius: 0 0 0 5px; }

  .bottom-panel { background: #000; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
  .win-display { background: #001a1a; color: var(--gold); text-align: center; padding: 6px; border-radius: 5px; font-weight: bold; border: 1px solid #004d40; font-size: 18px; }
  .control-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  .bet-control { flex: 1; background: #111; border-radius: 8px; display: flex; flex-direction: column; align-items: center; padding: 5px; border: 1px solid #444; }
  .spin-btn { width: 110px; height: 55px; background: linear-gradient(#4db6ac, #00796b); border: 2px solid #b2dfdb; border-radius: 8px; color: #fff; font-size: 22px; font-weight: bold; box-shadow: 0 4px 0 #004d40; }
  .auto-btn { flex: 1; height: 55px; background: #455a64; border: 1px solid #546e7a; border-radius: 8px; color: #fff; font-weight: bold; }
</style>
</head>
<body>

<div class="topbar">
  <div class="audio-ctrl" onclick="toggleMute()" id="muteBtn">ğŸ”Š</div>
  <div class="audio-ctrl" onclick="cycleBGM()" id="bgmBtn">ğŸµ 1</div>
  <div class="balance-box">ğŸ’° <span id="balanceText">0</span></div>
  <marquee style="flex:1; color:var(--gold); font-size: 12px;">æœ‰å•é¡Œæ‰¾é˜¿è¨˜</marquee>
  <a href="index.html" style="text-decoration:none;">
    <button style="background:none; border:1px solid #777; color:#ccc; border-radius:5px; padding:5px 12px; font-size:14px;">ğŸ  å›å¤§å»³</button>
  </a>
</div>

<div class="main-container">
  <div class="game-area"><div class="grid" id="grid"></div></div>
  
  <div class="combo-pillar" id="pillar">
    <div class="combo-info">
      <div style="font-size: 8px; color: #4db6ac;">COMBO</div>
      <div id="comboCount" style="font-size:16px; color:white; font-weight:bold;">0</div>
    </div>
    </div>
</div>

<div class="bottom-panel">
  <div class="win-display">WIN: <span id="sessionWinText">0</span></div>
  <div class="control-row">
    <div class="bet-control">
      <div style="font-size: 9px; color: #888;">BET</div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span onclick="changeBet(-1)" style="color:var(--gold); font-size:24px;">-</span>
        <span id="betText" style="font-weight:bold; font-size: 18px;">300</span>
        <span onclick="changeBet(1)" style="color:var(--gold); font-size:24px;">+</span>
      </div>
    </div>
    <button class="spin-btn" id="spinBtn" onclick="handleFirstClick(); startSpin();">SPIN</button>
    <button class="auto-btn" id="autoBtn" onclick="handleFirstClick(); toggleAuto()">è‡ªå‹•</button>
  </div>
</div>

<audio id="bgm1" src="background-music-434612.mp3" loop preload="auto"></audio>
<audio id="bgm2" src="soft-background-music-427252.mp3" loop preload="auto"></audio>
<audio id="sndSpin" src="https://assets.mixkit.co/active_storage/sfx/2014/2014-preview.mp3"></audio>
<audio id="sndMatch" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>

<script>
let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
let isSpinning = false, isAuto = false, combo = 0;
let currentBetIdx = 2, currentBGM = 1, isMuted = false, hasInteracted = false;
const betOptions = [50, 100, 300, 500, 1000];
const tileData = { 'ğŸ€':'mj-red','ğŸ€š':'mj-blue','ğŸ€':'mj-blue','ğŸ€‘':'mj-green','ğŸ€”':'mj-green','ğŸ€„':'mj-red','ğŸ€…':'mj-green','â¬œ':'mj-blue','èƒ¡':'tile-hu','å…ƒå¯¶':'tile-wild' };
let board = [];

// ç”Ÿæˆ 10 å€‹éšæ¢¯ç¯€é»
function createPillar() {
    const p = document.getElementById('pillar');
    // æˆ‘å€‘éœ€è¦ 1~10 å±¤
    for (let i = 1; i <= 10; i++) {
        const step = document.createElement('div');
        step.id = `step-${i}`;
        if (i === 2) { step.className = 'step special'; step.innerHTML = 'â¬œ'; }
        else if (i === 5) { step.className = 'step special'; step.innerHTML = 'ğŸ€„'; }
        else if (i === 10) { step.className = 'step special'; step.innerHTML = 'ğŸ€…'; }
        else { step.className = 'step'; step.innerHTML = 'â—'; }
        p.appendChild(step);
    }
}

function updateUI() {
    document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString();
    document.getElementById('comboCount').textContent = combo;
    document.getElementById('betText').textContent = betOptions[currentBetIdx];
    document.getElementById('sessionWinText').textContent = Math.floor(window.winAmt || 0).toLocaleString();
    
    // æ›´æ–° 1~10 éšæ¢¯ç‹€æ…‹
    for (let i = 1; i <= 10; i++) {
        const el = document.getElementById(`step-${i}`);
        if (el) el.classList.toggle('active', combo >= i);
    }
    localStorage.setItem('sicbo_balance', balance);
}

// å…¶é¤˜é‚è¼¯ä¿æŒä¸è®Š
function isWild(icon) {
    if (icon === 'å…ƒå¯¶') return true;
    if (combo >= 2 && icon === 'â¬œ') return true;
    if (combo >= 5 && icon === 'ğŸ€„') return true;
    if (combo >= 10 && icon === 'ğŸ€…') return true;
    return false;
}

function handleFirstClick() { if (!hasInteracted) { hasInteracted = true; playBGM(); } }
function playBGM() {
    const b1 = document.getElementById('bgm1'), b2 = document.getElementById('bgm2');
    b1.pause(); b2.pause(); if (isMuted) return;
    const active = currentBGM === 1 ? b1 : b2; active.currentTime = 0; active.play().catch(()=>{});
}
function cycleBGM() { currentBGM = currentBGM === 1 ? 2 : 1; document.getElementById('bgmBtn').textContent = `ğŸµ ${currentBGM}`; if (hasInteracted) playBGM(); }
function toggleMute() { isMuted = !isMuted; document.getElementById('muteBtn').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š'; playBGM(); }
function playSfx(id) { if (!isMuted) { const s = document.getElementById(id); if (s) { s.currentTime = 0; s.play().catch(()=>{}); } } }

function initBoard() {
    const gridEl = document.getElementById('grid'); gridEl.innerHTML = '';
    board = Array.from({length:4}, () => Array(4).fill(null));
    for (let r=0; r<4; r++) {
        for (let c=0; c<4; c++) {
            board[r][c] = Object.keys(tileData)[Math.floor(Math.random()*10)];
            const tile = document.createElement('div');
            tile.id = `tile-${r}-${c}`;
            gridEl.appendChild(tile);
            updateTileVisual(r, c);
        }
    }
}

function updateTileVisual(r, c) {
    const el = document.getElementById(`tile-${r}-${c}`);
    const icon = board[r][c];
    el.className = `mj-tile ${tileData[icon]}`;
    el.innerHTML = (icon === 'å…ƒå¯¶') ? 'ğŸ’°' : icon;
    if (isWild(icon) && icon !== 'èƒ¡') {
        el.innerHTML += '<div class="wild-tag">WILD</div>';
        el.classList.add('tile-wild-effect');
    }
}

async function startSpin() {
    if (isSpinning || balance < betOptions[currentBetIdx]) return;
    isSpinning = true; balance -= betOptions[currentBetIdx];
    combo = 0; window.winAmt = 0; playSfx('sndSpin'); updateUI(); initBoard();
    await new Promise(r => setTimeout(r, 600));
    processMatches();
}

async function processMatches() {
    let matches = [];
    for(let r=0; r<4; r++){ if(board[r][0]===board[r][1] && board[r][1]===board[r][2]) matches.push({r,c:0},{r,c:1},{r,c:2}); }
    if (matches.length > 0) {
        combo++; playSfx('sndMatch');
        let win = matches.length * 10 * combo;
        balance += win; window.winAmt += win;
        updateUI();
        matches.forEach(m => document.getElementById(`tile-${m.r}-${m.c}`).classList.add('eliminating'));
        await new Promise(r => setTimeout(r, 400));
        initBoard(); processMatches();
    } else {
        isSpinning = false; updateUI();
        if (isAuto) { await new Promise(r => setTimeout(r, 1000)); startSpin(); }
    }
}

function changeBet(dir) { if (!isSpinning) { currentBetIdx = (currentBetIdx + dir + betOptions.length) % betOptions.length; updateUI(); } }
function toggleAuto() { isAuto = !isAuto; document.getElementById('autoBtn').classList.toggle('active', isAuto); if (isAuto && !isSpinning) startSpin(); }

window.onload = () => { createPillar(); updateUI(); initBoard(); };
</script>
</body>
</html>