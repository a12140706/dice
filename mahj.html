<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
<title>éº»å°‡æ¶ˆæ¶ˆæ¨‚ - æ‰‹æ©Ÿå‹•ç•«ç‰ˆ</title>
<style>
  :root { --gold: #ffd86b; --bg: #004d40; --m-red: #d32f2f; --m-green: #2e7d32; --m-blue: #1976d2; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
  
  body { 
    margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: Arial; 
    height: 100dvh; display: flex; flex-direction: column; overflow: hidden; 
    padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
  }
  
  body.free-game-active { background: #3e2723; }

  .topbar { 
    height: 45px; background: rgba(0,0,0,0.8); display: flex; align-items: center; 
    padding: 0 10px; gap: 8px; border-bottom: 1px solid #00695c; z-index: 100; width: 100%;
  }

  .balance-box { 
    background: rgba(0,0,0,0.5); border: 1px solid var(--gold); border-radius: 8px; 
    padding: 4px 10px; color: var(--gold); font-weight: bold; font-size: 14px; 
  }

  .audio-ctrl { font-size: 11px; background: #004d40; border: 1px solid #b2dfdb; padding: 4px 8px; border-radius: 12px; }

  .free-game-bar { 
    height: 40px; background: linear-gradient(90deg, #ff8f00, #ff6f00); 
    display: none; align-items: center; justify-content: space-around; font-weight: bold; 
  }
  .free-game-active .free-game-bar { display: flex; }

  .main-container { 
    flex: 1; display: flex; flex-direction: row; justify-content: center; align-items: center;
    padding: 10px; gap: 10px; width: 100%; position: relative;
  }

  .game-area { 
    flex: 1; display: flex; justify-content: center; align-items: center; 
    width: 100%; max-width: 400px;
  }

  .grid { 
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; 
    width: 100%; aspect-ratio: 4 / 5; background: #00796b; 
    padding: 10px; border-radius: 12px; border: 3px solid #004d40;
    box-shadow: 0 10px 20px rgba(0,0,0,0.3); position: relative;
  }

  .combo-pillar { 
    width: 50px; height: 80%; background: rgba(0,0,0,0.3); 
    border-radius: 20px; border: 2px solid #b2dfdb; 
    display: flex; flex-direction: column-reverse; padding: 5px 0;
  }

  .step { 
    flex: 1; width: 70%; margin: 2px auto; background: rgba(255,255,255,0.1); 
    border-radius: 50%; display: flex; align-items: center; justify-content: center; 
    font-size: 10px; color: rgba(255,255,255,0.3);
  }
  .step.active { background: var(--gold); color: #000; box-shadow: 0 0 10px var(--gold); transform: scale(1.1); }

  .mj-tile { 
    background: #fff; border-radius: 8px; color: #000; 
    font-size: 8vw; display: flex; align-items: center; justify-content: center; 
    font-weight: bold; box-shadow: 0 4px 0 #999; position: relative;
    opacity: 0; /* åˆå§‹éš±è—ï¼Œé å‹•ç•«é¡¯ç¤º */
  }
  @media (min-width: 450px) { .mj-tile { font-size: 36px; } }

  /* â­ è½ä¸‹å‹•ç•«ä¿®æ­£ï¼šé–‹å±€èˆ‡è£œç‰Œå…±ç”¨ */
  .tile-drop { animation: dropIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.1) forwards; }
  @keyframes dropIn { 
    from { transform: translateY(-400px); opacity: 0; } 
    to { transform: translateY(0); opacity: 1; } 
  }

  .eliminating { animation: vanish 0.3s forwards; z-index: 10; }
  @keyframes vanish { to { transform: scale(1.4); opacity: 0; } }

  .bottom-panel { background: #000; padding: 12px; width: 100%; }
  .win-display { 
    background: #001a1a; color: var(--gold); text-align: center; 
    padding: 8px; border-radius: 8px; font-weight: bold; 
    border: 1px solid #004d40; font-size: 20px; margin-bottom: 10px;
  }
  .control-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }

  .spin-btn { 
    flex: 1.5; height: 55px; background: linear-gradient(#4db6ac, #00796b); 
    border: none; border-radius: 12px; color: #fff; font-size: 22px; font-weight: bold;
    box-shadow: 0 4px 0 #004d40;
  }
  .spin-btn:active { transform: translateY(2px); box-shadow: none; }
  .spin-btn:disabled { opacity: 0.5; }

  .auto-btn { 
    flex: 1; height: 55px; background: #455a64; border: none; 
    border-radius: 12px; color: #fff; font-weight: bold; font-size: 16px;
  }
  .auto-btn.active { background: #c2185b; box-shadow: 0 0 15px #c2185b; }

  .bet-box { 
    flex: 1.2; background: #111; border-radius: 12px; padding: 5px; 
    text-align: center; border: 1px solid #444; height: 55px;
    display: flex; flex-direction: column; justify-content: center;
  }
  
  #multOverlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
  .mj-red { color: var(--m-red); }
  .mj-blue { color: var(--m-blue); }
  .mj-green { color: var(--m-green); }
</style>
</head>
<body id="mainBody">

<div id="multOverlay">
  <div style="color:white; font-size: 18px; margin-bottom: 10px;">FREE GAME MULTIPLIER</div>
  <div class="mult-box" id="rollingMult" style="font-size: 80px; color: var(--gold); font-weight: bold;">?</div>
</div>

<div class="topbar">
  <div class="audio-ctrl" onclick="toggleMute()" id="muteBtn">ğŸ”Š</div>
  <div class="audio-ctrl" onclick="cycleBGM()" id="bgmBtn">ğŸµ 1</div>
  <div class="balance-box" id="balanceBox">ğŸ’° <span id="balanceText">0</span></div>
  <marquee style="flex:1; color:var(--gold); font-size: 11px;">é–‹å±€è½ä¸‹å‹•ç•«ä¿®æ­£ç‰ˆ - æ‰‹æ©Ÿå„ªå…ˆ</marquee>
</div>

<div class="free-game-bar" id="freeSpinsLeftBar">
  <span>FREE: <span id="freeSpinsLeft">0</span></span>
  <span class="multiplier-tag" id="currentMult">X1</span>
</div>

<div class="main-container">
  <div class="game-area">
    <div class="grid" id="grid"></div>
  </div>
  <div class="combo-pillar" id="pillar"></div>
</div>

<div class="bottom-panel">
  <div class="win-display">WIN: <span id="sessionWinText">0</span></div>
  <div class="control-row">
    <div class="bet-box">
      <div style="font-size: 10px; color: #888;">BET</div>
      <div style="display:flex; align-items:center; justify-content:space-around;">
        <span onclick="changeBet(-1)" style="color:var(--gold); font-size:24px; padding: 0 10px;">-</span>
        <span id="betText" style="font-weight:bold; font-size: 18px;">300</span>
        <span onclick="changeBet(1)" style="color:var(--gold); font-size:24px; padding: 0 10px;">+</span>
      </div>
    </div>
    <button class="spin-btn" id="spinBtn" onclick="handleFirstClick(); startSpin();">SPIN</button>
    <button class="auto-btn" id="autoBtn" onclick="handleFirstClick(); toggleAuto()">è‡ªå‹•</button>
  </div>
</div>

<audio id="bgm1" src="background-music-434612.mp3" loop></audio>
<audio id="bgm2" src="soft-background-music-427252.mp3" loop></audio>
<audio id="bgmFree" src="https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-130.mp3" loop></audio>
<audio id="sndSpin" src="https://assets.mixkit.co/active_storage/sfx/2014/2014-preview.mp3"></audio>
<audio id="sndMatch" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>

<script>
let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
let isSpinning = false, isAuto = false, combo = 0, winThisSpin = 0;
let freeSpins = 0, currentMultiplier = 1;
let currentBetIdx = 2, currentBGM = 1, isMuted = false, hasInteracted = false;
const betOptions = [50, 100, 300, 500, 1000];
const baseIcons = ['ğŸ€','ğŸ€š','ğŸ€','ğŸ€‘','ğŸ€”','ğŸ€„','ğŸ€…','â¬œ'];
const tileColor = { 'ğŸ€':'mj-red','ğŸ€š':'mj-blue','ğŸ€':'mj-blue','ğŸ€‘':'mj-green','ğŸ€”':'mj-green','ğŸ€„':'mj-red','ğŸ€…':'mj-green','â¬œ':'mj-blue','èƒ¡':'tile-hu','å…ƒå¯¶':'tile-wild' };
let board = [];

function createPillar() {
  const p = document.getElementById('pillar');
  p.innerHTML = '';
  for (let i = 1; i <= 10; i++) {
    const s = document.createElement('div');
    s.id = `step-${i}`;
    s.className = 'step';
    s.innerHTML = i===2?'â¬œ':i===5?'ğŸ€„':i===10?'ğŸ€…':'â—';
    p.appendChild(s);
  }
}

function updateUI() {
  document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString();
  document.getElementById('betText').textContent = betOptions[currentBetIdx];
  document.getElementById('sessionWinText').textContent = Math.floor(winThisSpin).toLocaleString();
  document.getElementById('freeSpinsLeft').textContent = freeSpins;
  document.getElementById('currentMult').textContent = `X${currentMultiplier}`;
  for (let i=1; i<=10; i++) {
    const s = document.getElementById(`step-${i}`);
    if(s) s.classList.toggle('active', combo >= i);
  }
  document.getElementById('mainBody').classList.toggle('free-game-active', freeSpins > 0 || document.getElementById('mainBody').classList.contains('in-free'));
  document.getElementById('spinBtn').disabled = isSpinning;
  localStorage.setItem('sicbo_balance', balance);
}

function getRandomTile(r, c, isFreeMode) {
  const rand = Math.random();
  if (rand < 0.04) return 'å…ƒå¯¶'; 
  if (!isFreeMode && rand > 0.98) return 'èƒ¡';
  let pick = baseIcons[Math.floor(Math.random() * baseIcons.length)];
  const isWhiteWild = (combo >= 2 && pick === 'â¬œ');
  const isRedWild = (combo >= 5 && pick === 'ğŸ€„');
  const isGreenWild = (combo >= 10 && pick === 'ğŸ€…');
  if ((isWhiteWild || isRedWild || isGreenWild) && Math.random() < 0.7) {
      pick = baseIcons[Math.floor(Math.random() * baseIcons.length)];
  }
  return pick;
}

function handleFirstClick() { if (!hasInteracted) { hasInteracted = true; playBGM(); } }
function playBGM() {
  const b1=document.getElementById('bgm1'), b2=document.getElementById('bgm2'), bf=document.getElementById('bgmFree');
  [b1, b2, bf].forEach(b => b.pause());
  if (isMuted) return;
  const isFree = freeSpins > 0 || document.getElementById('mainBody').classList.contains('free-game-active');
  if (isFree) { bf.play().catch(()=>{}); } 
  else { (currentBGM===1?b1:b2).play().catch(()=>{}); }
}

async function startSpin() {
  if (isSpinning) return;
  isSpinning = true; combo = 0; winThisSpin = 0; updateUI();
  
  // 1. å…ˆè®“èˆŠçš„æ–¹å¡Šæ¶ˆå¤±
  const oldTiles = document.querySelectorAll('.mj-tile');
  oldTiles.forEach(t => t.style.opacity = '0');
  
  // è™•ç†å…éŠèˆ‡ä¸‹æ³¨
  if (freeSpins > 0) {
    freeSpins--;
    document.getElementById('mainBody').classList.add('in-free');
    await runMultiplierDraw();
  } else if (!freeSpins && document.getElementById('mainBody').classList.contains('in-free')) {
    document.getElementById('mainBody').classList.remove('in-free');
    currentMultiplier = 1;
  } else {
    if(balance < betOptions[currentBetIdx]) { isSpinning=false; isAuto=false; alert("é¤˜é¡ä¸è¶³"); return; }
    balance -= betOptions[currentBetIdx];
    currentMultiplier = 1;
  }
  
  playBGM();
  if(!isMuted) document.getElementById('sndSpin').play();

  // 2. æ¸…ç©ºç¶²æ ¼ä¸¦æº–å‚™é‡æ–°è½ä¸‹
  const gridEl = document.getElementById('grid');
  gridEl.innerHTML = ''; board = [];

  // â­ é˜¿è¨˜çœ‹é€™è£¡ï¼šä¸€è¡Œä¸€è¡Œè½ä¸‹ï¼Œç‡Ÿé€ é–‹å±€å‹•ç•«æ„Ÿ
  for (let r=0; r<4; r++) {
    board[r] = [];
    for (let c=0; c<4; c++) {
      board[r][c] = getRandomTile(r, c, false);
      const t = document.createElement('div');
      t.id = `tile-${r}-${c}`;
      t.className = 'mj-tile'; 
      // å»¶é²æ·»åŠ  tile-dropï¼Œè®“å®ƒæœ‰å…ˆå¾Œè½ä¸‹çš„æ„Ÿè¦º
      setTimeout(() => {
        t.classList.add('tile-drop');
        drawTile(r, c);
      }, (3 - r) * 100 + (c * 50)); 
      gridEl.appendChild(t);
    }
  }

  // ç­‰å‹•ç•«è·‘å®Œå†é–‹å§‹åˆ¤æ–·
  await new Promise(r => setTimeout(r, 800));
  checkMatches();
}

async function runMultiplierDraw() {
  const overlay = document.getElementById('multOverlay');
  const rollingText = document.getElementById('rollingMult');
  overlay.style.display = 'flex';
  let finalMult = Math.floor(Math.random() * 9) + 2;
  let startTime = Date.now();
  return new Promise(resolve => {
    const timer = setInterval(() => {
      rollingText.textContent = `X${Math.floor(Math.random() * 15) + 2}`;
      if (Date.now() - startTime > 1200) {
        clearInterval(timer);
        currentMultiplier = finalMult;
        rollingText.textContent = `X${finalMult}`;
        setTimeout(() => { overlay.style.display = 'none'; resolve(); }, 600);
      }
    }, 80);
  });
}

function isWild(icon) {
  if (icon === 'å…ƒå¯¶') return true;
  if (combo >= 2 && icon === 'â¬œ') return true;
  if (combo >= 5 && icon === 'ğŸ€„') return true;
  if (combo >= 10 && icon === 'ğŸ€…') return true;
  return false;
}

function drawTile(r, c) {
  const el = document.getElementById(`tile-${r}-${c}`);
  if(!el) return;
  const icon = board[r][c];
  el.className = `mj-tile ${tileColor[icon] || ''} tile-drop`;
  el.innerHTML = icon === 'å…ƒå¯¶' ? 'ğŸ’°' : icon;
  if (isWild(icon) && icon !== 'èƒ¡') {
    el.innerHTML += '<div style="position:absolute;top:0;right:0;background:gold;color:#000;font-size:8px;padding:1px 2px;border-radius:0 0 0 4px;">WILD</div>';
  }
}

async function checkMatches() {
  let toEliminate = new Set();
  baseIcons.forEach(target => {
    let matchedInCols = [];
    for (let c = 0; c < 4; c++) {
      let colMatches = [];
      for (let r = 0; r < 4; r++) {
        if (board[r][c] === target || isWild(board[r][c])) colMatches.push({r, c});
      }
      if (colMatches.length > 0) matchedInCols.push(colMatches);
      else break;
    }
    if (matchedInCols.length >= 3) {
      matchedInCols.forEach(col => col.forEach(pos => toEliminate.add(`${pos.r},${pos.c}`)));
    }
  });

  if (toEliminate.size > 0) {
    combo++;
    if(!isMuted) document.getElementById('sndMatch').play();
    
    let basePrice = betOptions[currentBetIdx] / 10;
    let win = toEliminate.size * basePrice * currentMultiplier;
    winThisSpin += win; balance += win; updateUI();

    toEliminate.forEach(pos => {
      const [r, c] = pos.split(',').map(Number);
      document.getElementById(`tile-${r}-${c}`).classList.add('eliminating');
    });

    await new Promise(r => setTimeout(r, 350));
    toEliminate.forEach(pos => {
      const [r, c] = pos.split(',').map(Number);
      board[r][c] = getRandomTile(r, c, false);
      const el = document.getElementById(`tile-${r}-${c}`);
      el.classList.remove('eliminating', 'tile-drop');
      void el.offsetWidth; // å¼·åˆ¶é‡ç¹ªè§¸ç™¼å‹•ç•«
      drawTile(r, c);
      el.classList.add('tile-drop');
    });
    setTimeout(checkMatches, 600);
  } else {
    let huCount = 0;
    board.forEach(row => row.forEach(icon => { if(icon === 'èƒ¡') huCount++; }));
    if (huCount >= 3 && freeSpins === 0 && !document.getElementById('mainBody').classList.contains('in-free')) {
      alert("ğŸ€„ æ¹Šé½Šä¸‰èƒ¡ï¼10 å±€å…è²»éŠæˆ²ï¼");
      freeSpins = 10; isSpinning = false; updateUI();
      setTimeout(startSpin, 500);
    } else {
      isSpinning = false; updateUI();
      if (freeSpins > 0 || isAuto) setTimeout(startSpin, 1200);
    }
  }
}

function changeBet(dir) { if(!isSpinning && freeSpins === 0) { currentBetIdx=(currentBetIdx+dir+5)%5; updateUI(); } }
function toggleAuto() { isAuto=!isAuto; document.getElementById('autoBtn').classList.toggle('active', isAuto); if(isAuto && !isSpinning) startSpin(); }
function cycleBGM() { currentBGM=currentBGM===1?2:1; document.getElementById('bgmBtn').textContent=`ğŸµ ${currentBGM}`; if(hasInteracted) playBGM(); }
function toggleMute() { isMuted=!isMuted; document.getElementById('muteBtn').textContent=isMuted?'ğŸ”‡':'ğŸ”Š'; playBGM(); }

window.onload = () => { createPillar(); updateUI(); };
</script>
</body>
</html>