<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport"
    content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <title>é˜¿è¨˜ä¸‰ç¼ºä¸€</title>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="é˜¿è¨˜å¨›æ¨‚åŸ">

  <meta name="mobile-web-app-capable" content="yes">
  <style>
    :root {
      --gold: #ffd86b;
      --dark-red: #4a0404;
      --card-bg: rgba(255, 255, 255, 0.1);
      --red: #ff4757;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at center, #2a0202, #050000);
      color: #fff;
      font-family: "Microsoft JhengHei", Arial;
      height: 100dvh;
      width: 100vw;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    #welcomeUserContainer.rank-item {
      display: inline-block;
      padding: 5px 15px;
      margin-top: 5px;
      border-radius: 20px;
    }

    /* é€šç”¨é …ç›®æ¨£å¼ */
    .rank-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin-bottom: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.2s;
    }

    .buy-btn {
      background: #3b82f6;
      border: none;
      color: white;
      padding: 5px 15px;
      border-radius: 5px;
      font-weight: bold;
    }

    .equip-btn {
      background: #10b981;
      border: none;
      color: white;
      padding: 5px 15px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }

    /* å‘¼å¸ç‡ˆå‹•ç•«ï¼šé™°å½±èˆ‡äº®åº¦çš„å¼·å¼±è®ŠåŒ– */
    @keyframes breathing-glow {
      0% {
        box-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
        filter: brightness(1);
      }

      50% {
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
        filter: brightness(1.3);
        /* è®Šäº® */
      }

      100% {
        box-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
        filter: brightness(1);
      }
    }

    /* è£å‚™æŒ‰éˆ•æ¨£å¼ */
    .equip-btn {
      background: #10b981;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      font-size: 12px;
    }

    .buy-btn {
      background: #3b82f6;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      font-size: 12px;
    }

    /* ç¨±è™ŸåŸºç¤æ¨£å¼ */
    .player-title {
      font-weight: 900;
      margin-right: 5px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }

    /* ç¨±è™Ÿç­‰ç´šè‰²å½© */
    .t-green {
      color: #2ecc71 !important;
    }

    /* åˆç´š */
    .t-blue {
      color: #3498db !important;
    }

    /* ä¸­ç´š */
    .t-purple {
      color: #9b59b6 !important;
    }

    /* é«˜ç´š */
    .t-orange {
      color: #e67e22 !important;
    }

    /* å‚³å¥‡ */
    .t-red {
      color: #ff4757 !important;
      animation: title-glow 1s infinite alternate;
    }

    /* ç¥è©± */

    @keyframes title-glow {
      from {
        filter: drop-shadow(0 0 1px #ff4757);
      }

      to {
        filter: drop-shadow(0 0 5px #ff4757);
      }
    }

    .welcome-msg {
      position: relative;
      overflow: hidden;
      /* ç¢ºä¿ç‰¹æ•ˆä¸æœƒè¶…å‡ºåœ“è§’é‚Šæ¡† */
      z-index: 1;
    }

    /* --- ç‰¹æ•ˆ 1ï¼šæ¥µé™ç„ç« (éœ‡å‹• + ç†”å²©æµ) --- */
    .welcome-msg,
    .rank-item {
      position: relative !important;
      overflow: hidden !important;
      /* åš´æ ¼ç¦æ­¢å…§å®¹æº¢å‡º */
      contain: paint;
      /* é€™æ˜¯é˜²æ­¢æ©«å‘æ²è»¸çš„æœ€å¼·æ‰‹æ®µ */
      z-index: 1;
    }

    /* --- ç‰¹æ•ˆ 1ï¼šç„ç«ç„šèº« (ä¿®æ­£éœ‡å‹•ï¼Œé˜²æ­¢æ©«æ¢) --- */
    .fx-fire {
      /* é‚Šæ¡†æ”¹ç”¨æ¼¸å±¤è‰²ï¼Œæ¨¡æ“¬ç™¼ç†±çš„é‡‘å±¬ */
      border: 2px solid transparent !important;
      background:
        linear-gradient(#2a0000, #2a0000) padding-box,
        /* å…§å®¹èƒŒæ™¯ */
        linear-gradient(0deg, #ff4757, #ff9f43, #ff4757) border-box !important;
      /* é‚Šæ¡†ç«ç„°æµ */
      background-size: 100% 100%, 100% 300% !important;
      color: #fff !important;
      box-shadow: inset 0 0 15px #741b1b, 0 0 15px rgba(255, 71, 87, 0.5) !important;
      text-shadow: 0 0 8px #ff4757, 0 0 15px #ff7e67 !important;
      /* border-flow è®“é‚Šæ¡†é¡è‰²ç«„å‹•, fire-flicker è®“æ•´é«”é–ƒçˆ */
      animation:
        fire-flicker 0.2s ease-in-out infinite alternate,
        border-flow 1.5s linear infinite !important;
    }

    .fx-fire::before {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 200%;
      /* æ¨¡æ“¬å‘ä¸Šç«„çš„ç«è‹—æ¼¸å±¤ */
      background: linear-gradient(0deg,
          transparent 0%,
          rgba(255, 69, 0, 0.4) 20%,
          rgba(255, 165, 0, 0.2) 50%,
          transparent 80%);
      z-index: -1;
      animation: fire-rise 1s linear infinite;
      /* ç«è‹—å‘ä¸Šç«„å‹• */
    }

    /* --- ç‰¹æ•ˆ 2ï¼šé›·éœ†éœ“è™¹ (å¼·åŒ–éœ“è™¹æ„Ÿï¼Œå–æ¶ˆæé‚Š) --- */
   .fx-neon {
    border: 2px solid #fff !important;
    /* 1. é—œéµä¿®æ”¹ï¼šå°‡ 0% å’Œ 100% çš„é»‘è‰²æ”¹ç‚ºæ·±è—è‰²ï¼Œhue-rotate æ‰èƒ½æŠ“åˆ°é¡è‰²è®Šè‰² */
    background: linear-gradient(
        135deg, 
        #001a33 0%,   /* å–ä»£é»‘è‰² */
        #004488 25%, 
        #0066aa 50%, 
        #440088 75%, 
        #001a33 100%  /* å–ä»£é»‘è‰² */
    ) !important;
    background-size: 300% 300% !important;
    color: #fff !important;
    
    /* 2. å¢åŠ å¼·çƒˆçš„å…§éƒ¨ç™¼å…‰ï¼Œç›´æ¥æŠŠèƒŒæ™¯ç…§äº® */
    box-shadow: 
        inset 0 0 30px rgba(0, 210, 255, 0.7), 
        0 0 10px #fff, 
        0 0 20px #00d2ff !important;

    /* 3. å‹•ç•«çµ„åˆ */
    animation:
        neon-flicker 2s infinite,
        neon-rainbow 2s linear infinite,
        bg-flow-extreme 1s ease-in-out infinite !important;
    
    /* ç¢ºä¿å…§å®¹åœ¨ç™¼å…‰èƒŒæ™¯ä¸Šä¾ç„¶æ¸…æ™° */
    text-shadow: 0 0 5px #000, 2px 2px 2px #000 !important;
}

/* 4. å¼·åŒ–çš„èƒŒæ™¯ç§»å‹•ï¼šè®“æ¼¸å±¤åœ¨ç›’å­è£¡å¤§å¹…åº¦æ»‘å‹• */
@keyframes bg-flow-extreme {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
    /* --- ç‰¹æ•ˆ 3ï¼šè‡³å°Šçš‡é‡‘ (ä¿æŒç°¡æ½”é«˜ç´šæ„Ÿ) --- */
    .fx-gold {
      border: 1px solid #ffd700 !important;
      background-image: linear-gradient(110deg, #6b5500 0%, #ffd700 50%, #6b5500 100%) !important;
      background-size: 200% auto !important;
      color: #fff !important;
      animation: shine-gold 3s linear infinite !important;
    }

    /* --- å‹•ç•«ä¿®æ­£å®šç¾© --- */
    @keyframes fire-pulse {
      from {
        filter: brightness(1);
        box-shadow: 0 0 10px #ff4757;
      }

      to {
        filter: brightness(1.5);
        box-shadow: 0 0 20px #ff4757;
      }
    }

    @keyframes fire-swirl {
      0% {
        transform: rotate(0deg) scale(1);
      }

      50% {
        transform: rotate(180deg) scale(1.1);
      }

      100% {
        transform: rotate(360deg) scale(1);
      }
    }

    @keyframes border-flow {
      0% {
        background-position: 0% 0%, 50% 100%;
      }

      100% {
        background-position: 0% 0%, 50% -100%;
      }
    }

    /* ç«èˆŒå‘ä¸Šå‡é¨° */
    @keyframes fire-rise {
      0% {
        transform: translateY(0%);
        opacity: 0.8;
      }

      100% {
        transform: translateY(-50%);
        opacity: 0.4;
      }
    }

    @keyframes fire-flicker {
      0% {
        filter: brightness(1);
      }

      100% {
        filter: brightness(1.3);
      }
    }

    /* éœ“è™¹æé‚Šæµå‹• */
    @keyframes neon-trace {
      0% {
        clip-path: inset(0 70% 95% 0);
      }

      25% {
        clip-path: inset(0 0 70% 95%);
      }

      50% {
        clip-path: inset(95% 0 0 70%);
      }

      75% {
        clip-path: inset(70% 95% 0 0);
      }

      100% {
        clip-path: inset(0 70% 95% 0);
      }
    }

    @keyframes neon-rainbow {
      0% {
        filter: hue-rotate(0deg);
      }

      100% {
        filter: hue-rotate(360deg);
      }
    }

    /* éœ“è™¹ï¼šåŸæœ¬çš„é–ƒçˆæ•ˆæœ */
    @keyframes neon-flicker {

      0%,
      18%,
      22%,
      25%,
      53%,
      57%,
      100% {
        text-shadow: 0 0 10px #fff, 0 0 20px #00d2ff;
        opacity: 1;
      }

      20%,
      24%,
      55% {
        text-shadow: none;
        box-shadow: none;
        opacity: 0.7;
      }
    }

    @keyframes shine-gold {
      to {
        background-position: 200% center;
      }
    }

    @keyframes rotate-slow {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    @keyframes void-pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(0.97);
      }

      /* ç¨å¾®ç¸®å°æ¨¡æ“¬è¢«å¸å…¥ */
    }

    @keyframes breathing-glow {

      0%,
      100% {
        filter: brightness(1);
      }

      50% {
        filter: brightness(1.4);
      }
    }

    /* --- ç‰¹æ•ˆ 4ï¼šçµ•å°é›¶åº¦ (å†°è—å‘¼å¸ + çµæ™¶é–ƒçˆ) --- */
    .fx-ice {
      border: 1px solid #00f2fe !important;
      background: linear-gradient(135deg, #005f73, #00d4ff) !important;
      color: #fff !important;
      text-shadow: 0 0 10px #7ed6ff !important;
      box-shadow: 0 0 15px rgba(0, 242, 254, 0.5) !important;
      animation: ice-shimmer 2s ease-in-out infinite alternate !important;
    }

    .fx-ice::before {
      content: "â„";
      position: absolute;
      right: 5px;
      top: -5px;
      opacity: 0.3;
      font-size: 20px;
      animation: rotate-slow 5s linear infinite;
    }

    /* --- ç‰¹æ•ˆ 5ï¼šæ·±æµ·é›·é³´ (æ·±è—èƒŒæ™¯ + éš¨æ©Ÿé–ƒé›») --- */
    .fx-thunder {
      border: 1px solid #4834d4 !important;
      background: #060b28 !important;
      color: #fff !important;
      overflow: hidden;
    }

    .fx-thunder::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      opacity: 0;
      z-index: -1;
      animation: lightning-strike 2s steps(1) infinite;
    }

    /* --- ç‰¹æ•ˆ 6ï¼šé»‘æ´æ¹®æ»… (æš—ç´«è‰²é‚Šæ¡† + ç©ºé–“æ‰­æ›²æ„Ÿ) --- */
    .fx-void {
      border: 2px solid #2f3542 !important;
      background: black !important;
      color: #a55eea !important;
      box-shadow: 0 0 20px #6c5ce7 !important;
      animation: void-pulse 3s ease-in-out infinite !important;
    }

    .fx-void::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: conic-gradient(from 0deg, transparent, #6c5ce7, transparent);
      animation: rotate-slow 3s linear infinite;
      z-index: -1;
      opacity: 0.4;
    }

    /* --- æ–°ç‰¹æ•ˆå‹•ç•«å®šç¾© --- */
    @keyframes ice-shimmer {
      from {
        filter: saturate(1) brightness(1);
        box-shadow: 0 0 5px #00f2fe;
      }

      to {
        filter: saturate(1.5) brightness(1.2);
        box-shadow: 0 0 20px #00f2fe;
      }
    }

    @keyframes lightning-strike {

      0%,
      95%,
      98% {
        opacity: 0;
      }

      96%,
      99% {
        opacity: 0.4;
      }

      /* æ¨¡æ“¬é›·é›¨é–ƒé›»ç¬é–“é–ƒçˆ */
    }

    @keyframes void-pulse {

      0%,
      100% {
        transform: scale(1);
        filter: blur(0px);
      }

      50% {
        transform: scale(0.98);
        filter: blur(0.5px);
      }
    }

    @keyframes rotate-slow {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }


    .rank-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .rank-num {
      min-width: 25px;
      text-align: center;
      font-weight: bold;
    }

    .rank-bal {
      color: #f1c40f;
      font-weight: bold;
    }

    .header {
      height: 50px;
      flex-shrink: 0;
      background: linear-gradient(to bottom, #5c0a0a, #2a0202);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      border-bottom: 2px solid var(--gold);
      z-index: 100;
    }

    .logo {
      font-size: 18px;
      font-weight: 900;
      color: var(--gold);
    }

    .balance-display {
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 12px;
      border-radius: 20px;
      border: 1px solid var(--gold);
      font-size: 15px;
      color: var(--gold);
      font-weight: bold;
      cursor: pointer;
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      overflow: hidden;
    }

    .welcome-msg {
      font-size: 14px;
      color: #ccc;
      text-align: center;
      margin-bottom: 8px;
    }

    .game-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      align-content: start;
      overflow-y: auto;
      padding-bottom: 10px;
    }

    .game-card {
      background: var(--card-bg);
      border: 1px solid #444;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      text-decoration: none;
      color: inherit;
      min-height: 85px;
      transition: transform 0.1s;
    }

    .game-img {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }

    .game-info {
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 0 0 12px 12px;
    }

    .game-title {
      font-size: 12px;
      color: var(--gold);
      font-weight: bold;
    }

    .deposit-area {
      width: 100%;
      display: flex;
      gap: 10px;
      flex-shrink: 0;
      padding: 10px 0;
    }

    .btn-deposit {
      flex: 2;
      padding: 12px;
      border-radius: 12px;
      border: 2px solid var(--gold);
      background: linear-gradient(#ff4757, #b91c1c);
      color: #fff;
      font-size: 18px;
      font-weight: 900;
    }

    .btn-rank {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      border: 2px solid var(--gold);
      background: linear-gradient(#f59e0b, #92400e);
      color: #fff;
      font-size: 15px;
      font-weight: 900;
    }

    .footer {
      text-align: center;
      padding: 5px 0;
      font-size: 10px;
      color: #444;
    }

    /* --- æ’è¡Œæ¦œå´é‚Šæ¬„ä¿®æ­£ --- */
    #rankOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      z-index: 2999;
    }

    #rankSidebar {
      position: fixed;
      top: 0;
      right: -100%;
      /* åˆå§‹éš±è—åœ¨å³å´ */
      max-width: 95%;
      height: 100%;
      background: #1a0202;
      border-left: 2px solid var(--gold);
      z-index: 3000;
      transition: 0.3s ease;
      display: flex;
      flex-direction: column;
      padding: 20px;
      padding-top: calc(env(safe-area-inset-top) + 20px);
    }

    #rankSidebar.active {
      right: 0;
    }

    /* å•Ÿå‹•æ™‚æ‹‰å›è¢å¹• */

    .rank-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--gold);
      padding-bottom: 10px;
    }

    .rank-list {
      flex: 1;
      overflow-y: auto;
      margin-top: 10px;
    }

    .rank-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 5px;
      border-bottom: 1px solid rgba(255, 216, 107, 0.1);
      font-size: 14px;
    }

    .rank-num {
      color: var(--gold);
      font-weight: bold;
      width: 25px;
    }

    .rank-name {
      flex: 1;
      margin-left: 5px;
    }

    .rank-bal {
      color: #fff;
    }

    .close-rank {
      font-size: 30px;
      color: var(--gold);
      cursor: pointer;
    }



    /* æ©«å‘æ¨¡å¼èª¿æ•´ */
    @media (orientation: landscape) {
      .game-grid {
        grid-template-columns: repeat(5, 1fr);
      }

      .game-card {
        min-height: 65px;
      }

      .game-img {
        font-size: 22px;
      }
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-content {
      background: #1a1a1a;
      border: 2px solid var(--gold);
      padding: 20px;
      border-radius: 20px;
      width: 85%;
      max-width: 320px;
      text-align: center;
    }

    .modal-btn {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      font-weight: bold;
      color: #fff;
    }

 /* çµ•ä¸–ç‰¹æ•ˆï¼šéŒ¦é¯‰èºé· (çµ‚æ¥µå‹•æ…‹ç‰ˆ) */
.fx-cosmic-koi {
    position: relative;
    padding: 12px 20px;
    border-radius: 15px;
    color: white !important;
    font-weight: bold;
    text-align: center;
    text-shadow: 0 0 10px rgba(255, 158, 0, 0.8);
    overflow: hidden; /* ç¢ºä¿æµå…‰èˆ‡ç²’å­ä¸æº¢å‡º */
    z-index: 1;
    border: none;
    background: #10002b; /* æ·±è‰²åº•ï¼Œé˜²æ­¢èƒŒæ™¯ç¸®æ”¾æ™‚éœ²åº• */
}

/* 1. æµå…‰é‚Šæ¡†æ—‹è½‰å±¤ (::before) */
.fx-cosmic-koi::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: conic-gradient(
        transparent, 
        #ff9e00 10%, 
        #ff0054 20%, 
        transparent 30%, 
        transparent 70%, 
        #9d4edd 80%, 
        #ff9e00 90%
    );
    animation: koiRotate 4s linear infinite;
    z-index: -2;
}

/* 2. èƒŒæ™¯èˆ‡ç²’å­çµ„åˆå±¤ (::after) */
/* é€™ä¸€å±¤è² è²¬èƒŒæ™¯æ¼¸è®Šã€ç²’å­ã€ä»¥åŠç¸®æ”¾æ•ˆæœ */
.fx-cosmic-koi::after {
    content: '';
    position: absolute;
    inset: 3px; /* é€™è£¡æ±ºå®šé‚Šæ¡†çš„ç²—ç´° (3px) */
    background: 
        /* æ‡¸æµ®ç²’å­åœ–æ¡ˆ */
        radial-gradient(circle, rgba(255, 255, 255, 0.3) 1px, transparent 1px),
        /* åº•å±¤æ¼¸è®ŠèƒŒæ™¯ */
        linear-gradient(135deg, #240046 0%, #3c096c 50%, #5a189a 100%);
    background-size: 20px 20px, 400% 400%; /* ç²’å­å¯†åº¦èˆ‡èƒŒæ™¯å°ºå¯¸ */
    border-radius: 12px;
    z-index: -1;
    /* é€™è£¡åŒæ™‚åŸ·è¡Œï¼šç²’å­é£„æµ®å‹•ç•«ã€èƒŒæ™¯æµå‹•ã€æ•´é«”ç¸®æ”¾ */
    animation: 
        koiParticleMove 20s linear infinite, 
        koiBgFlow 8s ease infinite,
        koiScaleBreath 3s ease-in-out infinite;
}
@keyframes koiRotate {
    100% { transform: rotate(360deg); }
}
@keyframes koiParticleMove {
    0% { background-position: 0px 0px, 0% 50%; }
    100% { background-position: 100px 100px, 100% 50%; }
}
/* å‹•ç•«å®šç¾© */
@keyframes rotateBorder {
    100% { transform: rotate(360deg); }
}
@keyframes koiScaleBreath {
    0%, 100% { transform: scale(1); opacity: 0.9; }
    50% { transform: scale(1.05); opacity: 1; }
}
@keyframes koiFlow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
@keyframes koiBgFlow {
    0%, 100% { background-position: 20px 20px, 0% 50%; }
    50% { background-position: 20px 20px, 100% 50%; }
}
@keyframes koiGlow {
    0%, 100% { box-shadow: inset 0 0 0 2px rgba(16, 0, 43, 0.9), 0 0 10px rgba(255, 158, 0, 0.4); }
    50% { box-shadow: inset 0 0 0 2px rgba(16, 0, 43, 0.9), 0 0 25px rgba(255, 158, 0, 0.7); }
}

    .player-title.t-koi {
      color: #fff;
      text-shadow:
        0 0 5px #fff,
        0 0 10px #ff00de,
        0 0 15px #ff00de;
      animation: koi-text-glow 1.5s ease-in-out infinite alternate;
    }

    @keyframes koi-text-glow {
      from {
        filter: drop-shadow(0 0 2px #fff);
      }

      to {
        filter: drop-shadow(0 0 8px #ff00de);
      }
    }

    /* å‹•ç•«å®šç¾© */
    @keyframes cosmic-border {
      0% {
        background-position: 0% 0%, 0% 50%;
      }

      100% {
        background-position: 0% 0%, 300% 50%;
      }
    }

    @keyframes koi-scales {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    @keyframes koi-sweep {
      0% {
        left: -100%;
      }

      100% {
        left: 200%;
      }
    }

    /* éŒ¦é¯‰å°ˆå±¬å½©è‰²æ–‡å­— */
    .t-koi-color {
      background: linear-gradient(to right, #ff9e00, #ff0054, #9d4edd, #ff9e00);
      background-size: 200% auto;
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: koiTextMove 3s linear infinite;
      font-weight: bold;
      filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.5));
    }

    @keyframes koiTextMove {
      to {
        background-position: 200% center;
      }
    }

    .lotto-box {
      background: linear-gradient(135deg, #1a1a1a, #2c3e50);
      border: 3px solid #ffd700;
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      width: 85%;
      max-width: 350px;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
    }

    .lotto-item {
      margin: 15px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      color: #fff;
      animation: item-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    @keyframes item-pop {
      0% {
        transform: scale(0);
        opacity: 0;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .close-btn {
      margin-top: 20px;
      padding: 10px 30px;
      background: var(--gold);
      border: none;
      border-radius: 20px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <div class="header">
    <div class="logo">é˜¿è¨˜ä¸‰ç¼ºä¸€</div>
    <div style="color:var(--gold); font-size:13px; cursor:pointer; text-decoration:underline;" onclick="openShop()">ğŸªå•†åŸ
    </div>
    <div style="color:#ff4757; font-size:13px; cursor:pointer; text-decoration:underline; font-weight:bold;"
      onclick="playLotto()">ğŸ“…æ¨‚é€</div>
    <div class="balance-display" onclick="toggleRank()">ğŸ’ <span id="mainBalance">0</span></div>
  </div>
  <div>
    <marquee style="flex:1; color:var(--gold);">ç·šä¸Šæ¸¬è©¦ç‰ˆ</marquee>
  </div>

  <div class="container">
    <div class="welcome-msg" id="welcomeUser">åç¨±</div>

    <div class="welcome-msg">
      <span id="welcomeUserContainer">é¸æ“‡éŠæˆ²</span>
    </div>

    <div class="game-grid">
      <a href="sicbo.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #0a5c32, #084325);">ğŸ²</div>
        <div class="game-info">
          <div class="game-title">éª°å¯¶</div>
        </div>
      </a>

      <a href="slot.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #4a0404, #2a0202);">ğŸ°</div>
        <div class="game-info">
          <div class="game-title">777æ‹‰éœ¸æ©Ÿ</div>
        </div>
      </a>
      <a href="horse.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #1e3a8a, #1e1b4b);">ğŸ</div>
        <div class="game-info">
          <div class="game-title">è³½é¦¬å ´</div>
        </div>
      </a>
      <a href="gemslot.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #5b8a1e, #d1f51e);">ğŸ’</div>
        <div class="game-info">
          <div class="game-title">å¯¶çŸ³ç¤¦å‘</div>
        </div>
      </a>
      <a href="link.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #0f3fc4, #12e7f6);">ğŸ²</div>
        <div class="game-info">
          <div class="game-title">æ¶ˆæ¶ˆæ¨‚</div>
        </div>
      </a>
      <a href="mahj.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #e833a2, #d26019);">ğŸ€„</div>
        <div class="game-info">
          <div class="game-title">éº»å°‡æ¶ˆæ¶ˆæ¨‚</div>
        </div>
      </a>
      <a href="heart.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #fcb1df, #f5ac7f);">â¤ï¸</div>
        <div class="game-info">
          <div class="game-title">æ„›å¿ƒ</div>
        </div>
      </a>
      <a href="foodlink.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #f1c1c1, #56f19e);">ğŸ°</div>
        <div class="game-info">
          <div class="game-title">é€£é€£çœ‹</div>
        </div>
      </a>
       <a href="bomb.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #312222, #bad7c7);">ğŸ§§</div>
        <div class="game-info">
          <div class="game-title">å°‹å¯¶</div>
        </div>
      </a>
      <a href="#" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #312222, #bad7c7);">ğŸ§§</div>
        <div class="game-info">
          <div class="game-title">(æš«ç„¡)æœªå®Œæˆåˆ®åˆ®æ¨‚</div>
        </div>
      </a>
    </div>

    <div class="deposit-area">
      <button class="btn-deposit" onclick="openModal()">ğŸ’¸ è¬€å‰é˜¿</button>
      <button class="btn-rank" onclick="toggleRank()">ğŸ† æ’è¡Œ</button>
    </div>
  </div>

  <div class="footer">
    &copy; é˜¿è¨˜å¨›æ¨‚åŸ
  </div>

  <div id="rankOverlay" onclick="toggleRank()"></div>
  <div id="rankSidebar">
    <div class="rank-header">
      <h2 style="color:var(--gold); margin:0;">ğŸ’æ’è¡Œæ¦œ</h2>
      <span class="close-rank" onclick="toggleRank()">&times;</span>
    </div>
    <div class="rank-list" id="rankList">
      <p style="text-align:center; color:#888;">è¼‰å…¥ä¸­...</p>
    </div>
  </div>

  <div id="depositModal" class="modal">
    <div class="modal-content">
      <h2 style="color:var(--gold); margin-bottom:15px; font-size: 22px;">åˆ·é˜¿è¨˜çš„å¡ï¼Œé˜¿è¨˜çš„éŒ¢æœ‰é™ï¼Œä¸€å¤©ä¸€æ¬¡</h2>
      <button class="modal-btn" style="background:#f59e0b;" onclick="handleDeposit(1000000)">å„²å€¼ 1,000,000</button>
      <button class="modal-btn" style="background:#444; color:#ccc;" onclick="closeModal()">ç®—äº†</button>
    </div>
  </div>
  <div id="shopModal" class="modal">
    <div class="modal-content" style="max-width: 380px; padding: 15px;">
      <h2 style="color:var(--gold); margin-bottom:10px;">éŠæˆ²å•†åŸ</h2>

      <div style="display:flex; gap:5px; margin-bottom:15px;">
        <button class="modal-btn" id="tabTitle" style="margin:0; background:var(--red);"
          onclick="switchShop('title')">ç¨±è™Ÿ</button>
        <button class="modal-btn" id="tabEffect" style="margin:0; background:#444;"
          onclick="switchShop('effect')">ç‰¹æ•ˆ</button>
      </div>

      <div id="shopList" style="max-height: 300px; overflow-y: auto;">
      </div>

      <button class="modal-btn" style="background:#222; margin-top:10px; border:1px solid #444;"
        onclick="closeShop()">é›¢é–‹å•†åŸ</button>
    </div>
  </div>

  <div id="nameModal" class="modal">
    <div class="modal-content">
      <h2 style="color:var(--gold);">è«‹è¼¸å…¥éŠæˆ²æš±ç¨±</h2>
      <p style="color:#ccc; font-size:14px;">ç”¨æ–¼æ’è¡Œæ¦œé¡¯ç¤º</p>
      <input type="text" id="nicknameInput" placeholder="æœ€å¤š8å€‹å­—" maxlength="8">
      <button class="modal-btn" style="background:var(--red);" onclick="saveNewPlayer()">é€²å…¥éŠæˆ²</button>
    </div>
  </div>
  <div id="lottoModal" class="modal">
    <div class="lotto-box">
      <h2>ğŸ“… æ¯æ—¥é–‹ççµæœ</h2>
      <div id="lottoResultArea">
      </div>
      <button onclick="closeLottoModal()" class="close-btn">ç¢ºèªæ”¶ä¸‹</button>
    </div>
  </div>
  <div id="toast-msg"
    style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.8); color:white; padding:15px 30px; border-radius:30px; z-index:9999; font-size:16px; white-space:nowrap; border:1px solid #ffd700; box-shadow: 0 0 15px rgba(0,0,0,0.5);">
    âœ… å„²å€¼æˆåŠŸ
  </div>

  <audio id="sndCash" src="https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3" preload="auto"></audio>

  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>

  <script>
    const _k = ["AIzaSyDSRfVA", "uWCWCUd1NJop", "J6wHvsqsAM4UzJA"];

    const firebaseConfig = {
      apiKey: _k.join(''),
      authDomain: "game-80d68.firebaseapp.com",
      projectId: "game-80d68",
      storageBucket: "game-80d68.firebasestorage.app",
      messagingSenderId: "636332967920",
      appId: "1:636332967920:web:29e5600daf4db0ab613f35",
      measurementId: "G-MJZ4PGEHSQ"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    function updateMainBalance() {
      const balance = localStorage.getItem('sicbo_balance') || '5000';
      document.getElementById('mainBalance').textContent = Math.floor(parseFloat(balance)).toLocaleString();
    }

    function openModal() { document.getElementById('depositModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('depositModal').style.display = 'none'; }

    async function handleDeposit(amt) {
      const playerId = localStorage.getItem('player_id');
      if (!playerId) return alert("è«‹å…ˆç™»å…¥éŠæˆ²ï¼");

      // 1. å–å¾—ä»Šå¤©æ—¥æœŸå­—ä¸² (æ ¼å¼ä¾‹å¦‚: "2025-12-29")
      const today = new Date().toISOString().split('T')[0];

      try {
        // 2. æª¢æŸ¥é›²ç«¯ç´€éŒ„
        const userRef = db.collection("users").doc(playerId);
        const doc = await userRef.get();

        if (doc.exists) {
          const userData = doc.data();
          // å¦‚æœé›²ç«¯å­˜çš„æ—¥æœŸè·Ÿä»Šå¤©ä¸€æ¨£ï¼Œå°±æ“‹ä½
          //if (userData.lastDepositDate === today) {
          // alert("ä»Šå¤©å·²ç¶“åˆ·éå›‰ï¼Œæ˜å¤©å†ä¾†");
          //closeModal();
          // return;
          //}
        }

        // 3. åŸ·è¡Œå„²å€¼é‚è¼¯
        balance = parseFloat(localStorage.getItem('sicbo_balance')) || 0;
        balance += amt;

        // 4. åŒæ­¥æ›´æ–°æœ¬åœ°èˆ‡é›²ç«¯ (å­˜å…¥ä»Šå¤©æ—¥æœŸ)
        localStorage.setItem('sicbo_balance', balance);
        await userRef.update({
          balance: balance,
          lastDepositDate: today // ç´€éŒ„ä»Šå¤©å·²é ˜å–
        });

        // 5. UI å›é¥‹
        document.getElementById('sndCash').play().catch(() => { });
        updateMainBalance();
        const toast = document.getElementById('toast-msg');
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 1500);
      } catch (e) {
        console.error("å„²å€¼å¤±æ•—:", e);
        alert("é€£ç·šä¸ç©©å®šï¼Œè«‹ç¨å¾Œå†è©¦");
      }
    }
    // å•†å“å®šç¾©
    const SHOP_DATA = {
      title: [
        { id: 't_new', name: 'ğŸŒ± åˆå‡ºèŒ…å»¬', price: 50000 },
        { id: 't_hunter', name: 'ğŸ¹ è³­å ´çµäºº', price: 200000 },
        { id: 't_rich', name: 'ğŸ’° åœŸè±ª', price: 1000000 },
        { id: 't_lady', name: 'ğŸ‘— åƒé‡‘å¤§å°å§', price: 5000000 },
        { id: 't_sir', name: 'ğŸ© è±ªé–€å¤§å°‘çˆº', price: 5000000 },
        { id: 't_king', name: 'ğŸ‘‘ æ¢Ÿé›„', price: 10000000 },
        { id: 't_legend', name: 'ğŸ‰ è³­åŸå‚³å¥‡', price: 50000000 },
        { id: 't_god', name: 'âš–ï¸ å¯Œå¯æ•µåœ‹', price: 100000000 },
        { id: 't_world', name: 'ğŸª è³­ç¥', price: 500000000 },
        { id: 't_koi', name: 'ğŸŒŒ å¹¸é‹éŒ¦é¯‰', price: 0, lottoOnly: true }
      ],
      effect: [
        { id: 'e_thunder', name: 'âš¡ é›»é–ƒé›·é³´', price: 2000000, class: 'fx-thunder' },
        { id: 'e_void', name: 'ğŸŒ€ æ¹®æ»…é»‘æ´', price: 5000000, class: 'fx-void' },
        { id: 'e_gold', name: 'âœ¨ é»ƒé‡‘å‘¼å¸', price: 8000000, class: 'fx-gold' },
        { id: 'e_ice', name: 'â„ï¸ çµ•å°é›¶åº¦', price: 10000000, class: 'fx-ice' },
        { id: 'e_fire', name: 'ğŸ”¥ åœ°ç„ç«', price: 200000000, class: 'fx-fire' },
        { id: 'e_neon', name: 'ğŸŒˆ å½©è™¹æ¥µå…‰', price: 500000000, class: 'fx-neon' },
        { id: 'e_koi', name: 'ğŸŒŠ éŒ¦é¯‰èºé·', price: 0, class: 'fx-cosmic-koi', lottoOnly: true }
      ]
    };

    let currentShopTab = 'title';
    const LOTTO_CONFIG = {
      price: 10000,
      grandPrize: 100000000, // 1å„„
      chanceMoney: 0.05,    // 1% ä¸­ä¸€å„„
      chanceTitle: 0.01,    // 2% ä¸­ç¨±è™Ÿ "ğŸŒŒ å¹¸é‹éŒ¦é¯‰"
      chanceFx: 0.005,       // 1.5% ä¸­ç‰¹æ•ˆ "fx-cosmic-koi"
    };
    function showLottoAnimation(results) {
      const modal = document.getElementById('lottoModal');
      const area = document.getElementById('lottoResultArea');
      area.innerHTML = "";
      modal.style.display = "flex";

      if (results.length === 0) {
        area.innerHTML = "<div class='lotto-item' style='color:#999;'>ğŸ˜¢ å…¨éƒ¨æ§“é¾œï¼Œæ˜å¤©åŠ æ²¹</div>";
      } else {
        results.forEach((text, index) => {
          setTimeout(() => {
            const div = document.createElement('div');
            div.className = 'lotto-item';
            div.innerHTML = text;
            area.appendChild(div);
            // å¦‚æœä¸­äº†è¶…å¤§çï¼Œè§¸ç™¼æ‰‹æ©Ÿéœ‡å‹• (Vibration API)
            if (window.navigator.vibrate) window.navigator.vibrate([100, 50, 100]);
          }, index * 800); // æ¯å€‹çé …é–“éš” 0.8 ç§’å‡ºç¾
        });
      }
    }

    function closeLottoModal() {
      document.getElementById('lottoModal').style.display = "none";
    }
    async function playLotto() {
      const today = new Date().toDateString();
      const now = Date.now();
      const ONE_WEEK_MS = 7 * 24 * 60 * 60 * 1000; // 7å¤©æœŸé™

      let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 0;
      const playerId = localStorage.getItem('player_id');

      if (!playerId) return alert("è«‹å…ˆç™»å…¥éŠæˆ²ï¼");
      if (localStorage.getItem('lastLottoDate') === today) {
        alert("ä»Šæ—¥å·²åƒèˆ‡éæŠ•æ³¨ï¼Œè«‹æ˜æ—¥å†è©¦ï¼");
        return;
      }

      if (balance < 10000000) {
        alert("é¤˜é¡ä¸è¶³ 1åƒè¬ï¼");
        return;
      }

      if (!confirm("ç¢ºå®šè¦èŠ±è²» 1åƒè¬ åƒåŠ æ¯æ—¥å¤§æ¨‚é€å—ï¼Ÿ")) return;

      balance -= 10000000;
      localStorage.setItem('lastLottoDate', today);
      localStorage.setItem('sicbo_balance', balance);
      updateMainBalance();

      let results = [];
      let updates = { balance: balance, lastLottoDate: today };

      if (Math.random() < 0.05) {
        balance += 100000000;
        updates.balance = balance;
        localStorage.setItem('sicbo_balance', balance);
        results.push("ğŸ’° 1å„„å…ƒå¤§ç");
      }

      if (Math.random() < 0.02) {
        updates[`assets.t_koi`] = now;
        results.push("ğŸ·ï¸ é™å®šç¨±è™Ÿï¼šå¹¸é‹éŒ¦é¯‰");
      }

      if (Math.random() < 0.01) {
        updates[`assets.e_koi`] = now;
        results.push("âœ¨ çµ•ä¸–ç‰¹æ•ˆï¼šéŒ¦é¯‰èºé·");
      }

      try {
        await db.collection("users").doc(playerId).update(updates);

        // æ›´æ–°æœ¬åœ°ç«¯éæœŸæ™‚é–“ç‚º 7 å¤©
        let myAssets = JSON.parse(localStorage.getItem('my_assets') || '{}');
        if (updates[`assets.t_koi`]) myAssets['t_koi'] = now + ONE_WEEK_MS;
        if (updates[`assets.e_koi`]) myAssets['e_koi'] = now + ONE_WEEK_MS;
        localStorage.setItem('my_assets', JSON.stringify(myAssets));

        showLottoAnimation(results);
        updateMainBalance();
        if (results.length > 0) renderShop();
      } catch (error) {
        console.error("æ¨‚é€æ›´æ–°å¤±æ•—:", error);
      }
    }

    function switchShop(tab) {
      currentShopTab = tab;
      document.getElementById('tabTitle').style.background = tab === 'title' ? 'var(--red)' : '#444';
      document.getElementById('tabEffect').style.background = tab === 'effect' ? 'var(--red)' : '#444';
      renderShop();
    }

    function renderShop() {
      const shopList = document.getElementById('shopList');
      const myItems = JSON.parse(localStorage.getItem('my_assets') || '{}');
      const currentEquipped = JSON.parse(localStorage.getItem('equipped_assets') || '{"title":"","effect":""}');
      const now = Date.now();

      let html = '';
      SHOP_DATA[currentShopTab].forEach(item => {
        const expiry = myItems[item.id] || 0;
        const isOwned = now < expiry;
        const isEquipped = (currentShopTab === 'title' ? currentEquipped.title : currentEquipped.effect) === item.id;
        const isLottoOnly = item.lottoOnly === true; // åˆ¤æ–·æ˜¯å¦ç‚ºæ¨‚é€é™å®š

        // åˆ¤æ–·æ˜¯å¦ç‚ºç‰¹æ•ˆåˆ†é ï¼Œå¦‚æœæ˜¯ï¼Œå°±åŠ ä¸Šå°æ‡‰çš„ç‰¹æ•ˆ Class é€²è¡Œé è¦½
        const previewClass = (currentShopTab === 'effect' && item.class) ? item.class : "";
        const previewStyle = (currentShopTab === 'effect') ?
          "padding: 10px; border-radius: 15px; margin-bottom: 5px; text-align: center; font-weight: bold; position: relative; overflow: hidden; contain: paint;" : "";

        // è¨ˆç®—å‰©é¤˜å¤©æ•¸èˆ‡é¡¯ç¤ºæ–‡å­—
        let priceDisplay = '';
        let actionButton = '';

        if (isOwned) {
          // å·²æ“æœ‰ç‹€æ…‹ï¼šåˆ¤æ–·æ˜¯å¦ç‚ºæ°¸ä¹…ï¼ˆè¨­å®šè¶…é 10000 å¤©å³è¦–ç‚ºæ°¸ä¹…ï¼‰
          const daysLeft = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
          priceDisplay = daysLeft > 10000 ? 'âŒ› æ°¸ä¹…æ“æœ‰' : `â³ å‰©é¤˜: ${daysLeft} å¤©`;
          actionButton = `<button class="equip-btn" onclick="equipAsset('${currentShopTab}', '${item.id}')">${isEquipped ? 'âœ… ä½¿ç”¨ä¸­' : 'è£å‚™'}</button>`;
        } else if (isLottoOnly) {
          // æœªæ“æœ‰ä¸”æ˜¯æ¨‚é€é™å®š
          priceDisplay = `<span style="color:var(--gold); font-weight:bold;">ğŸ° å¤§æ¨‚é€é™å®š</span>`;
          actionButton = `<button class="buy-btn" style="background:#555; cursor:not-allowed; opacity:0.7;" disabled>éè³£å“</button>`;
        } else {
          // ä¸€èˆ¬è³¼è²·å•†å“
          priceDisplay = `åƒ¹æ ¼: ğŸ’ ${item.price.toLocaleString()}`;
          actionButton = `<button class="buy-btn" onclick="buyAsset('${currentShopTab}', '${item.id}', ${item.price})">ğŸ›’ è³¼è²·</button>`;
        }

        html += `
        <div style="border:1px solid #444; padding:12px; margin-bottom:12px; border-radius:15px; background:rgba(0,0,0,0.5); transition: 0.3s;">
          <div class="${previewClass}" style="${previewStyle}">
            <div style="color:var(--gold); font-weight:bold; font-size: 16px;">${item.name}</div>
            ${currentShopTab === 'effect' ? '<div style="font-size:10px; opacity:0.8;"></div>' : ''}
          </div>
          
          <div style="display:flex; justify-content:space-between; align-items:center; mt-2">
            <div style="text-align:left;">
              <div style="color:#aaa; font-size:11px; margin-top:5px;">
                ${priceDisplay}
              </div>
            </div>
            <div>
              ${actionButton}
            </div>
          </div>
        </div>
      `;
      });
      shopList.innerHTML = html;
    }

    // è³¼è²·èˆ‡è£å‚™é‚è¼¯
    async function buyAsset(type, id, price) {
      let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 0;
      if (balance < price) return alert("éŒ¢ä¸å¤ ï¼ä¸å€ŸéŒ¢å–”ï¼");
      if (!confirm("ç¢ºå®šè³¼è²· 7 å¤©ä½¿ç”¨æ¬Šå—ï¼Ÿ")) return;

      balance -= price;
      const expiry = Date.now() + (7 * 24 * 60 * 60 * 1000);

      // æ›´æ–°æœ¬åœ°
      let myAssets = JSON.parse(localStorage.getItem('my_assets') || '{}');
      myAssets[id] = expiry;
      localStorage.setItem('my_assets', JSON.stringify(myAssets));
      localStorage.setItem('sicbo_balance', balance);

      // åŒæ­¥ Firebase
      const playerId = localStorage.getItem('player_id');
      if (playerId) {
        await db.collection("users").doc(playerId).update({
          balance: balance,
          assets: myAssets
        });
      }

      updateMainBalance();
      renderShop();
      alert("è³¼è²·æˆåŠŸï¼");
    }

    async function equipAsset(type, id) {
      let equipped = JSON.parse(localStorage.getItem('equipped_assets') || '{"title":"","effect":""}');
      equipped[type] = id;
      localStorage.setItem('equipped_assets', JSON.stringify(equipped));

      // åŒæ­¥åˆ°æ’è¡Œæ¦œèˆ‡é¡¯ç¤º
      const playerId = localStorage.getItem('player_id');
      if (playerId) {
        // é€™è£¡æˆ‘å€‘æŠŠç¨±è™Ÿèˆ‡ç‰¹æ•ˆçš„ class å­˜å…¥ Firebase
        const titleObj = SHOP_DATA.title.find(t => t.id === equipped.title);
        const effectObj = SHOP_DATA.effect.find(e => e.id === equipped.effect);

        const updateData = {
          equipped_title: titleObj ? titleObj.name : "",
          equipped_fx: effectObj ? effectObj.class : ""
        };

        await db.collection("users").doc(playerId).update(updateData);
      }

      renderShop();
      loadRanking();
      alert("è£å‚™æˆåŠŸï¼");
      checkUserStatus();
    }
    // æ’è¡Œæ¦œé¡¯ç¤ºåˆ‡æ›
    async function toggleRank() {
      const sidebar = document.getElementById('rankSidebar');
      const overlay = document.getElementById('rankOverlay');

      if (sidebar.classList.contains('active')) {
        sidebar.classList.remove('active');
        overlay.style.display = 'none';
      } else {
        sidebar.classList.add('active');
        overlay.style.display = 'block';
        loadRanking(); // é–‹å•Ÿæ™‚æŠ“å–æœ€æ–°æ’å
      }
    }

    // å¾ Firebase æŠ“å–å‰ 10 å
    async function loadRanking() {
      const rankList = document.getElementById('rankList');
      try {
        const snapshot = await db.collection("users").orderBy("balance", "desc").limit(10).get();
        let html = '';
        let i = 1;

        // ä¿®æ”¹ loadRanking å…§éƒ¨çš„ HTML ç”Ÿæˆéƒ¨åˆ†
        snapshot.forEach(doc => {
          const data = doc.data();
          const fxClass = data.equipped_fx || "";
          const titleText = data.equipped_title || "";

          let titleColorClass = "t-blue"; // é è¨­è—è‰²
          if (titleText.includes("å¹¸é‹éŒ¦é¯‰")) titleColorClass = "t-koi-color"; // æ–°å¢éŒ¦é¯‰è‰²
          else if (titleText.includes("è³­ç¥") || titleText.includes("å¯Œå¯æ•µåœ‹")) titleColorClass = "t-red";
          else if (titleText.includes("æ¢Ÿé›„") || titleText.includes("å‚³å¥‡")) titleColorClass = "t-orange";
          else if (titleText.includes("åœŸè±ª") || titleText.includes("åƒé‡‘") || titleText.includes("å°‘çˆº")) titleColorClass = "t-purple";

          const titleHTML = titleText ? `<span class="player-title ${titleColorClass}">ã€${titleText}ã€‘</span>` : "";

          html += `
            <div class="rank-item ${fxClass}">
              <div class="rank-info">
                <span class="rank-num">${i === 1 ? 'ğŸ†' : i}</span>
                <span class="rank-name">${titleHTML}${data.name || 'ç„¡åæ°'}</span>
              </div>
              <span class="rank-bal">ğŸ’${Math.floor(data.balance).toLocaleString()}</span>
            </div>
          `;
          i++;
        });
        rankList.innerHTML = html || '<p style="text-align:center; color:#888;">å°šç„¡æ’åæ•¸æ“š</p>';
      } catch (e) {
        rankList.innerHTML = '<p style="text-align:center; color:red;">è¼‰å…¥å¤±æ•—</p>';
      }
    }

    async function checkUserStatus() {
      let playerId = localStorage.getItem('player_id');

      if (!playerId || playerId === "null") {
        document.getElementById('nameModal').style.display = 'flex';
        updateMainBalance();
        return;
      }

      try {
        const doc = await db.collection("users").doc(playerId).get();
        if (doc.exists) {
          const cloudData = doc.data();
          const localBal = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
          const cloudBal = cloudData.balance;

          localStorage.setItem('player_name', cloudData.name);

          if (cloudBal !== undefined && cloudBal > localBal) {
            localStorage.setItem('sicbo_balance', cloudBal);
          }
          else if (cloudBal !== undefined && localBal > cloudBal) {
            await db.collection("users").doc(playerId).update({ balance: localBal });
          }

          // --- å•†åŸç‰¹æ•ˆèˆ‡ç¨±è™Ÿé¡¯ç¤ºé‚è¼¯ ---
          // --- å•†åŸç‰¹æ•ˆèˆ‡ç¨±è™Ÿé¡¯ç¤ºé‚è¼¯ (æ‹†åˆ†ç‰ˆé¡¯ç¤º) ---
          const welcomeEl = document.getElementById('welcomeUser');
          const fxClass = cloudData.equipped_fx || "";
          const titleText = cloudData.equipped_title || "";
          const userName = cloudData.name || "ç„¡åæ°";

          welcomeEl.innerHTML = ""; // å…ˆæ¸…ç©º

          if (titleText) {
            const titleSpan = document.createElement('span');
            titleSpan.textContent = `ã€${titleText}ã€‘`;
            titleSpan.className = "player-title";

            // æ ¹æ“šæ–‡å­—å…§å®¹è‡ªå‹•ä¸Šè‰² (ä½ å¯ä»¥ä¾éœ€æ±‚å¢åŠ æ›´å¤šåˆ¤æ–·)
            if (titleText.includes("è³­ç¥") || titleText.includes("å¯Œå¯æ•µåœ‹")) titleSpan.classList.add("t-red");
            else if (titleText.includes("æ¢Ÿé›„") || titleText.includes("å‚³å¥‡")) titleSpan.classList.add("t-orange");
            else if (titleText.includes("åœŸè±ª") || titleText.includes("åƒé‡‘") || titleText.includes("å°‘çˆº")) titleSpan.classList.add("t-purple");
            else titleSpan.classList.add("t-blue");

            welcomeEl.appendChild(titleSpan);
          }

          const nameSpan = document.createElement('span');
          nameSpan.textContent = userName;
          welcomeEl.appendChild(nameSpan);

          // å¾ŒçºŒ Class è™•ç†ç¶­æŒåŸæ¨£
          welcomeEl.className = "welcome-msg";
          if (fxClass) {
            welcomeEl.classList.add(fxClass);
            welcomeEl.style.display = "inline-block";
            welcomeEl.style.padding = "8px 25px";
            welcomeEl.style.borderRadius = "25px";
            welcomeEl.style.position = "relative";
            welcomeEl.style.contain = "paint";
            welcomeEl.style.zIndex = "1";
            welcomeEl.style.color = "#fff";
          }

          updateMainBalance();
        } else {
          document.getElementById('nameModal').style.display = 'flex';
        }
      } catch (e) {
        console.error("Firebase é€£ç·šå¤±æ•—", e);
        const localName = localStorage.getItem('player_name');
        if (localName) {
          document.getElementById('welcomeUser').textContent = `æ­¡è¿å›ä¾†(é›¢ç·š)ï¼Œ${localName}`;
        } else {
          document.getElementById('nameModal').style.display = 'flex';
        }
        updateMainBalance();
      }
    }
    // --- å•†åŸåŠŸèƒ½ ---
    function openShop() { document.getElementById('shopModal').style.display = 'flex'; }
    function closeShop() { document.getElementById('shopModal').style.display = 'none'; }

    async function buyTitle(titleName, price) {
      let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 0;
      if (balance < price) return alert("éŒ¢ä¸å¤ å•¦");
      if (!confirm(`ç¢ºå®šè¦èŠ±è²» ğŸ’ ${price.toLocaleString()} è³¼è²·ã€Œ${titleName}ã€å—ï¼Ÿ`)) return;

      balance -= price;
      localStorage.setItem('sicbo_balance', balance);

      const playerId = localStorage.getItem('player_id');
      if (playerId) {
        try {
          // é—œéµä¿®æ”¹ï¼šåªæ›´æ–° equipped_titleï¼Œä¸æ”¹å‹• name æ¬„ä½
          await db.collection("users").doc(playerId).update({
            balance: balance,
            equipped_title: titleName
          });
          alert("è³¼è²·æˆåŠŸï¼ç¨±è™Ÿå·²æ›´æ–°ã€‚");
        } catch (e) {
          console.error("å•†åŸæ›´æ–°å¤±æ•—", e);
        }
      }
      updateMainBalance();
      closeShop();
      checkUserStatus(); // ç«‹å³é‡æ–°æ•´ç†é¡¯ç¤º
      loadRanking();
    }
    // --- é—œéµä¿®å¾©ï¼šå„²å­˜æš±ç¨± ---
    async function saveNewPlayer() {
      const nameInput = document.getElementById('nicknameInput');
      const name = nameInput.value.trim();
      if (!name) return alert("è«‹è¼¸å…¥åå­—ï¼");

      // 1. å¼·åˆ¶é‡æ–°ç²å–ä¸€æ¬¡ IDï¼Œå¦‚æœæ²’æœ‰å°±åœ°ç”Ÿæˆ
      let playerId = localStorage.getItem('player_id');
      if (!playerId || playerId === "" || playerId === "null") {
        playerId = 'u' + Date.now() + Math.floor(Math.random() * 1000);
        localStorage.setItem('player_id', playerId);
      }

      const localBal = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;

      try {
        // 2. å…ˆå­˜æœ¬åœ°ï¼Œç¢ºä¿ UI èƒ½å…ˆå‹•
        localStorage.setItem('player_name', name);
        localStorage.setItem('sicbo_balance', localBal);

        // 3. åŸ·è¡Œ Firebase å¯«å…¥ (æ­¤æ™‚ playerId çµ•å°æœ‰å€¼)
        await db.collection("users").doc(playerId).set({
          name: name,
          balance: localBal,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        document.getElementById('nameModal').style.display = 'none';
        document.getElementById('welcomeUser').textContent = `æ­¡è¿ï¼Œ${name}`;
        updateMainBalance();
      } catch (e) {
        console.error("å„²å­˜å¤±æ•—:", e);
        // è¬ä¸€ Firebase çœŸçš„é‚„æ˜¯å¤±æ•—ï¼Œè‡³å°‘è¦è®“ç©å®¶é—œæ‰è¦–çª—é€²å…¥éŠæˆ²
        document.getElementById('nameModal').style.display = 'none';
        document.getElementById('welcomeUser').textContent = `æ­¡è¿(æœ¬åœ°)ï¼Œ${name}`;
        updateMainBalance();
      }
    }

    window.onload = function () {
      updateMainBalance();
      checkUserStatus();
    };

    document.addEventListener('click', function (e) {
      let target = e.target.closest('a');
      if (target && target.href && target.getAttribute('href') !== '#') {
        e.preventDefault();
        window.location.href = target.href;
      }
    }, false);

    window.addEventListener('storage', (e) => {
      if (e.key === 'sicbo_balance') updateMainBalance();
    });
  </script>
</body>

</html>