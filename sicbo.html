<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>

<title>éª°å¯¶</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="é˜¿è¨˜å¨›æ¨‚åŸ">
<meta name="mobile-web-app-capable" content="yes">

<style>
  :root { --table-green: #0a5c32; --gold: #ffd86b; --red: #ff4757; --green: #2ecc71; }
  * { 
    box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent; 
    margin: 0; padding: 0; 
    touch-action: manipulation;
  }
  body { height: 100dvh; width: 100vw; font-family: "Microsoft JhengHei", Arial; background: #05140b; color: #fff; display: flex; flex-direction: column; overflow: hidden; }
  
  .topbar { 
    height: 50px; 
    background: linear-gradient(#4a0404, #2a0202); 
    display: flex; 
    align-items: center; 
    padding-left: calc(15px + env(safe-area-inset-left)); 
    padding-right: calc(15px + env(safe-area-inset-right)); 
    gap: 15px; 
    border-bottom: 2px solid #5c0a0a; 
    flex-shrink: 0; 
  }
  .sound-toggle {
    background: rgba(255,255,255,0.1);
    padding: 4px 10px;
    border-radius: 8px;
    border: 1px solid var(--gold);
    cursor: pointer;
    font-size: 14px;
    white-space: nowrap;
  }
  @media (orientation: portrait) {
    .portrait-tip {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh;
      background: #1a0505; z-index: 999; display: flex; flex-direction: column;
      justify-content: center; align-items: center; text-align: center; color: #fff;
    }
  }
  @media (orientation: landscape) { .portrait-tip { display: none; } }
  .balance-box { background: rgba(0,0,0,0.5); border: 1px solid var(--gold); border-radius: 15px; padding: 4px 15px; color: var(--gold); font-weight: bold; }
  
  #centerDisplay { position: fixed; top: 45%; left: 50%; transform: translate(-50%, -50%) scale(0); background: rgba(0, 0, 0, 0.95); border: 4px solid var(--gold); border-radius: 20px; padding: 40px; z-index: 3000; text-align: center; display: none; box-shadow: 0 0 50px #000; transition: transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
  #centerDisplay.show { display: block; transform: translate(-50%, -50%) scale(1.1); }
  .big-dice { font-size: 80px; letter-spacing: 10px; margin-bottom: 10px; text-shadow: 0 0 20px #fff; }
  .big-result { font-size: 42px; font-weight: 900; color: var(--gold); }
  
  #winAmountEffect { position: fixed; top: 65%; left: 50%; transform: translate(-50%, -50%); font-size: 80px; font-weight: 900; color: #fff000; text-shadow: 0 0 20px #ffae00, 0 0 40px #ffae00, 2px 2px 10px #000; z-index: 5000; display: none; pointer-events: none; animation: floatUp 1.8s ease-out forwards; }
  .triple-win-scale { transform: translate(-50%, -50%) scale(1.5) !important; color: #ff4757 !important; }
  @keyframes floatUp { 0% { opacity: 0; transform: translate(-50%, 20%); } 30% { opacity: 1; transform: translate(-50%, -55%); } 70% { opacity: 1; transform: translate(-50%, -60%); } 100% { opacity: 0; transform: translate(-50%, -100%); } }

  .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 4000; display: none; align-items: center; justify-content: center; }
  
  /* å´é‚Šæ¬„å„ªåŒ– */
  .main-layout { display: flex; flex: 1; padding: 5px; padding-left: calc(5px + env(safe-area-inset-left)); padding-right: calc(5px + env(safe-area-inset-right)); gap: 5px; overflow: hidden; }
  .history-sidebar { width: 140px; background: rgba(0,0,0,0.4); border-radius: 8px; display: flex; flex-direction: column; padding: 5px; overflow: hidden; }
  #historyList { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
  .hist-item { display: flex; align-items: center; justify-content: space-between; padding: 6px 2px; font-size: 11px; border-bottom: 1px solid rgba(255,255,255,0.05); flex-shrink: 0; }
  
  .miss-box { margin-top: 5px; background: #000; border: 1px solid #444; border-radius: 5px; padding: 5px; text-align: center; flex-shrink: 0; }
  .miss-box div:first-child { font-size: 10px; color: #aaa; }
  .miss-box #missCountText { font-size: 18px; font-weight: bold; color: #ff4757; }

  /* åœéª°å¾—ä¸»æŒ‰éˆ•æ¨£å¼ */
  .triple-winner-btn {
    margin-top: 5px;
    background: linear-gradient(to bottom, #ff4757, #b91c1c);
    border: 1px solid var(--gold);
    border-radius: 5px;
    padding: 4px;
    cursor: pointer;
    text-align: center;
    flex-shrink: 0;
    min-height: 45px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .triple-winner-btn span { font-size: 9px; color: #fff; display: block; }
  #latestWinnerInfo { font-size: 11px; color: var(--gold); font-weight: bold; }

  /* è‹±é›„æ¦œå½ˆçª—ç´€éŒ„ */
  .rank-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; font-size: 14px; }
  .rank-name { color: var(--gold); }
  .rank-amt { color: var(--green); font-weight: bold; }

  .full-hist-btn { background: var(--gold); border: none; color: #000; font-weight: bold; font-size: 12px; padding: 8px; border-radius: 5px; margin-top: 5px; cursor: pointer; }

  #fullHistoryOverlay, #tripleRankOverlay { background: rgba(0,0,0,0.95); flex-direction: column; padding: 20px; }
  #fullHistoryList, #tripleRankList { width: 100%; max-width: 400px; max-height: 70vh; overflow-y: auto; background: #222; border-radius: 10px; }

  .sum-big { color: var(--gold); } 
  .sum-small { color: #5cc9ff; } 
  .sum-triple { background: var(--red); color: #fff; border-radius: 3px; padding: 0 2px; }
  .table-container { flex: 1; display: flex; flex-direction: column; position: relative; }
  .betting-table { flex: 1; background: var(--table-green); border: 3px solid #084325; border-radius: 15px; display: grid; grid-template-rows: repeat(4, 1fr); gap: 1px; padding: 2px; }
  .bet-row { display: flex; gap: 1px; }
  .bet-cell { flex: 1; border: 1px solid rgba(255,215,0,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; cursor: pointer; font-weight: bold; }
  .odds-label { font-size: 9px; color: rgba(255,255,255,0.6); font-weight: normal; }
  .chip-on-cell { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 32px; height: 32px; border-radius: 50%; background: radial-gradient(circle, #ff4757, #b91c1c); border: 2px dashed #fff; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; z-index: 10; }
  .timer-box { position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: rgba(128,0,128,0.7); border: 3px solid var(--gold); display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: bold; color: var(--gold); }

  .footer-bar { height: 125px; background: linear-gradient(#333, #111); border-top: 2px solid #555; display: flex; align-items: center; padding: 0 10px; flex-shrink: 0; }
  .info-area { width: 80px; text-align: center; flex-shrink: 0; }
  .info-area div:first-child { font-size: 11px; color: var(--gold); }
  .info-area #totalBetText { font-size: 20px; font-weight: bold; }
  .chip-area { display: flex; gap: 10px; flex: 1; justify-content: center; align-items: center; }
  .chip-btn { width: 56px; height: 56px; border-radius: 50%; border: 3px solid #fff; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 18px; transition: transform 0.1s; }
  .chip-btn.active { transform: translateY(-10px); border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }
  .btn-area-row { display: flex; gap: 6px; height: 85px; flex-shrink: 0; width: 380px; }
  .btn-ui { flex: 1; height: 100%; border-radius: 10px; font-weight: 900; border: none; background: #eee; font-size: 17px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #000; }
  .btn-auto-active { background: var(--gold) !important; box-shadow: 0 0 12px var(--gold); }
  .rank-list {
      width: 70%;
      max-height: 60%;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid #333;
    }

    .rank-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #222;
      font-size: 14px;
    }

    .rank-name {
      color: var(--gold);
    }

    .rank-win {
      color: #2ecc71;
      font-weight: bold;
    }

    .t-green {
      color: #2ecc71 !important;
    }

    .t-blue {
      color: #3498db !important;
    }

    .t-purple {
      color: #9b59b6 !important;
    }

    .t-orange {
      color: #e67e22 !important;
    }

    .t-red {
      color: #ff4757 !important;
      animation: title-glow 1s infinite alternate;
    }

    @keyframes title-glow {
      from {
        filter: drop-shadow(0 0 1px #ff4757);
      }

      to {
        filter: drop-shadow(0 0 5px #ff4757);
      }
    }
/* è‡³å°Šå‚³å¥‡ï¼šç§»é™¤é†œé™‹æ—‹è½‰ï¼Œæ”¹ç‚ºé­‚ç«å™´ç™¼ */
.fx-ultimate-legend {
    position: relative;
    /* 1. èƒŒæ™¯æ”¹ç‚ºæµå…‰æ¼¸å±¤ï¼Œå–ä»£ç´”é»‘ */
    background: linear-gradient(90deg, 
        #000 0%, 
        #FFD700 20%, 
        #FFFFFF 40%, 
        #FF4500 60%, 
        #9400D3 80%, 
        #000 100%
    ) !important;
    background-size: 300% 100% !important;
    
    z-index: 1;
    border: 1px solid #FFD700;
    /* é€™è£¡å¿…é ˆæ˜¯ visibleï¼Œå¦å‰‡æµå‹•é™°å½±æœƒè¢«åˆ‡æ‰ */
    overflow: visible !important;
    width: 100% !important;
    box-sizing: border-box !important;

    /* éœ‡å‹•æ•ˆæœ + èƒŒæ™¯æµå‹•å‹•ç•« */
    animation: ult-bg-flow 4s linear infinite, ult-vibrate 0.15s infinite;
}

/* æ”¹é€ å¾Œçš„é™°å½±å±¤ï¼šå¤šè‰²å‘¼å¸ç™¼å…‰ */
.fx-ultimate-legend::after {
    content: '';
    position: absolute;
    inset: -2px;
    border-radius: 52px;
    z-index: -1;
    filter: blur(12px); /* ç¨å¾®åŠ æ·±æ¨¡ç³Šï¼Œæ›´æœ‰èƒ½é‡å ´çš„æ„Ÿè¦º */
    opacity: 0.7;
    /* åŸ·è¡Œå¤šè‰²é™°å½±è®Šæ›å‹•ç•« */
    animation: ult-shadow-glow 3s ease-in-out infinite alternate;
}

/* æ–‡å­—å±¤ç¶­æŒä½ åŸæœ¬çš„æµå…‰è³ªæ„Ÿ */
.fx-ultimate-legend span {
    position: relative;
    z-index: 20 !important;
    background: linear-gradient(to right, #fff 20%, #ffd700 40%, #ff4500 60%, #fff 80%);
    background-size: 200% auto;
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: ult-text-flow 2s linear infinite;
    font-weight: 900;
    filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
}

/* --- æ–°å¢/ä¿®æ”¹å‹•ç•«å®šç¾© --- */

/* èƒŒæ™¯æµå‹•ï¼šè®“é»‘æ¡†è£¡çš„é¡è‰²å‹•èµ·ä¾† */
@keyframes ult-bg-flow {
    0% { background-position: 0% 50%; }
    100% { background-position: 300% 50%; }
}

/* å¤šè‰²é™°å½±è®Šæ›ï¼šè£œå„ŸåŸæœ¬ JS ç²’å­çš„é¡è‰²å‹•æ…‹ */
@keyframes ult-shadow-glow {
    0% {
        background: #0f12dd;
        box-shadow: 0 0 15px #0f12dd, 0 0 30px rgba(255, 215, 0, 0.4);
    }
    50% {
        background: #9400D3;
        box-shadow: 0 0 20px #9400D3, 0 0 40px rgba(148, 0, 211, 0.4);
    }
    100% {
        background: #FF4500;
        box-shadow: 0 0 15px #FF4500, 0 0 30px rgba(255, 69, 0, 0.4);
    }
}

/* åŸæœ¬çš„å‹•ç•«ä¿ç•™ */
@keyframes ult-text-flow {
    0% { background-position: 0% center; }
    100% { background-position: 200% center; }
}

@keyframes ult-vibrate {
    0% { transform: translate(0,0); }
    50% { transform: translate(0.5px, -0.5px); }
    100% { transform: translate(0,0); }
}
/* --- ç‰¹æ•ˆ 12ï¼šæš—å½±é›·é›»ç‰¹æ•ˆ (fx-lightning) --- */
    .fx-lightning {
      background: #000 !important;
      color: #fff !important;
      box-shadow: 0 0 10px #00d2ff, 0 0 20px #3a7bd5 inset !important;
      animation: lightning-flash 2s infinite !important;
    }

    @keyframes lightning-flash {

      0%,
      90%,
      100% {
        opacity: 1;
      }

      92% {
        filter: brightness(3);
        transform: scale(1.02);
      }

      94% {
        filter: brightness(1);
      }

      96% {
        filter: brightness(2.5);
      }
    }

    /* --- æ–°ç‰¹æ•ˆå‹•ç•«å®šç¾© --- */
    @keyframes ice-shimmer {
      from {
        filter: saturate(1) brightness(1);
        box-shadow: 0 0 5px #00f2fe;
      }

      to {
        filter: saturate(1.5) brightness(1.2);
        box-shadow: 0 0 20px #00f2fe;
      }
    }

    @keyframes lightning-strike {

      0%,
      95%,
      98% {
        opacity: 0;
      }

      96%,
      99% {
        opacity: 0.4;
      }

      /* æ¨¡æ“¬é›·é›¨é–ƒé›»ç¬é–“é–ƒçˆ */
    }

    @keyframes void-pulse {

      0%,
      100% {
        transform: scale(1);
        filter: blur(0px);
      }

      50% {
        transform: scale(0.98);
        filter: blur(0.5px);
      }
    }

    @keyframes rotate-slow {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }
.fx-hacker {
      position: relative !important;
      background: #000 !important;
      border: 2px solid #0f0 !important;
      color: #0f0 !important;
      font-family: 'Courier New', monospace;
      overflow: hidden !important;
      box-shadow: 0 0 15px #0f0, inset 0 0 30px rgba(0, 255, 0, 0.4) !important;
      z-index: 1;
    }

    /* 1. èƒŒæ™¯æ¢ç´‹ */
    .fx-hacker::before {
      content: "";
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(0deg,
          transparent,
          transparent 2px,
          rgba(0, 255, 0, 0.1) 2px,
          rgba(0, 255, 0, 0.1) 4px);
      z-index: -1;
    }

    /* 2. äº‚ç¢¼ç€‘å¸ƒæµ - åŠ é•·å…§å®¹ç¢ºä¿å¾ªç’°ä¸æ–· */
    .fx-hacker::after {
      content: "10110010101010010101101010101001010101010101010010110101001010110101010010101101010010101010101010010010110100101010100101010101010100101101010010101101010100101011010100101010101010101001\A 0101010101010101010101010010101010101010110101010010101010100101010101010010101010010110101001010101\A 1101010100101011010100101010101010100101101010010101010010101101010101001001010110101010101001\A 1011001010101001010110101010100101010101010101001011010100101011010101001010110101001010101010101001001011010010101010010101010101010010110101001010110101010010101101010010101010101010101001";
      position: absolute;
      top: -100%;
      left: 0;
      width: 100%;
      height: 300%;
      /* å¢åŠ é«˜åº¦ */
      font-size: 12px;
      line-height: 12px;
      word-break: break-all;
      white-space: pre-wrap;
      color: rgba(0, 255, 0, 0.3);
      animation: matrix-scroll 4s linear infinite;
      z-index: -1;
    }

    @keyframes matrix-scroll {
      0% {
        transform: translateY(0);
      }

      100% {
        transform: translateY(50%);
      }

      /* æ§åˆ¶ç§»å‹•ç¯„åœ */
    }

    @keyframes matrix-bg-scroll {
      0% {
        transform: translateY(0);
      }

      100% {
        transform: translateY(-20px);
      }
    }

    @keyframes scanline-pass {
      0% {
        top: -20%;
      }

      100% {
        top: 120%;
      }
    }

    /* --- ç‰¹æ•ˆ 8ï¼šæ˜Ÿé›²éœ¸ä¸» (éŠ€æ²³ç¹æ˜Ÿç‰ˆ) --- */
    .fx-nebula {
      position: relative !important;
      background: transparent !important;
      border: 2px solid transparent !important;
      color: #fff !important;
      overflow: hidden !important;
      box-shadow: 0 0 20px #7b2cbf, 0 0 40px #e0aaff !important;
      text-shadow: 0 0 5px #fff, 0 0 10px #ff00de !important;
      z-index: 1;
    }

    /* é‚Šæ¡†å±¤ */
    .fx-nebula::before {
      content: "";
      position: absolute;
      inset: -3px;
      background: conic-gradient(from 0deg, #ff00de, #7b2cbf, #4cc9f0, #ff00de);
      z-index: -2;
      animation: spin-super-fast 3s linear infinite;
      border-radius: 12px;
    }

    /* èƒŒæ™¯å±¤ï¼šæ¥µè‡´å¯†åº¦çš„æ˜Ÿç©º */
    .fx-nebula::after {
      content: "";
      position: absolute;
      inset: 3px;
      background:
        /* Bright Stars (Big) */
        radial-gradient(2px 2px at 15% 15%, #fff, transparent),
        radial-gradient(2px 2px at 50% 20%, #fff, transparent),
        radial-gradient(2px 2px at 85% 15%, #fff, transparent),
        radial-gradient(2px 2px at 10% 80%, #fff, transparent),
        radial-gradient(2px 2px at 90% 85%, #fff, transparent),

        /* Medium Stars */
        radial-gradient(1.5px 1.5px at 30% 40%, rgba(255, 255, 255, 0.8), transparent),
        radial-gradient(1.5px 1.5px at 70% 60%, rgba(255, 255, 255, 0.8), transparent),
        radial-gradient(1.5px 1.5px at 20% 60%, rgba(255, 255, 255, 0.8), transparent),
        radial-gradient(1.5px 1.5px at 80% 30%, rgba(255, 255, 255, 0.8), transparent),

        /* Tiny Stars Cluster */
        radial-gradient(1px 1px at 5% 5%, rgba(255, 255, 255, 0.5), transparent),
        radial-gradient(1px 1px at 25% 25%, rgba(255, 255, 255, 0.5), transparent),
        radial-gradient(1px 1px at 45% 45%, rgba(255, 255, 255, 0.5), transparent),
        radial-gradient(1px 1px at 65% 65%, rgba(255, 255, 255, 0.5), transparent),
        radial-gradient(1px 1px at 85% 85%, rgba(255, 255, 255, 0.5), transparent),
        radial-gradient(1px 1px at 15% 75%, rgba(255, 255, 255, 0.5), transparent),
        radial-gradient(1px 1px at 35% 95%, rgba(255, 255, 255, 0.5), transparent),
        radial-gradient(1px 1px at 55% 15%, rgba(255, 255, 255, 0.5), transparent),
        radial-gradient(1px 1px at 75% 35%, rgba(255, 255, 255, 0.5), transparent),
        radial-gradient(1px 1px at 95% 55%, rgba(255, 255, 255, 0.5), transparent),
        radial-gradient(1px 1px at 2% 40%, rgba(255, 255, 255, 0.5), transparent),
        radial-gradient(1px 1px at 98% 60%, rgba(255, 255, 255, 0.5), transparent),

        /* Deep Background */
        linear-gradient(135deg, #12002f 0%, #30005a 100%);
      background-size: 200% 200%;
      z-index: -1;
      border-radius: 10px;
      animation: nebula-bg-shift 6s ease infinite alternate;
    }

    @keyframes nebula-bg-shift {
      0% {
        background-position: 0% 50%;
      }

      100% {
        background-position: 100% 50%;
      }
    }

    /* --- ç‰¹æ•ˆ 9ï¼šæ™‚å…‰é ˜ä¸» (é½’è¼ªå›æ­¸ç‰ˆ) --- */
    .fx-timelord {
      position: relative !important;
      background-color: #111 !important;
      /* å°‡ç¶²æ ¼èƒŒæ™¯ç§»åˆ°ä¸»å…ƒç´ ï¼Œè®“å‡º ::before çµ¦é½’è¼ª */
      background-image:
        linear-gradient(#444 1px, transparent 1px),
        linear-gradient(90deg, #444 1px, transparent 1px);
      background-size: 30px 30px;
      color: #ffd700 !important;
      border: 2px solid #ffd700 !important;
      overflow: hidden !important;
      box-shadow: inset 0 0 20px #000, 0 0 15px #ffd700 !important;
      z-index: 1;
      animation: bg-grid-scroll 4s linear infinite !important;
    }

    /* 1. å·¨å¤§é‡‘å±¬é½’è¼ª (å›æ­¸) */
    .fx-timelord::before {
      content: "âš™ï¸";
      position: absolute;
      right: -25px;
      bottom: -25px;
      font-size: 90px;
      opacity: 0.15;
      z-index: 0;
      animation: rotate-slow 10s linear infinite;
      filter: grayscale(1) brightness(1.5);
    }

    /* 2. é»ƒé‡‘æŒ‡é‡æƒé (Overlay æ¨¡å¼) */
    .fx-timelord::after {
      content: "";
      position: absolute;
      top: -100%;
      left: -50%;
      width: 200%;
      height: 300%;
      /* ä½¿ç”¨ hard-light æ··åˆæ¨¡å¼ */
      background: conic-gradient(from 0deg, transparent 0deg, rgba(255, 230, 0, 0.4) 15deg, rgba(255, 255, 255, 0.9) 20deg, transparent 25deg, transparent 40deg);
      animation: radar-sweep 3s linear infinite;
      z-index: 2;
      /* æ”¾åœ¨æœ€ä¸Šå±¤ */
      pointer-events: none;
      /* è®“é»æ“Šç©¿é€ */
      mix-blend-mode: hard-light;
      /* è®“å…‰æ•ˆç–ŠåŠ åœ¨æ–‡å­—ä¸Š */
    }

    @keyframes bg-grid-scroll {
      0% {
        background-position: 0 0;
      }

      100% {
        background-position: 0 30px;
      }
    }

    @keyframes grid-move {
      0% {}

      100% {
        transform: translateY(30px);
      }
    }

    @keyframes radar-sweep {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }


    /* --- ç‰¹æ•ˆ 10ï¼šçœ¾ç¥ä¹‹ç‹ (MAXIMALISM VERSION) --- */
    .fx-god-king {
      position: relative !important;
      /* Radiant sunburst gradient */
      background: radial-gradient(circle at center, #ffecb3 0%, #ffd700 40%, #a07e00 100%) !important;
      border: 2px solid #fff !important;
      color: #5c0a0a !important;
      /* Dark text for contrast */
      font-weight: 900 !important;
      overflow: hidden !important;
      /* Blinding outer glow */
      box-shadow: 0 0 30px #ffd700, 0 0 60px #fff, 0 0 80px #ffea00 !important;
      text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
      /* White outline for text */
      animation: god-pulse 2s ease-in-out infinite !important;
      z-index: 1;
    }

    /* Rotating Rays - Stronger contrast */
    .fx-god-king::before {
      content: "";
      position: absolute;
      top: -100%;
      left: -100%;
      width: 300%;
      height: 300%;
      background: repeating-conic-gradient(from 0deg,
          rgba(255, 255, 255, 0.4) 0deg 5deg,
          transparent 5deg 15deg);
      animation: spin-slow 10s linear infinite;
      z-index: 0;
    }

    /* Falling Gold Dust / Sparkles */
    .fx-god-king::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        radial-gradient(circle, #fff 1px, transparent 1px),
        radial-gradient(circle, #fff 2px, transparent 2px);
      background-size: 15px 15px, 30px 30px;
      animation: god-particles 1s linear infinite;
      z-index: 0;
      opacity: 0.6;
    }

    @keyframes nebula-float {
      0% {
        transform: translateY(0px) scale(1);
      }

      100% {
        transform: translateY(-3px) scale(1.02);
      }
    }

    @keyframes spin-super-fast {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes time-warp {
      0% {
        transform: perspective(300px) rotateX(20deg) translateY(0);
      }

      100% {
        transform: perspective(300px) rotateX(20deg) translateY(-20px);
      }
    }

    @keyframes god-pulse {

      0%,
      100% {
        transform: scale(1);
        box-shadow: 0 0 30px #ffd700;
      }

      50% {
        transform: scale(1.03);
        box-shadow: 0 0 50px #ffd700, 0 0 80px #fff;
      }
    }

    @keyframes god-particles {
      from {
        background-position: 0 0, 0 0;
      }

      to {
        background-position: 0 15px, 0 30px;
      }
    }
    /* --- 2. æ’è¡Œæ¦œé …ç›®ç‰¹æ•ˆæ ¸å¿ƒ (ç¢ºä¿åœ¨éŠæˆ² Sidebar å…§ç”Ÿæ•ˆ) --- */
    .rank-item {
      position: relative !important;
      overflow: hidden !important;
      contain: paint;
      /* é˜²æ­¢ç‰¹æ•ˆæº¢å‡ºé€ æˆæ‰‹æ©Ÿæ©«å‘æ»¾å‹• */
      z-index: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* [ç‰¹æ•ˆï¼šæ¥µé™ç„ç«] */
    .fx-fire {
      border: 2px solid transparent !important;
      background: linear-gradient(#2a0000, #2a0000) padding-box,
        linear-gradient(0deg, #ff4757, #ff9f43, #ff4757) border-box !important;
      background-size: 100% 100%, 100% 300% !important;
      color: #fff !important;
      box-shadow: inset 0 0 15px #741b1b, 0 0 15px rgba(255, 71, 87, 0.5) !important;
      text-shadow: 0 0 8px #ff4757 !important;
      animation: fire-flicker 0.2s ease-in-out infinite alternate, border-flow 1.5s linear infinite !important;
    }

    .fx-fire::before {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 200%;
      background: linear-gradient(0deg, transparent 0%, rgba(255, 69, 0, 0.4) 20%, transparent 80%);
      z-index: -1;
      animation: fire-rise 1s linear infinite;
    }

    /* [ç‰¹æ•ˆï¼šé›·éœ†éœ“è™¹] */
     .fx-neon {
    border: 2px solid #fff !important;
    /* 1. é—œéµä¿®æ”¹ï¼šå°‡ 0% å’Œ 100% çš„é»‘è‰²æ”¹ç‚ºæ·±è—è‰²ï¼Œhue-rotate æ‰èƒ½æŠ“åˆ°é¡è‰²è®Šè‰² */
    background: linear-gradient(
        135deg, 
        #001a33 0%,   /* å–ä»£é»‘è‰² */
        #004488 25%, 
        #0066aa 50%, 
        #440088 75%, 
        #001a33 100%  /* å–ä»£é»‘è‰² */
    ) !important;
    background-size: 300% 300% !important;
    color: #fff !important;
    
    /* 2. å¢åŠ å¼·çƒˆçš„å…§éƒ¨ç™¼å…‰ï¼Œç›´æ¥æŠŠèƒŒæ™¯ç…§äº® */
    box-shadow: 
        inset 0 0 30px rgba(0, 210, 255, 0.7), 
        0 0 10px #fff, 
        0 0 20px #00d2ff !important;

    /* 3. å‹•ç•«çµ„åˆ */
    animation:
        neon-flicker 2s infinite,
        neon-rainbow 2s linear infinite,
        bg-flow-extreme 1s ease-in-out infinite !important;
    
    /* ç¢ºä¿å…§å®¹åœ¨ç™¼å…‰èƒŒæ™¯ä¸Šä¾ç„¶æ¸…æ™° */
    text-shadow: 0 0 5px #000, 2px 2px 2px #000 !important;
}

/* 4. å¼·åŒ–çš„èƒŒæ™¯ç§»å‹•ï¼šè®“æ¼¸å±¤åœ¨ç›’å­è£¡å¤§å¹…åº¦æ»‘å‹• */
@keyframes bg-flow-extreme {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

    /* [ç‰¹æ•ˆï¼šè‡³å°Šçš‡é‡‘] */
    .fx-gold {
      border: 1px solid #ffd700 !important;
      background-image: linear-gradient(110deg, #6b5500 0%, #ffd700 50%, #6b5500 100%) !important;
      background-size: 200% auto !important;
      animation: shine-gold 3s linear infinite !important;
    }

     /* --- ç‰¹æ•ˆ 4ï¼šçµ•å°é›¶åº¦ (å†°è—å‘¼å¸ + çµæ™¶é–ƒçˆ) --- */
   .fx-ice {
    position: relative;
    overflow: hidden;
    border: 1px solid #00f2fe !important;
    background: linear-gradient(135deg, #005f73, #00d4ff) !important;
    color: #fff !important;
    text-shadow: 0 0 10px #7ed6ff !important;
    box-shadow: 0 0 15px rgba(0, 242, 254, 0.5) !important;
    animation: ice-shimmer 2s ease-in-out infinite alternate !important;
}
/* â„ï¸ é€™è£¡æ˜¯é›ªèŠ±å°ˆå±¬å±¤ */
.fx-ice::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
    
    /* ä½¿ç”¨ä¸‰å±¤éš¨æ©Ÿåˆ†ä½ˆçš„é›ªèŠ±é» */
    background-image: 
        radial-gradient(1.5px 1.5px at 20% 30%, #fff 100%, transparent),
        radial-gradient(2px 2px at 50% 70%, #fff 100%, transparent),
        radial-gradient(1.2px 1.2px at 80% 40%, #fff 100%, transparent);
    
    /* è®“é›ªèŠ±èƒŒæ™¯é‡è¤‡é‹ªæ»¿ï¼Œä¸¦è¨­å®šä¸åŒçš„å¤§å°ä¾†æ‰“ç ´è¦å¾‹ */
    background-size: 100px 100px, 150px 150px, 200px 200px;
    
    /* åŸ·è¡Œä¸‹é›ªå‹•ç•« */
    animation: snow-fall-fixed 10s linear infinite;
}
    .fx-ice::before {
      content: "â„" !important;
      color: #6860fe !important; 
      text-shadow: 0 0 5px rgba(237, 159, 255, 0.8) !important;
      position: absolute;
      right: 5px;
      top: -5px;
      opacity: 1;
      font-size: 20px;
      animation: rotate-slow 5s linear infinite;
    }
    @keyframes snow-fall-fixed {
    0% {
        background-position: 0 0, 0 0, 0 0;
    }
    100% {
        /* è®“ä¸‰å±¤é›ªèŠ±ä»¥ä¸åŒé€Ÿåº¦å’Œæ–¹å‘é£„è½ï¼Œè¦–è¦ºä¸Šå¾ˆéš¨æ©Ÿ */
        background-position: 100px 100px, -150px 300px, 200px 600px;
    }
}

    /* [ç‰¹æ•ˆï¼šé»‘æ´æ¹®æ»…] */
    .fx-void {
      border: 2px solid #2f3542 !important;
      background: black !important;
      color: #a55eea !important;
      box-shadow: 0 0 20px #6c5ce7 !important;
      animation: void-pulse 3s ease-in-out infinite !important;
    }

    /* --- ç‰¹æ•ˆï¼šæ·±æµ·é›·é³´ (ä¿®æ­£ç‰ˆ) --- */
    .fx-thunder {
      border: 1px solid #4834d4 !important;
      background: #060b28 !important;
      color: #fff !important;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    .fx-thunder::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      opacity: 0;
      z-index: -1;
      animation: lightning-strike 2s steps(1) infinite;
    }

    @keyframes lightning-strike {

      0%,
      95%,
      98% {
        opacity: 0;
      }

      96%,
      99% {
        opacity: 0.4;
      }

      /* æ¨¡æ“¬é–ƒé›»ç¬é–“äº®èµ· */
    }

    /* --- 3. æ‰€æœ‰é—œéµå‹•ç•«å®šç¾© (åˆä½µé¦–é æ‰€æœ‰ Keyframes) --- */
    @keyframes border-flow {
      0% {
        background-position: 0% 0%, 50% 100%;
      }

      100% {
        background-position: 0% 0%, 50% -100%;
      }
    }

    @keyframes fire-rise {
      0% {
        transform: translateY(0%);
        opacity: 0.8;
      }

      100% {
        transform: translateY(-50%);
        opacity: 0.4;
      }
    }

    @keyframes fire-flicker {
      0% {
        filter: brightness(1);
      }

      100% {
        filter: brightness(1.3);
      }
    }

    @keyframes neon-rainbow {
      0% {
        filter: hue-rotate(0deg);
      }

      100% {
        filter: hue-rotate(360deg);
      }
    }

    @keyframes neon-flicker {

      0%,
      18%,
      22%,
      25%,
      53%,
      57%,
      100% {
        opacity: 1;
      }

      20%,
      24%,
      55% {
        opacity: 0.7;
      }
    }

    @keyframes shine-gold {
      to {
        background-position: 200% center;
      }
    }

    @keyframes ice-shimmer {
      from {
        filter: brightness(1);
        box-shadow: 0 0 5px #00f2fe;
      }

      to {
        filter: brightness(1.2);
        box-shadow: 0 0 20px #00f2fe;
      }
    }

    @keyframes void-pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(0.98);
      }
    }
</style>
</head>
<body>
<div class="portrait-tip">
  <div style="font-size: 50px;">ğŸ”„</div>
  <p style="margin-top: 20px;">æ©«è‘—ç©</p>
</div>

<div id="tripleRankOverlay" class="modal">
  <div style="color:var(--gold); font-size:20px; margin-bottom:15px; font-weight:bold;">ğŸ†æœ€è¿‘10æ¬¡åœéª°å¾—ä¸»</div>
  <div id="tripleRankList"></div>
  <button class="btn-ui" style="background:var(--gold); margin-top:20px; width:150px; height: 50px; flex: none;" onclick="closeModal('tripleRankOverlay')">è¿”å›</button>
</div>

<div id="fullHistoryOverlay" class="modal">
  <div style="color:var(--gold); font-size:24px; margin-bottom:15px; font-weight:bold;">å®Œæ•´é–‹éª°ç´€éŒ„</div>
  <div id="fullHistoryList"></div>
  <button class="btn-ui" style="background:var(--gold); margin-top:20px; width:150px; height: 50px; flex: none;" onclick="closeModal('fullHistoryOverlay')">é—œé–‰</button>
</div>

<audio id="sndChip" src="https://assets.mixkit.co/active_storage/sfx/3005/3005-preview.mp3" preload="auto"></audio>
<audio id="sndDice" src="https://assets.mixkit.co/active_storage/sfx/2045/2045-preview.mp3" preload="auto"></audio>
<audio id="sndWin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
<audio id="sndTriple" src="https://www.myinstants.com/media/sounds/explosion.mp3"></audio>
<audio id="sndTick" src="https://assets.mixkit.co/active_storage/sfx/1115/1115-preview.mp3" preload="auto"></audio>
<audio id="sndCash" src="https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3" preload="auto"></audio>

<audio id="bgm1" src="background-music-434612.mp3" loop preload="auto"></audio>
<audio id="bgm2" src="soft-background-music-427252.mp3" loop preload="auto"></audio>
<audio id="bgm3" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" loop preload="auto"></audio>

<div id="centerDisplay">
  <div class="big-dice" id="bigDiceIcons"></div>
  <div class="big-result" id="bigResultText"></div>
</div>
<div id="winAmountEffect"></div>

<div class="topbar">
  <div class="sound-toggle" onclick="toggleMute()" id="soundIcon">ğŸ”Š</div>
  <div class="sound-toggle" onclick="cycleBGM()" id="bgmBtn">ğŸµ éŸ³æ¨‚ 1</div>
  <div class="balance-box">ğŸ’ <span id="balanceText">0</span></div>
  <div class="triple-winner-btn" onclick="showRank()">
        <span>ğŸ† æœ€æ–°åœéª°å¾—ä¸»</span>
        <div id="latestWinnerInfo">ç­‰å¾…ä¸­...</div>
    </div>
  <marquee style="flex:1; color:var(--gold);">è½‰æ©«çš„ç©</marquee>
  <a href="index.html" style="text-decoration:none;">
    <button style="background:none; border:1px solid #777; color:#ccc; border-radius:5px; padding:5px 12px; font-size:14px;">ğŸ  å›å¤§å»³</button>
  </a>
</div>

<div class="main-layout">
  <div class="history-sidebar">
    <div style="text-align:center; color:var(--gold); font-size:12px; font-weight:bold; padding-bottom:5px; border-bottom:1px solid #444;">é–‹éª°ç´€éŒ„</div>
    <div id="historyList"></div>
    
    

    <div class="miss-box">
        <div>æœªé–‹å±€æ•¸</div>
        <div id="missCountText">0</div>
    </div>
    <button class="full-hist-btn" onclick="openModal('fullHistoryOverlay')">å®Œæ•´ç´€éŒ„</button>
  </div>
  
  <div class="table-container">
    <div class="betting-table">
      <div class="bet-row">
        <div class="bet-cell" style="flex:1.2" onclick="placeBet('small')">å°<div class="odds-label">1:1</div><div id="chip-small"></div></div>
        <div class="bet-cell" onclick="placeBet('triple_1')">111<div class="odds-label">1:210</div><div id="chip-triple_1"></div></div>
        <div class="bet-cell" onclick="placeBet('triple_2')">222<div class="odds-label">1:210</div><div id="chip-triple_2"></div></div>
        <div class="bet-cell" onclick="placeBet('triple_3')">333<div class="odds-label">1:210</div><div id="chip-triple_3"></div></div>
        <div class="bet-cell" style="background:rgba(255,216,107,0.1)" onclick="placeBet('anyTriple')">å…¨åœ<div class="odds-label">1:34</div><div id="chip-anyTriple"></div></div>
        <div class="bet-cell" onclick="placeBet('triple_4')">444<div class="odds-label">1:210</div><div id="chip-triple_4"></div></div>
        <div class="bet-cell" onclick="placeBet('triple_5')">555<div class="odds-label">1:210</div><div id="chip-triple_5"></div></div>
        <div class="bet-cell" onclick="placeBet('triple_6')">666<div class="odds-label">1:210</div><div id="chip-triple_6"></div></div>
        <div class="bet-cell" style="flex:1.2" onclick="placeBet('big')">å¤§<div class="odds-label">1:1</div><div id="chip-big"></div></div>
      </div>
      <div class="bet-row" id="sumRow"></div>
      <div class="bet-row" id="singleRow"></div>
    </div>
    <div class="timer-box" id="timer">20</div>
  </div>
</div>

<div class="footer-bar">
  <div class="info-area">
    <div>ç¸½æŠ¼æ³¨</div>
    <div id="totalBetText">0</div>
  </div>
  <div class="chip-area">
    <div class="chip-btn" style="background:#3b82f6;" onclick="selectChip(1000, this)">1000</div>
    <div class="chip-btn active" style="background:#a855f7;" onclick="selectChip(6000, this)">6000</div>
    <div class="chip-btn" style="background:#ef4444;" onclick="selectChip(10000, this)">10000</div>
    <div class="chip-btn" style="background:var(--green);" onclick="selectChip(60000, this)">60000</div>
  </div>
  <div class="btn-area-row">
    <button class="btn-ui" id="btnAuto" onclick="toggleAuto()">è‡ªå‹•ç©</button>
    <button class="btn-ui" style="background:var(--gold);" onclick="repeatBets()">çºŒæŠ¼</button>
    <button class="btn-ui" onclick="clearBets()">æ¸…é™¤</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>

<script>
// --- Firebase åˆå§‹åŒ– ---
const firebaseConfig = {
  apiKey: "AIzaSyDSRfVAuWCWCUd1NJopJ6wHvsqsAM4UzJA",
  authDomain: "game-80d68.firebaseapp.com",
  projectId: "game-80d68",
  storageBucket: "game-80d68.firebasestorage.app",
  messagingSenderId: "636332967920",
  appId: "1:636332967920:web:29e5600daf4db0ab613f35",
  measurementId: "G-MJZ4PGEHSQ"
};
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();

// --- æ ¸å¿ƒè®Šæ•¸ ---
let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
let historyData = JSON.parse(localStorage.getItem('sicbo_history')) || [];
let missCount = parseInt(localStorage.getItem('sicbo_triple_miss')) || 0; 
let currentChip = 600, totalBet = 0, betData = {}, lastRoundBets = {}, isAutoPlaying = false;
let isMuted = false, currentBgmIdx = 1, timeLeft = 20; 
const bgmList = [null, 'bgm1', 'bgm2', 'bgm3'];
const BET_LIMIT = 60000;
const DICE_CHARS = ["", "âš€", "âš", "âš‚", "âšƒ", "âš„", "âš…"];
const SUM_ODDS = { 4:69, 17:69, 5:34, 16:34, 6:20, 15:20, 7:13, 14:13, 8:9, 13:9, 9:7.4, 10:6.8, 11:6.8, 12:7.4 };

// --- è²éŸ³é‚è¼¯ ---
function playSound(id) { if (!isMuted) { const s = document.getElementById(id); if(s) { s.volume = 1.0; s.currentTime = 0; s.play().catch(()=>{}); } } }
function toggleMute() { isMuted = !isMuted; document.getElementById('soundIcon').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š'; }
function cycleBGM() {
    bgmList.forEach(id => { if(id){ const a=document.getElementById(id); a.pause(); a.muted=true; a.currentTime=0; } });
    currentBgmIdx = (currentBgmIdx + 1) % 4;
    const btn = document.getElementById('bgmBtn');
    if (currentBgmIdx === 0) btn.textContent = 'ğŸš« éŸ³æ¨‚é—œ';
    else {
        const bgm = document.getElementById(bgmList[currentBgmIdx]);
        if(bgm) { bgm.muted = false; bgm.volume = 0.3; bgm.play().catch(()=>{}); btn.textContent = 'ğŸµ éŸ³æ¨‚ ' + currentBgmIdx; }
    }
}

// --- æ•¸æ“šå­˜å– ---
async function saveData() { 
    localStorage.setItem('sicbo_balance', balance); 
    localStorage.setItem('sicbo_history', JSON.stringify(historyData.slice(0,500))); 
    localStorage.setItem('sicbo_triple_miss', missCount); 
    
    const playerId = localStorage.getItem('player_id');
    if (playerId && db) {
        try {
            await db.collection("users").doc(playerId).update({ 
                balance: balance,
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (e) { console.warn("é›²ç«¯åŒæ­¥æš«ç·©ï¼ˆå¯èƒ½æ˜¯ç¶²è·¯æ³¢å‹•ï¼‰"); }
    }
}

function openModal(id) { document.getElementById(id).style.display = 'flex'; if(id==='fullHistoryOverlay') renderFullHistory(); }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

// --- åˆå§‹åŒ– ---
function initTable() {
  const sRow = document.getElementById('sumRow'), gRow = document.getElementById('singleRow');
  sRow.innerHTML = ''; gRow.innerHTML = '';
  for(let i=4; i<=17; i++) sRow.innerHTML += `<div class="bet-cell" onclick="placeBet('sum_${i}')">${i}<div class="odds-label">1:${SUM_ODDS[i]}</div><div id="chip-sum_${i}"></div></div>`;
  for(let i=1; i<=6; i++) gRow.innerHTML += `<div class="bet-cell" onclick="placeBet('single_${i}')">${i}<div class="odds-label">1:1</div><div id="chip-single_${i}"></div></div>`;
  updateUI(); renderHistory(); loadTripleWinners();
}

// --- ç›£è½åœéª°æ¦œ (æ”¹ç‚ºè®€å–æœ€è¿‘ 1 ç­†é¡¯ç¤ºåœ¨å´é‚Š) ---
function loadTripleWinners() {
    db.collection("sicbo_wins").orderBy("time", "desc").limit(1).onSnapshot(snapshot => {
        const info = document.getElementById('latestWinnerInfo');
        if (!snapshot.empty) {
            const latest = snapshot.docs[0].data();
            info.innerHTML = `${latest.name} <br> è´ $${Math.floor(latest.win).toLocaleString()}`;
        } else {
            info.innerText = "ç­‰å¾…...";
        }
    });
}

// --- é¡¯ç¤ºæœ€è¿‘ 10 æ¬¡åœéª°ç²çæ’è¡Œæ¦œ ---
async function showRank() {
    const modal = document.getElementById('tripleRankOverlay');
    const list = document.getElementById('tripleRankList');
    list.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">è¼‰å…¥ä¸­...</div>';
    modal.style.display = 'flex';

    try {
        // 1. å…ˆæŠ“å–ä½¿ç”¨è€…å°ç…§è¡¨ (ç¨±è™Ÿèˆ‡ç‰¹æ•ˆ)
        const userDocs = await db.collection("users").get();
        let userSettings = {};
        userDocs.forEach(u => {
            const userData = u.data();
            userSettings[userData.name] = {
                fx: userData.equipped_fx || "",
                title: userData.equipped_title || ""
            };
        });

        // 2. æŠ“å–éª°å¯¶ç´€éŒ„
        const snapshot = await db.collection("sicbo_wins").orderBy("time", "desc").limit(10).get();
        list.innerHTML = '';

        if (snapshot.empty) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">æš«ç„¡ç´€éŒ„</div>';
            return;
        }

        snapshot.forEach(doc => {
            const data = doc.data();
            const userName = data.name || 'ç„¡åæ°';
            
            // 3. å–å¾—è©²ç©å®¶çš„ç‰¹æ•ˆèˆ‡ç¨±è™Ÿ
            const playerSetting = userSettings[userName] || { fx: "", title: "" };
            const fxClass = playerSetting.fx;
            const titleText = playerSetting.title;

            // 4. ç¨±è™Ÿé¡è‰²åˆ¤å®š
            let titleColorClass = "t-blue";
            if (titleText.includes("å¹¸é‹éŒ¦é¯‰")) titleColorClass = "t-koi-color"; // æ–°å¢éŒ¦é¯‰è‰²
          else if (titleText.includes("è³­ç¥") || titleText.includes("å¯Œå¯æ•µåœ‹") || titleText.includes("è‡³å°Š") || titleText.includes("èººå¹³")) titleColorClass = "t-red";
          else if (titleText.includes("æ¢Ÿé›„") || titleText.includes("å‚³å¥‡") || titleText.includes("é´»é‹") || titleText.includes("å¤©é¸")) titleColorClass = "t-orange";
          else if (titleText.includes("åœŸè±ª") ||  titleText.includes("åƒé‡‘") || titleText.includes("ç‹—å±") || titleText.includes("å°‘çˆº") || titleText.includes("ä»™å¥³") ) titleColorClass = "t-purple";
          else if (titleText.includes("å¹¸é‹")) titleColorClass = "t-yellow";
            const titleHTML = titleText ? `<span class="player-title ${titleColorClass}" style="font-size:10px; display:block;">ã€${titleText}ã€‘</span>` : "";

            const row = document.createElement('div');
            // æ³¨å…¥ç‰¹æ•ˆ Class
            row.className = `rank-item ${fxClass}`;
            
            // 5. è¨­å®šæ¨£å¼ (åŒ…å« min-width ç¢ºä¿ä¸æ“ å£“)
            row.style.cssText = "margin-bottom:10px; padding:12px; border-radius:10px; background:rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center; min-width:max-content; width:100%;";
            
            row.innerHTML = `
    <div style="display:flex; align-items:center; gap:8px; flex:1; overflow:visible;">
        <div style="display:flex; flex-direction:column; line-height:1.4; overflow:visible; flex:1; min-width:0;">
            <div style="display:block; width:100%; overflow:visible;">
                ${titleHTML}
            </div>
            <span class="rank-name" style="color:#fff; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                ${userName} (${data.dice})
            </span>
        </div>
    </div>
    <span class="rank-amt" style="color:#ffd700; font-weight:bold; margin-left:15px; flex-shrink:0;">
        +$${Math.floor(data.win).toLocaleString()}
    </span>
`;
            list.appendChild(row);
        });
    } catch (error) {
        console.error("Rank Error:", error);
        list.innerHTML = '<div style="text-align:center; padding:20px; color:#ff4757;">è®€å–å¤±æ•—</div>';
    }
}

// --- éŠæˆ²é‚è¼¯ ---
function selectChip(val, el) { currentChip = val; document.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); playSound('sndTick'); }
function placeBet(key) {
  // 1. æ™‚é–“é™åˆ¶åˆ¤æ–·
  if (timeLeft <= 3) return;

  // 2. é¤˜é¡åˆ¤æ–·
  if (balance < currentChip) {
    alert("é¤˜é¡ä¸è¶³ï¼");
    return;
  }

  // 3. ã€æ–°å¢ã€‘å–®é …ä¸‹æ³¨ä¸Šé™åˆ¤æ–· (BET_LIMIT)
  let currentPosBet = (betData[key] || 0);
  if (currentPosBet + currentChip > BET_LIMIT) {
    return;
  }

  // 4. ã€æ–°å¢ã€‘ç¸½ä¸‹æ³¨é¡é™åˆ¶ (å¯é¸ï¼Œè‹¥æ‚¨éœ€è¦é™åˆ¶æ•´å ´ç¸½é¡ï¼Œå¯åŠ æ­¤æ®µ)
  // if (totalBet + currentChip > 20000) { 
  //   alert("ç¸½ä¸‹æ³¨é¡å·²é”ä¸Šé™"); 
  //   return; 
  // }

  // åŸ·è¡Œä¸‹æ³¨
  betData[key] = currentPosBet + currentChip; 
  balance -= currentChip; 
  totalBet += currentChip;
  
  playSound('sndChip'); 
  updateUI(); 
  renderChip(key);
}

// ... å…¶é¤˜å‡½å¼ä¿æŒä¸è®Š ...

// ä¿®æ”¹ repeatBets ä¹Ÿè¦è€ƒæ…®é™åˆ¶ (é¿å…è‡ªå‹•æŠ•æ³¨æ™‚çˆ†é¡åº¦)
function repeatBets() {
  for (let k in lastRoundBets) {
    let amtToBet = lastRoundBets[k];
    let currentInPos = (betData[k] || 0);
    
    // è¨ˆç®—è©²ä½ç½®é‚„èƒ½å¡å¤šå°‘ç±Œç¢¼
    let canBetAmt = Math.min(amtToBet, BET_LIMIT - currentInPos);
    let clicks = Math.floor(canBetAmt / currentChip);
    
    for(let i=0; i<clicks; i++) {
      if (balance >= currentChip) {
        placeBet(k);
      }
    }
  }
}
function renderChip(key) {
  const container = document.getElementById('chip-' + key);
  let chip = container.querySelector('.chip-on-cell') || document.createElement('div');
  chip.className = 'chip-on-cell'; chip.textContent = betData[key];
  container.appendChild(chip);
}
function updateUI() {
  document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString();
  document.getElementById('totalBetText').textContent = totalBet.toLocaleString();
  document.getElementById('missCountText').textContent = missCount;
}

function simulateRound() {
  playSound('sndDice');
  let d = [Math.floor(Math.random()*6)+1, Math.floor(Math.random()*6)+1, Math.floor(Math.random()*6)+1];
  const sum = d[0]+d[1]+d[2], isTriple = (d[0]===d[1] && d[1]===d[2]);
  
  missCount = isTriple ? 0 : missCount + 1;

  const center = document.getElementById('centerDisplay');
  document.getElementById('bigDiceIcons').textContent = `${DICE_CHARS[d[0]]} ${DICE_CHARS[d[1]]} ${DICE_CHARS[d[2]]}`;
  document.getElementById('bigResultText').textContent = `${sum} é» - ${isTriple ? "åœéª°" : (sum >= 11 ? "å¤§" : "å°")}`;
  center.style.display = 'block'; 
  setTimeout(() => center.classList.add('show'), 50);
  if (isTriple) playSound('sndTriple');

  let winTotal = 0, tripleWinAmt = 0;
  for (let key in betData) {
    let amt = betData[key], won = 0;
    if (!isTriple) { 
        if (key === 'small' && sum <= 10) won = amt * 1; 
        if (key === 'big' && sum >= 11) won = amt * 1; 
    }
    if (key === `sum_${sum}`) won = amt * SUM_ODDS[sum];
    if (key === 'anyTriple' && isTriple) { won = amt * 34; tripleWinAmt += (amt + won); }
    if (key === `triple_${d[0]}` && isTriple) { won = amt * 210; tripleWinAmt += (amt + won); }
    if (key === `single_${d[0]}`) won += amt * 1;
    if (key === `single_${d[1]}`) won += amt * 1;
    if (key === `single_${d[2]}`) won += amt * 1;
    if (won > 0) winTotal += (amt + won);
  }

  // åƒ…åœ¨é–‹å‡ºåœéª°ä¸”æœ‰äººç²çæ™‚å­˜å…¥ç´€éŒ„
  if (isTriple && tripleWinAmt > 0) {
      db.collection("sicbo_wins").add({
          name: localStorage.getItem('player_name') || 'å¹¸é‹å…’',
          win: tripleWinAmt, dice: `${d[0]}${d[1]}${d[2]}`, time: firebase.firestore.FieldValue.serverTimestamp()
      });
  }

  balance += winTotal;
  if (winTotal > 0) {
      setTimeout(() => { if(!isTriple) playSound('sndWin'); }, 1200);
      const effect = document.getElementById('winAmountEffect');
      effect.textContent = `+${winTotal.toLocaleString()}`;
      isTriple ? effect.classList.add('triple-win-scale') : effect.classList.remove('triple-win-scale');
      setTimeout(() => { effect.style.display = 'block'; setTimeout(() => effect.style.display = 'none', 2000); }, 1200);
  }
  
  historyData.unshift({ dice: d.join(' '), sum, type: isTriple ? 'triple' : (sum >= 11 ? 'big' : 'small') });
  
  setTimeout(() => {
    center.classList.remove('show'); setTimeout(() => center.style.display = 'none', 300);
    lastRoundBets = JSON.parse(JSON.stringify(betData)); betData = {}; totalBet = 0;
    document.querySelectorAll('.chip-on-cell').forEach(c => c.remove());
    updateUI(); renderHistory(); saveData();
    if (isAutoPlaying) setTimeout(repeatBets, 600);
  }, 4500);
}

function clearBets() { balance += totalBet; totalBet = 0; betData = {}; document.querySelectorAll('.chip-on-cell').forEach(c => c.remove()); updateUI(); }
function toggleAuto() { isAutoPlaying = !isAutoPlaying; document.getElementById('btnAuto').classList.toggle('btn-auto-active', isAutoPlaying); if (isAutoPlaying && timeLeft > 3) repeatBets(); }
function renderHistory() { document.getElementById('historyList').innerHTML = historyData.slice(0, 10).map(h => `<div class="hist-item"><span>${h.dice}</span><span class="sum-${h.type}">${h.sum}</span></div>`).join(''); }
function renderFullHistory() { document.getElementById('fullHistoryList').innerHTML = historyData.slice(0, 300).map(h => `<div class="rank-item"><span>${h.dice}</span><span class="sum-${h.type}">${h.sum}</span></div>`).join(''); }

setInterval(() => { 
  timeLeft--; 
  if (timeLeft < 0) { timeLeft = 20; simulateRound(); } 
  else if (timeLeft <= 5 && timeLeft > 0) playSound('sndTick');
  document.getElementById('timer').textContent = timeLeft; 
}, 1000);

window.onload = async () => {
    const playerId = localStorage.getItem('player_id');
    const localBal = localStorage.getItem('sicbo_balance');
    if (localBal !== null) { balance = parseFloat(localBal); }

    if (playerId && db) {
        try {
            const doc = await db.collection("users").doc(playerId).get();
            if (doc.exists) {
                const cloudBal = doc.data().balance;
                if (cloudBal !== undefined && cloudBal > balance) {
                    balance = cloudBal;
                    localStorage.setItem('sicbo_balance', balance);
                } 
                else if (cloudBal !== undefined && balance > cloudBal) {
                    saveData(); 
                }
            }
        } catch (e) { console.log("é›¢ç·šæ¨¡å¼"); }
    }
    initTable();
    updateUI();

    document.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', async (e) => {
            const href = link.getAttribute('href');
            if (href && href !== '#' && !href.startsWith('javascript')) {
                e.preventDefault();
                await saveData();
                window.location.href = href;
            }
        });
    });
};

window.addEventListener('pagehide', () => {
    localStorage.setItem('sicbo_balance', balance);
});
</script>
</body>
</html>