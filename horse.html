<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
<title>è³½é¦¬å ´</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root { --gold: #ffd86b; --grass: #27ae60; --red: #ff4757; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
  
  body { 
    background: #1a0505; color: #fff; font-family: "Microsoft JhengHei", Arial; 
    height: 100dvh; width: 100vw; overflow: hidden;
    display: flex;
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
  }

  /* é ‚éƒ¨æ¬„ï¼šåŒæ­¥æ‹‰éœ¸æ©Ÿé¢¨æ ¼ */
  .topbar {
    height: calc(50px + env(safe-area-inset-top)); background: linear-gradient(#4a0404, #2a0202);
    display: flex; align-items: center; padding: 0 15px; gap: 10px; border-bottom: 2px solid #5c0a0a; flex-shrink: 0;
    position: absolute; top: 0; left: 0; right: 0; z-index: 10;
  }
  .sound-btn { background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 8px; border: 1px solid var(--gold); cursor: pointer; font-size: 13px; color: #fff; }
  .balance-box { background: rgba(0,0,0,0.5); border: 1px solid var(--gold); border-radius: 15px; padding: 4px 12px; color: var(--gold); font-weight: bold; font-size: 16px; }

  /* å·¦å´ï¼šè³½é¦¬è·‘é“å€ */
  .race-section {
    flex: 3; /* æé«˜åˆ° 3ï¼Œè®“è·‘é“ä½”æ“š 75% ç•«é¢é•·åº¦ */
    display: flex; flex-direction: column;
    border-right: 2px solid #444; position: relative;
    padding-top: 50px; /* å°æ‡‰é ‚éƒ¨æ¬„é«˜åº¦ */
  }

  .track-area {
    flex: 1; background: var(--grass); position: relative;
    display: flex; flex-direction: column; justify-content: space-around;
    padding: 5px 0; overflow: hidden;
  }
  .lane {
    height: 15%; width: 100%; border-bottom: 1px dashed rgba(255,255,255,0.2);
    position: relative; display: flex; align-items: center;
  }
  .horse {
    position: absolute; left: 10px; font-size: 40px; transition: left 0.1s linear;
    z-index: 2; transform: scaleX(-1); display: flex; justify-content: center; align-items: center;
  }
  .horse-num { 
    position: absolute; top: -12px; transform: translateX(-50%) scaleX(-1); left: 50%;
    background: #000; color: #fff; font-size: 12px; padding: 1px 6px; border-radius: 10px; 
    white-space: nowrap; border: 1px solid var(--gold);
  }
  .finish-line {
    position: absolute; right: 60px; top: 0; bottom: 0; width: 15px;
    background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px);
    border-left: 2px solid #ccc; z-index: 1;
  }

  /* å³å´ï¼šä¸‹æ³¨æ§åˆ¶å€ */
  .control-section {
    flex: 0.7; /* ç¸®å°åˆ° 0.7ï¼Œè®“å‡ºæ›´å¤šç©ºé–“çµ¦é¦¬è·‘ */
    background: #222; display: flex; flex-direction: column;
    padding: 8px; 
    padding-top: 50px; /* å°æ‡‰é ‚éƒ¨æ¬„é«˜åº¦ */
    padding-bottom: env(safe-area-inset-bottom);
  }

  .chip-area { display: flex; justify-content: center; gap: 15px; margin-bottom: 10px; }
  .chip {
    width: 45px; height: 45px; border-radius: 50%; border: 2px dashed #fff;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: bold; background: #444; color: #fff; transition: 0.2s;
  }
  .chip.active { transform: scale(1.15); border-style: solid; border-color: var(--gold); background: #856404; box-shadow: 0 0 10px var(--gold); }
  .chip-100 { background: #2980b9; }
  .chip-500 { background: #8e44ad; }
  .chip-1000 { background: #c0392b; }

  .bet-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; flex: 1; }
  .bet-btn {
    background: #333; border: 2px solid #555; border-radius: 10px; color: #fff;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-size: 16px; font-weight: bold;
  }
  .bet-btn span { color: var(--gold); font-size: 11px; margin-top: 2px; }
  .bet-btn.active { border-color: var(--gold); background: #4a3a00; box-shadow: 0 0 10px var(--gold); }

  .action-area { height: 70px; display: flex; align-items: center; gap: 10px; }
  .go-btn {
    flex: 1; height: 50px; border-radius: 25px; background: var(--red);
    color: #fff; border: none; font-size: 20px; font-weight: bold; box-shadow: 0 4px 0 #8b0000;
  }
  .go-btn:disabled { background: #555; box-shadow: none; transform: translateY(2px); }

  /* è¨Šæ¯è¦†è“‹å±¤ */
  #msgOverlay {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.85); padding: 20px 40px; border-radius: 20px;
    color: var(--gold); font-size: 28px; font-weight: bold; display: none; z-index: 100;
    border: 2px solid var(--gold); text-align: center; pointer-events: none;
    text-shadow: 0 0 10px #f00;
  }

  @keyframes gallop {
    0% { transform: scaleX(-1) translateY(0) rotate(0deg); }
    50% { transform: scaleX(-1) translateY(-10px) rotate(-5deg); }
    100% { transform: scaleX(-1) translateY(0) rotate(0deg); }
  }
  .horse.running { animation: gallop var(--speed, 0.4s) infinite ease-in-out; }

  @media (orientation: portrait) {
    .portrait-tip {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh;
      background: #1a0505; z-index: 999; display: flex; flex-direction: column;
      justify-content: center; align-items: center; text-align: center;
    }
  }
  @media (orientation: landscape) { .portrait-tip { display: none; } }
</style>
</head>
<body>

<div class="portrait-tip">
  <div style="font-size: 50px;">ğŸ”„</div>
  <p style="margin-top: 20px;">æ©«è‘—ç©</p>
</div>

<div class="topbar">
  <div class="sound-btn" onclick="toggleMute()" id="muteBtn">ğŸ”Š</div>
  <div class="sound-btn" onclick="cycleBGM()" id="bgmBtn">ğŸµ éŸ³æ¨‚ 1</div>
  <div class="balance-box">ğŸ’° <span id="balanceText">0</span></div>
  <marquee style="flex:1; color:var(--gold); font-size: 12px;">æœ‰å•é¡Œæ‰¾é˜¿è¨˜</marquee>
  <a href="index.html" style="text-decoration:none;">
    <button style="background:none; border:1px solid #777; color:#ccc; border-radius:5px; padding:5px 12px; font-size:14px; font-weight:bold;">ğŸ  å›å¤§å»³</button>
  </a>
</div>

<div class="race-section">
  <div id="msgOverlay"></div>
  <div class="track-area" id="track">
    <div class="finish-line"></div>
    <div class="lane"><div class="horse" id="h1"><span class="horse-num">1</span>ğŸ</div></div>
    <div class="lane"><div class="horse" id="h2"><span class="horse-num">2</span>ğŸ</div></div>
    <div class="lane"><div class="horse" id="h3"><span class="horse-num">3</span>ğŸ</div></div>
    <div class="lane"><div class="horse" id="h4"><span class="horse-num">4</span>ğŸ</div></div>
    <div class="lane"><div class="horse" id="h5"><span class="horse-num">5</span>ğŸ</div></div>
    <div class="lane"><div class="horse" id="h6"><span class="horse-num">6</span>ğŸ</div></div>
  </div>
</div>

<div class="control-section">
  <div class="chip-area">
    <div class="chip chip-100 active" id="chip100" onclick="setBet(100)">100</div>
    <div class="chip chip-500" id="chip500" onclick="setBet(500)">500</div>
    <div class="chip chip-1000" id="chip1000" onclick="setBet(1000)">1K</div>
  </div>
  
  <div class="bet-grid" id="betGrid"></div>
  
  <div class="action-area">
    <button id="goBtn" class="go-btn" onclick="startRace()">é–‹è·‘</button>
  </div>
</div>

<audio id="sndRace" src="https://assets.mixkit.co/active_storage/sfx/2045/2045-preview.mp3" preload="auto"></audio>
<audio id="sndWin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
<audio id="bgm1" src="background-music-434612.mp3" loop preload="auto"></audio>
<audio id="bgm2" src="soft-background-music-427252.mp3" loop preload="auto"></audio>
<audio id="bgm3" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" loop preload="auto"></audio>

<script>
let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
let selectedHorse = null;
let currentBet = 100;
let isRacing = false;
let isMuted = false;
let horseOdds = [0, 5, 5, 5, 5, 5, 5];

// éŸ³æ¨‚æ§åˆ¶
let currentBgmIdx = 1;
const bgmList = [null, 'bgm1', 'bgm2', 'bgm3'];

function updateUI() {
  document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString();
}

function toggleMute() {
  isMuted = !isMuted;
  document.getElementById('muteBtn').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
}

function cycleBGM() {
  // åœæ­¢ç•¶å‰éŸ³æ¨‚
  if (bgmList[currentBgmIdx]) {
    document.getElementById(bgmList[currentBgmIdx]).pause();
  }
  
  // åˆ‡æ›åˆ°ä¸‹ä¸€å€‹
  currentBgmIdx++;
  if (currentBgmIdx >= bgmList.length) currentBgmIdx = 0;
  
  if (bgmList[currentBgmIdx]) {
    document.getElementById(bgmList[currentBgmIdx]).play().catch(()=>{});
    document.getElementById('bgmBtn').textContent = 'ğŸµ éŸ³æ¨‚ ' + currentBgmIdx;
  } else {
    document.getElementById('bgmBtn').textContent = 'ğŸµ éŸ³æ¨‚ï¼šé—œ';
  }
}

function setBet(amt) {
  if (isRacing) return;
  currentBet = amt;
  document.querySelectorAll('.chip').forEach(c => {
    let val = parseInt(c.innerText.replace('K','000'));
    c.classList.toggle('active', val === amt);
  });
}

function refreshOdds() {
  const grid = document.getElementById('betGrid');
  grid.innerHTML = '';
  for (let i = 1; i <= 6; i++) {
    // é€™è£¡åªè² è²¬ç”Ÿæˆ HTMLï¼Œä¸æ”¹ horseOdds[i] çš„æ•¸å€¼
    grid.innerHTML += `
      <button class="bet-btn ${selectedHorse === i ? 'active' : ''}" onclick="selectHorse(${i})">
        ${i} è™Ÿ<span>è³ ç‡ 1:${horseOdds[i]}</span>
      </button>
    `;
  }
}
function generateNewOdds() {
  for (let i = 1; i <= 6; i++) {
    horseOdds[i] = (Math.random() * 8 + 2).toFixed(1);
  }
}
function selectHorse(num) {
  if (isRacing) return;
  selectedHorse = num;
  // ç›´æ¥æ›´æ–° UIï¼Œä¸é‡æ–°éš¨æ©ŸåŒ–è³ ç‡
  document.querySelectorAll('.bet-btn').forEach((btn, idx) => {
    btn.classList.toggle('active', (idx + 1) === num);
  });
}

function startRace() {
  if (isRacing || selectedHorse === null) {
    if (selectedHorse === null) showMsg("è«‹å…ˆé¸æ“‡é¦¬åŒ¹");
    return;
  }
  if (balance < currentBet) { showMsg("é¤˜é¡ä¸è¶³"); return; }

  balance -= currentBet;
  updateUI();
  isRacing = true;
  document.getElementById('goBtn').disabled = true;
  if(!isMuted) document.getElementById('sndRace').play().catch(()=>{});

  const horses = [1, 2, 3, 4, 5, 6].map(n => {
    const el = document.getElementById('h' + n);
    el.classList.add('running');
    return { id: n, el: el, pos: 10 };
  });

  const trackWidth = document.getElementById('track').clientWidth - 110;

  const timer = setInterval(() => {
    horses.forEach(h => {
      let odds = parseFloat(horseOdds[h.id]);
      
      // --- èª¿æ•´å¾Œçš„æ•¸å€¼é‚è¼¯ ---
      
      // 1. å¤§å¹…å¼·åŒ–ä¿åº•å„ªå‹¢ (ç†±é–€é¦¬è·‘å¾—æ›´ç©©)
      // è³ ç‡ 2 çš„é¦¬ bias ç´„ 2.5ï¼Œè³ ç‡ 10 çš„é¦¬ bias åƒ… 0.5
      let bias = (5 / odds) * 1.0; 
      
      // 2. ç¸®å°éš¨æ©Ÿä¸Šé™ (é™ä½é«˜å€ç‡é¦¬ã€Œä¸€æ³¢å¸¶èµ°ã€çš„æ©Ÿç‡)
      // ä»¥å‰éš¨æ©Ÿåˆ° 14ï¼Œç¾åœ¨éš¨æ©Ÿä¸Šé™æ§åˆ¶åœ¨ 7~9 ä¹‹é–“
      let randomRange = 7 + (odds / 5); 
      
      // 3. ç¸®å°æ¯æ­¥ä½ç§» (è®“é¦¬è·‘æ…¢ä¸€é»ï¼Œå¢åŠ æ¯”è³½æ­¥æ•¸ï¼Œè®“è®Šæ•¸ç™¼æ®ä½œç”¨)
      let step = (bias + (Math.random() * randomRange)) * 0.7; 
      
      h.pos += step;
      h.el.style.left = h.pos + 'px';

      // å‹•ä½œåŒæ­¥å¾®èª¿ (å› ç‚ºæ­¥å¹…è®Šå°ï¼Œåˆ†æ¯ä¹Ÿè¦èª¿å°ï¼Œå‹•ä½œæ‰ä¸æœƒå¤ªæ…¢)
      let animSpeed = 0.6 - (step / 12);
      h.el.style.setProperty('--speed', (animSpeed < 0.1 ? 0.1 : animSpeed) + 's');

      if (h.pos >= trackWidth) {
        clearInterval(timer);
        finishRace(h.id);
      }
    });
  }, 60);
}

function finishRace(winnerId) {
  setTimeout(() => {
    if (selectedHorse === winnerId) {
      let winAmt = Math.floor(currentBet * horseOdds[winnerId]);
      balance += winAmt;
      showMsg(`ğŸŠ ${winnerId}è™Ÿç²å‹ ğŸŠ<br>è´å¾— $${winAmt.toLocaleString()}`);
      if(!isMuted) document.getElementById('sndWin').play().catch(()=>{});
    } else {
      showMsg(`${winnerId}è™Ÿç²å‹<br>å†æ¥å†å²ï¼`);
    }
    
    setTimeout(() => {
      horsesReset();
      isRacing = false;
      document.getElementById('goBtn').disabled = false;
      document.getElementById('msgOverlay').style.display = 'none';
      selectedHorse = null;
      
      // é—œéµï¼šé€™å±€å¾¹åº•çµæŸäº†ï¼Œé€™æ™‚å€™æ‰ç”Ÿæˆä¸‹ä¸€å±€çš„è³ ç‡
      generateNewOdds(); 
      refreshOdds();
      
      updateUI();
      localStorage.setItem('sicbo_balance', balance);
    }, 3000);
  }, 500);
}

function horsesReset() {
  for(let i=1; i<=6; i++) {
    const el = document.getElementById('h'+i);
    el.style.left = '10px';
    el.classList.remove('running');
  }
}

function showMsg(text) {
  const overlay = document.getElementById('msgOverlay');
  overlay.innerHTML = text;
  overlay.style.display = 'block';
}

// ä¿®æ­£ location.href è·³è½‰
document.addEventListener('click', function(e) {
  let target = e.target.closest('a') || e.target.closest('button');
  if (target && target.getAttribute('onclick')?.includes('location.href')) {
    let href = target.getAttribute('onclick').match(/'([^']+)'/)[1];
    if (href) {
      e.preventDefault();
      window.location.href = href;
    }
  }
}, false);

generateNewOdds(); 
refreshOdds();
updateUI();
</script>
</body>
</html>