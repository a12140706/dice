<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport"
    content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <title>è³½é¦¬å ´</title>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root {
      --gold: #ffd86b;
      --grass: #27ae60;
      --red: #ff4757;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      margin: 0;
      padding: 0;
    }

    body {
      background: #1a0505;
      color: #fff;
      font-family: "Microsoft JhengHei", Arial;
      height: 100dvh;
      width: 100vw;
      overflow: hidden;
      display: flex;
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    .topbar {
      height: calc(50px + env(safe-area-inset-top));
      background: linear-gradient(#4a0404, #2a0202);
      display: flex;
      align-items: center;
      padding: 0 15px;
      gap: 10px;
      border-bottom: 2px solid #5c0a0a;
      flex-shrink: 0;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
    }

    .sound-btn {
      background: rgba(255, 255, 255, 0.1);
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid var(--gold);
      cursor: pointer;
      font-size: 13px;
      color: #fff;
    }

    .balance-box {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid var(--gold);
      border-radius: 15px;
      padding: 4px 12px;
      color: var(--gold);
      font-weight: bold;
      font-size: 16px;
    }

    /* æ¦œé¦–é¡¯ç¤ºå€ */
    .rank-header-area {
      position: absolute;
      top: calc(55px + env(safe-area-inset-top));
      left: 50%;
      transform: translateX(-50%);
      z-index: 5;
      display: flex;
      justify-content: center;
      width: auto;
    }

    .rank-btn-horizontal {
      background: linear-gradient(#b91c1c, #7f1d1d);
      border: 1px solid var(--gold);
      border-radius: 20px;
      padding: 4px 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
      cursor: pointer;
      white-space: nowrap;
    }

    .rank-btn-horizontal span {
      font-size: 11px;
      color: #fff;
    }

    #topWinnerName {
      font-size: 13px;
      color: var(--gold);
      font-weight: bold;
    }

    .race-section {
      flex: 3;
      display: flex;
      flex-direction: column;
      border-right: 2px solid #444;
      position: relative;
      padding-top: 50px;
    }

    .track-area {
      flex: 1;
      background: var(--grass);
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      padding: 5px 0;
      overflow: hidden;
    }

    .lane {
      height: 15%;
      width: 100%;
      border-bottom: 1px dashed rgba(255, 255, 255, 0.2);
      position: relative;
      display: flex;
      align-items: center;
    }

    .horse {
      position: absolute;
      left: 10px;
      font-size: 40px;
      transition: left 0.1s linear;
      z-index: 2;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 50%;
    }

    .horse-body {
      transform: scaleX(-1);
    }

    .horse.my-horse {
      filter: drop-shadow(0 0 10px var(--gold)) drop-shadow(0 0 20px #f1c40f);
      z-index: 100;
    }

    .horse.my-horse::before {
      content: 'â˜…';
      position: absolute;
      top: -25px;
      color: var(--gold);
      font-size: 18px;
      animation: starRotate 1s infinite linear;
    }

    @keyframes starRotate {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .horse.fatigued {
      filter: drop-shadow(0 0 5px red);
      animation: blink 0.3s infinite;
    }

    @keyframes blink {
      50% {
        opacity: 0.6;
      }
    }

    .status-pop {
      position: absolute;
      top: -20px;
      /* èª¿æ•´åˆå§‹ä½ç½®åœ¨é¦¬çš„ä¸Šæ–¹ */
      left: 50%;
      transform: translateX(-50%);
      font-size: 16px;
      /* ç¨å¾®æ”¾å¤§ */
      font-weight: 900;
      white-space: nowrap;
      pointer-events: none;
      animation: popUp 1.0s ease-out forwards;
      z-index: 999;
      /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
    }

    .pop-dash {
      color: #fff176;
      text-shadow: 1px 1px 3px #000;
    }

    .pop-tired {
      color: #ff5252;
      text-shadow: 1px 1px 3px #000;
    }

    @keyframes popUp {
      0% {
        opacity: 0;
        transform: translateX(-50%) translateY(10px);
      }

      15% {
        opacity: 1;
        transform: translateX(-50%) translateY(-5px);
      }

      80% {
        opacity: 1;
      }

      100% {
        opacity: 0;
        transform: translateX(-50%) translateY(-40px);
      }
    }

    .horse-num {
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      background: #000;
      color: #fff;
      font-size: 12px;
      padding: 1px 6px;
      border-radius: 10px;
      border: 1px solid var(--gold);
      z-index: 5;
    }

    .finish-line {
      position: absolute;
      right: 60px;
      top: 0;
      bottom: 0;
      width: 15px;
      background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px);
      border-left: 2px solid #ccc;
      z-index: 1;
    }

    .control-section {
      flex: 1.2;
      background: #222;
      display: flex;
      flex-direction: column;
      padding: 8px;
      padding-top: 50px;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .chip-area {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .chip {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: 2px dashed #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      background: #444;
      color: #fff;
      cursor: pointer;
    }

    .chip.active {
      transform: scale(1.1);
      border-style: solid;
      border-color: var(--gold);
      background: #856404;
      box-shadow: 0 0 10px var(--gold);
    }

    /* è£œå›å„é¢é¡é¡è‰² */
    .chip-500 {
      background: #2ecc71;
    }

    /* ç¶ è‰² */
    .chip-1000 {
      background: #3498db;
    }

    /* è—è‰² */
    .chip-5000 {
      background: #9b59b6;
    }

    /* ç´«è‰² */
    .chip-allin {
      background: #e67e22;
    }

    /* æ©˜è‰² */
    .bet-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      flex: 1;
    }

    .bet-btn {
      background: #333;
      border: 2px solid #555;
      border-radius: 10px;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
    }

    .bet-btn span {
      color: var(--gold);
      font-size: 10px;
    }

    .bet-btn.active {
      border-color: var(--gold);
      background: #4a3a00;
    }

    .action-area {
      height: 60px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .go-btn {
      flex: 1;
      height: 45px;
      border-radius: 25px;
      background: var(--red);
      color: #fff;
      border: none;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 4px 0 #8b0000;
    }

    .go-btn:disabled {
      background: #555;
      box-shadow: none;
      transform: translateY(2px);
    }

    #msgOverlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      padding: 20px 40px;
      border-radius: 20px;
      color: var(--gold);
      font-size: 24px;
      font-weight: bold;
      display: none;
      z-index: 100;
      border: 2px solid var(--gold);
      text-align: center;
    }

    /* æ’è¡Œæ¦œå½ˆçª— */
    .modal {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 5000;
    }

    .rank-list {
      width: 70%;
      max-height: 60%;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid #333;
    }

    .rank-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #222;
      font-size: 14px;
    }

    .rank-name {
      color: var(--gold);
    }

    .rank-win {
      color: #2ecc71;
      font-weight: bold;
    }

    .t-green {
      color: #2ecc71 !important;
    }

    .t-blue {
      color: #3498db !important;
    }

    .t-purple {
      color: #9b59b6 !important;
    }

    .t-orange {
      color: #e67e22 !important;
    }

    .t-red {
      color: #ff4757 !important;
      animation: title-glow 1s infinite alternate;
    }

    @keyframes title-glow {
      from {
        filter: drop-shadow(0 0 1px #ff4757);
      }

      to {
        filter: drop-shadow(0 0 5px #ff4757);
      }
    }

    /* --- 2. æ’è¡Œæ¦œé …ç›®ç‰¹æ•ˆæ ¸å¿ƒ (ç¢ºä¿åœ¨éŠæˆ² Sidebar å…§ç”Ÿæ•ˆ) --- */
    .rank-item {
      position: relative !important;
      overflow: hidden !important;
      contain: paint;
      /* é˜²æ­¢ç‰¹æ•ˆæº¢å‡ºé€ æˆæ‰‹æ©Ÿæ©«å‘æ»¾å‹• */
      z-index: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* [ç‰¹æ•ˆï¼šæ¥µé™ç„ç«] */
    .fx-fire {
      border: 2px solid transparent !important;
      background: linear-gradient(#2a0000, #2a0000) padding-box,
        linear-gradient(0deg, #ff4757, #ff9f43, #ff4757) border-box !important;
      background-size: 100% 100%, 100% 300% !important;
      color: #fff !important;
      box-shadow: inset 0 0 15px #741b1b, 0 0 15px rgba(255, 71, 87, 0.5) !important;
      text-shadow: 0 0 8px #ff4757 !important;
      animation: fire-flicker 0.2s ease-in-out infinite alternate, border-flow 1.5s linear infinite !important;
    }

    .fx-fire::before {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 200%;
      background: linear-gradient(0deg, transparent 0%, rgba(255, 69, 0, 0.4) 20%, transparent 80%);
      z-index: -1;
      animation: fire-rise 1s linear infinite;
    }

    /* [ç‰¹æ•ˆï¼šé›·éœ†éœ“è™¹] */
    .fx-neon {
      border: 2px solid #fff !important;
      background: rgba(0, 0, 0, 0.9) !important;
      box-shadow: 0 0 10px #fff, 0 0 20px #00d2ff !important;
      animation: neon-flicker 2s infinite, neon-rainbow 4s linear infinite !important;
    }

    /* [ç‰¹æ•ˆï¼šè‡³å°Šçš‡é‡‘] */
    .fx-gold {
      border: 1px solid #ffd700 !important;
      background-image: linear-gradient(110deg, #6b5500 0%, #ffd700 50%, #6b5500 100%) !important;
      background-size: 200% auto !important;
      animation: shine-gold 3s linear infinite !important;
    }

    /* [ç‰¹æ•ˆï¼šçµ•å°é›¶åº¦] */
    .fx-ice {
      border: 1px solid #00f2fe !important;
      background: linear-gradient(135deg, #005f73, #00d4ff) !important;
      text-shadow: 0 0 10px #7ed6ff !important;
      animation: ice-shimmer 2s ease-in-out infinite alternate !important;
    }

    /* [ç‰¹æ•ˆï¼šé»‘æ´æ¹®æ»…] */
    .fx-void {
      border: 2px solid #2f3542 !important;
      background: black !important;
      color: #a55eea !important;
      box-shadow: 0 0 20px #6c5ce7 !important;
      animation: void-pulse 3s ease-in-out infinite !important;
    }

    /* --- ç‰¹æ•ˆï¼šæ·±æµ·é›·é³´ (ä¿®æ­£ç‰ˆ) --- */
    .fx-thunder {
      border: 1px solid #4834d4 !important;
      background: #060b28 !important;
      color: #fff !important;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    .fx-thunder::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      opacity: 0;
      z-index: -1;
      animation: lightning-strike 2s steps(1) infinite;
    }

    @keyframes lightning-strike {

      0%,
      95%,
      98% {
        opacity: 0;
      }

      96%,
      99% {
        opacity: 0.4;
      }

      /* æ¨¡æ“¬é–ƒé›»ç¬é–“äº®èµ· */
    }

    /* --- 3. æ‰€æœ‰é—œéµå‹•ç•«å®šç¾© (åˆä½µé¦–é æ‰€æœ‰ Keyframes) --- */
    @keyframes border-flow {
      0% {
        background-position: 0% 0%, 50% 100%;
      }

      100% {
        background-position: 0% 0%, 50% -100%;
      }
    }

    @keyframes fire-rise {
      0% {
        transform: translateY(0%);
        opacity: 0.8;
      }

      100% {
        transform: translateY(-50%);
        opacity: 0.4;
      }
    }

    @keyframes fire-flicker {
      0% {
        filter: brightness(1);
      }

      100% {
        filter: brightness(1.3);
      }
    }

    @keyframes neon-rainbow {
      0% {
        filter: hue-rotate(0deg);
      }

      100% {
        filter: hue-rotate(360deg);
      }
    }

    @keyframes neon-flicker {

      0%,
      18%,
      22%,
      25%,
      53%,
      57%,
      100% {
        opacity: 1;
      }

      20%,
      24%,
      55% {
        opacity: 0.7;
      }
    }

    @keyframes shine-gold {
      to {
        background-position: 200% center;
      }
    }

    @keyframes ice-shimmer {
      from {
        filter: brightness(1);
        box-shadow: 0 0 5px #00f2fe;
      }

      to {
        filter: brightness(1.2);
        box-shadow: 0 0 20px #00f2fe;
      }
    }

    @keyframes void-pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(0.98);
      }
    }

    @media (orientation: portrait) {
      .portrait-tip {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100dvh;
        background: #1a0505;
        z-index: 999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
    }

    @media (orientation: landscape) {
      .portrait-tip {
        display: none;
      }
    }
  </style>
</head>

<body>

  <div class="portrait-tip">
    <div style="font-size: 50px;">ğŸ”„</div>
    <p style="margin-top: 20px;">è«‹å°‡æ‰‹æ©Ÿæ©«æ”¾é€²è¡ŒéŠæˆ²</p>
  </div>

  <div id="rankModal" class="modal">
    <div style="color:var(--gold); font-size:18px; margin-bottom:10px; font-weight:bold;">ğŸ†æœ€é«˜çé‡‘æ¦œ</div>
    <div class="rank-list" id="rankList"></div>
    <button class="sound-btn" style="margin-top:15px; padding:8px 25px;" onclick="closeRank()">è¿”å›éŠæˆ²</button>
  </div>

  <div class="topbar">
    <div class="sound-btn" onclick="toggleMute()" id="muteBtn">ğŸ”Š</div>
    <div class="sound-btn" onclick="cycleBGM()" id="bgmBtn">ğŸµ éŸ³æ¨‚ 1</div>
    <div class="balance-box">ğŸ’ <span id="balanceText">0</span></div>
    <marquee style="flex:1; color:var(--gold); font-size: 12px;">æœ‰å•é¡Œå†èªª</marquee>
    <a href="index.html" style="text-decoration:none;"><button class="sound-btn">ğŸ  å›å¤§å»³</button></a>
  </div>

  <div class="rank-header-area">
    <div class="rank-btn-horizontal" onclick="openRank()">
      <span>ğŸ†è³½é¦¬æ¦œé¦–:</span>
      <div id="topWinnerName">è®€å–ä¸­...</div>
    </div>
  </div>

  <div class="race-section">
    <div id="msgOverlay"></div>
    <div class="track-area" id="track">
      <div class="finish-line"></div>
      <div class="lane">
        <div class="horse" id="h1"><span class="horse-num">1</span>
          <div class="horse-body">ğŸ</div>
        </div>
      </div>
      <div class="lane">
        <div class="horse" id="h2"><span class="horse-num">2</span>
          <div class="horse-body">ğŸ¦“</div>
        </div>
      </div>
      <div class="lane">
        <div class="horse" id="h3"><span class="horse-num">3</span>
          <div class="horse-body">ğŸ¦„</div>
        </div>
      </div>
      <div class="lane">
        <div class="horse" id="h4"><span class="horse-num">4</span>
          <div class="horse-body">ğŸ</div>
        </div>
      </div>
      <div class="lane">
        <div class="horse" id="h5"><span class="horse-num">5</span>
          <div class="horse-body">ğŸ</div>
        </div>
      </div>
      <div class="lane">
        <div class="horse" id="h6"><span class="horse-num">6</span>
          <div class="horse-body">ğŸ</div>
        </div>
      </div>
    </div>
  </div>

  <div class="control-section">
    <div class="chip-area">
      <div class="chip chip-500" id="chip500" onclick="setBet(1000000)">1000K</div>
      <div class="chip chip-1000" id="chip1000" onclick="setBet(5000000)">5000K</div>
      <div class="chip chip-5000" id="chipHalfIn" onclick="setBet('half')">æ¢­åŠå“ˆ</div>
      <div class="chip chip-allin active" id="chipAllIn" onclick="setBet('allin')">æ¢­å“ˆ</div>
    </div>
    <div class="bet-grid" id="betGrid"></div>
    <div class="action-area">
      <button id="goBtn" class="go-btn" onclick="startRace()">é–‹è·‘</button>
    </div>
  </div>

  <audio id="sndRace" src="https://assets.mixkit.co/active_storage/sfx/2045/2045-preview.mp3" preload="auto"></audio>
  <audio id="sndWin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
  <audio id="bgm1" src="background-music-434612.mp3" loop preload="auto"></audio>
  <audio id="bgm2" src="soft-background-music-427252.mp3" loop preload="auto"></audio>
  <audio id="bgm3" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" loop preload="auto"></audio>

  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>

  <script>
    // --- Firebase åˆå§‹åŒ– ---
    const firebaseConfig = {
      apiKey: "AIzaSyDSRfVAuWCWCUd1NJopJ6wHvsqsAM4UzJA",
      authDomain: "game-80d68.firebaseapp.com",
      projectId: "game-80d68",
      storageBucket: "game-80d68.firebasestorage.app",
      messagingSenderId: "636332967920",
      appId: "1:636332967920:web:29e5600daf4db0ab613f35",
      measurementId: "G-MJZ4PGEHSQ"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // --- æ ¸å¿ƒè®Šæ•¸ ---
    let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
    let selectedHorse = null;
    let currentBet = 'allin';
    let isRacing = false;
    let isMuted = false;
    let horseStats = [];
    let isAudioUnlocked = false;

    let currentBgmIdx = 1;
    const bgmList = [null, 'bgm1', 'bgm2', 'bgm3'];

    const horseConfigs = [
      { filter: 'hue-rotate(0deg)' }, { filter: 'grayscale(100%)' }, { filter: 'hue-rotate(280deg)' },
      { filter: 'hue-rotate(50deg) brightness(1.3)' }, { filter: 'hue-rotate(180deg)' }, { filter: 'invert(100%) brightness(1.5)' }
    ];

    // --- æ•¸æ“šåŒæ­¥é‚è¼¯ (é«˜é¡å„ªå…ˆ) ---
    async function saveData() {
      localStorage.setItem('sicbo_balance', balance);
      const playerId = localStorage.getItem('player_id');
      if (playerId && db) {
        try {
          await db.collection("users").doc(playerId).update({
            balance: balance,
            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
          });
        } catch (e) { console.warn("é›²ç«¯åŒæ­¥å»¶é²"); }
      }
    }

    // --- å®‰å…¨è·³è½‰å™¨ ---
    async function syncAndRedirect(url) {
      await saveData();
      window.location.href = url;
    }

    function updateUI() {
      document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString();
      localStorage.setItem('sicbo_balance', balance);
      // é€™è£¡ç¶­æŒç°¡å–®æ›´æ–°ï¼Œä¸»è¦çš„ Firebase åŒæ­¥äº¤çµ¦éŠæˆ²é—œéµé»æˆ–è·³è½‰æ””æˆª
    }

    function listenRank() {
      db.collection("users").get().then(userDocs => {
        let userSettings = {};
        userDocs.forEach(u => {
          const userData = u.data();
          userSettings[userData.name] = {
            fx: userData.equipped_fx || "",
            title: userData.equipped_title || ""
          };
        });

        // ä¿®æ”¹é€™è£¡ï¼šç”± win æ”¹ç‚º timeï¼ŒæŠ“å–æœ€æ–°çš„ 10 ç­†
        db.collection("horse_wins").orderBy("time", "desc").limit(10).onSnapshot(snap => {
          let html = '';
          let first = true;
          let i = 1;

          snap.forEach(doc => {
            const d = doc.data();
            const userName = d.name || 'ç„¡åæ°';
            const recordWin = d.win || 0;

            const playerSetting = userSettings[userName] || { fx: "", title: "" };
            const fxClass = playerSetting.fx;
            const titleText = playerSetting.title;

            let titleColorClass = "t-blue";
            if (titleText.includes("è³­ç¥") || titleText.includes("å¯Œå¯æ•µåœ‹") || titleText.includes("ç´…")) titleColorClass = "t-red";
            else if (titleText.includes("æ¢Ÿé›„") || titleText.includes("å‚³å¥‡") || titleText.includes("æ©™")) titleColorClass = "t-orange";
            else if (titleText.includes("åœŸè±ª") || titleText.includes("ç´«")) titleColorClass = "t-purple";
            else if (titleText.includes("ç¶ ")) titleColorClass = "t-green";

            const titleHTML = titleText ? `<span class="player-title ${titleColorClass}">ã€${titleText}ã€‘</span>` : "";

            if (first) {
              const topEl = document.getElementById('topWinnerName');
              if (topEl) {
                // é€™è£¡é¡¯ç¤ºæœ€æ–°çš„ä¸€ç­†ç²çè€…
                topEl.innerHTML = `<span style="color:#fff">${userName}</span> <span style="color:#ffd700">$${Math.floor(recordWin).toLocaleString()}</span>`;
              }
              first = false;
            }

            html += `
                <div class="rank-item ${fxClass}" style="margin-bottom:10px; padding:12px; border-radius:10px; background:rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center; min-width:max-content; width:100%;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="color:#ffd700; font-weight:bold; width:20px;">${i === 1 ? 'âœ¨' : i}</span>
                        <div style="display:flex; flex-direction:column;">
                            ${titleHTML}
                            <span style="color:#fff; font-size:13px; white-space:nowrap;">${userName}</span>
                        </div>
                    </div>
                    <span style="color:#ffd700; font-weight:bold; margin-left:15px;">$${Math.floor(recordWin).toLocaleString()}</span>
                </div>`;
            i++;
          });

          const listEl = document.getElementById('rankList');
          if (listEl) listEl.innerHTML = html || '<div style="padding:20px; color:#666; text-align:center;">ç­‰å¾…å‚³å¥‡...</div>';
        });
      });
    }

    function openRank() { document.getElementById('rankModal').style.display = 'flex'; }
    function closeRank() { document.getElementById('rankModal').style.display = 'none'; }

    // --- åˆå§‹åŒ–èˆ‡æ ¡æº– ---
    window.onload = async () => {
      generateNewOdds();
      refreshOdds();
      applyHorseStyles();
      listenRank();

      // 1. æœ¬åœ°è®€å–
      const localBal = localStorage.getItem('sicbo_balance');
      if (localBal !== null) balance = parseFloat(localBal);

      // 2. è¯ç¶²æ ¡æº– (é«˜é¡å„ªå…ˆ)
      const playerId = localStorage.getItem('player_id');
      if (playerId && db) {
        try {
          const doc = await db.collection("users").doc(playerId).get();
          if (doc.exists) {
            const cloudBal = doc.data().balance;
            if (cloudBal !== undefined && cloudBal > balance) {
              balance = cloudBal;
              localStorage.setItem('sicbo_balance', balance);
            } else if (cloudBal !== undefined && balance > cloudBal) {
              saveData(); // æœ¬åœ°è´æ¯”è¼ƒå¤šï¼Œè£œå‚³é›²ç«¯
            }
          }
        } catch (e) { console.log("é›¢ç·šæ¨¡å¼"); }
      }
      updateUI();

      // 3. æ‰‹æ©Ÿè·³è½‰æ””æˆª
      document.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', (e) => {
          const href = link.getAttribute('href');
          if (href && href !== '#' && !href.startsWith('javascript')) {
            e.preventDefault();
            syncAndRedirect(href);
          }
        });
      });
    };

    // æœ€çµ‚ä¿éšªï¼šæ»‘æ‰é é¢å­˜æª”
    window.addEventListener('pagehide', () => {
      localStorage.setItem('sicbo_balance', balance);
      saveData();
    });

    // --- è³½é¦¬éŠæˆ²é‚è¼¯ ---
    function applyHorseStyles() {
      for (let i = 1; i <= 6; i++) {
        const horseEl = document.getElementById('h' + i);
        if (horseEl) horseEl.querySelector('.horse-body').style.filter = horseConfigs[i - 1].filter;
      }
    }

    function stopAllBGM() {
      bgmList.forEach(id => { if (id) { const a = document.getElementById(id); a.pause(); a.muted = true; a.currentTime = 0; } });
    }

    function cycleBGM() {
      if (!isAudioUnlocked) return;
      stopAllBGM();
      currentBgmIdx = (currentBgmIdx + 1) % 4;
      const btn = document.getElementById('bgmBtn');
      if (currentBgmIdx === 0) btn.textContent = 'ğŸµ éŸ³æ¨‚ï¼šé—œ';
      else {
        btn.textContent = 'ğŸµ éŸ³æ¨‚ ' + currentBgmIdx;
        if (!isMuted) {
          const bgm = document.getElementById(bgmList[currentBgmIdx]);
          if (bgm) { bgm.muted = false; bgm.volume = 0.3; bgm.play().catch(() => { }); }
        }
      }
    }

    function toggleMute() {
      isMuted = !isMuted;
      document.getElementById('muteBtn').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      if (isMuted) stopAllBGM();
      else if (currentBgmIdx !== 0 && isAudioUnlocked) {
        const bgm = document.getElementById(bgmList[currentBgmIdx]);
        if (bgm) { bgm.muted = false; bgm.play().catch(() => { }); }
      }
    }

    function unlockAudio() {
      if (isAudioUnlocked) return;
      const audios = document.querySelectorAll('audio');
      audios.forEach(a => { a.muted = true; let p = a.play(); if (p !== undefined) { p.then(() => { a.pause(); a.currentTime = 0; }).catch(() => { }); } });
      isAudioUnlocked = true;
      setTimeout(() => { if (!isMuted && currentBgmIdx !== 0) { const bgm = document.getElementById(bgmList[currentBgmIdx]); if (bgm) { bgm.muted = false; bgm.volume = 0.3; bgm.play().catch(() => { }); } } }, 300);
    }
    document.addEventListener('click', unlockAudio);

    function setBet(amt) {
      if (isRacing) return;
      if (amt === 'half') {
        currentBet = Math.floor(balance / 2);
      } else {
        currentBet = amt;
      }
      
      document.querySelectorAll('.chip').forEach(c => {
        if (amt === 'allin') c.classList.toggle('active', c.id === 'chipAllIn');
        else if (amt === 'half') c.classList.toggle('active', c.id === 'chipHalfIn');
        else {
          let val = parseInt(c.innerText.replace('K', '000'));
          c.classList.toggle('active', val === amt);
        }
      });
    }

    function generateNewOdds() {
      let totalVisiblePower = 0;
      let rawScores = [];
      // ä¿æŒä½ åŸæœ¬çš„å¼·å¼±åˆ†å¸ƒæ¨¡æ¿
      let templates = [{ min: 4, max: 5 }, { min: 3, max: 5 }, { min: 2, max: 4 }, { min: 2, max: 4 }, { min: 1, max: 3 }, { min: 1, max: 2 }];
      templates.sort(() => Math.random() - 0.5);

      for (let i = 1; i <= 6; i++) {
        let t = templates[i - 1];
        let speed = Math.floor(Math.random() * (t.max - t.min + 1)) + t.min;
        let burst = Math.floor(Math.random() * (t.max - t.min + 1)) + t.min;
        let stamina = Math.floor(Math.random() * 5) + 1;

        // è¨ˆç®—å¸³é¢æˆ°åŠ› (ç”¨æ–¼åŸºæº–è³ ç‡)
        let visiblePower = (Math.pow(speed, 3.5) + Math.pow(burst, 3.8) + Math.pow(stamina, 1.5));

        // ç”Ÿæˆéš±è—ç‹€æ…‹æ³¢å‹• (0.90 ~ 1.10)
        let hiddenCondition = 0.90 + (Math.random() * 0.20);

        // ç¢ºå®šè¦–è¦ºåŒ–åœ–ç¤º (ä¸åŒ…å«èª¤å°æ©Ÿç‡)
        let mood = "æ™®â­é€š";
        if (hiddenCondition >= 1.05) mood = "ç«ğŸ”¥ç†±";
        else if (hiddenCondition <= 0.95) mood = "ç–²ğŸ’¤ç´¯";

        rawScores.push({ id: i, speed, burst, stamina, visiblePower, hiddenCondition, mood });
        totalVisiblePower += visiblePower;
      }

      // æ‰¾å‡ºå…¨å ´æœ€å¼·èˆ‡ç¬¬äºŒå¼·ï¼Œç”¨æ–¼è¨ˆç®— Gap
      let sortedScores = [...rawScores].sort((a, b) => b.visiblePower - a.visiblePower);
      let top1 = sortedScores[0];
      let top2 = sortedScores[1];

      rawScores.forEach(s => {
        let winProb = s.visiblePower / totalVisiblePower;
        let baseOdds = (1 / winProb) * 0.88;

        // å¼·é¦¬å‹•æ…‹è³ ç‡å£“åˆ¶é‚è¼¯
        if (s.id === top1.id) {
          let gap = top1.visiblePower / top2.visiblePower;
          if (gap > 2.0) {
            baseOdds = 1.1 + (Math.random() * 0.15); // ä¸€å¼·ç¨å¤§ï¼šè³ ç‡æ¥µä½
          } else if (gap > 1.4) {
            baseOdds = 1.3 + (Math.random() * 0.2);  // äº›å¾®å„ªå‹¢
          } else {
            baseOdds = Math.max(baseOdds, 1.5);      // é›™é›„ç«¶çˆ­
          }
        }

        let finalOdds = Math.max(1.05, Math.min(99.0, parseFloat(baseOdds.toFixed(1))));

        // å­˜å…¥ horseStats (åŒ…å« condition èˆ‡ mood)
        horseStats[s.id] = {
          speed: s.speed,
          burst: s.burst,
          stamina: s.stamina,
          odds: finalOdds.toFixed(1),
          condition: s.hiddenCondition, // å½±éŸ¿ startRace çš„é€Ÿåº¦
          mood: s.mood // ç”¨æ–¼ä»‹é¢é¡¯ç¤º
        };
      });
    }

    function refreshOdds() {
      const grid = document.getElementById('betGrid');
      grid.innerHTML = '';
      for (let i = 1; i <= 6; i++) {
        let s = horseStats[i];
        grid.innerHTML += `
  <button class="bet-btn ${selectedHorse === i ? 'active' : ''}" onclick="selectHorse(${i})">
    <span class="mood-icon">${s.mood}</span> ${i}è™Ÿ 
    <span>1:${s.odds}</span>
    <small>ğŸ’¨${s.speed} âš¡${s.burst} ğŸ–${s.stamina}</small>
  </button>
`;
      }
    }

    function selectHorse(num) { if (!isRacing) { selectedHorse = num; refreshOdds(); } }

    function spawnStatus(horseEl, text, type) {
      const pop = document.createElement('div'); pop.className = `status-pop pop-${type}`; pop.innerText = text;
      horseEl.appendChild(pop); setTimeout(() => pop.remove(), 2000);
    }

    function startRace() {
      if (isRacing || selectedHorse === null) {
        if (selectedHorse === null) showMsg("è«‹å…ˆé¸æ“‡é¦¬åŒ¹");
        return;
      }

      let finalBetAmount;
      if (currentBet === 'allin') {
        finalBetAmount = balance;
      } else {
        // å¦‚æœæ˜¯ 'half'ï¼Œåœ¨ setBet æ™‚å·²ç¶“ç®—å¥½å­˜å…¥ currentBet äº†ï¼Œæˆ–è€…æ˜¯å›ºå®šçš„ K æ•¸
        finalBetAmount = currentBet;
      }

      if (balance <= 0) { showMsg("ä½ å·²ç¶“æ²’éŒ¢äº†"); return; }
      if (balance < finalBetAmount) { showMsg("é¤˜é¡ä¸è¶³"); return; }

      // --- è³‡æ–™å®‰å…¨ä¿®æ”¹ï¼šæ‰£éŒ¢å¾Œç«‹å³åŒæ­¥ ---
      balance -= finalBetAmount;
      updateUI();
      saveData();
      // ----------------------------------

      isRacing = true;
      document.getElementById('goBtn').disabled = true;

      const myHorseEl = document.getElementById('h' + selectedHorse);
      myHorseEl.classList.add('my-horse');

      if (!isMuted && isAudioUnlocked) {
        const raceSnd = document.getElementById('sndRace');
        raceSnd.muted = false; raceSnd.play().catch(() => { });
      }

      const horses = [1, 2, 3, 4, 5, 6].map(n => {
        const el = document.getElementById('h' + n);
        el.classList.add('running');
        const s = horseStats[n];
        return {
          id: n, el: el, pos: 10,
          speed: s.speed, burst: s.burst, stamina: s.stamina,
          condition: s.condition,
          dashCount: 0, maxDashes: s.stamina + 2,
          isFatigued: false, hasChecked: false
        };
      });

      const trackWidth = document.getElementById('track').clientWidth - 110;

      const timer = setInterval(() => {
        let finished = false;
        horses.forEach(h => {
          if (h.pos > trackWidth * 0.85 && !h.hasChecked) {
            h.hasChecked = true;
            if (Math.random() < (6 - h.stamina) * 0.12) {
              h.isFatigued = true;
              spawnStatus(h.el, "åŠ›ç«­!!", "tired");
              h.el.classList.add('fatigued');
            }
          }

          let dashBonus = 0;
          if (!h.isFatigued && h.dashCount < h.maxDashes) {
            if (Math.random() < (0.01 + h.burst * 0.008)) {
              h.dashCount++;
              let minStep = 10 + (h.burst * 3);
              dashBonus = minStep + (Math.random() * (45 - minStep));
              // æ¢å¾©ç‰ˆæœ¬ 1 çš„è±å¯Œæç¤ºæ–‡å­—
              spawnStatus(h.el, dashBonus > 35 ? "å¤§è¡åˆº!" : "å°åŠ é€Ÿ", "dash");
            }
          }

          let fatigueFactor = h.isFatigued ? 0.3 : 1.0;
          let baseSpeedValue = (1.1 + (h.speed * 0.15)) * h.condition;
          let baseStep = (baseSpeedValue * fatigueFactor + (Math.random() * 4.0)) * 0.5;
          let step = baseStep + (dashBonus * 0.22);

          h.pos += step;
          h.el.style.left = h.pos + 'px';

          let animSpeed = Math.max(0.1, 0.6 - (step / 6));
          h.el.style.setProperty('--speed', animSpeed + 's');

          if (h.pos >= trackWidth && !finished) {
            finished = true;
            clearInterval(timer);
            finishRace(h.id, finalBetAmount);
          }
        });
      }, 50);
    }

    function finishRace(winnerId, betPlaced) {
      setTimeout(() => {
        if (selectedHorse === winnerId) {
          let winAmt = Math.floor(betPlaced * horseStats[winnerId].odds);
          balance += winAmt;
          showMsg(`ğŸŠ ${winnerId}è™Ÿç²å‹ ğŸŠ<br>è´å¾— $${winAmt.toLocaleString()}`);
          if (!isMuted && isAudioUnlocked) { document.getElementById('sndWin').muted = false; document.getElementById('sndWin').play().catch(() => { }); }

          // --- æ¯æ¬¡è´éŒ¢éƒ½å¯«å…¥ç´€éŒ„ ---
          if (winAmt > 0) {
            db.collection("horse_wins").add({
              name: localStorage.getItem('player_name') || 'ç„¡åé¨å£«',
              win: winAmt,
              time: firebase.firestore.FieldValue.serverTimestamp()
            }).catch(e => console.error("ç´€éŒ„å¯«å…¥å¤±æ•—", e));
          }
        } else {
          showMsg(`${winnerId}è™Ÿç²å‹<br>`);
        }

        // çµç®—å¾Œç«‹å³åŒæ­¥é¤˜é¡åˆ°é›²ç«¯
        saveData();

        setTimeout(() => {
          for (let i = 1; i <= 6; i++) { const el = document.getElementById('h' + i); el.style.left = '10px'; el.classList.remove('running', 'fatigued', 'my-horse'); }
          isRacing = false; document.getElementById('goBtn').disabled = false;
          document.getElementById('msgOverlay').style.display = 'none';
          selectedHorse = null; generateNewOdds(); refreshOdds(); updateUI();
        }, 3000);
      }, 500);
    }

    function showMsg(text) { const overlay = document.getElementById('msgOverlay'); overlay.innerHTML = text; overlay.style.display = 'block'; }
  </script>
</body>

</html>