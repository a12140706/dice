<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
<title>è³½é¦¬å ´</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root { --gold: #ffd86b; --grass: #27ae60; --red: #ff4757; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
  
  body { 
    background: #1a0505; color: #fff; font-family: "Microsoft JhengHei", Arial; 
    height: 100dvh; width: 100vw; overflow: hidden;
    display: flex;
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
  }

  .topbar {
    height: calc(50px + env(safe-area-inset-top)); background: linear-gradient(#4a0404, #2a0202);
    display: flex; align-items: center; padding: 0 15px; gap: 10px; border-bottom: 2px solid #5c0a0a; flex-shrink: 0;
    position: absolute; top: 0; left: 0; right: 0; z-index: 10;
  }
  .sound-btn { background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 8px; border: 1px solid var(--gold); cursor: pointer; font-size: 13px; color: #fff; }
  .balance-box { background: rgba(0,0,0,0.5); border: 1px solid var(--gold); border-radius: 15px; padding: 4px 12px; color: var(--gold); font-weight: bold; font-size: 16px; }

  .race-section {
    flex: 3; display: flex; flex-direction: column;
    border-right: 2px solid #444; position: relative;
    padding-top: 50px; 
  }

  .track-area {
    flex: 1; background: var(--grass); position: relative;
    display: flex; flex-direction: column; justify-content: space-around;
    padding: 5px 0; overflow: hidden;
  }
  .lane {
    height: 15%; width: 100%; border-bottom: 1px dashed rgba(255,255,255,0.2);
    position: relative; display: flex; align-items: center;
  }
  .horse {
    position: absolute; left: 10px; font-size: 40px; transition: left 0.1s linear;
    z-index: 2; display: flex; justify-content: center; align-items: center;
  }
  .horse-body { transform: scaleX(-1); }

  .horse.fatigued { filter: drop-shadow(0 0 5px red); animation: blink 0.3s infinite; }
  @keyframes blink { 50% { opacity: 0.6; } }
  
  .status-pop {
    position: absolute; top: -35px; left: 50%; transform: translateX(-50%);
    font-size: 14px; font-weight: bold; white-space: nowrap; pointer-events: none;
    animation: popUp 1.0s ease-out forwards; z-index: 10;
  }
  .pop-dash { color: #fff176; text-shadow: 1px 1px 3px #000, 0 0 5px #f1c40f; }
  .pop-tired { color: #ff5252; text-shadow: 1px 1px 3px #000; }
  @keyframes popUp {
    0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
    15% { opacity: 1; transform: translateX(-50%) translateY(-5px); }
    80% { opacity: 1; }
    100% { opacity: 0; transform: translateX(-50%) translateY(-40px); }
  }

  .horse-num { 
    position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
    background: #000; color: #fff; font-size: 12px; padding: 1px 6px; border-radius: 10px; 
    white-space: nowrap; border: 1px solid var(--gold); z-index: 5;
  }
  .finish-line {
    position: absolute; right: 60px; top: 0; bottom: 0; width: 15px;
    background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px);
    border-left: 2px solid #ccc; z-index: 1;
  }

  .control-section {
    flex: 1.2; background: #222; display: flex; flex-direction: column;
    padding: 8px; padding-top: 50px; padding-bottom: env(safe-area-inset-bottom);
  }

  .chip-area { display: flex; justify-content: center; gap: 15px; margin-bottom: 10px; }
  .chip {
    width: 45px; height: 45px; border-radius: 50%; border: 2px dashed #fff;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: bold; background: #444; color: #fff; transition: 0.2s;
  }
  .chip.active { transform: scale(1.15); border-style: solid; border-color: var(--gold); background: #856404; box-shadow: 0 0 10px var(--gold); }
  .chip-100 { background: #2980b9; }
  .chip-500 { background: #8e44ad; }
  .chip-1000 { background: #c0392b; }
  .chip-5000 { background: #2bc049; }

  .bet-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; flex: 1; }
  .bet-btn {
    background: #333; border: 2px solid #555; border-radius: 10px; color: #fff;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-size: 16px; font-weight: bold;
  }
  .bet-btn span { color: var(--gold); font-size: 11px; margin-top: 2px; }
  .bet-btn small { font-size: 10px; color: #aaa; font-weight: normal; margin-top: 2px; }
  .bet-btn.active { border-color: var(--gold); background: #4a3a00; box-shadow: 0 0 10px var(--gold); }

  .action-area { height: 70px; display: flex; align-items: center; gap: 10px; }
  .go-btn {
    flex: 1; height: 50px; border-radius: 25px; background: var(--red);
    color: #fff; border: none; font-size: 20px; font-weight: bold; box-shadow: 0 4px 0 #8b0000;
  }
  .go-btn:disabled { background: #555; box-shadow: none; transform: translateY(2px); }

  #msgOverlay {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.85); padding: 20px 40px; border-radius: 20px;
    color: var(--gold); font-size: 28px; font-weight: bold; display: none; z-index: 100;
    border: 2px solid var(--gold); text-align: center; pointer-events: none;
    text-shadow: 0 0 10px #f00;
  }

  @keyframes gallop {
    0% { transform: scaleX(-1) translateY(0) rotate(0deg); }
    50% { transform: scaleX(-1) translateY(-3px) rotate(-2deg); }
    100% { transform: scaleX(-1) translateY(0) rotate(0deg); }
  }
  .horse.running .horse-body { animation: gallop var(--speed, 0.8s) infinite ease-in-out; }

  @media (orientation: portrait) {
    .portrait-tip {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh;
      background: #1a0505; z-index: 999; display: flex; flex-direction: column;
      justify-content: center; align-items: center; text-align: center;
    }
  }
  @media (orientation: landscape) { .portrait-tip { display: none; } }
</style>
</head>
<body>

<div class="portrait-tip">
  <div style="font-size: 50px;">ğŸ”„</div>
  <p style="margin-top: 20px;">æ©«è‘—ç©</p>
</div>

<div class="topbar">
  <div class="sound-btn" onclick="toggleMute()" id="muteBtn">ğŸ”Š</div>
  <div class="sound-btn" onclick="cycleBGM()" id="bgmBtn">ğŸµ éŸ³æ¨‚ 1</div>
  <div class="balance-box">ğŸ’° <span id="balanceText">0</span></div>
  <marquee style="flex:1; color:var(--gold); font-size: 12px;">æœ‰å•é¡Œæ‰¾é˜¿è¨˜</marquee>
  <a href="index.html" style="text-decoration:none;">
    <button style="background:none; border:1px solid #777; color:#ccc; border-radius:5px; padding:5px 12px; font-size:14px; font-weight:bold;">ğŸ  å›å¤§å»³</button>
  </a>
</div>

<div class="race-section">
  <div id="msgOverlay"></div>
  <div class="track-area" id="track">
    <div class="finish-line"></div>
    <div class="lane"><div class="horse" id="h1"><span class="horse-num">1</span><div class="horse-body">ğŸ</div></div></div>
    <div class="lane"><div class="horse" id="h2"><span class="horse-num">2</span><div class="horse-body">ğŸ¦“</div></div></div>
    <div class="lane"><div class="horse" id="h3"><span class="horse-num">3</span><div class="horse-body">ğŸ¦„</div></div></div>
    <div class="lane"><div class="horse" id="h4"><span class="horse-num">4</span><div class="horse-body">ğŸ</div></div></div>
    <div class="lane"><div class="horse" id="h5"><span class="horse-num">5</span><div class="horse-body">ğŸ</div></div></div>
    <div class="lane"><div class="horse" id="h6"><span class="horse-num">6</span><div class="horse-body">ğŸ</div></div></div>
  </div>
</div>

<div class="control-section">
  <div class="chip-area">
    <div class="chip chip-100 active" id="chip100" onclick="setBet(100)">100</div>
    <div class="chip chip-500" id="chip500" onclick="setBet(500)">500</div>
    <div class="chip chip-1000" id="chip1000" onclick="setBet(1000)">1K</div>
    <div class="chip chip-5000" id="chip5000" onclick="setBet(5000)">5K</div>
  </div>
  <div class="bet-grid" id="betGrid"></div>
  <div class="action-area">
    <button id="goBtn" class="go-btn" onclick="startRace()">é–‹è·‘</button>
  </div>
</div>

<audio id="sndRace" src="https://assets.mixkit.co/active_storage/sfx/2045/2045-preview.mp3" preload="auto"></audio>
<audio id="sndWin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
<audio id="bgm1" src="background-music-434612.mp3" loop preload="auto"></audio>
<audio id="bgm2" src="soft-background-music-427252.mp3" loop preload="auto"></audio>
<audio id="bgm3" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" loop preload="auto"></audio>

<script>
let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
let selectedHorse = null;
let currentBet = 100;
let isRacing = false;
let isMuted = false;
let horseStats = []; 
let isAudioUnlocked = false; 

let currentBgmIdx = 1;
const bgmList = [null, 'bgm1', 'bgm2', 'bgm3'];

const horseConfigs = [
    { filter: 'hue-rotate(0deg)' },           
    { filter: 'grayscale(100%)' },           
    { filter: 'hue-rotate(280deg)' },         
    { filter: 'hue-rotate(50deg) brightness(1.3)' }, 
    { filter: 'hue-rotate(180deg)' },         
    { filter: 'invert(100%) brightness(1.5)' } 
];

function updateUI() {
  document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString();
}

function applyHorseStyles() {
    for (let i = 1; i <= 6; i++) {
        const horseEl = document.getElementById('h' + i);
        if (horseEl) {
            const body = horseEl.querySelector('.horse-body');
            body.style.filter = horseConfigs[i-1].filter;
        }
    }
}

function stopAllBGM() {
    bgmList.forEach(id => {
        if (id) {
            const a = document.getElementById(id);
            a.pause(); a.muted = true; a.currentTime = 0;
        }
    });
}

function cycleBGM() {
    if (!isAudioUnlocked) return;
    stopAllBGM();
    currentBgmIdx = (currentBgmIdx + 1) % 4;
    const btn = document.getElementById('bgmBtn');
    if (currentBgmIdx === 0) btn.textContent = 'ğŸµ éŸ³æ¨‚ï¼šé—œ';
    else {
        btn.textContent = 'ğŸµ éŸ³æ¨‚ ' + currentBgmIdx;
        if (!isMuted) {
            const bgm = document.getElementById(bgmList[currentBgmIdx]);
            if(bgm) { bgm.muted = false; bgm.volume = 0.3; bgm.play().catch(()=>{}); }
        }
    }
}

function toggleMute() {
    isMuted = !isMuted;
    document.getElementById('muteBtn').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
    if (isMuted) stopAllBGM();
    else if (currentBgmIdx !== 0 && isAudioUnlocked) {
        const bgm = document.getElementById(bgmList[currentBgmIdx]);
        if(bgm) { bgm.muted = false; bgm.play().catch(()=>{}); }
    }
}

function unlockAudio() {
    if (isAudioUnlocked) return;
    const audios = document.querySelectorAll('audio');
    audios.forEach(a => {
        a.muted = true; 
        let p = a.play();
        if (p !== undefined) { p.then(() => { a.pause(); a.currentTime = 0; }).catch(() => {}); }
    });
    isAudioUnlocked = true;
    setTimeout(() => {
        if (!isMuted && currentBgmIdx !== 0) {
            const bgm = document.getElementById(bgmList[currentBgmIdx]);
            if (bgm) { bgm.muted = false; bgm.volume = 0.3; bgm.play().catch(() => {}); }
        }
    }, 300);
    document.removeEventListener('click', unlockAudio);
    document.removeEventListener('touchstart', unlockAudio);
}
document.addEventListener('click', unlockAudio);
document.addEventListener('touchstart', unlockAudio);

function setBet(amt) {
  if (isRacing) return;
  currentBet = amt;
  document.querySelectorAll('.chip').forEach(c => {
    let val = parseInt(c.innerText.replace('K','000'));
    c.classList.toggle('active', val === amt);
  });
}

function refreshOdds() {
  const grid = document.getElementById('betGrid');
  grid.innerHTML = '';
  for (let i = 1; i <= 6; i++) {
    let s = horseStats[i];
    grid.innerHTML += `
      <button class="bet-btn ${selectedHorse === i ? 'active' : ''}" onclick="selectHorse(${i})">
        ${i} è™Ÿ
        <span>è³ ç‡ 1:${s.odds}</span>
        <small>é€Ÿ${s.speed} çˆ†âš¡${s.burst} è€ğŸ–${s.stamina}</small>
      </button>
    `;
  }
}

function generateNewOdds() {
  let totalFieldScore = 0;
  let scores = [];
  
  // 1. å®šç¾©ã€Œå‘½é‹æ¨¡æ¿ã€ï¼šç¢ºä¿ä¸€å±€è£¡é¢æœ‰å¼·ã€æœ‰ä¸­ã€æœ‰å¼±
  // æ¨¡æ¿ï¼š[é ‚å°–, å„ªç­‰, æ™®é€š, æ™®é€š, åå¼±, æ¥µå¼±]
  let templates = [
    {min: 4, max: 5}, {min: 3, max: 5}, {min: 2, max: 4}, 
    {min: 2, max: 4}, {min: 1, max: 3}, {min: 1, max: 2}
  ];
  
  // éš¨æ©Ÿæ´—ç‰Œæ¨¡æ¿ï¼Œè®“æ¯ä¸€å±€å¼·é¦¬çš„ä½ç½®ä¸ä¸€æ¨£
  templates.sort(() => Math.random() - 0.5);

  for (let i = 1; i <= 6; i++) {
    let t = templates[i-1];
    
    // æ ¹æ“šæ¨¡æ¿éš¨æ©Ÿå±¬æ€§
    let speed = Math.floor(Math.random() * (t.max - t.min + 1)) + t.min;
    let burst = Math.floor(Math.random() * (t.max - t.min + 1)) + t.min;
    let stamina = Math.floor(Math.random() * (t.max - t.min + 1)) + t.min;
    
    // è¨ˆç®—æˆ°é¬¥åŠ› (åŠ é‡çˆ†ç™¼åŠ›ï¼Œè®“å®ƒæˆç‚ºè®Šæ•¸)
    let power = (speed * 3) + (burst * 5.0) + (stamina * 2.0);
    
    scores.push({ id: i, speed, burst, stamina, power });
    totalFieldScore += power;
  }

  // 2. æ ¹æ“šã€Œç›¸å°å¼·åº¦ã€åˆ†é…è³ ç‡
  scores.forEach(s => {
    let powerShare = s.power / totalFieldScore;
    
    // è³ ç‡ = (1 / ä½”æ¯”) * æŠ½æ°´
    // æŠ½æ°´ä¿‚æ•¸æ”¹ç‚º 0.9ï¼Œè®“æ•¸å­—æ›´æ¼‚äº®
    let rawOdds = (1 / powerShare) * 0.9; 

    // å¢åŠ æ³¢å‹•ï¼Œè®“åŒæ¨£æ˜¯ã€Œå¼·é¦¬ã€çš„è³ ç‡æ¯æ¬¡ä¹Ÿä¸ä¸€æ¨£
    let noise = (Math.random() * 1.5 - 0.75);
    let finalOdds = (rawOdds + noise).toFixed(1);

    // 3. é™åˆ¶ä¸Šä¸‹é™ï¼Œç¢ºä¿ä¸æœƒå‡ºç¾ 0 æˆ–æ˜¯è² æ•¸
    if (finalOdds < 1.3) finalOdds = (1.3 + Math.random() * 0.4).toFixed(1);
    if (finalOdds > 50.0) finalOdds = (40.0 + Math.random() * 20).toFixed(1);

    horseStats[s.id] = { 
      speed: s.speed, 
      burst: s.burst, 
      stamina: s.stamina, 
      odds: finalOdds, 
      dashCount: 0 
    };
  });
}

function selectHorse(num) {
  if (isRacing) return;
  selectedHorse = num;
  document.querySelectorAll('.bet-btn').forEach((btn, idx) => {
    btn.classList.toggle('active', (idx + 1) === num);
  });
}

function spawnStatus(horseEl, text, type) {
    const pop = document.createElement('div');
    pop.className = `status-pop pop-${type}`;
    pop.innerText = text;
    horseEl.appendChild(pop);
    setTimeout(() => pop.remove(), 2000);
}

function startRace() {
  if (isRacing || selectedHorse === null) {
    if (selectedHorse === null) showMsg("è«‹å…ˆé¸æ“‡é¦¬åŒ¹");
    return;
  }
  if (balance < currentBet) { showMsg("é¤˜é¡ä¸è¶³"); return; }

  balance -= currentBet;
  updateUI();
  isRacing = true;
  document.getElementById('goBtn').disabled = true;
  
  if(!isMuted && isAudioUnlocked) {
      const raceSnd = document.getElementById('sndRace');
      raceSnd.muted = false; raceSnd.play().catch(()=>{});
  }

  const horses = [1, 2, 3, 4, 5, 6].map(n => {
    const el = document.getElementById('h' + n);
    el.classList.add('running');
    const s = horseStats[n];
    return { 
        id: n, el: el, pos: 10, 
        speed: s.speed, burst: s.burst, stamina: s.stamina,
        dashCount: 0, maxDashes: s.stamina,
        isFatigued: false, hasChecked: false 
    };
  });

  const trackWidth = document.getElementById('track').clientWidth - 110;

  const timer = setInterval(() => {
    let finished = false;
    horses.forEach(h => {
      let fatigueFactor = 1.0;
      let dashBonus = 0;

      // 1. åŸºç¤é€Ÿåº¦åŸºå€¼æ‹‰è¿‘ï¼š
      // é€Ÿåº¦ 1: 1.2
      // é€Ÿåº¦ 5: 1.6 
      // å·®è·è®Šå¾—å¾ˆå°
      let baseSpeedValue = 1.1 + (h.speed * 0.2);

      if (h.pos > trackWidth * 0.85 && !h.hasChecked) {
          h.hasChecked = true;
          if (Math.random() < (6 - h.stamina) * 0.12) {
              h.isFatigued = true;
              spawnStatus(h.el, "åŠ›ç«­!!", "tired");
              h.el.classList.add('fatigued');
          }
      }

      // 2. çˆ†ç™¼åŠ›å®Œå…¨ç¨ç«‹ï¼š
      // ä¸ç®¡åŸºç¤é€Ÿåº¦ï¼Œçˆ†ç™¼ 5 å°±æ˜¯åŠ å¾ˆå¤§ï¼Œçˆ†ç™¼ 1 å°±æ˜¯åŠ å¾ˆå°‘
      if (!h.isFatigued && h.dashCount < h.maxDashes) {
          // çˆ†ç™¼é »ç‡ï¼šçˆ†ç™¼ç­‰ç´šè¶Šé«˜ï¼Œè¶Šå®¹æ˜“è¡åˆº
          if (Math.random() < (h.burst * 0.012)) {
              h.dashCount++;
              // çˆ†ç™¼åŠ æˆå…¬å¼ï¼šç›´æ¥ç”¨ Burst ç­‰ç´šç®—ï¼Œä¸ä¹˜åŸºç¤é€Ÿåº¦
              dashBonus = (h.burst * 14) + (Math.random() * 10); 
              spawnStatus(h.el, h.burst >= 4 ? "è¶…ç´šåŠ é€Ÿ!!" : "åŠ é€Ÿ", "dash");
          }
      }

      if (h.isFatigued) fatigueFactor = 0.3;
      
      // è¨ˆç®—æœ€çµ‚æ­¥é•·
      let baseStep = (baseSpeedValue * fatigueFactor + (Math.random() * 4.0)) * 0.5;
      let step = baseStep + (dashBonus * 0.22); 
      
      h.pos += step;
      h.el.style.left = h.pos + 'px';
      
      let animSpeed = Math.max(0.1, 0.6 - (step / 6));
      h.el.style.setProperty('--speed', animSpeed + 's');

      if (h.pos >= trackWidth && !finished) {
        finished = true;
        clearInterval(timer);
        finishRace(h.id);
      }
    });
  }, 50);
}

function finishRace(winnerId) {
  setTimeout(() => {
    if (selectedHorse === winnerId) {
      let winAmt = Math.floor(currentBet * horseStats[winnerId].odds);
      balance += winAmt;
      showMsg(`ğŸŠ ${winnerId}è™Ÿç²å‹ ğŸŠ<br>è´å¾— $${winAmt.toLocaleString()}`);
      if(!isMuted && isAudioUnlocked) {
          const winSnd = document.getElementById('sndWin');
          winSnd.muted = false; winSnd.play().catch(()=>{});
      }
    } else {
      showMsg(`${winnerId}è™Ÿç²å‹<br>å†æ¥å†å²ï¼`);
    }
    
    setTimeout(() => {
      horsesReset();
      isRacing = false;
      document.getElementById('goBtn').disabled = false;
      document.getElementById('msgOverlay').style.display = 'none';
      selectedHorse = null;
      generateNewOdds(); 
      refreshOdds();
      updateUI();
      localStorage.setItem('sicbo_balance', balance);
    }, 3000);
  }, 500);
}

function horsesReset() {
  for(let i=1; i<=6; i++) {
    const el = document.getElementById('h'+i);
    el.style.left = '10px';
    el.classList.remove('running', 'fatigued');
  }
}

function showMsg(text) {
  const overlay = document.getElementById('msgOverlay');
  overlay.innerHTML = text;
  overlay.style.display = 'block';
}

document.addEventListener('click', function(e) {
  let target = e.target.closest('a');
  if (target) {
    const href = target.getAttribute('href');
    if (href) window.location.href = href;
  }
}, false);

window.onload = () => {
    generateNewOdds(); 
    refreshOdds();
    updateUI();
    applyHorseStyles();
};
</script>
</body>
</html>