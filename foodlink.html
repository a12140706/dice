<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
    <title>ç”œé»é€£é€£çœ‹ - å¨›æ¨‚åŸç‰ˆ</title>
    <style>
        :root { --table-green: #0a5c32; --gold: #ffd86b; --bg-dark: #05140b; --tile-size: 54px; --tile-gap: 5px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; touch-action: manipulation; }
        
        body { height: 100dvh; width: 100vw; font-family: "Microsoft JhengHei", Arial; background: var(--bg-dark); color: #fff; display: flex; flex-direction: column; overflow: hidden; }

        /* æ©«å‘æç¤º */
        @media (orientation: portrait) {
            .portrait-tip { position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh; background: #1a0505; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        }
        @media (orientation: landscape) { .portrait-tip { display: none; } }

        /* é ‚éƒ¨æ¬„ */
        .topbar { 
            height: 50px; background: linear-gradient(#4a0404, #2a0202); display: flex; align-items: center; 
            padding: 0 calc(15px + env(safe-area-inset-right)) 0 calc(15px + env(safe-area-inset-left));
            gap: 12px; border-bottom: 2px solid #5c0a0a; flex-shrink: 0; 
        }
        .btn-tool { background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 8px; border: 1px solid var(--gold); cursor: pointer; font-size: 13px; color: var(--gold); white-space: nowrap; }
        .balance-box { background: rgba(0,0,0,0.5); border: 1px solid var(--gold); border-radius: 15px; padding: 4px 15px; color: var(--gold); font-weight: bold; font-size: 16px; }

        /* éŠæˆ²å€åŸŸ */
        .main-layout { flex: 1; display: flex; justify-content: center; align-items: center; padding: 10px; position: relative; }
        #game-board { 
            display: grid; grid-template-columns: repeat(10, var(--tile-size)); grid-template-rows: repeat(6, var(--tile-size)); 
            gap: var(--tile-gap); padding: 12px; background: var(--table-green); border: 4px solid #084325; border-radius: 15px; box-shadow: inset 0 0 50px rgba(0,0,0,0.5); position: relative;
        }
        .slot { position: relative; width: var(--tile-size); height: var(--tile-size); }
        .tile { position: absolute; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; font-size: 30px; border-radius: 6px; transition: transform 0.2s; user-select: none; z-index: 10; }
        .layer-1 { background: #334155; box-shadow: 0 3px 6px rgba(0,0,0,0.4); border: 1px solid #475569; }
        .layer-0.covered { background: #1e293b; border: 1px dashed #475569; transform: scale(0.9); }
        .layer-0.unlocked { background: rgba(255,255,255,0.15); transform: scale(1); }
        .selected { outline: 3px solid #fff; transform: scale(1.1); z-index: 20 !important; background: #64748b !important; }

        /* å‹•ç•«å…ƒç´  */
        #line-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .floating-score { position: absolute; font-weight: bold; font-size: 24px; pointer-events: none; z-index: 500; animation: floatUp 0.7s ease-out forwards; text-shadow: 0 2px 4px #000; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-60px); opacity: 0; } }
        
        #shuffle-toast { position: fixed; top: 65px; left: 50%; transform: translateX(-50%); background: var(--gold); color: #000; padding: 6px 20px; border-radius: 20px; font-weight: bold; opacity: 0; transition: opacity 0.3s; z-index: 200; }

        /* çµç®—ç•«é¢ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .modal-content { background: #1a1a1a; border: 2px solid var(--gold); padding: 40px; border-radius: 20px; text-align: center; width: 340px; }
        .btn-collect { background: var(--gold); border: none; padding: 15px 40px; border-radius: 10px; font-weight: bold; font-size: 20px; cursor: pointer; margin-top: 20px; }

        /* ç‰¹æ•ˆé¡è‰² */
        .heart-gold { filter: drop-shadow(0 0 8px #fbbf24); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% {transform:scale(1)} 50% {transform:scale(1.05)} }
    </style>
</head>
<body>

<div class="portrait-tip">
    <div style="font-size: 50px;">ğŸ”„</div>
    <p style="margin-top: 20px; color:#fff;">è«‹æ—‹è½‰æ‰‹æ©Ÿæ©«å‘éŠç©</p>
</div>

<audio id="sndChip" src="https://assets.mixkit.co/active_storage/sfx/3005/3005-preview.mp3" preload="auto"></audio>
<audio id="sndWin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
<audio id="bgm1" src="background-music-434612.mp3" loop preload="auto"></audio>
<audio id="bgm2" src="soft-background-music-427252.mp3" loop preload="auto"></audio>
<audio id="bgm3" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" loop preload="auto"></audio>

<div class="topbar">
    <div class="btn-tool" onclick="toggleMute()" id="soundIcon">ğŸ”Š</div>
    <div class="btn-tool" onclick="cycleBGM()" id="bgmBtn">ğŸµ éŸ³æ¨‚ 1</div>
    <div class="balance-box">ğŸ’° <span id="balanceText">0</span></div>
    <div style="flex:1; text-align:right;">
        <button class="btn-tool" onclick="initMap()" style="margin-right:5px;">é‡æ–°é–‹å§‹</button>
        <button class="btn-tool" onclick="location.href='index.html'" style="background:none; border-color:#777;">ğŸ  å›å¤§å»³</button>
    </div>
</div>

<div id="shuffle-toast">ç„¡è§£ï¼Œè‡ªå‹•é‡æ’ä¸­...</div>

<div class="main-layout">
    <div id="game-board">
        <canvas id="line-canvas"></canvas>
    </div>
</div>

<div id="settle-screen" class="modal">
    <div class="modal-content">
        <h1 style="color:var(--gold); margin-bottom:10px;">ğŸ‰ éé—œå¤§å‰!</h1>
        <p id="reward-text" style="color:#fff; font-size:18px; line-height:1.8;"></p>
        <button class="btn-collect" onclick="closeSettle()">é ˜å–é‡‘å¹£</button>
    </div>
</div>

<script>
    // --- åˆå§‹åŒ–è®Šæ•¸ ---
    const ROWS = 6, COLS = 10, LAYERS = 2;
    const DESSERTS = ['ğŸ“','ğŸ','ğŸ°','ğŸ‡','ğŸ¬','ğŸ­','ğŸ©','ğŸ®','ğŸ¯','ğŸª','ğŸ§','ğŸ’'];
    let boardData = [], firstSelect = null, score = 0, tilesLeft = 0;
    
    // è®€å–éª°å¯¶å…±ç”¨é¤˜é¡ (ç¢ºä¿ key ä¸€è‡´)
    let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
    let isMuted = false;
    let currentBgmIdx = 1;
    const bgmList = [null, 'bgm1', 'bgm2', 'bgm3'];

    // --- éŸ³æ¨‚èˆ‡æ‰‹æ©Ÿè§£é–è£œä¸ ---
    function playSound(id) { 
        if (!isMuted) { const s = document.getElementById(id); if(s) { s.currentTime = 0; s.play().catch(()=>{}); } } 
    }

    function toggleMute() { isMuted = !isMuted; document.getElementById('soundIcon').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š'; }

    function cycleBGM() {
        bgmList.forEach(id => { if(id){ const a=document.getElementById(id); a.pause(); a.currentTime=0; } });
        currentBgmIdx = (currentBgmIdx + 1) % 4;
        const btn = document.getElementById('bgmBtn');
        if (currentBgmIdx === 0) { btn.textContent = 'ğŸš« éŸ³æ¨‚é—œ'; } 
        else {
            const bgm = document.getElementById(bgmList[currentBgmIdx]);
            if(bgm) { bgm.volume = 0.3; bgm.play().catch(()=>{}); btn.textContent = 'ğŸµ éŸ³æ¨‚ ' + currentBgmIdx; }
        }
    }

    document.addEventListener('click', function unlock() {
        const audios = document.querySelectorAll('audio');
        audios.forEach(a => { a.play().then(() => { a.pause(); a.currentTime = 0; }).catch(() => {}); });
        setTimeout(() => { if(currentBgmIdx === 1) { const b1 = document.getElementById('bgm1'); b1.volume = 0.3; b1.play().catch(()=>{}); } }, 150);
        document.removeEventListener('click', unlock);
    }, { once: true });

    // --- éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---
    function initMap() {
        score = 0; tilesLeft = ROWS * COLS * LAYERS;
        updateUI();
        let pool = [];
        for (let i = 0; i < (tilesLeft / 2); i++) {
            const char = DESSERTS[Math.floor(Math.random() * DESSERTS.length)];
            const style = ['ğŸ®','ğŸ¯','ğŸª','ğŸ§'].includes(char) ? 'heart-gold' : (['ğŸ‡','ğŸ¬','ğŸ­','ğŸ©'].includes(char) ? 'heart-purple' : 'heart-red');
            pool.push({char, style}, {char, style});
        }
        pool.sort(() => Math.random() - 0.5);
        boardData = [];
        for (let l = 0; l < LAYERS; l++) {
            boardData[l] = [];
            for (let r = 0; r < ROWS; r++) {
                boardData[l][r] = [];
                for (let c = 0; c < COLS; c++) { boardData[l][r][c] = { ...pool.pop(), cleared: false }; }
            }
        }
        renderBoard();
        checkDeadlock();
    }

    function renderBoard() {
        const container = document.getElementById('game-board');
        const canvas = document.getElementById('line-canvas');
        container.querySelectorAll('.slot').forEach(s => s.remove());
        canvas.width = container.clientWidth; canvas.height = container.clientHeight;

        for (let r = 0; r < ROWS; r++) {
            for (let c = 0; c < COLS; c++) {
                const slot = document.createElement('div'); slot.className = 'slot';
                for (let l = 0; l < LAYERS; l++) {
                    const data = boardData[l][r][c];
                    if (data.cleared) continue;
                    const tile = document.createElement('div');
                    const isCovered = (l === 0 && !boardData[1][r][c].cleared);
                    tile.className = `tile layer-${l} ${isCovered ? 'covered' : 'unlocked ' + data.style}`;
                    tile.innerText = isCovered ? "" : data.char;
                    tile.onclick = () => { if (!isCovered) handleSelect(l, r, c, tile); };
                    slot.appendChild(tile);
                }
                container.appendChild(slot);
            }
        }
    }

    function handleSelect(l, r, c, el) {
        if (firstSelect) {
            if (firstSelect.el === el) { el.classList.remove('selected'); firstSelect = null; return; }
            const path = getPath(firstSelect.r, firstSelect.c, r, c);
            if (firstSelect.char === boardData[l][r][c].char && path) {
                drawConnectLine(path);
                let bonus = boardData[l][r][c].style === 'heart-gold' ? 50 : (boardData[l][r][c].style === 'heart-purple' ? 20 : 10);
                showFloatingScore(firstSelect.r, firstSelect.c, bonus);
                showFloatingScore(r, c, bonus);
                
                boardData[firstSelect.l][firstSelect.r][firstSelect.c].cleared = true;
                boardData[l][r][c].cleared = true;
                score += bonus; tilesLeft -= 2;
                playSound('sndChip');
                firstSelect = null;
                setTimeout(() => { renderBoard(); if (tilesLeft === 0) showSettle(); else checkDeadlock(); }, 200);
            } else { el.classList.remove('selected'); firstSelect = null; }
        } else {
            firstSelect = { l, r, c, el, char: boardData[l][r][c].char };
            el.classList.add('selected');
        }
    }

    function drawConnectLine(path) {
        const ctx = document.getElementById('line-canvas').getContext('2d');
        ctx.lineWidth = 5; ctx.strokeStyle = '#ffd86b'; ctx.shadowBlur = 10; ctx.shadowColor = '#ffd86b';
        ctx.beginPath();
        path.forEach((p, i) => {
            const x = p.c * (54 + 5) + 27 + 12;
            const y = p.r * (54 + 5) + 27 + 12;
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();
        setTimeout(() => ctx.clearRect(0, 0, 1000, 1000), 200);
    }

    function showFloatingScore(r, c, val) {
        const f = document.createElement('div');
        f.className = 'floating-score';
        f.innerText = `+${val}`;
        f.style.left = `${c * 59 + 25}px`; f.style.top = `${r * 59 + 15}px`;
        f.style.color = val === 50 ? '#ffd86b' : '#fff';
        document.getElementById('game-board').appendChild(f);
        setTimeout(() => f.remove(), 700);
    }

    function checkDeadlock() {
        let avail = [];
        for(let l=0; l<2; l++) for(let r=0; r<6; r++) for(let c=0; c<10; c++)
            if(!boardData[l][r][c].cleared && (l===1 || boardData[1][r][c].cleared)) avail.push({r,c,l,char:boardData[l][r][c].char});
        
        let hasMove = false;
        for(let i=0; i<avail.length; i++) for(let j=i+1; j<avail.length; j++)
            if(avail[i].char === avail[j].char && getPath(avail[i].r, avail[i].c, avail[j].r, avail[j].c)) { hasMove=true; break; }
        
        if(!hasMove && tilesLeft > 0) {
            const t = document.getElementById('shuffle-toast'); t.style.opacity = '1';
            setTimeout(() => { autoShuffle(); t.style.opacity = '0'; checkDeadlock(); }, 1000);
        }
    }

    function autoShuffle() {
        let p = [];
        for(let l=0; l<2; l++) for(let r=0; r<6; r++) for(let c=0; c<10; c++) if(!boardData[l][r][c].cleared) p.push(boardData[l][r][c]);
        p.sort(() => Math.random()-0.5);
        for(let l=0; l<2; l++) for(let r=0; r<6; r++) for(let c=0; c<10; c++) if(!boardData[l][r][c].cleared) boardData[l][r][c] = p.pop();
        renderBoard();
    }

    function getPath(r1, c1, r2, c2) {
        const isEmpty = (r, c) => (r < 0 || r >= 6 || c < 0 || c >= 10 || boardData[1][r][c].cleared);
        const checkStraight = (r1, c1, r2, c2) => {
            if (r1 !== r2 && c1 !== c2) return false;
            if (r1 === r2) { for (let c = Math.min(c1, c2) + 1; c < Math.max(c1, c2); c++) if (!isEmpty(r1, c)) return false; }
            else { for (let r = Math.min(r1, r2) + 1; r < Math.max(r1, r2); r++) if (!isEmpty(r, c1)) return false; }
            return true;
        };
        if (checkStraight(r1, c1, r2, c2)) return [{r:r1, c:c1}, {r:r2, c:c2}];
        for (let i = -1; i <= 6; i++) 
            if (isEmpty(i, c1) && checkStraight(r1, c1, i, c1) && isEmpty(i, c2) && checkStraight(i, c1, i, c2) && checkStraight(i, c2, r2, c2))
                return [{r:r1, c:c1}, {r:i, c:c1}, {r:i, c:c2}, {r:r2, c:c2}];
        for (let j = -1; j <= 10; j++)
            if (isEmpty(r1, j) && checkStraight(r1, c1, r1, j) && isEmpty(r2, j) && checkStraight(r1, j, r2, j) && checkStraight(r2, j, r2, c2))
                return [{r:r1, c:c1}, {r:r1, c:j}, {r:r2, c:j}, {r:r2, c:c2}];
        return null;
    }

    function updateUI() { document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString(); }

    function showSettle() {
        playSound('sndWin');
        const reward = Math.floor(score / 10);
        balance += reward;
        localStorage.setItem('sicbo_balance', balance);
        updateUI();
        document.getElementById('reward-text').innerText = `æœ¬å±€å¾—åˆ†ï¼š${score}\nè½‰æ›é‡‘å¹£ï¼š${reward} ğŸ’°\nç•¶å‰é¤˜é¡ï¼š${Math.floor(balance)}`;
        document.getElementById('settle-screen').style.display = 'flex';
    }

    function closeSettle() { document.getElementById('settle-screen').style.display = 'none'; initMap(); }

    window.onload = initMap;
</script>
</body>
</html>