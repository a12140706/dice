<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
    <title>ç”œé»é€£é€£çœ‹ - é€²éšç‰ˆ</title>
    <style>
        :root {
            --table-green: #0a5c32;
            --gold: #ffd86b;
            --bg-dark: #05140b;
            --tile-size: 54px;
            --tile-gap: 6px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            touch-action: manipulation;
        }

        body {
            height: 100dvh;
            width: 100vw;
            font-family: "Microsoft JhengHei", Arial;
            background: var(--bg-dark);
            color: #fff;
            display: flex;
            /* æ”¹ç‚ºæ°´å¹³æ’åˆ—ï¼Œè®“ topbar ç«™åœ¨å³é‚Š */
            flex-direction: row;
            overflow: hidden;
        }

        @media (orientation: portrait) {
            .portrait-tip {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100dvh;
                background: #1a0505;
                z-index: 9999;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
            }
        }

        @media (orientation: landscape) {
            .portrait-tip {
                display: none;
            }
        }

        /* é ‚éƒ¨æ¬„ */
        .topbar {
            width: 100px;
            /* å›ºå®šå¯¬åº¦ */
            height: 100%;
            /* é«˜åº¦æ’æ»¿ */
            background: linear-gradient(to bottom, #4a0404, #2a0202);
            display: flex;
            flex-direction: column;
            /* æŒ‰éˆ•å‚ç›´æ’åˆ— */
            align-items: center;
            padding: env(safe-area-inset-top) 10px env(safe-area-inset-bottom) 10px;
            gap: 15px;
            border-left: 2px solid #5c0a0a;
            /* é‚Šæ¡†æ”¹åˆ°å·¦é‚Š */
            border-bottom: none;
            flex-shrink: 0;
            z-index: 1000;
            order: 2;
            /* å¼·åˆ¶æ’åœ¨å³é‚Š */
        }

        .btn-tool {
            width: 100%;
            text-align: center;
            padding: 10px 5px;
        }

        .balance-box {
            width: 90%;
            text-align: center;
            padding: 8px 5px;
            font-size: 12px;
        }

        /* éŠæˆ²å€åŸŸ */
        .main-layout {
            flex: 1;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            position: relative;
            order: 1;
            /* æ’åœ¨å·¦é‚Š */
        }

        #game-board {
            display: grid;
            grid-template-columns: repeat(10, var(--tile-size));
            grid-template-rows: repeat(6, var(--tile-size));
            gap: var(--tile-gap);
            padding: 15px;
            background: var(--table-green);
            border: 4px solid #084325;
            border-radius: 15px;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: visible;
        }

        /* ç•«å¸ƒå¤–æ“´ */
        #line-canvas {
            position: absolute;
            top: -35px;
            left: -35px;
            width: calc(100% + 70px);
            height: calc(100% + 70px);
            pointer-events: none;
            z-index: 500;
        }

        .slot {
            position: relative;
            width: var(--tile-size);
            height: var(--tile-size);
        }

        .tile {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            border-radius: 8px;
            transition: transform 0.15s;
            user-select: none;
            z-index: 10;
        }

        /* ä¸Šå±¤ï¼šåŠ åšåº¦æ„Ÿ */
        .layer-1 {
            background: #254879;
            box-shadow: 0 4px 0 #1a222c, 0 6px 12px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translateY(-4px);
        }

        /* ä¸‹å±¤ï¼šå¹³è²¼æ„Ÿ */
        .layer-0.unlocked {
            background: #2d3a4d;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateY(0);
        }

        .layer-0.covered {
            background: #1a222c;
            border: 1px dashed #444;
            transform: scale(0.9);
            opacity: 0.5;
        }

        /* é¸å–æ•ˆæœ */
        .selected {
            outline: 3px solid #fff;
            transform: scale(1.1) translateY(-8px) !important;
            box-shadow: 0 0 20px #fff, 0 10px 20px rgba(0, 0, 0, 0.5) !important;
            z-index: 50 !important;
        }

        /* å™´åˆ†èˆ‡å‹•ç•« */
        .floating-score {
            position: absolute;
            font-weight: bold;
            font-size: 24px;
            pointer-events: none;
            z-index: 600;
            animation: floatUp 0.7s ease-out forwards;
            text-shadow: 0 2px 4px #000;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(-60px);
                opacity: 0;
            }
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
    </style>
</head>

<body>
    <div class="portrait-tip">
        <div style="font-size: 50px;">ğŸ”„</div>
        <p style="margin-top: 20px; color:#fff; font-size: 18px;">æ©«è‘—ç©</p>
    </div>
    <div class="topbar">
        <a href="index.html" style="text-decoration:none;">
            <button
                style="background:none; border:1px solid #777; color:#ccc; border-radius:5px; padding:5px 12px; font-size:14px;">ğŸ 
                å›å¤§å»³</button>
        </a>
        <div class="btn-tool" onclick="toggleMute()" id="soundIcon">ğŸ”Š</div>
        <div class="btn-tool" onclick="cycleBGM()" id="bgmBtn" style="font-size: 11px;">ğŸµ éŸ³æ¨‚ 1</div>
        <div class="balance-box">ğŸ’°<br><span id="balanceText">0</span></div>

        <div style="flex:1;"></div>

        <button class="btn-tool" onclick="initMap()">é‡æ–°é–‹å§‹</button>

    </div>

    <div class="main-layout">
        <div id="game-board"><canvas id="line-canvas"></canvas></div>
    </div>

    <div id="settle-screen" class="modal">
        <div
            style="background:#1a1a1a; border:2px solid var(--gold); padding:40px; border-radius:20px; text-align:center;">
            <h1 style="color:var(--gold); margin-bottom:10px;">ğŸ‰ éé—œ!</h1>
            <p id="reward-text" style="color:#fff; font-size:18px; margin-bottom:20px;"></p>
            <button class="btn-tool" onclick="closeSettle()" style="padding:10px 30px; font-size:18px;">é ˜å–çå‹µ</button>
        </div>
    </div>

    <audio id="sndChip" src="https://assets.mixkit.co/active_storage/sfx/3005/3005-preview.mp3" preload="auto"></audio>
    <audio id="sndWin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
    <audio id="bgm1" src="background-music-434612.mp3" loop preload="auto"></audio>
    <audio id="bgm2" src="soft-background-music-427252.mp3" loop preload="auto"></audio>
    <audio id="bgm3" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" loop preload="auto"></audio>

    <script>
        const ROWS = 6, COLS = 10, LAYERS = 2;
        const DESSERTS = ['ğŸ“', 'ğŸ', 'ğŸ°', 'ğŸ‡', 'ğŸ¬', 'ğŸ­', 'ğŸ©', 'ğŸ®', 'ğŸ¯', 'ğŸª', 'ğŸ§', 'ğŸ’'];
        let boardData = [], firstSelect = null, score = 0, tilesLeft = 0;
        let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
        let isMuted = false;
        let currentBgmIdx = 1;
        const bgmList = [null, 'bgm1', 'bgm2', 'bgm3'];

        function playSound(id) { if (!isMuted) { const s = document.getElementById(id); if (s) { s.currentTime = 0; s.play().catch(() => { }); } } }
        function toggleMute() { isMuted = !isMuted; document.getElementById('soundIcon').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š'; }
        function cycleBGM() {
            bgmList.forEach(id => { if (id) { const a = document.getElementById(id); a.pause(); a.currentTime = 0; } });
            currentBgmIdx = (currentBgmIdx + 1) % 4;
            const btn = document.getElementById('bgmBtn');
            if (currentBgmIdx === 0) { btn.textContent = 'ğŸš« éŸ³æ¨‚é—œ'; }
            else {
                const bgm = document.getElementById(bgmList[currentBgmIdx]);
                if (bgm) { bgm.volume = 0.3; bgm.play().catch(() => { }); btn.textContent = 'ğŸµ éŸ³æ¨‚ ' + currentBgmIdx; }
            }
        }
        document.addEventListener('click', function unlock() {
            const audios = document.querySelectorAll('audio');
            audios.forEach(a => { a.play().then(() => { a.pause(); a.currentTime = 0; }).catch(() => { }); });
            setTimeout(() => { if (currentBgmIdx === 1) { const b1 = document.getElementById('bgm1'); b1.volume = 0.3; b1.play().catch(() => { }); } }, 150);
            document.removeEventListener('click', unlock);
        }, { once: true });

        function initMap() {
            score = 0; tilesLeft = ROWS * COLS * LAYERS;
            updateUI();
            let pool = [];
            for (let i = 0; i < (tilesLeft / 2); i++) {
                const char = DESSERTS[Math.floor(Math.random() * DESSERTS.length)];
                const style = ['ğŸ®', 'ğŸ¯', 'ğŸª', 'ğŸ§'].includes(char) ? 'heart-gold' : (['ğŸ‡', 'ğŸ¬', 'ğŸ­', 'ğŸ©'].includes(char) ? 'heart-purple' : 'heart-red');
                pool.push({ char, style }, { char, style });
            }
            pool.sort(() => Math.random() - 0.5);
            boardData = [];
            for (let l = 0; l < LAYERS; l++) {
                boardData[l] = [];
                for (let r = 0; r < ROWS; r++) {
                    boardData[l][r] = [];
                    for (let c = 0; c < COLS; c++) { boardData[l][r][c] = { ...pool.pop(), cleared: false }; }
                }
            }
            renderBoard();
        }

        function renderBoard() {
            const container = document.getElementById('game-board');
            const canvas = document.getElementById('line-canvas');
            container.querySelectorAll('.slot').forEach(s => s.remove());
            canvas.width = container.offsetWidth + 70; canvas.height = container.offsetHeight + 70;

            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    const slot = document.createElement('div'); slot.className = 'slot';
                    for (let l = 0; l < LAYERS; l++) {
                        const data = boardData[l][r][c];
                        if (data.cleared) continue;
                        const tile = document.createElement('div');
                        const isCovered = (l === 0 && !boardData[1][r][c].cleared);
                        tile.className = `tile layer-${l} ${isCovered ? 'covered' : 'unlocked ' + data.style}`;
                        tile.innerText = isCovered ? "" : data.char;
                        tile.onclick = (e) => { e.stopPropagation(); if (!isCovered) handleSelect(l, r, c, tile); };
                        slot.appendChild(tile);
                    }
                    container.appendChild(slot);
                }
            }
        }

        function handleSelect(l, r, c, el) {
            if (firstSelect) {
                // é»é¸åŒä¸€å€‹ï¼šç›´æ¥å–æ¶ˆ
                if (firstSelect.el === el) {
                    el.classList.remove('selected');
                    firstSelect = null;
                    return;
                }

                const path = getPath(firstSelect.r, firstSelect.c, r, c);

                // åˆ¤æ–·ï¼šåœ–æ¡ˆç›¸åŒ ä¸” è·¯å¾‘ç›¸é€š
                if (firstSelect.char === boardData[l][r][c].char && path) {
                    // ã€æˆåŠŸé€£ç·šã€‘
                    drawConnectLine(path);
                    let bonus = boardData[l][r][c].style === 'heart-gold' ? 50 : (boardData[l][r][c].style === 'heart-purple' ? 20 : 10);
                    showFloatingScore(firstSelect.r, firstSelect.c, bonus);
                    showFloatingScore(r, c, bonus);

                    boardData[firstSelect.l][firstSelect.r][firstSelect.c].cleared = true;
                    boardData[l][r][c].cleared = true;
                    score += bonus; tilesLeft -= 2;

                    playSound('sndChip'); // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
                    firstSelect = null;
                    setTimeout(() => { renderBoard(); if (tilesLeft === 0) showSettle(); }, 200);
                } else {
                    // ã€å¤±æ•—ï¼šåœ–æ¡ˆä¸åŒ æˆ– è·¯å¾‘ä¸é€šã€‘
                    // æ’­æ”¾å¤±æ•—éŸ³æ•ˆ (é€™è£¡ä½¿ç”¨ä½æ²‰çš„è²éŸ³)
                    playFailSound();

                    // è¦–è¦ºå›é¥‹ï¼šè®“å…©é¡†éƒ½é–ƒçˆä¸€ä¸‹ç´…è‰²æˆ–éœ‡å‹•
                    firstSelect.el.classList.remove('selected');
                    el.classList.add('selected');

                    // å¿«é€Ÿé‡è¨­ï¼Œä¸å¡ä½ç©å®¶
                    setTimeout(() => {
                        el.classList.remove('selected');
                        firstSelect = null;
                    }, 150);
                }
            } else {
                // ç¬¬ä¸€ä¸‹é¸å–
                firstSelect = { l, r, c, el, char: boardData[l][r][c].char };
                el.classList.add('selected');
                // å¯ä»¥åŠ ä¸€å€‹å¾®å°çš„é»æ“ŠéŸ³
            }
        }

        // å°ˆé–€è™•ç†é€£ç·šå¤±æ•—çš„é›»å­éŸ³ (å¦‚æœæ²’æœ‰éŸ³æª”å¯ä»¥ç”¨ä»£ç¢¼ç”¢ç”Ÿ)
        function playFailSound() {
            if (isMuted) return;
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.type = 'square'; // é€™ç¨®æ³¢å½¢è½èµ·ä¾†æ¯”è¼ƒåƒã€Œå—¶ã€çš„éŒ¯èª¤è²
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime); // ä½é »
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.2);
            } catch (e) { }
        }

        function drawConnectLine(path) {
            const ctx = document.getElementById('line-canvas').getContext('2d');
            ctx.clearRect(0, 0, 2000, 2000);
            ctx.lineWidth = 5; ctx.strokeStyle = '#ffd86b'; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            ctx.shadowBlur = 10; ctx.shadowColor = '#ffd86b';
            ctx.beginPath();
            path.forEach((p, i) => {
                const x = p.c * (54 + 6) + 27 + 15 + 35;
                const y = p.r * (54 + 6) + 27 + 15 + 35;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.stroke();
            setTimeout(() => ctx.clearRect(0, 0, 2000, 2000), 250);
        }

        function getPath(r1, c1, r2, c2) {
            // åˆ¤å®šè©²æ ¼æ˜¯å¦å¯ä»¥é€šè¡Œï¼ˆæ¿å¤–æˆ–å·²æ¶ˆé™¤ï¼‰
            const isEmpty = (r, c) => {
                if (r < 0 || r >= ROWS || c < 0 || c >= COLS) return true;
                return boardData[0][r][c].cleared && boardData[1][r][c].cleared;
            };

            // ç›´ç·šæª¢æŸ¥
            const checkStraight = (r1, c1, r2, c2) => {
                if (r1 !== r2 && c1 !== c2) return false;
                if (r1 === r2) {
                    for (let c = Math.min(c1, c2) + 1; c < Math.max(c1, c2); c++) {
                        if (!isEmpty(r1, c)) return false;
                    }
                } else {
                    for (let r = Math.min(r1, r2) + 1; r < Math.max(r1, r2); r++) {
                        if (!isEmpty(r, c1)) return false;
                    }
                }
                return true;
            };

            // 1. æª¢æŸ¥ 0 æŠ˜ (ç›´ç·š)
            if (checkStraight(r1, c1, r2, c2)) return [{ r: r1, c: c1 }, { r: r2, c: c2 }];

            // 2. æª¢æŸ¥ 1 æŠ˜ (Lå‹)
            // è½‰æŠ˜é» A (r1, c2)
            if (isEmpty(r1, c2) && checkStraight(r1, c1, r1, c2) && checkStraight(r1, c2, r2, c2)) {
                return [{ r: r1, c: c1 }, { r: r1, c: c2 }, { r: r2, c: c2 }];
            }
            // è½‰æŠ˜é» B (r2, c1)
            if (isEmpty(r2, c1) && checkStraight(r1, c1, r2, c1) && checkStraight(r2, c1, r2, c2)) {
                return [{ r: r1, c: c1 }, { r: r2, c: c1 }, { r: r2, c: c2 }];
            }

            // 3. æª¢æŸ¥ 2 æŠ˜ (Zå‹æˆ–Uå‹)
            // æ°´å¹³æƒææ‰€æœ‰å¯èƒ½çš„å‚ç›´æŠ˜é»
            for (let i = -1; i <= ROWS; i++) {
                if (i === r1 || i === r2) continue; // å·²ç¶“åœ¨ 1 æŠ˜æª¢æŸ¥éäº†
                if (isEmpty(i, c1) && isEmpty(i, c2) && checkStraight(r1, c1, i, c1) && checkStraight(i, c1, i, c2) && checkStraight(i, c2, r2, c2)) {
                    return [{ r: r1, c: c1 }, { r: i, c: c1 }, { r: i, c: c2 }, { r: r2, c: c2 }];
                }
            }
            // å‚ç›´æƒææ‰€æœ‰å¯èƒ½çš„æ°´å¹³æŠ˜é»
            for (let j = -1; j <= COLS; j++) {
                if (j === c1 || j === c2) continue;
                if (isEmpty(r1, j) && isEmpty(r2, j) && checkStraight(r1, c1, r1, j) && checkStraight(r1, j, r2, j) && checkStraight(r2, j, r2, c2)) {
                    return [{ r: r1, c: c1 }, { r: r1, c: j }, { r: r2, c: j }, { r: r2, c: c2 }];
                }
            }

            return null;
        }

        function showFloatingScore(r, c, val) {
            const f = document.createElement('div');
            f.className = 'floating-score';
            f.innerText = `+${val}`;
            f.style.left = `${c * 60 + 20}px`; f.style.top = `${r * 60 + 10}px`;
            f.style.color = val === 50 ? '#ffd86b' : '#fff';
            document.getElementById('game-board').appendChild(f);
            setTimeout(() => f.remove(), 700);
        }

        function updateUI() { document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString(); }
        function showSettle() {
            playSound('sndWin');
	    const multiplier = Math.floor(Math.random() * (20 - 10 + 1)) + 10;
            const reward = Math.floor(score) * multiplier;
            balance += reward;
            localStorage.setItem('sicbo_balance', balance);
            updateUI();
            document.getElementById('reward-text').innerText = `æœ¬å±€å¾—åˆ†ï¼š${score}\nå­˜å…¥é‡‘å¹£ï¼š${reward} ğŸ’°`;
            document.getElementById('settle-screen').style.display = 'flex';
        }
        function closeSettle() { document.getElementById('settle-screen').style.display = 'none'; initMap(); }

        window.onload = initMap;
    </script>
</body>

</html>